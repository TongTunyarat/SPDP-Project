<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-admin.css">
    <link rel="stylesheet" href="/css/ScorePeriodSetting.css">
    <link rel="stylesheet" href="/css/Dashboard-Admin.css">

    <!-- Calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!--    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->


</head>
<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>
        <form th:action="@{/logout}" method="post" class="logout-container" onsubmit="clearLocalStorageBeforeLogout()">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </form>

        <script>
            function clearLocalStorageBeforeLogout() {
                localStorage.removeItem("selectedSemester");
            }
        </script>



        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                </path>
            </svg> Homepage </h4>
            <li><a href="/admin-dashboard" class="active">Dashboard</a></li>
            <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
            <li><a href="/admin-timeliness-scoring">Timeliness Scoring</a></li>
        </ul>

        <h2> Pages </h2>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                <g fill="#ffffff" fill-rule="nonzero">
                    <g transform="scale(5.33333,5.33333)">
                        <path
                                d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                        </path>
                    </g>
                </g>
            </svg>Score Evaluation </h4>
            <li><a href="/scoring-periods">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                </path>
            </svg> Manage Schedule </h4>
            <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
            <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
            <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
            <li><a href="/admin/editDefenseSchedulePage">Edit Defense Timing</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                </path>
            </svg> Manage Project </h4>
            <li><a href="/project-overview">Project Overview</a></li>
            <li><a href="/project-details">Project Details</a></li>
            <li><a href="/project-committee">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>

    <div class="content">
        <!--    HEADER    -->
        <div class="header-section">
            <span id="date-time"></span>

            <div class="semester-container">
                <select id="semester-selector" onchange="fetchGradingStatistics(); fetchImportantDates(); fetchProposalData(); fetchDefenseData(); fetchPosterData(); fetchGradeDistribution(); fetchEvaluationStatus(); fetchTeacherScoringData();"></select>
            </div>

            <!--    TAB: Proposal & Poster &  Defense   -->
            <div class="filters">
                <div class="filter active">Proposal</div>
                <div class="filter">Poster</div>
                <div class="filter">Defense</div>
            </div>

        </div>

        <!--    TAB: ICT & DST    -->
        <div class="tabs">
            <div class="tab active">All</div>
            <div class="tab">ICT</div>
            <div class="tab">DST</div>
        </div>

        <!-- Card Header -->
        <div class="card-wrapper">
            <div class="header-container">
                <label class="text-header"> Proposal Evaluation </label>
                <label class="text-center">
                    <h1> 0/0 <span style="color: #919EAB;">Groups</span></h1>
                </label>
            </div>

            <div class="header-container">
                <label class="text-header"> Senior Project 1 </label>
                <label class="text-center">
                    <h1> 0/0 <span style="color: #919EAB;"> Students </span></h1>
                </label>
            </div>

            <div class="header-container">
                <label class="text-header"> Poster Evaluation </label>
                <label class="text-center">
                    <h1> 0/0 <span style="color: #919EAB;">Groups</span></h1>
                </label>
            </div>

            <div class="header-container">
                <label class="text-header"> Defense Evaluation </label>
                <label class="text-center">
                    <h1> 0/0 <span style="color: #919EAB;">Groups</span></h1>
                </label>
            </div>

            <div class="header-container">
                <label class="text-header"> Senior Project 2 </label>
                <label class="text-center">
                    <h1> 0/0 <span style="color: #919EAB;"> Students </span></h1>
                </label>
            </div>

        </div>


        <!--    Content    -->
        <div class="main-content">
            <div class="panel">
                <div class="panel-title">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="chart-container">
                    <canvas id="gradeBarChart"></canvas>
                </div>
                <div style="font-size: 13px; text-align: center; margin-top: 10px; color: #666;">
                    ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏£‡∏î‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>
                <div class="timeline">
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</div>
                <div class="panel-chart">
                    <canvas id="evaluationPieChart"></canvas>
                </div>
            </div>
        </div>

        <div class="main-content-list">
            <div class="panel-list">
                <div class="panel-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</div>
                <canvas id="teacher-scoring-chart"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- ----------- Set Header Value -------------- -->
<script>
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    function formatDate() {
        const date = new Date();
        const options = { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' };
        const formattedDate = date.toLocaleDateString('en-US', options);

        // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        const [weekday, month, day, year] = formattedDate.replace(',', '').split(' ');

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà "Monday 03, March 2025"
        return `${weekday} ${day} ${month} ${year}`;
    }

    document.getElementById("date-time").textContent = formatDate();

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Dropdown (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ)
    const semesterSelect = document.getElementById("semester-selector");
    semesterSelect.addEventListener("change", function () {
        console.log("Selected Semester:", semesterSelect.value);

        localStorage.setItem("selectedSemester", semesterSelect.value);
        // fetchGradeDistribution();
        // fetchEvaluationStatus();
        // fetchTeacherScoringData();

        fetchGradingStatistics();
        fetchImportantDates();
        fetchProposalData();
        fetchDefenseData();
        fetchPosterData();
        fetchGradeDistribution();
        fetchEvaluationStatus();
        fetchTeacherScoringData();
    });

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners
    document.addEventListener("DOMContentLoaded", function () {
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        // fetchGradeDistribution();

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö semester selector
        const semesterSelect = document.getElementById("semester-selector");
        semesterSelect.addEventListener("change", function () {
            console.log("Selected Semester:", semesterSelect.value);
            fetchGradeDistribution();
            fetchEvaluationStatus();
            fetchTeacherScoringData();
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tabs (All, ICT, DST)
        const tabs = document.querySelectorAll(".tab");
        tabs.forEach(tab => {
            tab.addEventListener("click", function () {
                // ‡πÄ‡∏≠‡∏≤ active ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å tab
                tabs.forEach(t => t.classList.remove("active"));
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° active ‡πÉ‡∏´‡πâ tab ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
                this.classList.add("active");
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô tab
                fetchGradeDistribution();
                fetchEvaluationStatus();
                fetchTeacherScoringData();
            });
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö filters (Proposal, Poster, Defense)
        const filters = document.querySelectorAll(".filter");
        filters.forEach(filter => {
            filter.addEventListener("click", function () {
                // ‡πÄ‡∏≠‡∏≤ active ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å filter
                filters.forEach(f => f.classList.remove("active"));
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° active ‡πÉ‡∏´‡πâ filter ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
                this.classList.add("active");
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô filter
                fetchGradeDistribution();
                fetchEvaluationStatus();
                fetchTeacherScoringData();
            });
        });
    });
</script>

<!-- --------- Semester Change ------------- -->
<script>

    async function fetchAcademicYears() {
        try {
            const response = await fetch('/api/academic-years'); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
            const data = await response.json();

            console.log("Year: ", data);

            const semesterSelector = document.getElementById('semester-selector');
            semesterSelector.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà

            data.forEach(year => {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = "üìÜ "+year;
                // option.innerHTML = `<!--<i class='far fa-calendar'></i> ${year} <i class='fas fa-chevron-down dropdown-arrow'></i>-->`;
                semesterSelector.appendChild(option);
            });

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô default (‡πÄ‡∏ä‡πà‡∏ô 2025)
            // const currentYear = new Date().getFullYear();  // ‡∏´‡∏≤‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            // if (!semesterSelector.value) {
            //     semesterSelector.value = currentYear.toString();  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ default ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            // }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0-11 (‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° = 0, ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° = 11)

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <= 6 (‡∏°.‡∏Ñ. - ‡∏°‡∏¥.‡∏¢.) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -1, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏Å.‡∏Ñ. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const defaultYear = currentMonth <= 8 ? currentYear - 1 : currentYear;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            // if (data.includes(defaultYear.toString())) {
            //     semesterSelector.value = defaultYear.toString();
            // } else {
            //     semesterSelector.selectedIndex = 0; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÅ‡∏ó‡∏ô
            // }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const savedSemester = localStorage.getItem("selectedSemester");

            if (savedSemester && data.includes(savedSemester)) {
                semesterSelector.value = savedSemester;
            } else if (data.includes(defaultYear.toString())) {
                semesterSelector.value = defaultYear.toString();
            } else {
                semesterSelector.selectedIndex = 0;
            }


            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchGradingStatistics ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ initial ‡∏õ‡∏µ‡πÑ‡∏õ
            await fetchGradingStatistics();
            await fetchImportantDates();
            await fetchProposalData();
            await fetchDefenseData();
            await fetchPosterData();
            await fetchGradeDistribution();
            await fetchEvaluationStatus();
            await fetchTeacherScoringData();

        } catch (error) {
            console.error("Error fetching academic years:", error);
        }
    }

    fetchAcademicYears();
</script>

<!-- ------------- For Grading Card --------------- -->
<script>
    let gradingData = [];  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    let gradingSummary = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ (completedProposals, completedDefenses, totalGroups, defenseEva, proposalEva)

    document.addEventListener('DOMContentLoaded', function() {
        // fetchGradingStatistics();

        const tabs = document.querySelectorAll(".tab");
        tabs.forEach(tab => {
            tab.addEventListener("click", function () {
                tabs.forEach(t => t.classList.remove("active"));
                this.classList.add("active");

                const selectedProgram = this.textContent.trim(); // ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤ "All", "ICT", ‡∏´‡∏£‡∏∑‡∏≠ "DST"
                updateGradingByProgram(selectedProgram);
            });
        });
    });

    async function fetchGradingStatistics() {
        const selectedYear = document.getElementById("semester-selector").value;  // ‡∏î‡∏∂‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å dropdown
        console.log("selectedYear: ", selectedYear);  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡πÑ‡∏´‡∏°‡πÉ‡∏ô console
        if (!selectedYear) {
            console.log("No year selected");
            return;
        }

        try {
            const response = await fetch(`/api/grading-statistics?year=${selectedYear}`);  // ‡∏™‡πà‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡πÉ‡∏ô query parameter
            const data = await response.json();

            console.log("üìå Data from API:", data);

            if (!Array.isArray(data.student)) {
                console.error("‚ùå API response 'student' is not an array!", data);
                return;
            }

            gradingData = data.student;  // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• student ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            gradingSummary = {
                totalGroups: data.totalGroups,
                completedProposals: data.completedProposals,
                completedDefenses: data.completedDefenses,
                proposalEvaluation: data.proposalEvaluation,  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠
                defenseEvaluation: data.defenseEvaluation   // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
            };

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "I"
            const validStudentGrades = gradingData.filter(student => {
                const validProposal = gradingSummary.proposalEvaluation.some(evaluation => {
                    if (evaluation.student && evaluation.student.studentId === student.studentId) {
                        console.log(`Proposal Grade for ${student.studentId}: ${evaluation.gradeResult}`);
                        return evaluation.gradeResult !== "I";
                    }
                    return false;
                });

                const validDefense = gradingSummary.defenseEvaluation.some(evaluation => {
                    if (evaluation.student && evaluation.student.studentId === student.studentId) {
                        console.log(`Defense Grade for ${student.studentId}: ${evaluation.gradeResult}`);
                        return evaluation.gradeResult !== "I";
                    }
                    return false;
                });

                return validProposal || validDefense; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "I"
            });

            console.log("üìä Valid Students Count:", validStudentGrades.length);

            gradingSummary.validStudents = validStudentGrades.length;  // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô student ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

            updateGradingByProgram("All");
        } catch (error) {
            console.error('‚ùå Fetch error:', error);
        }
    }

    function updateGradingByProgram(program) {
        console.log("üìå Data before filter:", gradingData);

        if (!Array.isArray(gradingData)) {
            console.error("‚ùå gradingData is not an array!", gradingData);
            return;
        }

        let filteredData = gradingData;
        if (program !== "All") {
            // Filter data by program
            filteredData = gradingData.filter(item => item.program === program);
        }

        // Use evaluations from gradingSummary
        const proposalEvaluation = gradingSummary.proposalEvaluation || [];
        const defenseEvaluation = gradingSummary.defenseEvaluation || [];

        // Proposal: ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ gradeResult ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "I"
        const successfulProposal = filteredData.filter(item =>
            proposalEvaluation.some(proposal =>
                proposal.student.studentId === item.studentId && proposal.gradeResult !== "I"
            )
        );

        // Defense: ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ gradeResult ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "I"
        const successfulDefense = filteredData.filter(item =>
            defenseEvaluation.some(defense =>
                defense.studentId.studentId === item.studentId && defense.gradeResult !== "I"
            )
        );

        const totalCount = filteredData.length;

        console.log(`üìä ${program} - Proposal: ${successfulProposal.length}/${totalCount}`);
        console.log(`üìä ${program} - Defense: ${successfulDefense.length}/${totalCount}`);

        updateGradingCards(successfulProposal.length, successfulDefense.length, totalCount, program);
    }

    function updateGradingCards(proposalCount, defenseCount, totalCount, program) {
        console.log("üéûÔ∏è Proposal:", proposalCount, "Defense:", defenseCount);

        // Update Proposal Grades (‡πÉ‡∏ö‡∏ó‡∏µ‡πà 2)
        const proposalCard = document.querySelector('.card-wrapper .header-container:nth-child(2)');
        if (proposalCard) {
            const headingEl = proposalCard.querySelector('.text-center h1');
            if (headingEl) {
                headingEl.innerHTML = `${proposalCount}/${totalCount} <span style="color: #919EAB;"> Students </span>`;
            }
        }

        // Update Defense Grades (‡πÉ‡∏ö‡∏ó‡∏µ‡πà 5)
        const defenseCard = document.querySelector('.card-wrapper .header-container:nth-child(5)');
        if (defenseCard) {
            const headingEl = defenseCard.querySelector('.text-center h1');
            if (headingEl) {
                headingEl.innerHTML = `${defenseCount}/${totalCount} <span style="color: #919EAB;"> Students </span>`;
            }
        }
    }
</script>

<!-- ------------- For Proposal Evaluation Card --------------- -->
<script>
    async function fetchProposalData() {
        const program = document.querySelector(".tab.active");
        console.log("Program: "+ program.textContent)

        const selectedYear = document.getElementById("semester-selector").value;  // ‡∏î‡∏∂‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å dropdown

        if (!selectedYear) {
            console.error("Year is not selected!");
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/proposal-evaluation?program=${program.textContent}&year=${selectedYear}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Fetch Proposal Data:", data);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
            if (!data || typeof data.totalProjects === "undefined" || typeof data.completedProjects === "undefined") {
                throw new Error("Invalid data format");
            }

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ .header-container ‡∏ó‡∏µ‡πà‡∏°‡∏µ .text-header ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 'Proposal Evaluation'
            const headerContainers = document.querySelectorAll(".header-container");
            headerContainers.forEach(container => {
                const headerText = container.querySelector(".text-header");
                if (headerText && headerText.textContent.includes("Proposal Evaluation")) {
                    const proposalHeader = container.querySelector(".text-center h1");
                    // const proposalFooter = container.querySelector(".text-footer");

                    if (proposalHeader) {
                        proposalHeader.innerHTML = `${data.completedProjects}/${data.totalProjects} <span style="color: #919EAB;">Groups</span>`;
                    }

                    // if (proposalFooter) {
                    //     proposalFooter.innerHTML = `${data.completedProjects} <span style="color: #919EAB;">completed</span>`;
                    // }
                }
            });

        } catch (error) {
            console.error("Error fetching proposal data:", error);
        }
    }

    // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà tab
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function () {
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö program ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const program = tab.textContent.trim();
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™ active ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fetchProposalData ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ program ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ
            fetchProposalData();
            fetchDefenseData();
            fetchPosterData();
        });
    });
</script>

<!-- ------------- For Defense Evaluation Card --------------- -->
<script>
    async function fetchDefenseData() {
        const program = document.querySelector(".tab.active");
        const selectedYear = document.getElementById("semester-selector").value;

        try {
            const response = await fetch(`http://localhost:8080/api/defense-evaluation?program=${program.textContent}&year=${selectedYear}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Fetch Defense Data:", data);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
            if (!data || typeof data.totalProjects === "undefined" || typeof data.completedProjects === "undefined") {
                throw new Error("Invalid data format");
            }

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ .header-container ‡∏ó‡∏µ‡πà‡∏°‡∏µ .text-header ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 'Proposal Evaluation'
            const headerContainers = document.querySelectorAll(".header-container");
            headerContainers.forEach(container => {
                const headerText = container.querySelector(".text-header");
                if (headerText && headerText.textContent.includes("Defense Evaluation")) {
                    const defenseHeader = container.querySelector(".text-center h1");
                    // const defenseFooter = container.querySelector(".text-footer");

                    if (defenseHeader) {
                        defenseHeader.innerHTML = `${data.completedProjects}/${data.totalProjects} <span style="color: #919EAB;">Groups</span>`;
                    }

                    // if (defenseFooter) {
                    //     defenseFooter.innerHTML = `${data.completedProjects} <span style="color: #919EAB;">completed</span>`;
                    // }
                }
            });

        } catch (error) {
            console.error("Error fetching proposal data:", error);
        }
    }
</script>

<!-- ------------- For Poster Evaluation Card --------------- -->
<script>
    async function fetchPosterData() {
        const program = document.querySelector(".tab.active");
        const selectedYear = document.getElementById("semester-selector").value;

        try {
            const response = await fetch(`http://localhost:8080/api/poster-evaluation?program=${program.textContent}&year=${selectedYear}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Fetch Defense Data:", data);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
            if (!data || typeof data.totalProjects === "undefined" || typeof data.completedProjects === "undefined") {
                throw new Error("Invalid data format");
            }

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ .header-container ‡∏ó‡∏µ‡πà‡∏°‡∏µ .text-header ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 'Proposal Evaluation'
            const headerContainers = document.querySelectorAll(".header-container");
            headerContainers.forEach(container => {
                const headerText = container.querySelector(".text-header");
                console.log("headerText: "+headerText.textContent)
                if (headerText && headerText.textContent.includes("Poster Evaluation")) {
                    console.log("update poster card")
                    const posterHeader = container.querySelector(".text-center h1");
                    // const posterFooter = container.querySelector(".text-footer");

                    if (posterHeader) {
                        posterHeader.innerHTML = `${data.completedProjects}/${data.totalProjects} <span style="color: #919EAB;">Groups</span>`;
                    }

                    // if (posterFooter) {
                    //     posterFooter.innerHTML = `${data.completedProjects} <span style="color: #919EAB;">completed</span>`;
                    // }
                }
            });

        } catch (error) {
            console.error("Error fetching proposal data:", error);
        }
    }
</script>

<!-- ---------- For Grade Bar Chart -------------- -->
<script>
    let gradeChart = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå Chart.js

    async function fetchGradeDistribution() {
        try {
            const semesterYear = document.getElementById("semester-selector").value;
            const activeTab = document.querySelector(".tab.active").textContent;
            const activeFilter = document.querySelector(".filter.active").textContent;

            let evaType;
            switch (activeFilter) {
                case "Proposal": evaType = "Proposal Evaluation"; break;
                case "Poster": evaType = "Poster Exhibition"; break;
                case "Defense": evaType = "Defense Evaluation"; break;
                default: evaType = "Proposal Evaluation";
            }

            console.log(`Fetching data for: ${activeTab} program, ${semesterYear} year, ${evaType}`);

            const response = await fetch(`http://localhost:8080/api/grading-graph?program=${activeTab}&year=${semesterYear}&evaType=${evaType}`);
            const data = await response.json();
            updateChart(data, evaType);

        } catch (error) {
            console.error("Error fetching grade distribution:", error);
        }
    }

    function updateChart(gradeData, evaType) {
        console.log("üëÅÔ∏è‚Äçüó®Ô∏è Update Grade Bar Chart: ");
        console.log(gradeData);
        console.log(evaType)

        const ctx = document.getElementById("gradeBarChart").getContext("2d");
        const chartContainer = document.querySelector(".chart-container");

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        let noGradeMessage = document.getElementById("noGradeMessage");

        if (evaType === "Poster Exhibition") {
            document.getElementById("gradeBarChart").style.display = "none";

            if (!noGradeMessage) {
                noGradeMessage = document.createElement("div");
                noGradeMessage.id = "noGradeMessage";
                noGradeMessage.classList.add("no-grade-message");
                noGradeMessage.textContent = "Poster Exhibition ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏Å‡∏£‡∏î";
                chartContainer.appendChild(noGradeMessage);
            }

            return;
        } else {
            document.getElementById("gradeBarChart").style.display = "block";
            if (noGradeMessage) {
                noGradeMessage.remove();
            }
        }

        if (gradeChart) {
            gradeChart.destroy();
        }

        const gradeOrder = ["A", "B+", "B", "C+", "C", "D+", "D", "F", "I"];
        const chartData = gradeOrder.map(grade => gradeData[grade] || 0);

        gradeChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: gradeOrder,
                datasets: [{
                    label: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
                    data: chartData,
                    backgroundColor: [
                        "#4CAF50", "#8BC34A", "#CDDC39",
                        "#FFEB3B", "#FFC107", "#FF9800",
                        "#FF5722", "#F44336", "#9E9E9E"
                    ],
                    borderColor: "#444",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (tooltipItem) => `${tooltipItem.raw} ‡∏Ñ‡∏ô`
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" }
                    }
                }
            }
        });
    }

</script>

<!-- ---------- For Reminder Card ----------- -->
<script>
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï timeline
    function fetchImportantDates() {
        const semesterYear = document.getElementById("semester-selector").value;

        fetch(`http://localhost:8080/api/important-dates?year=${semesterYear}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                updateTimeline(data);
            })
            .catch(error => {
                console.error("Error fetching important dates:", error);
            });
    }

    function updateTimeline(scoringPeriods) {
        const timelineContainer = document.querySelector(".timeline");
        timelineContainer.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

        const displayNames = {
            "Proposal Evaluation": "Proposal Presentation",
            "Poster Evaluation": "Poster Exhibition",
            "Defense Evaluation": "Senior Project Defense",
            "Proposal Grade": "Proposal Grading",
            "Defense Grade": "Defense Grading"
        };

        const today = new Date();
        const currentYear = today.getFullYear();

        let hasItems = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏´‡∏°

        scoringPeriods.forEach(period => {
            const endDate = new Date(period.endDate);
            if (endDate.getFullYear() !== currentYear) return;

            hasItems = true; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

            const daysRemaining = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));

            const startDateFormatted = formatDate(period.startDate);
            const endDateFormatted = formatDate(period.endDate);

            const timelineItem = document.createElement("div");
            timelineItem.classList.add("timeline-item");

            let statusClass = "";
            let statusText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ : ${daysRemaining} ‡∏ß‡∏±‡∏ô`;

            if (daysRemaining === 0) {
                statusClass = "timeline-expired";
                statusText = "‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß!";
            } else if (daysRemaining <= 7) {
                statusClass = "timeline-urgent";
            } else if (daysRemaining >= 30) {
                statusClass = "timeline-chill";
            } else if (daysRemaining < 30) {
                statusClass = "timeline-lessthan1m";
            }

            if (statusClass) timelineItem.classList.add(statusClass);

            timelineItem.innerHTML = `
            <div class="timeline-icon">
                <i class="fa-solid fa-calendar"></i>
            </div>
            <div class="timeline-content">
                <div class="timeline-title">${displayNames[period.evaluationType] || period.evaluationType}</div>
                <div class="timeline-date">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ : ${startDateFormatted} - ${endDateFormatted}</div>
                <div class="timeline-status">${statusText}</div>
            </div>
        `;

            timelineContainer.appendChild(timelineItem);
        });

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢
        if (!hasItems) {
            const emptyMessage = document.createElement("div");
            emptyMessage.classList.add("timeline-empty");
            emptyMessage.innerHTML = `
<!--            <div class="timeline-icon">-->
<!--                <i class="fa-solid fa-calendar-xmark"></i>-->
<!--            </div>-->
            <div class="timeline-content">
                <i class="fa-solid fa-calendar-xmark"></i>
                <div class="timeline-title">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>
            </div>
        `;
            timelineContainer.appendChild(emptyMessage);
        }
    }



    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    document.addEventListener("DOMContentLoaded", function() {
        fetchImportantDates();

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
        setInterval(fetchImportantDates, 24 * 60 * 60 * 1000);
    });
</script>

<!-- ----------- For Pie Chart ------------- -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let evaluationChart = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå Chart.js

    async function fetchEvaluationStatus() {
        try {
            const activeFilter = document.querySelector('.filter.active').textContent.trim();
            const activeProgram = document.querySelector('.tab.active').textContent.trim();
            const selectedYear = document.getElementById('semester-selector').value;

            let evaType = activeFilter === 'Proposal' ? 'Proposal' :
                activeFilter === 'Poster' ? 'Poster' :
                    'Defense';

            const response = await fetch(`/api/student-counts?evaType=${evaType}&year=${selectedYear}&program=${activeProgram}`);

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            console.log("üìä Student Count Data:", data);

            updatePieChart(data);

        } catch (error) {
            console.error("‚ùå Error fetching evaluation status:", error);
        }
    }

    function updatePieChart(data) {
        console.log("üêñ Update Pie Chart: ");
        console.log(data);

        const ctx = document.getElementById("evaluationPieChart").getContext("2d");

        // Destroy existing chart to prevent overlapping
        if (evaluationChart) {
            evaluationChart.destroy();
        }

        evaluationChart = new Chart(ctx, {
            type: "pie",
            data: {
                labels: ["‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß", "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô", "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô"],
                datasets: [{
                    data: [data.completed, data.partial, data.notEvaluated],
                    backgroundColor: ["#26a69a", "#feca57", "#ff6b6b"],
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                layout: {
                    padding: 10
                },
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: {
                            boxWidth: 20,
                            padding: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const value = tooltipItem.raw;
                                const total = data.completed + data.partial + data.notEvaluated;
                                const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                return `${value} ‡∏Ñ‡∏ô (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

</script>

<!-- ------- Instructor scoring --------- -->
<script>
    const unitLabel = evaType === "Poster" ? "‡∏Å‡∏•‡∏∏‡πà‡∏°" : "‡∏Ñ‡∏ô";

    async function fetchTeacherScoringData() {
        try {
            const activeFilter = document.querySelector('.filter.active').textContent.trim();
            const activeProgram = document.querySelector('.tab.active').textContent.trim();
            const selectedYear = document.getElementById('semester-selector').value;

            let evaType = activeFilter === 'Proposal' ? 'Proposal' :
                activeFilter === 'Poster' ? 'Poster' :
                    'Defense';

            console.log("üòà Scoring");
            console.log("üòà", evaType, selectedYear, activeProgram);

            const response = await fetch(`http://localhost:8080/api/teacher-scoring/remaining?evaType=${evaType}&year=${selectedYear}&program=${activeProgram}`);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å API
            console.log("üòà", data);

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
            const labels = [];
            const remainingCounts = [];
            const completedCounts = []; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            const totalAssignedCounts = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô arrays
            data.forEach(item => {
                labels.push(item.instructorName);
                remainingCounts.push(item.remainingCount);
                totalAssignedCounts.push(item.totalAssigned);

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å totalAssigned - remainingCount
                const completed = item.totalAssigned - item.remainingCount;
                completedCounts.push(completed);
            });

            // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà
            const ctx = document.getElementById('teacher-scoring-chart').getContext('2d');
            if (window.chartInstance) {
                window.chartInstance.destroy();
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö stacked
            window.chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, // ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå
                    datasets: [{
                        label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                        data: completedCounts, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                        backgroundColor: '#20c8ba', // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
                        borderColor: '#1e9e9b',
                        borderWidth: 1
                    }, {
                        label: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô',
                        data: remainingCounts, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥
                        backgroundColor: '#ff8080', // ‡∏™‡∏µ‡πÅ‡∏î‡∏á (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô)
                        borderColor: '#ff4d4d',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top',
                        },
                        // tooltip: {
                        //     callbacks: {
                        //         // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå
                        //         title: function(tooltipItems) {
                        //             return tooltipItems[0].label;
                        //         },
                        //         // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏°
                        //         afterTitle: function(context) {
                        //             const index = context[0].dataIndex;
                        //             return `‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:`;
                        //         },
                        //         // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô
                        //         label: function(context) {
                        //             const index = context.dataIndex;
                        //             const datasetIndex = context.datasetIndex;
                        //
                        //             // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° dataset ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡πâ
                        //             if (datasetIndex === 0) {
                        //                 return `‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${completedCounts[index]} ‡∏Ñ‡∏ô`;
                        //             } else {
                        //                 return `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ${remainingCounts[index]} ‡∏Ñ‡∏ô`;
                        //             }
                        //         },
                        //         // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å label
                        //         afterLabel: function(context) {
                        //             const index = context.dataIndex;
                        //             const totalAssigned = totalAssignedCounts[index];
                        //             const completed = completedCounts[index];
                        //             const remaining = remainingCounts[index];
                        //             const percentComplete = totalAssigned > 0
                        //                 ? Math.round((completed / totalAssigned) * 100)
                        //                 : 0;
                        //
                        //             return [
                        //                 `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalAssigned} ‡∏Ñ‡∏ô`,
                        //                 `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ${percentComplete}%`
                        //             ];
                        //         }
                        //     }
                        // }
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label;
                                },
                                afterTitle: function(context) {
                                    return `‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:`;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const datasetIndex = context.datasetIndex;
                                    const unitLabel = evaType === "Poster" ? "‡∏Å‡∏•‡∏∏‡πà‡∏°" : "‡∏Ñ‡∏ô";

                                    if (datasetIndex === 0) {
                                        return `‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${completedCounts[index]} ${unitLabel}`;
                                    } else {
                                        return `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ${remainingCounts[index]} ${unitLabel}`;
                                    }
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const totalAssigned = totalAssignedCounts[index];
                                    const completed = completedCounts[index];
                                    const percentComplete = totalAssigned > 0
                                        ? Math.round((completed / totalAssigned) * 100)
                                        : 0;
                                    const unitLabel = evaType === "Poster" ? "‡∏Å‡∏•‡∏∏‡πà‡∏°" : "‡∏Ñ‡∏ô";

                                    return [
                                        `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalAssigned} ${unitLabel}`,
                                        `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ${percentComplete}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true // ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡∏ô x ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
                        },
                        y: {
                            stacked: true, // ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡∏ô y ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Error fetching teacher scoring data:", error);
        }
    }
</script>


</body>
