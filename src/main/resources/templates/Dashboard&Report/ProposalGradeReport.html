<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Grade Report</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-admin.css">
    <link rel="stylesheet" href="/css/GradeReport.css">

</head>
<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>
        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                    </path>
                </svg>
                Homepage
            </h4>
            <li><a href="/admin-dashboard">Dashboard</a></li>
            <li><a href="/admin-proposal-report" class="active">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
        </ul>

        <h2> Pages </h2>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Score Evaluation
            </h4>
            <li><a href="/PeriodSetting.html">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                    </path>
                </svg>
                Manage Schedule
            </h4>
            <li><a href="#">Proposal Schedule</a></li>
            <li><a href="#">Defense Schedule</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                    </path>
                </svg>
                Manage Project
            </h4>
            <li><a href="/project-overview">Project Overview</a></li>
            <li><a href="/project-details">Project Details</a></li>
            <li><a href="/project-committee">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>

    <div class="content">
        <!--    HEADER    -->
        <div class="header-section">
            Proposal Grade Report
            <div class="export-btn">
                <button>Export</button>
            </div>
        </div>

        <!--    TAB: ICT & DST    -->
        <div class="tabs">
            <div class="tab active">All</div>
            <div class="tab">ICT</div>
            <div class="tab">DST</div>

            <input type="text" placeholder="Search">
        </div>

        <div class="body-section">

            <div class="table-container">

                <table>
                    <thead>
                    <tr>
                        <th>Project ID</th>
                        <th>Project Name</th>
                        <th>Advisor</th>
                        <th>Student ID</th>
                        <th>Student Name</th>
                        <th>Section</th>
                        <th>Track</th>
                        <th>Grade</th>
                    </tr>
                    </thead>
                    <tbody id="projectTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>

<script>
    // สร้างฟังก์ชันสำหรับดึงข้อมูลและแสดงผล
    document.addEventListener('DOMContentLoaded', function() {
        fetchProposalGrades();

        // เพิ่ม event listener สำหรับปุ่ม tab
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // ลบ class active จากทุก tab
                tabs.forEach(t => t.classList.remove('active'));
                // เพิ่ม class active ให้กับ tab ที่ถูกคลิก
                this.classList.add('active');

                // กรองข้อมูลตามโปรแกรมที่เลือก
                const program = this.textContent === 'All' ? '' : this.textContent;
                filterByProgram(program);
            });
        });

        // เพิ่ม event listener สำหรับช่องค้นหา
        const searchInput = document.querySelector('.tabs input[type="text"]');
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            filterBySearchTerm(searchTerm);
        });

        // เพิ่ม event listener สำหรับปุ่ม Export
        const exportBtn = document.querySelector('.export-btn button');
        exportBtn.addEventListener('click', exportToCSV);
    });

    // ตัวแปรเก็บข้อมูลทั้งหมด
    let allProposalData = [];
    // ตัวแปรเก็บข้อมูลที่จัดกลุ่มแล้ว
    let groupedProjects = [];


    // ฟังก์ชันดึงข้อมูลจาก API
    function fetchProposalGrades() {
        fetch('http://localhost:8080/api/proposal-grade')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                allProposalData = data;
                processAndGroupData(data);
                renderGroupedTable(groupedProjects);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('projectTable').innerHTML =
                    `<tr><td colspan="8">Error loading data: ${error.message}</td></tr>`;
            });
    }

    // ฟังก์ชันจัดกลุ่มข้อมูลตามโครงการ
    function processAndGroupData(data) {
        // data = {studentProject: Array(61), gradingProposalEvaluation: Array(3), projectInstructorRole: Array(28)}

        // กรองเฉพาะโครงการที่มีสถานะ Active
        const activeProjects = data.studentProject.filter(project => project.status === 'Active');

        // สร้างแมปของข้อมูลเกรด โดยใช้ projectId และ studentId เป็นคีย์
        const gradeMap = {};
        data.gradingProposalEvaluation.forEach(grade => {
            const key = `${grade.project.projectId}_${grade.student.studentId}`;
            gradeMap[key] = grade;
        });

        // จัดกลุ่มข้อมูลตามโครงการ
        const projectGroups = {};

        activeProjects.forEach(projectItem => {
            const projectId = projectItem.project.projectId;

            if (!projectGroups[projectId]) {
                // ค้นหาอาจารย์ที่ปรึกษาจาก projectInstructorRole
                const instructor = data.projectInstructorRole.find(role => role.projectIdRole.projectId === projectId);
                const professorName = instructor ? instructor.instructor.professorName : '';

                // สร้างรหัสโครงการในรูปแบบใหม่ (เช่น "DST SP2024-01")
                const program = projectItem.project.program;
                const projectIdParts = projectId.split(' ');
                const shortProjectId = projectIdParts[projectIdParts.length - 1];
                const formattedProjectId = `${program} ${shortProjectId}`;

                projectGroups[projectId] = {
                    projectId: formattedProjectId,
                    projectTitle: projectItem.project.projectTitle,
                    program: projectItem.project.program,
                    advisor: professorName,
                    students: []
                };
            }

            // หาเกรดสำหรับนักศึกษาคนนี้
            const key = `${projectId}_${projectItem.student.studentId}`;
            // const grade = gradeMap[key] ? gradeMap[key].gradeResult : '';
            const grade = gradeMap[key]?.gradeResult ?? '';

            // เพิ่มข้อมูลนักศึกษา
            projectGroups[projectId].students.push({
                studentId: projectItem.student.studentId,
                studentName: projectItem.student.studentName,
                section: projectItem.student.section,
                track: projectItem.student.track || '',
                grade: grade
            });
        });

        // แปลงเป็น array และเพิ่มข้อมูลเพิ่มเติมเพื่อการทดสอบ (ถ้าข้อมูลมีน้อย)
        groupedProjects = Object.values(projectGroups);

        // ถ้าข้อมูลมีน้อย ให้เพิ่มข้อมูลตัวอย่างเพื่อทดสอบ
        if (groupedProjects.length < 3) {
            addSampleProjects();
        }
    }

    // ฟังก์ชันแสดงข้อมูลในตารางแบบจัดกลุ่ม
    // function renderGroupedTable(projects) {
    //     const tableBody = document.getElementById('projectTable');
    //     tableBody.innerHTML = '';
    //
    //     if (projects.length === 0) {
    //         tableBody.innerHTML = '<tr><td colspan="8">No active projects found</td></tr>';
    //         return;
    //     }
    //
    //     projects.forEach(project => {
    //         let isFirstStudent = true;
    //
    //         // สำหรับแต่ละนักศึกษาในโครงการ
    //         project.students.forEach((student, index) => {
    //             const row = document.createElement('tr');
    //
    //             // เปลี่ยนสีพื้นหลังของแถวตามลำดับของโครงการ
    //             if (index % 2 === 0) {
    //                 row.style.backgroundColor = '#ffffff'; // สีขาว สำหรับโครงการคี่
    //             } else {
    //                 row.style.backgroundColor = '#f2f2f2'; // สีเทา สำหรับโครงการคู่
    //             }
    //
    //             if (isFirstStudent) {
    //                 // แถวแรกของโครงการ - แสดงรายละเอียดโครงการและนักศึกษาคนแรก
    //                 row.innerHTML = `
    //                 <td rowspan="${project.students.length}">${project.projectId}
    //                     <div class="${project.program.toLowerCase()}-badge">${project.program}</div>
    //                 </td>
    //                 <td rowspan="${project.students.length}">
    //                     ${project.projectTitle}
    //                 </td>
    //                 <td rowspan="${project.students.length}">${project.advisor}</td>
    //                 <td>${student.studentId}</td>
    //                 <td>${student.studentName}</td>
    //                 <td>${student.section}</td>
    //                 <td>${student.track}</td>
    //                 <td>${student.grade}</td>
    //             `;
    //             } else {
    //                 // แถวถัดไปของโครงการ - แสดงเฉพาะข้อมูลนักศึกษา
    //                 row.innerHTML = `
    //                 <td>${student.studentId}</td>
    //                 <td>${student.studentName}</td>
    //                 <td>${student.section}</td>
    //                 <td>${student.track}</td>
    //                 <td>${student.grade}</td>
    //             `;
    //             }
    //
    //             tableBody.appendChild(row);
    //             isFirstStudent = false;
    //         });
    //     });
    // }
    // ฟังก์ชันแสดงข้อมูลในตารางแบบจัดกลุ่ม
    function renderGroupedTable(projects) {
        const tableBody = document.getElementById('projectTable');
        tableBody.innerHTML = '';

        if (projects.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8">No active projects found</td></tr>';
            return;
        }

        projects.forEach((project, projectIndex) => {
            let isFirstStudent = true;

            // สำหรับแต่ละนักศึกษาในโครงการ
            project.students.forEach((student, index) => {
                const row = document.createElement('tr');

                // เปลี่ยนสีพื้นหลังของแถวตามลำดับของโครงการ
                if (projectIndex % 2 === 0) {
                    // โครงการคู่
                    row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#ffffff'; // สีขาว สำหรับนักศึกษาในโครงการคู่
                } else {
                    // โครงการคี่
                    row.style.backgroundColor = index % 2 === 0 ? '#f3f3f3' : '#f3f3f3'; // สีเทาอ่อน สำหรับนักศึกษาในโครงการคี่
                }

                if (isFirstStudent) {
                    // ใช้รูปแบบที่คุณต้องการ โดยแยก projectId และ badge ให้อยู่คนละบรรทัด
                    const prefix = project.projectId.match(/^(ICT|DST)/)[0];
                    const remainingId = project.projectId.substring(prefix.length);

                    // <td rowspan="${project.students.length}">${project.projectId}
                    //     <div class="${project.program.toLowerCase()}-badge">${project.program}</div>
                    // </td>

                    // แถวแรกของโครงการ - แสดงรายละเอียดโครงการและนักศึกษาคนแรก
                    row.innerHTML = `
                <td rowspan="${project.students.length}">${remainingId}<br>
                    <div class="${prefix.toLowerCase()}-badge">${prefix}</div>
                </td>
                <td rowspan="${project.students.length}">
                    ${project.projectTitle}
                </td>
                <td rowspan="${project.students.length}">${project.advisor}</td>
                <td>${student.studentId}</td>
                <td>${student.studentName}</td>
                <td>${student.section}</td>
                <td>${student.track}</td>
                <td>${student.grade}</td>
            `;
                } else {
                    // แถวถัดไปของโครงการ - แสดงเฉพาะข้อมูลนักศึกษา
                    row.innerHTML = `
                <td>${student.studentId}</td>
                <td>${student.studentName}</td>
                <td>${student.section}</td>
                <td>${student.track}</td>
                <td>${student.grade}</td>
            `;
                }

                tableBody.appendChild(row);
                isFirstStudent = false;
            });
        });
    }

    // ฟังก์ชันกรองข้อมูลตามโปรแกรม
    function filterByProgram(program) {
        if (groupedProjects.length === 0) return;

        if (program === '') {
            // แสดงทั้งหมด
            renderGroupedTable(groupedProjects);
        } else {
            // กรองเฉพาะโปรแกรมที่เลือก
            const filteredProjects = groupedProjects.filter(project =>
                project.program === program
            );
            renderGroupedTable(filteredProjects);
        }
    }

    // ฟังก์ชันกรองข้อมูลตามคำค้นหา
    function filterBySearchTerm(searchTerm) {
        if (groupedProjects.length === 0) return;

        const filteredProjects = groupedProjects.filter(project => {
            // ค้นหาจากข้อมูลโครงการ
            if (
                project.projectId.toLowerCase().includes(searchTerm) ||
                project.projectTitle.toLowerCase().includes(searchTerm) ||
                project.advisor.toLowerCase().includes(searchTerm)
            ) {
                return true;
            }

            // ค้นหาจากข้อมูลนักศึกษา
            return project.students.some(student =>
                student.studentId.toLowerCase().includes(searchTerm) ||
                student.studentName.toLowerCase().includes(searchTerm) ||
                student.track.toLowerCase().includes(searchTerm)
            );
        });

        renderGroupedTable(filteredProjects);
    }

    // ฟังก์ชัน Export ข้อมูลเป็น CSV
    function exportToCSV() {
        if (groupedProjects.length === 0) return;

        // สร้างข้อมูล CSV
        let csvContent = "Project ID,Project Title,Program,Student ID,Student Name,Advisor,Section,Track,Grade\n";

        // สร้างแถวข้อมูล
        groupedProjects.forEach(project => {
            project.students.forEach(student => {
                csvContent += `"${project.projectId}","${project.projectTitle}","${project.program}","${student.studentId}","${student.studentName}","${project.advisor}","${student.section}","${student.track}","${student.grade}"\n`;
            });
        });

        // สร้าง Blob และดาวน์โหลด
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'proposal_grades.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</html>