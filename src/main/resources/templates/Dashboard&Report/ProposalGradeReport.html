<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Grade Report</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-admin.css">
    <link rel="stylesheet" href="/css/GradeReport.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>

        <form th:action="@{/logout}" method="post" class="logout-container">
            <!--        ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cross-Site Request Forgery (CSRF)-->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </form>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                </path>
            </svg> Homepage </h4>
            <li><a href="/admin-dashboard">Dashboard</a></li>
            <li><a href="/admin-proposal-report" class="active">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
            <li><a href="/admin-timeliness-scoring">Timeliness Scoring</a></li>
        </ul>

        <h2> Pages </h2>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                <g fill="#ffffff" fill-rule="nonzero">
                    <g transform="scale(5.33333,5.33333)">
                        <path
                                d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                        </path>
                    </g>
                </g>
            </svg>Score Evaluation </h4>
            <li><a href="/scoring-periods">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                </path>
            </svg> Manage Schedule </h4>
            <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
            <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
            <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
            <li><a href="/admin/editDefenseSchedulePage">Edit Defense Timing</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                </path>
            </svg> Manage Project </h4>
            <li><a href="/project-overview">Project Overview</a></li>
            <li><a href="/project-details">Project Details</a></li>
            <li><a href="/project-committee">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>

    <div class="content">
        <!--    HEADER    -->
        <div class="header-section">
            Proposal Grade Report

            <div class="header-button">
                <div class="semester-container">
                    <select id="semester-selector" onchange="fetchProposalGrades();"></select>
                </div>

                <div class="export-btn">
                    <button>Export</button>
                </div>
            </div>
        </div>

        <!--    TAB: ICT & DST    -->
        <div class="tabs">
            <div class="tab active">All</div>
            <div class="tab">ICT</div>
            <div class="tab">DST</div>

            <input type="text" placeholder="Search">
        </div>

        <div class="body-section">

            <div class="table-container">

                <table>
                    <thead>
                    <tr>
                        <th>Project ID</th>
                        <th>Project Name</th>
                        <th>Advisor</th>
                        <th>Student ID</th>
                        <th>Student Name</th>
                        <th>Section</th>
                        <th>Track</th>
                        <th>Grade</th>
                    </tr>
                    </thead>
                    <tbody id="projectTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>

<!-- --------- Semester Change ------------- -->
<!--<script>-->
<!--    async function fetchAcademicYears() {-->
<!--        try {-->
<!--            const response = await fetch('/api/academic-years'); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API-->
<!--            const data = await response.json();-->

<!--            console.log("Year: ", data);-->

<!--            const semesterSelector = document.getElementById('semester-selector');-->
<!--            semesterSelector.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà-->

<!--            data.forEach(year => {-->
<!--                const option = document.createElement("option");-->
<!--                option.value = year;-->
<!--                option.textContent = "üìÜ "+year;-->
<!--                semesterSelector.appendChild(option);-->
<!--            });-->

<!--            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô default (‡πÄ‡∏ä‡πà‡∏ô 2025)-->
<!--            // const currentYear = new Date().getFullYear();  // ‡∏´‡∏≤‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô-->
<!--            // if (!semesterSelector.value) {-->
<!--            //     semesterSelector.value = (currentYear - 1).toString();  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ default ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô-->
<!--            // }-->
<!--            //-->
<!--            // // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchGradingStatistics ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ initial ‡∏õ‡∏µ‡πÑ‡∏õ-->
<!--            // await fetchProposalGrades();-->

<!--            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô-->
<!--            const currentDate = new Date();-->
<!--            const currentYear = currentDate.getFullYear();-->
<!--            const currentMonth = currentDate.getMonth() + 1; // getMonth() ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0-11 (‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° = 0, ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° = 11)-->

<!--            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <= 6 (‡∏°.‡∏Ñ. - ‡∏°‡∏¥.‡∏¢.) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -1, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏Å.‡∏Ñ. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô-->
<!--            const defaultYear = currentMonth <= 8 ? currentYear - 1 : currentYear;-->

<!--            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà-->
<!--            if (data.includes(defaultYear.toString())) {-->
<!--                semesterSelector.value = defaultYear.toString();-->
<!--            } else {-->
<!--                semesterSelector.selectedIndex = 0; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÅ‡∏ó‡∏ô-->
<!--            }-->

<!--            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchGradingStatistics ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ initial ‡∏õ‡∏µ‡πÑ‡∏õ-->
<!--            await fetchProposalGrades();-->

<!--        } catch (error) {-->
<!--            console.error("Error fetching academic years:", error);-->
<!--        }-->
<!--    }-->
<!--</script>-->
<script>
    const semesterSelect = document.getElementById("semester-selector");
    semesterSelect.addEventListener("change", function () {
        console.log("Selected Semester:", semesterSelect.value);

        localStorage.setItem("selectedSemester", semesterSelect.value);

        fetchProposalGrades();

    });

    async function fetchAcademicYears() {
        try {
            const response = await fetch('/api/academic-years'); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
            const data = await response.json();

            console.log("Year: ", data);

            const semesterSelector = document.getElementById('semester-selector');
            semesterSelector.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å API
            data.forEach(year => {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = "üìÜ "+year;
                semesterSelector.appendChild(option);
            });

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ‡∏à‡∏≤‡∏Å localStorage (‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Dashboard)
            const savedSemester = localStorage.getItem("selectedSemester");

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ savedSemester ‡πÉ‡∏ô localStorage ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
            if (savedSemester && data.includes(savedSemester)) {
                semesterSelector.value = savedSemester;
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å localStorage ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ default
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1; // getMonth() ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0-11 (‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° = 0, ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° = 11)

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <= 6 (‡∏°.‡∏Ñ. - ‡∏°‡∏¥.‡∏¢.) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -1, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏Å.‡∏Ñ. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const defaultYear = currentMonth <= 8 ? currentYear - 1 : currentYear;

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (data.includes(defaultYear.toString())) {
                    semesterSelector.value = defaultYear.toString();
                } else {
                    semesterSelector.selectedIndex = 0; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÅ‡∏ó‡∏ô
                }
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ semester
            await fetchProposalGrades();

        } catch (error) {
            console.error("Error fetching academic years:", error);
        }
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î
    document.addEventListener("DOMContentLoaded", function () {
        fetchAcademicYears(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchAcademicYears ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    });
</script>


<script>
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    document.addEventListener('DOMContentLoaded', function() {
        // fetchProposalGrades();
        fetchAcademicYears();

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° tab
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // ‡∏•‡∏ö class active ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å tab
                tabs.forEach(t => t.classList.remove('active'));
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° class active ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö tab ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
                this.classList.add('active');

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const program = this.textContent === 'All' ? '' : this.textContent;
                filterByProgram(program);
            });
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        const searchInput = document.querySelector('.tabs input[type="text"]');
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            filterBySearchTerm(searchTerm);
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Export
        const exportBtn = document.querySelector('.export-btn button');
        exportBtn.addEventListener('click', exportToCSV);
    });

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let allProposalData = [];
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß
    let groupedProjects = [];


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
    function fetchProposalGrades() {
        const selectedYear = document.getElementById("semester-selector").value;  // ‡∏î‡∏∂‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å dropdown
        console.log("selectedYear: ", selectedYear);  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡πÑ‡∏´‡∏°‡πÉ‡∏ô console
        if (!selectedYear) {
            console.log("No year selected");
            return;
        }
        console.log("üòàselectedYear: ", selectedYear);
        fetch(`http://localhost:8080/api/proposal-grade?year=${selectedYear}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(data)

                allProposalData = data;
                processAndGroupData(data);
                renderGroupedTable(groupedProjects);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('projectTable').innerHTML =
                    `<tr><td colspan="8">Error loading data: ${error.message}</td></tr>`;
            });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    function processAndGroupData(data) {
        // data = {studentProject: Array(61), gradingProposalEvaluation: Array(3), projectInstructorRole: Array(28)}

        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Active
        const activeProjects = data.studentProject.filter(project => project.status === 'Active');

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏°‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏£‡∏î ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ projectId ‡πÅ‡∏•‡∏∞ studentId ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå
        const gradeMap = {};
        data.gradingProposalEvaluation.forEach(grade => {
            const key = `${grade.project.projectId}_${grade.student.studentId}`;
            gradeMap[key] = grade;
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
        const projectGroups = {};

        activeProjects.forEach(projectItem => {
            const projectId = projectItem.project.projectId;

            if (!projectGroups[projectId]) {
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å projectInstructorRole
                const instructor = data.projectInstructorRole.find(role => role.projectIdRole.projectId === projectId);
                const professorName = instructor ? instructor.instructor.professorName : '';

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô "DST SP2024-01")
                const program = projectItem.project.program;
                const projectIdParts = projectId.split(' ');
                const shortProjectId = projectIdParts[projectIdParts.length - 1];
                const formattedProjectId = `${program} ${shortProjectId}`;

                projectGroups[projectId] = {
                    projectId: formattedProjectId,
                    projectTitle: projectItem.project.projectTitle,
                    program: projectItem.project.program,
                    advisor: professorName,
                    students: []
                };
            }

            // ‡∏´‡∏≤‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
            const key = `${projectId}_${projectItem.student.studentId}`;
            // const grade = gradeMap[key] ? gradeMap[key].gradeResult : '';
            const grade = gradeMap[key]?.gradeResult ?? '';

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
            projectGroups[projectId].students.push({
                studentId: projectItem.student.studentId,
                studentName: projectItem.student.studentName,
                section: projectItem.student.section,
                track: projectItem.student.track || '',
                grade: grade
            });
        });

        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏ô‡πâ‡∏≠‡∏¢)
        groupedProjects = Object.values(projectGroups);

        // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏ô‡πâ‡∏≠‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        // if (groupedProjects.length < 3) {
        //     addSampleProjects();
        // }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
    function renderGroupedTable(projects) {
        const tableBody = document.getElementById('projectTable');
        tableBody.innerHTML = '';

        if (projects.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8">No active projects found</td></tr>';
            return;
        }

        projects.forEach((project, projectIndex) => {
            let isFirstStudent = true;

            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
            project.students.forEach((student, index) => {
                const row = document.createElement('tr');

                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                if (projectIndex % 2 === 0) {
                    // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡πà
                    row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#ffffff'; // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡πà
                } else {
                    // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡πà
                    row.style.backgroundColor = index % 2 === 0 ? '#f3f3f3' : '#f3f3f3'; // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡πà
                }

                if (isFirstStudent) {
                    // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÇ‡∏î‡∏¢‡πÅ‡∏¢‡∏Å projectId ‡πÅ‡∏•‡∏∞ badge ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
                    const prefix = project.projectId.match(/^(ICT|DST)/)[0];
                    const remainingId = project.projectId.substring(prefix.length);

                    // <td rowspan="${project.students.length}">${project.projectId}
                    //     <div class="${project.program.toLowerCase()}-badge">${project.program}</div>
                    // </td>

                    // ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ - ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
                    row.innerHTML = `
                <td rowspan="${project.students.length}">${remainingId}<br>
                    <div class="${prefix.toLowerCase()}-badge">${prefix}</div>
                </td>
                <td rowspan="${project.students.length}">
                    ${project.projectTitle}
                </td>
                <td rowspan="${project.students.length}">${project.advisor}</td>
                <td>${student.studentId}</td>
                <td>${student.studentName}</td>
                <td>${student.section}</td>
                <td>${student.track}</td>
                <td>${student.grade}</td>
            `;
                } else {
                    // ‡πÅ‡∏ñ‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                    row.innerHTML = `
                <td>${student.studentId}</td>
                <td>${student.studentName}</td>
                <td>${student.section}</td>
                <td>${student.track}</td>
                <td>${student.grade}</td>
            `;
                }

                tableBody.appendChild(row);
                isFirstStudent = false;
            });
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°
    function filterByProgram(program) {
        if (groupedProjects.length === 0) return;

        if (program === '') {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            renderGroupedTable(groupedProjects);
        } else {
            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const filteredProjects = groupedProjects.filter(project =>
                project.program === program
            );
            renderGroupedTable(filteredProjects);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    function filterBySearchTerm(searchTerm) {
        if (groupedProjects.length === 0) return;

        const filteredProjects = groupedProjects.filter(project => {
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
            if (
                project.projectId.toLowerCase().includes(searchTerm) ||
                project.projectTitle.toLowerCase().includes(searchTerm) ||
                project.advisor.toLowerCase().includes(searchTerm)
            ) {
                return true;
            }

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
            return project.students.some(student =>
                student.studentId.toLowerCase().includes(searchTerm) ||
                student.studentName.toLowerCase().includes(searchTerm) ||
                student.track.toLowerCase().includes(searchTerm)
            );
        });

        renderGroupedTable(filteredProjects);
    }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script>
    async function exportToCSV() {
        if (groupedProjects.length === 0) return;

        let result = await showColumnSelectionDialog();
        if (!result) return;

        const selectedColumns = result.columns;
        const programFilter = result.programFilter;

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Proposal Grades');

        const allColumns = [
            { id: 'projectId', header: 'Project ID', key: 'projectId', width: 12 },
            { id: 'projectTitle', header: 'Project Title', key: 'projectTitle', width: 40 },
            { id: 'program', header: 'Program', key: 'program', width: 15 },
            { id: 'studentId', header: 'Student ID', key: 'studentId', width: 15 },
            { id: 'studentName', header: 'Student Name', key: 'studentName', width: 25 },
            { id: 'advisor', header: 'Advisor', key: 'advisor', width: 25 },
            { id: 'section', header: 'Section', key: 'section', width: 10 },
            { id: 'track', header: 'Track', key: 'track', width: 15 },
            { id: 'grade', header: 'Grade', key: 'grade', width: 10 }
        ];

        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const filteredColumns = allColumns.filter(col => selectedColumns.includes(col.id));
        worksheet.columns = filteredColumns;

        const headerRow = worksheet.getRow(1);
        headerRow.font = { bold: true, color: { argb: 'FFFFFF' } };
        headerRow.alignment = { vertical: 'middle', horizontal: 'center' };

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        filteredColumns.forEach((col, index) => {
            const cell = headerRow.getCell(index + 1);
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: '4472C4' } // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°
            };
        });

        // ‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ï‡∏≤‡∏° program ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        let projectsToExport = [...groupedProjects];
        if (programFilter !== 'all') {
            projectsToExport = groupedProjects.filter(project => project.program === programFilter);
        }

        projectsToExport.forEach(project => {
            project.students.forEach(student => {
                const rowData = {};
                filteredColumns.forEach(col => {
                    rowData[col.key] = ['studentId', 'studentName', 'section', 'track', 'grade'].includes(col.key) ? student[col.key] : project[col.key];
                });
                worksheet.addRow(rowData);
            });
        });

        worksheet.eachRow((row, rowNumber) => {
            if (rowNumber > 1) { // ‡∏Ç‡πâ‡∏≤‡∏° Header row
                row.alignment = { vertical: 'middle' };

                row.eachCell((cell, colNumber) => {
                    if (colNumber <= filteredColumns.length) { // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏µ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: rowNumber % 2 === 0 ? 'E9EFF7' : 'FFFFFF' }
                        };
                    }

                    // ‡πÉ‡∏™‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏•‡∏•‡πå
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
            }
        });


        if (selectedColumns.includes('grade')) {
            worksheet.getColumn('grade').alignment = { horizontal: 'center' };
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ program ‡πÑ‡∏´‡∏ô
        let filename = 'proposal_grades';
        if (programFilter !== 'all') {
            filename += `_${programFilter}`;
        }
        filename += '.xlsx';

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showColumnSelectionDialog() {
        return new Promise(resolve => {
            const allColumns = [
                { id: 'projectId', name: 'Project ID' },
                { id: 'projectTitle', name: 'Project Title' },
                { id: 'program', name: 'Program' },
                { id: 'studentId', name: 'Student ID' },
                { id: 'studentName', name: 'Student Name' },
                { id: 'advisor', name: 'Advisor' },
                { id: 'section', name: 'Section' },
                { id: 'track', name: 'Track' },
                { id: 'grade', name: 'Grade' }
            ];

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á overlay
            const overlay = document.createElement('div');
            overlay.className = 'export-overlay';
            document.body.appendChild(overlay);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á dialog
            const dialog = document.createElement('div');
            dialog.className = 'export-dialog';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
            const title = document.createElement('h3');
            title.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export';
            dialog.appendChild(title);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á Program
            const filterContainer = document.createElement('div');
            filterContainer.className = 'program-filter';

            const filterLabel = document.createElement('div');
            filterLabel.className = 'filter-label';
            filterLabel.textContent = '‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Program:';
            filterContainer.appendChild(filterLabel);

            const programFilterOptions = document.createElement('div');
            programFilterOptions.className = 'filter-options';

            // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å All
            const allOption = document.createElement('div');
            allOption.className = 'filter-option selected';
            allOption.dataset.value = 'all';
            allOption.textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            programFilterOptions.appendChild(allOption);

            // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å DST
            const dstOption = document.createElement('div');
            dstOption.className = 'filter-option';
            dstOption.dataset.value = 'DST';
            dstOption.textContent = 'DST';
            programFilterOptions.appendChild(dstOption);

            // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ICT
            const ictOption = document.createElement('div');
            ictOption.className = 'filter-option';
            ictOption.dataset.value = 'ICT';
            ictOption.textContent = 'ICT';
            programFilterOptions.appendChild(ictOption);

            filterContainer.appendChild(programFilterOptions);
            dialog.appendChild(filterContainer);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Select All
            const selectAllContainer = document.createElement('div');
            selectAllContainer.className = 'select-all-option';

            const selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.id = 'select-all';
            selectAllCheckbox.checked = true;

            const selectAllLabel = document.createElement('label');
            selectAllLabel.htmlFor = 'select-all';
            selectAllLabel.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

            selectAllContainer.appendChild(selectAllCheckbox);
            selectAllContainer.appendChild(selectAllLabel);
            dialog.appendChild(selectAllContainer);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
            const columnsContainer = document.createElement('div');
            columnsContainer.className = 'column-options';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
            const checkboxes = [];
            allColumns.forEach(col => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'column-option';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `col-${col.id}`;
                checkbox.value = col.id;
                checkbox.checked = true;
                checkboxes.push(checkbox);

                const label = document.createElement('label');
                label.htmlFor = `col-${col.id}`;
                label.textContent = col.name;

                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(label);
                columnsContainer.appendChild(optionDiv);
            });
            dialog.appendChild(columnsContainer);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'export-actions';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-button';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => {
                document.body.removeChild(dialog);
                document.body.removeChild(overlay);
                resolve(null);
            };

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'export-button';
            confirmBtn.textContent = 'Export';
            confirmBtn.onclick = () => {
                const selectedCols = Array.from(document.querySelectorAll('.column-option input[type=checkbox]:checked')).map(cb => cb.value);
                if (selectedCols.length === 0) {
                    alert('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå');
                    return;
                }

                // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á program
                const selectedFilter = document.querySelector('.filter-option.selected').dataset.value;

                document.body.removeChild(dialog);
                document.body.removeChild(overlay);

                // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á program
                resolve({
                    columns: selectedCols,
                    programFilter: selectedFilter
                });
            };

            actionsDiv.appendChild(cancelBtn);
            actionsDiv.appendChild(confirmBtn);
            dialog.appendChild(actionsDiv);

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Select All
            selectAllCheckbox.addEventListener('change', () => {
                checkboxes.forEach(cb => {
                    cb.checked = selectAllCheckbox.checked;
                });
            });

            // ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á checkboxes
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const allChecked = checkboxes.every(cb => cb.checked);
                    const noneChecked = checkboxes.every(cb => !cb.checked);

                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
                });
            });

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á program
            const filterOptionElements = programFilterOptions.querySelectorAll('.filter-option');
            filterOptionElements.forEach(option => {
                option.addEventListener('click', () => {
                    // ‡∏•‡∏ö class selected ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    filterOptionElements.forEach(opt => opt.classList.remove('selected'));
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° class selected ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
                    option.classList.add('selected');
                });
            });

            // ‡πÅ‡∏™‡∏î‡∏á dialog
            document.body.appendChild(dialog);
        });
    }
</script>

</html>