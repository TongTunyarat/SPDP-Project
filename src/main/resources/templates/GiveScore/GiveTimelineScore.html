<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeliness Score</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-admin.css">
    <link rel="stylesheet" href="/css/Timeline.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>

        <form th:action="@{/logout}" method="post" class="logout-container">
            <!--        ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cross-Site Request Forgery (CSRF)-->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </form>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                </path>
            </svg> Homepage </h4>
            <li><a href="/admin-dashboard">Dashboard</a></li>
            <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
            <li><a href="/admin-timeliness-scoring" class="active">Timeliness Scoring</a></li>
        </ul>

        <h2> Pages </h2>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                <g fill="#ffffff" fill-rule="nonzero">
                    <g transform="scale(5.33333,5.33333)">
                        <path
                                d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                        </path>
                    </g>
                </g>
            </svg>Score Evaluation </h4>
            <li><a href="/scoring-periods">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                </path>
            </svg> Manage Schedule </h4>
            <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
            <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
            <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
            <li><a href="#">Edit Defense Timing</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                </path>
            </svg> Manage Project </h4>
            <li><a href="/project-overview">Project Overview</a></li>
            <li><a href="/project-details">Project Details</a></li>
            <li><a href="/project-committee">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>

    <div class="content">
        <!--    HEADER    -->
        <div class="header-section">
            Timeliness Scoring

            <div class="header-button">
                <div class="semester-container">
                    <select id="semester-selector" onchange="fetchProposalGrades(); fetchTimelineScores();"></select>
                </div>
            </div>
        </div>

        <!--    TAB: ICT & DST    -->
        <div class="tabs">
            <div class="tab active">All</div>
            <div class="tab">ICT</div>
            <div class="tab">DST</div>

            <div class="tabs-right">
                <select id="evaTypeSelect">
                    <option value="Proposal" data-eva-type="Proposal">Proposal Presentation</option>
<!--                    <option value="poster" data-eva-type="Poster">Poster Exhibition</option>-->
                    <option value="Defense" data-eva-type="Defense">Senior Project Defense</option>
                </select>

                <input type="text" placeholder="Search">
            </div>
        </div>

        <div class="body-section">

            <div class="table-container">
<!--                <button onclick="saveScores()">Save Scores</button>-->
                <button class="save-button" onclick="saveScores()">Save Scores</button>


                <table>
                    <thead>
                    <tr>
                        <th>Project ID</th>
                        <th>Project Name</th>
                        <th>Advisor</th>
                        <th>Score</th>
                    </tr>
                    </thead>
                    <tbody id="projectTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>


<!-- Semester Change -->
<script>
    const semesterSelect = document.getElementById("semester-selector");
    semesterSelect.addEventListener("change", function () {
        console.log("Selected Semester:", semesterSelect.value);

        localStorage.setItem("selectedSemester", semesterSelect.value);

        fetchProposalGrades();
        fetchTimelineScores();

    });

    async function fetchAcademicYears() {
        try {
            const response = await fetch('/api/academic-years');
            const data = await response.json();

            const semesterSelector = document.getElementById('semester-selector');
            semesterSelector.innerHTML = "";

            data.forEach(year => {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = "üìÜ " + year;
                semesterSelector.appendChild(option);
            });

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ‡∏à‡∏≤‡∏Å localStorage (‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Dashboard)
            const savedSemester = localStorage.getItem("selectedSemester");

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ savedSemester ‡πÉ‡∏ô localStorage ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
            if (savedSemester && data.includes(savedSemester)) {
                semesterSelector.value = savedSemester;
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å localStorage ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ default
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1; // getMonth() ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0-11 (‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° = 0, ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° = 11)

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <= 6 (‡∏°.‡∏Ñ. - ‡∏°‡∏¥.‡∏¢.) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -1, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏Å.‡∏Ñ. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const defaultYear = currentMonth <= 8 ? currentYear - 1 : currentYear;

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (data.includes(defaultYear.toString())) {
                    semesterSelector.value = defaultYear.toString();
                } else {
                    semesterSelector.selectedIndex = 0; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÅ‡∏ó‡∏ô
                }
            }

            // const currentDate = new Date();
            // const currentYear = currentDate.getFullYear();
            // const currentMonth = currentDate.getMonth() + 1;
            // const defaultYear = currentMonth <= 8 ? currentYear - 1 : currentYear;
            //
            // if (data.includes(defaultYear.toString())) {
            //     semesterSelector.value = defaultYear.toString();
            // } else {
            //     semesterSelector.selectedIndex = 0;
            // }

            await fetchProposalGrades();

        } catch (error) {
            console.error("Error fetching academic years:", error);
        }
    }
</script>

<!-- Main Logic -->
<script>
    let timelineScoresMap = {};
    let allProposalData = [];
    let groupedProjects = [];

    document.addEventListener('DOMContentLoaded', function () {
        fetchAcademicYears();

        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', async function () {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                const program = this.textContent === 'All' ? '' : this.textContent;

                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ input ICT/DST ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏° tab)
                await fetchProposalGrades();

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                filterByProgram(program);
            });
        });

        document.getElementById("evaTypeSelect").addEventListener('change', function () {
            fetchTimelineScores();
        });

        const searchInput = document.querySelector('.tabs input[type="text"]');
        searchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            filterBySearchTerm(searchTerm);
        });

        const exportBtn = document.querySelector('.export-btn button');
        exportBtn.addEventListener('click', exportToCSV);
    });

    function fetchProposalGrades() {
        const selectedYear = document.getElementById("semester-selector").value;
        const program = document.querySelector('.tab.active').textContent;
        console.log("üìò ProposalGrades Year:", selectedYear, "Program:", program);

        return fetch(`http://localhost:8080/api/proposal-grade?year=${selectedYear}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(async data => {
                allProposalData = data;
                await processAndGroupData(data);
                filterByProgram(program); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderGroupedTable ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ
                await fetchTimelineScores();
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('projectTable').innerHTML =
                    `<tr><td colspan="8">Error loading data: ${error.message}</td></tr>`;
            });
    }

    function processAndGroupData(data) {
        const activeProjects = data.studentProject.filter(project => project.status === 'Active');

        const gradeMap = {};
        data.gradingProposalEvaluation.forEach(grade => {
            const key = `${grade.project.projectId}_${grade.student.studentId}`;
            gradeMap[key] = grade;
        });

        const projectGroups = {};
        activeProjects.forEach(projectItem => {
            const projectId = projectItem.project.projectId;

            if (!projectGroups[projectId]) {
                const instructor = data.projectInstructorRole.find(role => role.projectIdRole.projectId === projectId);
                const professorName = instructor ? instructor.instructor.professorName : '';

                const program = projectItem.project.program;
                const projectIdParts = projectId.split(' ');
                const shortProjectId = projectIdParts[projectIdParts.length - 1];
                const formattedProjectId = `${program} ${shortProjectId}`;

                projectGroups[projectId] = {
                    projectId: formattedProjectId,
                    projectTitle: projectItem.project.projectTitle,
                    program: projectItem.project.program,
                    advisor: professorName,
                    students: []
                };
            }

            const key = `${projectId}_${projectItem.student.studentId}`;
            const grade = gradeMap[key]?.gradeResult ?? '';

            projectGroups[projectId].students.push({
                studentId: projectItem.student.studentId,
                studentName: projectItem.student.studentName,
                section: projectItem.student.section,
                track: projectItem.student.track || '',
                grade: grade
            });
        });

        groupedProjects = Object.values(projectGroups);
    }

    function renderGroupedTable(projects) {
        const tableBody = document.getElementById('projectTable');
        tableBody.innerHTML = '';

        if (projects.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8">No active projects found</td></tr>';
            return;
        }

        projects.forEach((project, projectIndex) => {
            let isFirstStudent = true;

            project.students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.style.backgroundColor = projectIndex % 2 === 0 ? '#ffffff' : '#f3f3f3';

                if (isFirstStudent) {
                    const prefix = project.projectId.match(/^(ICT|DST)/)?.[0] || '';
                    const remainingId = project.projectId.substring(prefix.length);
                    const maxScore = maxScoreMap[project.projectId];

                    row.innerHTML = `
                    <td rowspan="${project.students.length}">${remainingId}<br>
                        <div class="${prefix.toLowerCase()}-badge">${prefix}</div>
                    </td>
                    <td rowspan="${project.students.length}">${project.projectTitle}</td>
                    <td rowspan="${project.students.length}">${project.advisor}</td>
                    <td>
                        <input type="number" min="0" max="${maxScore}" class="timeline-input"
                        value="${timelineScoresMap[project.projectId] ?? ''}"
                        data-project-id="${project.projectId}"
                        data-max-score="${maxScore}">
                        <small class="max-score-label">(Max: ${maxScore})</small>
                    </td>
                `;
                }

                tableBody.appendChild(row);
                isFirstStudent = false;
            });
        });

        addInputValidation();
    }

    let maxScoreMap = {};

    function fetchTimelineScores() {
        const selectedYear = document.getElementById("semester-selector").value;
        const evaType = document.getElementById("evaTypeSelect").value;

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ program
        let program = document.querySelector('.tab.active').textContent;
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 'All' ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏õ
        // if (program === 'All') {
        //     program = '';
        // }

        return fetch(`/api/timeline-score?year=${selectedYear}&evaType=${evaType}&program=${program}`)
            .then(response => response.json())
            .then(data => {
                timelineScoresMap = {};
                maxScoreMap = {}; // Reset max scores

                data.forEach(score => {
                    timelineScoresMap[score.projectId] = score.timelineScore;
                    maxScoreMap[score.projectId] = score.maxScore; // Store maxScore for each project
                });
                // data.forEach(score => {
                //     timelineScoresMap[score.projectId] = score.timelineScore;
                // });

                // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ timeline scores ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° program ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                const activeProgram = document.querySelector('.tab.active').textContent;
                filterByProgram(activeProgram);
            })
            .catch(error => {
                console.error('Error fetching timeline scores:', error);
            });
    }


    function filterByProgram(program) {
        if (groupedProjects.length === 0) return;

        if (program === 'All' || program === '') {
            renderGroupedTable(groupedProjects);
        } else {
            const filteredProjects = groupedProjects.filter(project =>
                project.program === program
            );
            renderGroupedTable(filteredProjects);
        }
    }

    function filterBySearchTerm(searchTerm) {
        if (groupedProjects.length === 0) return;

        const filteredProjects = groupedProjects.filter(project => {
            if (
                project.projectId.toLowerCase().includes(searchTerm) ||
                project.projectTitle.toLowerCase().includes(searchTerm) ||
                project.advisor.toLowerCase().includes(searchTerm)
            ) {
                return true;
            }

            return project.students.some(student =>
                student.studentId.toLowerCase().includes(searchTerm) ||
                student.studentName.toLowerCase().includes(searchTerm) ||
                student.track.toLowerCase().includes(searchTerm)
            );
        });

        renderGroupedTable(filteredProjects);
    }

</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Save Score -->
<script>

    document.addEventListener('DOMContentLoaded', function() {
        // Add CSS styling for invalid scores
        const styleElement = document.createElement('style');
        styleElement.textContent = `
        .invalid-score {
            border: 2px solid #ff0000 !important;
            background-color: rgba(255, 0, 0, 0.1) !important;
            color: #ff0000;
        }

        .invalid-score:focus {
            outline-color: #ff0000;
        }

        .invalid-score-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 80%;
        }
    `;
        document.head.appendChild(styleElement);

        // The rest of this function will be called by your existing DOMContentLoaded handler
    });

    // Add this to your renderGroupedTable function after creating the input elements
    function addInputValidation() {
        const inputs = document.querySelectorAll(".timeline-input");

        inputs.forEach(input => {
            // Remove any existing event listeners by cloning and replacing
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);

            // Add new event listener for validation
            newInput.addEventListener("input", function() {
                const maxScore = parseFloat(this.getAttribute("data-max-score"));
                let value = parseFloat(this.value);

                if (isNaN(value)) {
                    this.classList.remove("invalid-score");
                    this.title = "";
                } else if (value > maxScore) {
                    this.classList.add("invalid-score");
                    this.title = `Maximum score is ${maxScore}`;
                } else if (value < 0) {
                    this.classList.add("invalid-score");
                    this.title = "Score cannot be negative";
                } else {
                    this.classList.remove("invalid-score");
                    this.title = "";
                }
            });
        });
    }

    function checkForInvalidScores() {
        const inputs = document.querySelectorAll('.timeline-input');
        const invalidScores = [];

        inputs.forEach(input => {
            const value = parseFloat(input.value);
            const maxScore = parseFloat(input.getAttribute('data-max-score'));
            const projectId = input.getAttribute('data-project-id');

            // Only check fields that have values entered
            if (!isNaN(value) && input.value !== '') {
                if (value > maxScore || value < 0) {
                    invalidScores.push({
                        projectId: projectId,
                        value: input.value,
                        maxScore: maxScore
                    });
                }
            }
        });

        return invalidScores;
    }

    function saveScores() {
        const invalidScores = checkForInvalidScores();

        if (invalidScores.length > 0) {
            // Create and show invalid score alert
            const invalidScoreAlert = document.createElement('div');
            invalidScoreAlert.className = 'invalid-score-alert';

            let alertContent = '<h3 style="margin-top:0">‚ö†Ô∏è Invalid Scores Detected</h3>';
            alertContent += '<p>Cannot save scores. Please correct the following:</p><ul>';

            invalidScores.forEach(item => {
                // Determine the problem with the score
                let problem = "";
                if (parseFloat(item.value) > parseFloat(item.maxScore)) {
                    problem = `Maximum score is ${item.maxScore}`;
                } else if (parseFloat(item.value) < 0) {
                    problem = "Score cannot be negative";
                } else {
                    problem = "Invalid score";
                }

                alertContent += `
                <li style="margin-bottom: 10px;">
                    <div><strong>${item.projectId}</strong></div>
                    <div style="color: #dc3545;">Score: ${item.value} - <strong>${problem}</strong></div>
                </li>
            `;
            });

            alertContent += '</ul>';
            alertContent += '<button id="closeInvalidAlert" style="background-color:#dc3545;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;float:right">Close</button>';
            alertContent += '<div style="clear:both"></div>';

            invalidScoreAlert.innerHTML = alertContent;
            document.body.appendChild(invalidScoreAlert);

            // Add event listener to close button
            document.getElementById('closeInvalidAlert').addEventListener('click', function() {
                invalidScoreAlert.remove();
            });

            // Automatically remove after 10 seconds
            setTimeout(() => {
                if (document.body.contains(invalidScoreAlert)) {
                    invalidScoreAlert.remove();
                }
            }, 10000);

            return; // Stop execution and don't save
        }

        // Continue with the original save function if no invalid scores
        const scores = [];
        const inputs = document.querySelectorAll('.timeline-input');

        inputs.forEach(input => {
            const projectId = input.getAttribute('data-project-id');
            const score = input.value;

            if (score !== '') {
                scores.push({
                    projectId: projectId,
                    score: score,
                    evaType: document.getElementById("evaTypeSelect").value
                });
            }
        });

        if (scores.length === 0) {
            alert("No scores to save");
            return;
        }

        fetch('/api/save/timeliness', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(scores)
        })
            .then(async response => {
                const data = await response.text();
                if (!response.ok) {
                    throw new Error(data);
                }
                console.log('Scores saved:', data);
                // alert("Scores saved successfully!");
                showAutoAlert("Timeliness score saved successfully!");
            })
            .catch(error => {
                console.error('Error saving scores:', error);
                alert("Failed to save scores: " + error.message);
            });
    }

    function showAutoAlert(message, type = "success", duration = 3000) {
        Swal.fire({
            title: message,
            icon: type, // "success", "error", "warning", "info", "question"
            timer: 1000, // ‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)
            showConfirmButton: false, // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î OK
            allowOutsideClick: false, // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
            backdrop: true // ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô alert()
        });
    }

    // same score -------------------
    // Add this function to your JavaScript
    function applySameScore() {
        // Show a dialog to get the score and criteria for applying it
        Swal.fire({
            title: 'Apply Same Score to Multiple Projects',
            html: `
            <div style="text-align: left; margin-bottom: 15px;">
                <label for="score-value" style="display: block; margin-bottom: 5px; font-weight: bold;">Score:</label>
                <input id="score-value" type="number" min="0" class="swal2-input" placeholder="Enter score">
            </div>
            <div style="text-align: left; margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Apply to:</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button id="btn-all" class="swal2-confirm swal2-styled" style="margin: 0; background-color: #6c757d;">All Projects</button>
                    <button id="btn-ict" class="swal2-confirm swal2-styled" style="margin: 0; background-color: #007bff;">ICT Only</button>
                    <button id="btn-dst" class="swal2-confirm swal2-styled" style="margin: 0; background-color: #28a745;">DST Only</button>
                </div>
                <div style="display: flex; gap: 10px;">
<!--                    <button id="btn-empty" class="swal2-confirm swal2-styled" style="margin: 0; background-color: #dc3545;">Empty Only</button>-->
                    <button id="btn-selected" class="swal2-confirm swal2-styled" style="margin: 0; background-color: #fd7e14;">Selected Only</button>
                </div>
            </div>
        `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Close',
            didOpen: () => {
                // Add event listeners to the buttons
                document.getElementById('btn-all').addEventListener('click', () => applyScoreToProjects('all'));
                document.getElementById('btn-ict').addEventListener('click', () => applyScoreToProjects('ict'));
                document.getElementById('btn-dst').addEventListener('click', () => applyScoreToProjects('dst'));
                // document.getElementById('btn-empty').addEventListener('click', () => applyScoreToProjects('empty'));
                document.getElementById('btn-selected').addEventListener('click', () => applyScoreToProjects('selected'));
            }
        });
    }

    function applyScoreToProjects(criteria) {
        const scoreValue = document.getElementById('score-value').value;

        if (!scoreValue) {
            Swal.fire({
                icon: 'error',
                title: 'Missing Score',
                text: 'Please enter a score value first',
                timer: 2000,
                showConfirmButton: false
            });
            return;
        }

        const inputs = document.querySelectorAll('.timeline-input');
        let updatedCount = 0;

        inputs.forEach(input => {
            const maxScore = parseFloat(input.getAttribute('data-max-score'));
            const projectId = input.getAttribute('data-project-id');

            // Skip if score would be invalid
            if (parseFloat(scoreValue) > maxScore || parseFloat(scoreValue) < 0) {
                return;
            }

            let shouldUpdate = false;

            switch(criteria) {
                case 'all':
                    shouldUpdate = true;
                    break;
                case 'ict':
                    shouldUpdate = projectId.includes('ICT');
                    break;
                case 'dst':
                    shouldUpdate = projectId.includes('DST');
                    break;
                // case 'empty':
                //     shouldUpdate = input.value === '';
                //     break;
                case 'selected':
                    // For selected, we'll need to check if the row is selected
                    // We'll implement this later with checkboxes
                    const row = input.closest('tr');
                    shouldUpdate = row && row.classList.contains('selected-row');
                    break;
            }

            if (shouldUpdate) {
                input.value = scoreValue;
                updatedCount++;

                // Trigger input event for validation
                const event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            }
        });

        // Close the dialog and show success message
        Swal.fire({
            icon: 'success',
            title: 'Scores Updated',
            text: `Applied score ${scoreValue} to ${updatedCount} projects`,
            timer: 2000,
            showConfirmButton: false
        });
    }

    // Add this to enable row selection for the "Selected Only" option
    function setupRowSelection() {
        const tableRows = document.querySelectorAll('#projectTable tr');

        tableRows.forEach(row => {
            row.addEventListener('click', function(e) {
                // Don't toggle selection if clicking on an input
                if (e.target.tagName === 'INPUT') return;

                // Toggle selected class
                this.classList.toggle('selected-row');
            });
        });
    }

    // Call this after rendering the table
    function enhanceTable() {
        setupRowSelection();

        // Add CSS for selected rows
        if (!document.getElementById('row-selection-styles')) {
            const style = document.createElement('style');
            style.id = 'row-selection-styles';
            style.textContent = `
            .selected-row {
                background-color: rgba(0, 123, 255, 0.15) !important;
                border-left: 3px solid #007bff;
            }
            #projectTable tr {
                cursor: pointer;
            }
            #projectTable tr td input {
                cursor: text;
            }
        `;
            document.head.appendChild(style);
        }
    }

    // Modify the renderGroupedTable function to call enhanceTable at the end
    const originalRenderGroupedTable = renderGroupedTable;
    renderGroupedTable = function(projects) {
        originalRenderGroupedTable(projects);
        enhanceTable();
    };

    // Add button to the UI
    function addSameScoreButton() {
        // First remove any existing same-score buttons to prevent duplicates
        const existingButtons = document.querySelectorAll('.same-score-button');
        existingButtons.forEach(button => button.remove());

        const saveButton = document.querySelector('.save-button');
        if (saveButton) {
            const sameScoreButton = document.createElement('button');
            sameScoreButton.className = 'same-score-button';
            sameScoreButton.innerHTML = 'Apply Same Score';
            sameScoreButton.onclick = applySameScore;
            sameScoreButton.style.marginRight = '10px';
            sameScoreButton.style.backgroundColor = '#17a2b8';
            sameScoreButton.style.color = 'white';
            sameScoreButton.style.border = 'none';
            sameScoreButton.style.padding = '8px 16px';
            sameScoreButton.style.borderRadius = '4px';
            sameScoreButton.style.cursor = 'pointer';

            saveButton.parentNode.insertBefore(sameScoreButton, saveButton);
        }
    }

    // Call this when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for the original UI to render
        setTimeout(addSameScoreButton, 500);
    });

    // Also call when the table is reloaded
    const originalFetchProposalGrades = fetchProposalGrades;
    fetchProposalGrades = function() {
        return originalFetchProposalGrades().then(() => {
            setTimeout(addSameScoreButton, 200);
        });
    };
</script>


</html>
