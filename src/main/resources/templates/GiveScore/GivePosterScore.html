<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Give Score Proposal Evaluation</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-instructor.css">
    <link rel="stylesheet" href="/css/GivePropEvaScore.css">

    <!-- Library -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<div class="container">
    <!-- script ในการเปิดปิด period -->
    <script>
        let accessPeriods = {};

        console.log('Calling updateLinkStatus function');
        // window.onload = fetchAccessPeriods;
        document.addEventListener('DOMContentLoaded', function() {
            fetchAccessPeriods();
        });
        setInterval(updateLinkStatus, 60000);

        async function fetchAccessPeriods() {
            try {
                const response = await fetch('http://localhost:8080/api/period'); // เปลี่ยน URL ตาม backend ของคุณ
                if (!response.ok) {
                    throw new Error('Failed to fetch access periods');
                }

                const data = await response.json(); // แปลง response เป็น JSON
                console.log(data);

                accessPeriods = convertApiResponseToObject(data); // แปลง array จาก API เป็น object ที่ใช้งานง่าย
                console.log("before set date: ", accessPeriods)
                updateLinkStatus(); // อัปเดตสถานะของลิงก์
            } catch (error) {
                console.error('Error fetching access periods:', error);
            }
        }

        // ฟังก์ชันแปลง API Response (Array) เป็น Object ตาม key ที่ใช้ใน HTML
        function convertApiResponseToObject(data) {
            console.log("🎞️Convert api");
            console.log(data);

            // ตรวจสอบว่า data เป็น array และไม่เป็น null หรือ undefined
            if (!Array.isArray(data) || data.length === 0) {
                console.log("💡No data to process");
                return {}; // ถ้าไม่มีข้อมูล หรือไม่เป็น array จะคืนค่าเป็น object ว่างๆ
            }

            // 1️⃣ กำหนดประเภทของ Evaluation ที่รองรับ
            const allTypes = {
                "proposalEvaluation": "/show-proposal-eva-projects",
                "posterEvaluation": "/show-poster-projects",
                "defenseEvaluation": "/show-defense-eva-projects",
                "proposalGrade": "/show-proposal-grade-projects",
                "defenseGrade": "/show-defense-grade-projects"
            };

            let periodsObj = {};

            // 2️⃣ สร้างค่าเริ่มต้นให้ทุกประเภท (isActive = false)
            Object.keys(allTypes).forEach(type => {
                periodsObj[type] = {
                    start: null, // ไม่มีข้อมูลให้เป็น null
                    end: null,
                    isActive: false, // ปิดการใช้งาน
                    path: allTypes[type],
                    title: type
                };
            });

            // 3️⃣ อัปเดตค่าถ้ามีข้อมูลจาก API
            data.forEach((period, index) => {
                console.log(`💡Processing item at index: ${index}`);

                let evaluationTypeKey;

                // ใช้ switch-case เพื่อแปลง evaluationType ให้ตรงกับคีย์ใน allTypes
                switch (period.evaluationType) {
                    case "Proposal Evaluation":
                        evaluationTypeKey = "proposalEvaluation";
                        break;
                    case "Poster Evaluation":
                        evaluationTypeKey = "posterEvaluation";
                        break;
                    case "Defense Evaluation":
                        evaluationTypeKey = "defenseEvaluation";
                        break;
                    case "Proposal Grade":
                        evaluationTypeKey = "proposalGrade";
                        break;
                    case "Defense Grade":
                        evaluationTypeKey = "defenseGrade";
                        break;
                    default:
                        console.log(`💡No matching key for evaluation type: ${period.evaluationType}`);
                        return; // ถ้าไม่ตรงกับ case ใดๆ ก็ให้ข้ามไป
                }

                console.log("💡Evaluation type key:", evaluationTypeKey);

                if (periodsObj.hasOwnProperty(evaluationTypeKey)) {
                    // ตรวจสอบและแปลงวันที่ ถ้าวันที่เป็น string ที่ไม่สามารถแปลงได้เป็นวันที่ จะตั้งค่าเป็น null
                    const startDate = Date.parse(period.startDate); // แปลงเป็น timestamp
                    const endDate = Date.parse(period.endDate); // แปลงเป็น timestamp

                    periodsObj[evaluationTypeKey] = {
                        start: isNaN(startDate) ? null : new Date(startDate), // ถ้าแปลงไม่สำเร็จให้เป็น null
                        end: isNaN(endDate) ? null : new Date(endDate), // ถ้าแปลงไม่สำเร็จให้เป็น null
                        isActive: true, // มีข้อมูล API -> เปิดใช้งาน
                        path: allTypes[evaluationTypeKey],
                        title: period.evaluationType
                    };
                }
            });

            console.log("🎞️Final periodsObj: ", periodsObj); // ตรวจสอบผลลัพธ์
            return periodsObj;
        }

        function updateLinkStatus() {
            const currentTime = new Date(); // Get current time
            console.log("Current Time: ", currentTime); // Debugging line
            console.log("accessPeriods: ", accessPeriods)

            // Get all links with data-period
            const links = document.querySelectorAll('a[data-period]');
            console.log("links:", links); // ตรวจสอบว่าได้ลิงก์ทั้งหมดหรือไม่

            links.forEach(link => {
                const periodKey = link.getAttribute('data-period');
                const period = accessPeriods[periodKey];
                console.log("periodKey:", periodKey); // ตรวจสอบว่า periodKey ถูกต้อง
                console.log("period: ",period)

                if (period) {
                    const startTime = period.start ? new Date(period.start) : null;
                    const endTime = period.end ? new Date(period.end) : null;

                    console.log(`Checking link ${periodKey}:`, currentTime, startTime, endTime); // Debugging

                    const isAccessible =
                        period.isActive &&
                        (startTime === null || currentTime >= startTime) &&
                        (endTime === null || currentTime <= endTime);

                    console.log(`Is Accessible: ${isAccessible}`);


                    if (!isAccessible) {
                        link.classList.add('disabled-link'); // เพิ่มสไตล์
                        console.log('Disabled link added:', link);

                        link.addEventListener('click', function (e) {
                            e.preventDefault();

                            let alertMessage = "🚫 This link is not accessible right now.";

                            // ตรวจสอบว่า startTime หรือ endTime เป็น null หรือไม่
                            if (startTime && endTime) {
                                alertMessage += ` Available from ${startTime.toLocaleDateString()} to ${endTime.toLocaleDateString()}`;
                            }

                            console.warn(alertMessage); // แสดง warning ใน console
                            alert(alertMessage); // แสดง alert ตามข้อความที่กำหนด
                        });
                    } else {
                        link.classList.remove('disabled-link');

                        // ลบ event listener ที่เคยเพิ่มไว้ เพื่อไม่ให้ alert ทำงานถ้าเปลี่ยนสถานะเป็น accessible
                        link.replaceWith(link.cloneNode(true));
                    }
                }
            });
        }
    </script>


    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>
        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                <path
                        d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                </path>
            </svg> Homepage </h4>
            <li><a href="/instructor/view">Dashboard</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                <g fill="#ffffff" fill-rule="nonzero">
                    <g transform="scale(5.33333,5.33333)">
                        <path
                                d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                        </path>
                    </g>
                </g>
            </svg> Evaluation (40%) </h4>
            <li><a href="/show-proposal-eva-projects" data-period="proposalEvaluation">Proposal Evaluation</a></li>
            <li><a href="/show-poster-projects" data-period="posterEvaluation"  class="active">Poster Evaluation</a></li>
            <li><a href="/show-defense-eva-projects" data-period="defenseEvaluation">Defense Evaluation</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                <g fill="#ffffff" fill-rule="nonzero">
                    <g transform="scale(5.33333,5.33333)">
                        <path
                                d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                        </path>
                    </g>
                </g>
            </svg> Grades (60%) </h4>
            <li><a href="/show-proposal-grade-projects" data-period="proposalGrade">Proposal Grade</a></li>
            <li><a href="/show-defense-grade-projects" data-period="defenseGrade">Defense Grade</a></li>
        </ul>
    </div>

    <div class="content">

        <div class="header-section">
            <a href="/show-poster-projects" class="gray-link">Poster Evaluation (40%)</a> > <span id="project-id-title"></span>
        </div>

        <div class="body-section">

            <div class="project-details">

                <h1>Project Details</h1>

                <div class="details" id="project-details">
                    <div><strong>Project ID:</strong> <span id="project-id"></span>
                        <input type="hidden" id="projectIdInput" th:value="${projectId}">
                    </div>
                    <div><strong>Project Title:</strong> <span id="project-title"></span></div>
                    <div><strong>Project Advisor:</strong> <span id="project-advisor"></span></div>
                    <div><strong>Project Description:</strong> <span id="project-description"></span></div>
                    <div><strong>Date:</strong> <span id="project-date"></span></div>
                </div>

            </div>

            <!-- A -->
            <div class="table-container">
                <h1> A. Poster Presentation [Apperance] </h1>

                <table class="evaluation-table" id="appearance-table">
                    <thead>
                    </thead>
                </table>
            </div>

            <!-- B -->
            <div class="table-container">
                <h1> B. Contents </h1>

                <table class="evaluation-table" id="content-table">
                    <thead>
                    </thead>
                </table>
            </div>

            <!-- C -->
            <div class="table-container">
                <h1> C. Presentation [Verbal] </h1>

                <table class="evaluation-table" id="presentation-table">
                    <thead>
                    </thead>
                </table>
            </div>

            <!-- Comment -->
            <div class="table-container">
                <h1> Comment </h1>
                <textarea id="comment" rows="4" cols="50"></textarea>
            </div>

            <!-- Score Result -->
            <div class="table-container">
                <h1> Score Result </h1>

                <div id="card-container"></div>

                <button class="save-button"> Save</button>
            </div>

            <!-- Modal -->
            <div id="confirmationModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-button" id="closeModal">&times;</span>
                    <h3>Are you sure you want to save the scores?</h3>
                    <div>
                        <button id="confirmSave" class="confirm-button">Yes, Save</button>
                        <button id="cancelSave" class="cancel-button">Cancel</button>
                    </div>
                </div>
            </div>


        </div>
    </div>
</div>

<!-- ------------ Show Project detail ----------------- -->
<script>
    window.onload = function () {
        const projectId = getProjectIdFromURL();

        if (!projectId) {
            displayError("ไม่พบข้อมูล projectId");
            return;
        }

        fetchProjectDetails(projectId)
            .then(displayProjectDetails)
            .catch(error => handleFetchError(error, 'ไม่พบข้อมูลโปรเจกต์'));

        fetchAndDisplayInstructor(projectId)
        // fetchAndDisplayScores(projectId);
        // fetchAndDisplayCardResultScores(projectId);

    };

    // Utility Functions
    function getProjectIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("projectId");
    }

    function displayError(message) {
        document.getElementById('student-score').innerHTML = message;
    }

    function handleFetchError(error, userMessage) {
        console.error("Error fetching data:", error);
        alert(userMessage);
    }

    // Fetch Functions
    async function fetchProjectDetails(projectId) {
        const url = `http://localhost:8080/instructor/getProjectDetails?projectId=${encodeURIComponent(projectId)}`;
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    }

    // Display Functions
    function displayProjectDetails(project) {
        document.getElementById('project-id').textContent = project.projectId;
        document.getElementById('project-id-title').textContent = project.projectId;
        document.getElementById('project-title').textContent = project.projectTitle;
        document.getElementById('project-description').textContent = project.projectDescription;
        document.getElementById('project-date').textContent = project.recordedOn.split("T")[0];
    }

    async function fetchAndDisplayInstructor(projectId) {
        const url = `http://localhost:8080/project/instructor?projectId=${encodeURIComponent(projectId)}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const instructorData = await response.json();

            if (Array.isArray(instructorData) && instructorData.length > 0) {
                displayInstructorDetails(instructorData[0]); // Assume only one record is needed
            } else {
                console.warn("No instructor data found for this project.");
                document.getElementById('project-advisor').textContent = "N/A";
            }
        } catch (error) {
            console.error('Error fetching instructor details:', error);
        }
    }


    function displayInstructorDetails(instructor) {
        document.getElementById('project-advisor').textContent = instructor.professorName;
    }

</script>


<!-- ------------ Show Score Criteria ----------------- -->
<script>
    // 1. เพิ่ม CSS styles
    document.addEventListener('DOMContentLoaded', function() {
        // Add CSS styling for invalid scores
        const styleElement = document.createElement('style');
        styleElement.textContent = `
    .invalid-score {
        border: 2px solid #ff0000 !important;
        background-color: rgba(255, 0, 0, 0.1) !important;
        color: #ff0000;
    }

    .invalid-score:focus {
        outline-color: #ff0000;
    }
`;
        document.head.appendChild(styleElement);

        fetchData();
    });

    // ปรับปรุง event listener
    function addInputValidation() {
        const inputs = document.querySelectorAll(".present-score-input");
        console.log(`Found ${inputs.length} inputs to validate`);

        inputs.forEach((input, index) => {
            // ลบ event listeners ที่มีอยู่เดิมทั้งหมด (clone และแทนที่)
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);

            // เพิ่ม event listener ใหม่
            newInput.addEventListener("input", function(event) {
                console.log(`Input #${index} changed: ${this.value}`);

                // ดึงค่า maxScore จาก attribute
                const maxScore = parseFloat(this.getAttribute("data-max"));
                let value = parseFloat(this.value);

                // ตรวจสอบค่าและแสดงการแจ้งเตือนเท่านั้น (ไม่เปลี่ยนค่า)
                if (value > maxScore) {
                    this.classList.add("invalid-score");
                    this.title = `Maximum score is ${maxScore}`;
                } else if (value < 0) {
                    this.classList.add("invalid-score");
                    this.title = "Score cannot be negative";
                } else if (!isNaN(value)) {
                    this.classList.remove("invalid-score");
                    this.title = "";
                }

            });
        });
    }

    function fetchData() {
        let url = 'http://localhost:8080/instructor/criteriaPoster';

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log("criteriaPoster Length: "+ data.length);
                console.log("Show Data criteriaPoster: " + JSON.stringify(data, null, 2));

                displayAppearanceCriteria(data);
                displayContentsCriteria(data);
                displayPresentationCriteria(data);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    //================================  displayAppearanceCriteria  ==========================================
    function displayAppearanceCriteria(data) {
        const table = document.getElementById("appearance-table");
        table.innerHTML = "";

        const tbody = document.createElement("tbody");

        const appearanceCriteria = data.filter(i => i.type === "Poster Presentation (Appearance)");

        appearanceCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>
                <strong>${criteria.criteriaName}</strong><br>
                <span class="subtitle">${criteria.criteriaNameTH}</span>
                <span class="max-score">Max Score ${criteria.maxScore}</span>
            </td>
            <td><input type="number" class="present-score-input" min="0" data-max="${criteria.maxScore}" data-criteria-id="${criteria.criteriaId}" /></td>
        `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody);

        // เพิ่มการตรวจสอบ input
        addInputValidation();
    }

    //================================  displayContentsCriteria  ==========================================
    function displayContentsCriteria(data) {
        const table = document.getElementById("content-table");
        table.innerHTML = "";
        const tbody = document.createElement("tbody");

        const contentsCriteria = data.filter(i => i.type === "Contents");

        contentsCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>
                <strong>${criteria.criteriaName}</strong><br>
                <span class="subtitle">${criteria.criteriaNameTH}</span>
                <span class="max-score">Max Score ${criteria.maxScore}</span>
            </td>
            <td><input type="number" class="present-score-input" min="0" data-max="${criteria.maxScore}" data-criteria-id="${criteria.criteriaId}" /></td>
        `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody);

        // เพิ่มการตรวจสอบ input
        addInputValidation();
    }

    //================================  displayPresentationCriteria  ==========================================
    function displayPresentationCriteria(data) {
        const table = document.getElementById("presentation-table");
        table.innerHTML = "";

        const tbody = document.createElement("tbody");

        const presentationCriteria = data.filter(i => i.type === "Presentation (Verbal)");

        presentationCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>
                <strong>${criteria.criteriaName}</strong><br>
                <span class="subtitle">${criteria.criteriaNameTH}</span>
                <span class="max-score">Max Score ${criteria.maxScore}</span>
            </td>
            <td><input type="number" class="present-score-input" min="0" data-max="${criteria.maxScore}" data-criteria-id="${criteria.criteriaId}" /></td>
        `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody);

        // เพิ่มการตรวจสอบ input
        addInputValidation();
    }

    document.addEventListener('DOMContentLoaded', function () {
        fetchData();
    });
</script>


<!-- -------------- Insert Score to Database -------------- -->
<script>
    // Function to check for invalid scores
    function checkForInvalidScores() {
        const invalidInputs = document.querySelectorAll('.invalid-score');
        const invalidScoreDetails = [];

        invalidInputs.forEach(input => {
            const criteriaId = input.getAttribute('data-criteria-id');
            const maxScore = input.getAttribute('data-max');
            const value = input.value;

            // Find criteria name if available
            const parentRow = input.closest('tr');
            let criteriaName = '';

            if (parentRow) {
                const nameElement = parentRow.querySelector('strong');
                if (nameElement) {
                    criteriaName = nameElement.textContent.trim();
                }
            }

            invalidScoreDetails.push({
                criteriaId: criteriaId,
                name: criteriaName || `Criteria ID: ${criteriaId}`,
                value: value,
                maxScore: maxScore
            });
        });

        return invalidScoreDetails;
    }

    document.querySelector('.save-button').addEventListener('click', function(event) {
        event.preventDefault();

        // First check for invalid scores
        const invalidScores = checkForInvalidScores();

        if (invalidScores.length > 0) {
            // Create and show invalid score alert
            const invalidScoreAlert = document.createElement('div');
            invalidScoreAlert.className = 'invalid-score-alert';
            invalidScoreAlert.style.position = 'fixed';
            invalidScoreAlert.style.top = '20px';
            invalidScoreAlert.style.left = '50%';
            invalidScoreAlert.style.transform = 'translateX(-50%)';
            invalidScoreAlert.style.backgroundColor = '#f8d7da';
            invalidScoreAlert.style.color = '#721c24';
            invalidScoreAlert.style.padding = '15px 20px';
            invalidScoreAlert.style.borderRadius = '5px';
            invalidScoreAlert.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
            invalidScoreAlert.style.zIndex = '1000';
            invalidScoreAlert.style.maxWidth = '80%';

            let alertContent = '<h3 style="margin-top:0">⚠️ Invalid Scores Detected</h3>';
            alertContent += '<p>Cannot save evaluation. Please correct the following scores:</p><ul>';

            invalidScores.forEach(item => {
                // ระบุปัญหาของคะแนน
                let problem = "";
                if (parseFloat(item.value) > parseFloat(item.maxScore)) {
                    problem = `Maximum score is (${item.maxScore})`;
                } else if (parseFloat(item.value) < 0) {
                    problem = "Score cannot be negative";
                } else {
                    problem = "Invalid-score";
                }

                alertContent += `
                <li style="margin-bottom: 10px;">
                    <div><strong>${item.name}</strong></div>
                    <div style="color: #dc3545;">Score: ${item.value}  <strong>${problem}</strong></div>
                </li>
            `;

            });

            alertContent += '</ul>';
            alertContent += '<button id="closeInvalidAlert" style="background-color:#dc3545;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;float:right">ปิด</button>';
            alertContent += '<div style="clear:both"></div>';

            invalidScoreAlert.innerHTML = alertContent;
            document.body.appendChild(invalidScoreAlert);

            // Add event listener to close button
            document.getElementById('closeInvalidAlert').addEventListener('click', function() {
                invalidScoreAlert.remove();
            });

            // Automatically remove after 10 seconds
            setTimeout(() => {
                if (document.body.contains(invalidScoreAlert)) {
                    invalidScoreAlert.remove();
                }
            }, 10000);

            return; // Stop execution and don't show the confirmation modal
        }

        document.getElementById("confirmationModal").style.display = "block";

        document.getElementById("confirmSave").addEventListener('click', function() {
            document.getElementById("confirmationModal").style.display = "none";

            console.log("Save Process");
            var projectId = getProjectIdFromURL();
            console.log("projectId: " + projectId);

            var studentScores = document.querySelectorAll('.present-score-input');
            var studentData = {};

            studentScores.forEach((input) => {
                let studentId = input.dataset.studentId;
                let scoreCriteriaId = input.getAttribute('data-criteria-id');
                let score = parseFloat(input.value) || 0;

                if (!studentData[studentId]) {
                    studentData[studentId] = [];
                }
                studentData[studentId].push({scoreCriteriaId, score});
            });

            // ดึงค่าคอมเมนต์จาก textarea
            var comment = document.getElementById("comment").value;
            console.log("Comment: ", comment);

            var instructorId = "";
            fetchInstructorId();

            function fetchInstructorId() {
                fetch(`http://localhost:8080/get-instructorId?projectId=${projectId}`)
                    .then(response => response.text())
                    .then(data => {
                        instructorId = data;
                        console.log("Instructor Id: " + instructorId);
                        sendEvaluationData();
                    })
                    .catch(error => {
                        console.error('Error fetching instructorId:', error);
                    });
            }

            function sendEvaluationData() {
                for (let studentId in studentData) {
                    let scoreDTOList = studentData[studentId];

                    console.log(studentId);
                    console.log(JSON.stringify(scoreDTOList));

                    fetch('http://localhost:8080/savePosterEvaluation?' +
                        new URLSearchParams({
                            instructorId: instructorId,
                            projectId: projectId,
                        }), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            scores: scoreDTOList,
                            comment: comment // เพิ่ม comment ส่งไปด้วย
                        })
                    })
                        .then(response => {
                            console.log(response.status)
                            if (!response.ok) {
                                return response.text().then(text => {
                                    console.error("Error response from server:", text);
                                    throw new Error(text);
                                });
                            }
                            return response;
                        })
                        .then(data => {
                            console.log(`Evaluation saved successfully:`, data);
                        })
                        .catch(error => {
                            console.error('Error saving evaluation:', error);
                        });
                }

                function showNotification(message, callback) {
                    const notification = document.createElement("div");
                    notification.textContent = message;
                    notification.style.position = "fixed";
                    notification.style.top = "20px";
                    notification.style.right = "20px";
                    notification.style.padding = "10px 20px";
                    notification.style.background = "green";
                    notification.style.color = "white";
                    notification.style.borderRadius = "5px";
                    notification.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
                    document.body.appendChild(notification);

                    // ให้ข้อความหายไปอัตโนมัติหลังจาก 3 วินาที
                    setTimeout(() => {
                        notification.remove();
                        if (callback) callback(); // เรียก callback หลังจากแจ้งเตือนเสร็จ
                    }, 1000);
                }

                // แสดงแจ้งเตือนก่อน แล้วค่อยเปลี่ยนหน้า
                showNotification("Evaluation saved successfully!", function() {
                    window.location.href = "/show-poster-projects";
                });

                // alert('Evaluation saved successfully!');
                // window.location.href = '/show-poster-projects';
            }
        });

        document.getElementById("cancelSave").addEventListener('click', function() {
            document.getElementById("confirmationModal").style.display = "none";
        });

        document.getElementById("closeModal").addEventListener('click', function() {
            document.getElementById("confirmationModal").style.display = "none";
        });
    });

</script>


<!-- -------------- Show Evaluation Score -------------- -->
<script>

    document.addEventListener("DOMContentLoaded", async function () {
        const projectId = getProjectIdFromURL();
        if (!projectId) {
            console.error('❌ No project ID found');
            return;
        }

        try {
            const instructorId = await fetchInstructorId(projectId);
            if (!instructorId) {
                console.error('❌ No instructor ID found');
                return;
            }

            console.log('📌 Loading scores for Project:', projectId, 'Instructor:', instructorId);

            // ✅ โหลดคะแนนให้เสร็จก่อน
            await loadEvaluationData(instructorId, projectId);
            console.log("✅ Scores Loaded");

            // ✅ ผูก event listener หลังจากโหลดคะแนนเสร็จ
            addScoreInputListeners();
            addInputListeners();

            // ✅ คำนวณคะแนนสูงสุด
            calculateMaxScore();

            // ✅ คำนวณคะแนนรวม และ สร้าง Card หลังจากคะแนนถูกโหลดครบ
            updateTotalScore();
            displayResultsCards();

            console.log("✅ Script Fully Loaded");
        } catch (error) {
            console.error('❌ Error in initialization:', error);
        }
    });


    // Add event listeners to score inputs
    function addScoreInputListeners() {
        const scoreInputs = document.querySelectorAll('.present-score-input');
        scoreInputs.forEach(input => {
            input.addEventListener('change', () => {
                // validateScore(input);
                updateTotalScore();
            });
        });
    }

    // Validate score input
    // function validateScore(input) {
    //     const maxScore = parseInt(input.getAttribute('data-max'));
    //     let value = parseFloat(input.value) || 0;
    //
    //     if (value < 0) value = 0;
    //     if (value > maxScore) value = maxScore;
    //
    //     input.value = value;
    // }

    // Fetch instructor ID
    async function fetchInstructorId(projectId) {
        try {
            const response = await fetch(`http://localhost:8080/get-instructorId?projectId=${projectId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const instructorId = await response.text();
            console.log('📌 Retrieved instructor ID:', instructorId);
            return instructorId;
        } catch (error) {
            console.error('❌ Error fetching instructor ID:', error);
            throw error;
        }
    }

    // Load all evaluation data
    async function loadEvaluationData(instructorId, projectId) {
        try {
            const scores = await fetchScores(instructorId, projectId);
            if (scores && scores.length > 0) {
                populateScores(scores);
            } else {
                initializeEmptyScores();
            }
        } catch (error) {
            console.warn('⚠️ Error loading evaluation data:', error);
            initializeEmptyScores();
        }
    }

    // Initialize empty scores
    function initializeEmptyScores() {
        const inputs = document.querySelectorAll('.present-score-input');
        inputs.forEach(input => {
            input.value = '0';
        });
        updateTotalScore();
    }

    // Fetch scores
    async function fetchScores(instructorId, projectId) {
        try {
            const response = await fetch(`http://localhost:8080/getPosterEvaluation?` +
                new URLSearchParams({
                    instructorId: instructorId,
                    projectId: projectId,
                }));

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const text = await response.text();
            if (!text || text.trim() === '') {
                console.log('📝 No existing scores found');
                return [];
            }

            try {
                const data = JSON.parse(text);
                // Log the raw data to inspect its structure
                console.log('Raw API response:', data);

                // ดึงข้อมูลคอมเมนต์จาก API และแสดงใน textarea
                if (data.comment) {
                    document.getElementById("comment").value = data.comment;
                    console.log(`✅ Loaded comment: ${data.comment}`);
                } else {
                    console.log('📝 No comment found');
                }

                // Handle different possible data structures
                let scores;
                if (Array.isArray(data)) {
                    scores = data;
                } else if (data.posterEvaluationScores) {
                    scores = data.posterEvaluationScores;
                } else {
                    scores = [];
                }

                console.log('✅ Processed scores:', scores);
                return scores;
            } catch (e) {
                console.warn('⚠️ Invalid JSON response:', text);
                return [];
            }
        } catch (error) {
            console.error('❌ Error fetching scores:', error);
            return [];
        }
    }

    // Populate scores
    function populateScores(scores) {
        if (!Array.isArray(scores)) {
            console.warn('⚠️ Invalid scores data');
            initializeEmptyScores();
            return;
        }

        scores.forEach(score => {
            // Log the score object to inspect its structure
            console.log('Processing score object:', score);

            // Get criteriaId from criteriaPoster object
            const criteriaId = score?.criteriaPoster?.criteriaId;
            const scoreValue = score?.score || 0;

            if (criteriaId) {
                const inputField = document.querySelector(`.present-score-input[data-criteria-id="${criteriaId}"]`);
                if (inputField) {
                    inputField.value = scoreValue;
                    console.log(`✅ Populated score ${scoreValue} for criteria ${criteriaId}`);
                } else {
                    console.warn(`⚠️ No input field found for criteria: ${criteriaId}`);
                }
            } else {
                console.warn('⚠️ No criteriaId found in score object:', score);
            }
        });

        updateTotalScore();
    }

    // Update total score
    function updateTotalScore() {
        const inputs = document.querySelectorAll('.present-score-input');
        let total = 0;

        inputs.forEach(input => {
            total += parseFloat(input.value) || 0;
        });

    }
</script>


<!-- --------------- Show Score Result ------------------ -->
<script>
    function displayResultsCards() {
        console.log("📌 Creating card result...");
        const cardContainer = document.querySelector('#card-container');
        cardContainer.innerHTML = "";

        const maxScore = calculateMaxScore().toFixed(2);
        let totalScore = calculateTotalScore().toFixed(2);

        // ป้องกัน totalScore ไม่ให้เกิน maxScore และให้ทศนิยมไม่เกิน 2 จุด
        // totalScore = Math.min(totalScore, maxScore).toFixed(2);

        console.log(`📊 Adjusted Score: ${totalScore} / ${maxScore}`);

        const card = document.createElement('div');
        card.className = 'card-score-result';
        card.dataset.type = "poster";
        card.innerHTML = `
        <h3>คะแนนรวม Poster</h3>
        <span class="score">${totalScore} / ${maxScore}</span>
    `;

        cardContainer.appendChild(card);
    }


    function addInputListeners() {
        console.log("🎯 Adding event listeners...");
        const inputs = document.querySelectorAll('.present-score-input');
        inputs.forEach(input => {
            console.log(`📌 Found input: ${input.name}, Value: ${input.value}, Max: ${input.dataset.maxScore}`);
            input.addEventListener("input", updatePosterTotalScore);
        });
    }

    function updatePosterTotalScore() {
        console.log("✏️ Input changed! Updating...");
        let totalScore = calculateTotalScore();
        const maxScore = calculateMaxScore();

        // ป้องกัน totalScore ไม่ให้เกิน maxScore
        // totalScore = Math.min(totalScore, maxScore);


        let scoreDisplay = document.querySelector('.card-score-result[data-type="poster"] .score');

        if (!scoreDisplay) {
            console.warn("⚠️ Score display not found. Creating new card...");
            displayResultsCards();
            scoreDisplay = document.querySelector('.card-score-result[data-type="poster"] .score');
        }

        if (scoreDisplay) {
            console.log(`🎯 Updating Score: ${totalScore} / ${maxScore}`);
            scoreDisplay.textContent = `${totalScore.toFixed(2)} / ${maxScore.toFixed(2)}`;
        }
    }


    function calculateTotalScore() {
        let total = 0;
        document.querySelectorAll('.present-score-input').forEach(input => {
            let value = parseFloat(input.value);
            console.log(`➕ Adding: ${value || 0}`);
            total += value || 0;
        });
        // return Math.round(total);
        return total;
    }

    function calculateMaxScore() {
        let maxScore = 0;
        document.querySelectorAll('.present-score-input').forEach(input => {
            // console.log(input);
            // Use getAttribute or dataset to access data attributes
            let max = parseFloat(input.getAttribute('data-max')) || parseFloat(input.dataset.max);
            console.log(`🛠️ Max Score Found: ${max || 0}`);
            maxScore += max || 0;
        });
        return maxScore;
    }
</script>



</html>