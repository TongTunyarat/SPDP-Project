<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Give Score Proposal Evaluation</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-instructor.css">
    <link rel="stylesheet" href="/css/GivePropEvaScore.css">

    <!-- Library -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>
        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                    </path>
                </svg>
                Homepage
            </h4>
            <li><a href="/dashboard-instructors">Dashboard</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Evaluation (40%)
            </h4>
            <li><a href="/show-proposal-eva-projects">Proposal Evaluation</a></li>
            <li><a href="/show-poster-projects">Poster Evaluation</a></li>
            <li><a href="/show-defense-eva-projects">Defense Evaluation</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Grades (60%)
            </h4>
            <li><a href="/show-proposal-grade-projects">Proposal Grade</a></li>
            <li><a href="/show-defense-grade-projects">Defense Grade</a></li>
        </ul>
    </div>

    <div class="content">

        <div class="header-section">
            <a href="/show-poster-projects" class="gray-link">Poster Evaluation (40%)</a> > <span id="project-id-title"></span>
        </div>

        <div class="body-section">

            <div class="project-details">

                <h1>Project Details</h1>

                <div class="details">
                    <div><strong>Project ID:</strong> <span id="project-id"></span></div>
                    <div><strong>Project Title:</strong> <span id="project-title"></span></div>
                    <div><strong>Project Advisor:</strong> <span id="project-advisor"></span></div>
                    <div><strong>Project Description:</strong> <span id="project-description"></span></div>
                    <div><strong>Date:</strong> <span id="project-date"></span></div>
                </div>

            </div>

            <div class="table-container">
                <h1>Student Score</h1>
                <table>

                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Quality of Work</th>
                        <th>Level of Progress</th>
                        <th>Presentation Language</th>
                        <th>Question & Answer</th>
                        <th>Result</th>
                    </tr>
                    </thead>

                    <tbody id="student-score">
                    <!-- Record Result -->

                    </tbody>
                </table>
            </div>

            <!-- A -->
            <div class="table-container">
                <h1> A. Poster Presentation [Apperance] </h1>

                <table class="evaluation-table" id="appearance-table">
                    <thead>
                    </thead>
                </table>
            </div>

            <!-- B -->
            <div class="table-container">
                <h1> B. Contents </h1>

                <table class="evaluation-table" id="content-table">
                    <thead>
                    </thead>
                </table>
            </div>

            <!-- C -->
            <div class="table-container">
                <h1> C. Presentation [Verbal] </h1>

                <table class="evaluation-table" id="presentation-table">
                    <thead>
                    </thead>
                </table>
            </div>

            <div class="table-container">
                <h1> Comment </h1>
                <label class="comment-poster">
                    <input type="text">
                </label>
            </div>


            <!-- Score Result -->
            <div class="table-container">
                <h1> Score Result </h1>

                <div id="card-container"></div>

                <button class="save-button"> Save</button>
            </div>

        </div>
    </div>
</div>


<!-- ------------ Show Project detail ----------------- -->
<script>
    window.onload = fetchData;

    function getProjectIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("projectId"); // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å ?projectId=xxxx
    }

    function fetchData() {
        // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ projectId ‡∏à‡∏≤‡∏Å URL
        const projectId = "DST SP2024-01"
        // const projectId = getProjectIdFromURL();

        if (!projectId) {
            document.getElementById('student-score').innerHTML = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• projectId";
            return;
        }

        const url = `http://localhost:8080/instructor/giveScorePosterEvaluation?projectId=${encodeURIComponent(projectId)}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log("Data received from API:", data);
                displayStudentScore(data);
                displayResultsCards(data);
                displayStudentHeader(data);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('student-score').innerHTML = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            });
    }

    // Show Project Details //
    document.addEventListener('DOMContentLoaded', function () {
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ projectId ‡∏à‡∏≤‡∏Å URL
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');

        if (projectId) {
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ projectId ‡πÉ‡∏ô URL
            fetch(`http://localhost:8080/instructor/getProjectDetails?projectId=${projectId}`)
                .then(response => response.json())
                .then(project => {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å API ‡πÉ‡∏ô HTML
                    document.getElementById('project-id').textContent = project.projectId;
                    document.getElementById('project-id-title').textContent = project.projectId;
                    document.getElementById('project-title').textContent = project.projectTitle;
                    document.getElementById('project-advisor').textContent = project.projectTitle;
                    document.getElementById('project-description').textContent = project.projectDescription;
                    document.getElementById('project-date').textContent = project.recordedOn;
                })
                .catch(error => {
                    console.error('Error fetching project details:', error);
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå');
                });
        } else {
            // alert('‡πÑ‡∏°‡πà‡∏û‡∏ö projectId ‡πÉ‡∏ô URL');
        }
    });

    // Show Student Score
    function displayStudentScore(data) {
        let tableBody = document.querySelector("tbody");
        tableBody.innerHTML = "";

        if (!Array.isArray(data)) {
            data = [data]; // ‡πÅ‡∏õ‡∏•‡∏á Object ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        }

        try {
            data.forEach(project => {
                project.students.forEach(student => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                <td style="text-align: left;">${student.studentName}</td>
                <td>${project.score}</td>
                <td>${project.score}</td>
                <td>${project.score}</td>
                <td>${project.score}</td>
                <td>${project.score * 4}</td>
            `;
                    tableBody.appendChild(row);
                });
            });
        } catch (error) {
            console.error("Error displaying data in HTML:", error);
            document.getElementById('student-score').innerHTML = "No valid data to display.";
        }
    }

    // function displayResultsCards(data) {
    //     const cardContainer = document.querySelector('#card-container');
    //     cardContainer.innerHTML = "";
    //
    //     if (!Array.isArray(data)) {
    //         data = [data]; // ‡πÅ‡∏õ‡∏•‡∏á Object ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    //     }
    //
    //     try {
    //         data.forEach(project => {
    //             project.students.forEach(student => {
    //                 const card = document.createElement('div');
    //                 card.className = 'card-score-result';
    //                 card.innerHTML = `
    //                     <span class="icon"><i class="fa fa-user"></i> ${student.studentId} ${student.studentName}</span>
    //                     <span class="score"> / 100</span>
    //                 `;
    //                 cardContainer.appendChild(card);
    //             });
    //         });
    //     } catch (error) {
    //         console.error("Error displaying data in HTML:", error);
    //         document.getElementById('student-score').innerHTML = "No valid data to display.";
    //     }
    // }

    function displayStudentHeader(data) {
        if (!Array.isArray(data)) {
            data = [data]; // ‡πÅ‡∏õ‡∏•‡∏á Object ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        }

        try {
            data.forEach(project => {
                const studentNameHeader = document.getElementById('student-name-header');

                studentNameHeader.innerHTML = '';

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° <th> ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏Å
                const emptyTh = document.createElement('th');
                emptyTh.innerHTML = '';  // ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
                studentNameHeader.appendChild(emptyTh);

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° <th> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
                project.students.forEach(student => {
                    const studentTh = document.createElement('th');
                    studentTh.innerHTML = `${student.studentId} ${student.studentName}`;
                    studentNameHeader.appendChild(studentTh);
                });

                // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡∏Å Header ‡∏ô‡∏∂‡∏á
                const studentNameHeader2 = document.getElementById('student-name-header-2');
                if (studentNameHeader2) {
                    studentNameHeader2.innerHTML = '';
                    studentNameHeader2.appendChild(emptyTh.cloneNode(true)); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á

                    project.students.forEach(student => {
                        const studentTh2 = document.createElement('th');
                        studentTh2.innerHTML = `${student.studentId} ${student.studentName}`;
                        studentNameHeader2.appendChild(studentTh2);  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
                    });
                }
            });
        } catch (error) {
            console.error("Error displaying data: ", error);
        }
    }
</script>


<!-- ------------ Show Score Criteria ----------------- -->
<script>
    function fetchData() {
        let url = 'http://localhost:8080/instructor/criteriaPoster';

        fetch(url)
            .then(response => {
                // console.log(response.json());
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log("criteriaPoster Length: "+ data.length);
                console.log("Show Data criteriaPoster: " + JSON.stringify(data, null, 2));

                displayAppearanceCriteria(data)
                displayContentsCriteria(data)
                displayPresentationCriteria(data)
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        fetchData();
    });

    //================================  displayAppearanceCriteria  ==========================================
    function displayAppearanceCriteria(data) {
        const table = document.getElementById("appearance-table");
        table.innerHTML = "";

        const tbody = document.createElement("tbody");

        const appearanceCriteria = data.filter(i => i.type === "Poster Presentation (Appearance)");

        appearanceCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>
                    <strong>${criteria.criteriaName}</strong><br>
                    <span class="subtitle">${criteria.criteriaNameTH}</span>
                    <span class="max-score">Max Score ${criteria.maxScore}</span>
                </td>
                <td><input type="number" class="present-score-input" min="0" max="${criteria.maxScore}" data-criteria-id="${criteria.criteriaId}" /></td>
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody)
    }

    //================================  displayContentsCriteria  ==========================================
    function displayContentsCriteria(data) {
        const table = document.getElementById("content-table");
        table.innerHTML = "";
        const tbody = document.createElement("tbody");

        const appearanceCriteria = data.filter(i => i.type === "Contents");

        appearanceCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>
                    <strong>${criteria.criteriaName}</strong><br>
                    <span class="subtitle">${criteria.criteriaNameTH}</span>
                    <span class="max-score">Max Score ${criteria.maxScore}</span>
                </td>
                <td><input type="number" class="present-score-input" min="0" max="${criteria.maxScore}" data-criteria-id="${criteria.criteriaId}" /></td>
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody)
    }

    //================================  displayPresentationCriteria  ==========================================
    function displayPresentationCriteria(data) {
        const table = document.getElementById("presentation-table");
        table.innerHTML = "";

        const tbody = document.createElement("tbody");

        const appearanceCriteria = data.filter(i => i.type === "Presentation (Verbal)");

        appearanceCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>
                    <strong>${criteria.criteriaName}</strong><br>
                    <span class="subtitle">${criteria.criteriaNameTH}</span>
                    <span class="max-score">Max Score ${criteria.maxScore}</span>
                </td>
                <td><input type="number" class="present-score-input" min="0" max="${criteria.maxScore}" data-criteria-id="${criteria.criteriaId}" /></td>
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody)
    }
</script>


<!-- -------------- Insert Score to Database -------------- -->
<script>
    document.querySelector('.save-button').addEventListener('click', function(event) {
        console.log("Save Process");
        event.preventDefault();

        // ===== projectId ===== //
        var projectId = getProjectIdFromURL();
        console.log("projectId: " + projectId);

        // ===== student score ===== //
        var studentScores = document.querySelectorAll('.present-score-input'); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å input ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (scores)

        var studentData = {};

        studentScores.forEach((input) => {
            let studentId = input.dataset.studentId; // ‡∏î‡∏∂‡∏á studentId
            let scoreCriteriaId = input.getAttribute('data-criteria-id'); // ‡∏î‡∏∂‡∏á criteria ID ‡∏à‡∏≤‡∏Å data-attribute
            let score = parseFloat(input.value) || 0;

            if (!studentData[studentId]) {
                studentData[studentId] = [];
            }
            studentData[studentId].push({scoreCriteriaId, score});
        });

        console.log(studentData);

        // ===== instructorId ===== //
        var instructorId = "";
        fetchInstructorId();

        function fetchInstructorId() {
            fetch(`http://localhost:8080/get-instructorId?projectId=${projectId}`)
                .then(response => response.text())
                .then(data => {
                    instructorId = data;
                    console.log("Instructor Id: " + instructorId);
                    sendEvaluationData();  // Call the function to send data after instructorId is fetched
                })
                .catch(error => console.error('Error fetching instructorId:', error));
        }

        function sendEvaluationData() {
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà /saveEvaluation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ student
            for (let studentId in studentData) {
                let scoreDTOList = studentData[studentId];

                console.log(studentId);
                console.log(JSON.stringify(scoreDTOList));

                fetch('http://localhost:8080/savePosterEvaluation?' +
                    new URLSearchParams({
                        instructorId: instructorId,
                        projectId: projectId,
                    }), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(scoreDTOList)
                })
                    .then(response => {
                        console.log(response.status)
                        if (!response.ok) {
                            return response.text().then(text => {
                                console.error("Error response from server:", text);
                                throw new Error(text);
                            });
                        }
                        return response;
                    })
                    .then(data => {
                        console.log(`Evaluation saved successfully:`, data);
                    })
                    .catch(error => {
                        console.error('Error saving evaluation:', error);
                    });
            }
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° alert ‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            alert('Evaluation saved successfully!');

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô path ‡πÑ‡∏õ‡∏ó‡∏µ‡πà /show-proposal-eva-projects
            window.location.href = '/show-poster-projects';
        }
    });
</script>


<!-- -------------- Show Evaluation Score -------------- -->
<script>
    // Load evaluation data when page loads
    document.addEventListener("DOMContentLoaded", async function() {
        const projectId = getProjectIdFromURL();
        if (!projectId) {
            console.error('‚ùå No project ID found');
            return;
        }

        try {
            const instructorId = await fetchInstructorId(projectId);
            if (!instructorId) {
                console.error('‚ùå No instructor ID found');
                return;
            }

            console.log('üìå Loading scores for Project:', projectId, 'Instructor:', instructorId);
            await loadEvaluationData(instructorId, projectId);

            // Add event listeners to all score inputs
            addScoreInputListeners();
        } catch (error) {
            console.error('‚ùå Error in initialization:', error);
        }
    });

    // Add event listeners to score inputs
    function addScoreInputListeners() {
        const scoreInputs = document.querySelectorAll('.present-score-input');
        scoreInputs.forEach(input => {
            input.addEventListener('change', () => {
                validateScore(input);
                updateTotalScore();
            });
        });
    }

    // Validate score input
    function validateScore(input) {
        const maxScore = parseInt(input.getAttribute('max'));
        let value = parseFloat(input.value) || 0;

        if (value < 0) value = 0;
        if (value > maxScore) value = maxScore;

        input.value = value;
    }

    // Fetch instructor ID
    async function fetchInstructorId(projectId) {
        try {
            const response = await fetch(`http://localhost:8080/get-instructorId?projectId=${projectId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const instructorId = await response.text();
            console.log('üìå Retrieved instructor ID:', instructorId);
            return instructorId;
        } catch (error) {
            console.error('‚ùå Error fetching instructor ID:', error);
            throw error;
        }
    }

    // Load all evaluation data
    async function loadEvaluationData(instructorId, projectId) {
        try {
            const scores = await fetchScores(instructorId, projectId);
            if (scores && scores.length > 0) {
                populateScores(scores);
            } else {
                initializeEmptyScores();
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Error loading evaluation data:', error);
            initializeEmptyScores();
        }
    }

    // Initialize empty scores
    function initializeEmptyScores() {
        const inputs = document.querySelectorAll('.present-score-input');
        inputs.forEach(input => {
            input.value = '0';
        });
        updateTotalScore();
    }

    // Fetch scores
    async function fetchScores(instructorId, projectId) {
        try {
            const response = await fetch(`http://localhost:8080/getPosterEvaluation?` +
                new URLSearchParams({
                    instructorId: instructorId,
                    projectId: projectId,
                }));

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const text = await response.text();
            if (!text || text.trim() === '') {
                console.log('üìù No existing scores found');
                return [];
            }

            try {
                const data = JSON.parse(text);
                // Log the raw data to inspect its structure
                console.log('Raw API response:', data);

                // Handle different possible data structures
                let scores;
                if (Array.isArray(data)) {
                    scores = data;
                } else if (data.posterEvaluationScores) {
                    scores = data.posterEvaluationScores;
                } else {
                    scores = [];
                }

                console.log('‚úÖ Processed scores:', scores);
                return scores;
            } catch (e) {
                console.warn('‚ö†Ô∏è Invalid JSON response:', text);
                return [];
            }
        } catch (error) {
            console.error('‚ùå Error fetching scores:', error);
            return [];
        }
    }

    // Populate scores
    function populateScores(scores) {
        if (!Array.isArray(scores)) {
            console.warn('‚ö†Ô∏è Invalid scores data');
            initializeEmptyScores();
            return;
        }

        scores.forEach(score => {
            // Log the score object to inspect its structure
            console.log('Processing score object:', score);

            // Get criteriaId from criteriaPoster object
            const criteriaId = score?.criteriaPoster?.criteriaId;
            const scoreValue = score?.score || 0;

            if (criteriaId) {
                const inputField = document.querySelector(`.present-score-input[data-criteria-id="${criteriaId}"]`);
                if (inputField) {
                    inputField.value = scoreValue;
                    console.log(`‚úÖ Populated score ${scoreValue} for criteria ${criteriaId}`);
                } else {
                    console.warn(`‚ö†Ô∏è No input field found for criteria: ${criteriaId}`);
                }
            } else {
                console.warn('‚ö†Ô∏è No criteriaId found in score object:', score);
            }
        });

        updateTotalScore();
    }

    // Update total score
    function updateTotalScore() {
        const inputs = document.querySelectorAll('.present-score-input');
        let total = 0;

        inputs.forEach(input => {
            total += parseFloat(input.value) || 0;
        });

        const scoreDisplays = document.querySelectorAll('.card-score-result.score');
        scoreDisplays.forEach(display => {
            display.textContent = `${total.toFixed(2)} / 100`;
        });
    }
</script>


<!-- --------------- Show Score Result ------------------ -->
<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const data = await fetchStudentScore();
        if (data) { // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å display
            displayResultsCards(data);
        } else {
            console.warn("‚ö†Ô∏è No data returned from fetchStudentScore().");
        }
    });


    function displayResultsCards(data) {
        const cardContainer = document.querySelector('#card-container');
        cardContainer.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô

        if (!data || data.rawTotalScore === undefined) {
            console.error("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:", data);
            cardContainer.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Poster</p>";
            return;
        }

        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á N/A)
        const score = data.rawTotalScore !== undefined ? data.rawTotalScore : "N/A";

        const card = document.createElement('div');
        card.className = 'card-score-result';
        card.innerHTML = `
        <h3>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° Poster</h3>
        <span class="score">${score} / 40</span>
    `;

        cardContainer.appendChild(card);
    }

    async function fetchStudentScore() {
        try {
            console.log("üìå Fetching student score...");

            const projectId = getProjectIdFromURL();
            const instructorId = await fetchInstructorId(projectId);

            const response = await fetch(`http://localhost:8080/scoreTotalPoster?instructorId=${instructorId}&projectId=${projectId}`);

            if (!response.ok) {
                console.error(`‚ùå HTTP Error: ${response.status}`);
                return null; // ‚ùó ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô return null
            }

            const text = await response.text();
            console.log("üìå Raw API Response:", text);

            try {
                const data = JSON.parse(text);
                console.log("‚úÖ Student Score Data:", data);

                if (!data.rawTotalScore) {
                    console.warn("‚ö†Ô∏è API response is missing score data.");
                    return null; // ‚ùó ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô return null
                }

                return data; // ‚úÖ Return ‡∏Ñ‡πà‡∏≤ data ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            } catch (jsonError) {
                console.error("‚ö†Ô∏è JSON Parse Error:", jsonError);
                return null;
            }

        } catch (error) {
            console.error("‚ùå Error fetching student score:", error);
            return null;
        }
    }
</script>

</html>