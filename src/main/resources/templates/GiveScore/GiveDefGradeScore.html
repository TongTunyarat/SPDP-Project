<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Senior Project 2</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-instructor.css">
    <link rel="stylesheet" href="/css/GiveGradeScore.css">

    <!-- Library -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<div class="container">
    <!-- script ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î period -->
    <script>
        let accessPeriods = {};

        console.log('Calling updateLinkStatus function');
        // window.onload = fetchAccessPeriods;
        document.addEventListener('DOMContentLoaded', function () {
            fetchAccessPeriods();
        });
        setInterval(updateLinkStatus, 60000);

        async function fetchAccessPeriods() {
            try {
                const response = await fetch('http://localhost:8080/api/period'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ï‡∏≤‡∏° backend ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                if (!response.ok) {
                    throw new Error('Failed to fetch access periods');
                }

                const data = await response.json(); // ‡πÅ‡∏õ‡∏•‡∏á response ‡πÄ‡∏õ‡πá‡∏ô JSON
                console.log(data);

                accessPeriods = convertApiResponseToObject(data); // ‡πÅ‡∏õ‡∏•‡∏á array ‡∏à‡∏≤‡∏Å API ‡πÄ‡∏õ‡πá‡∏ô object ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
                console.log("before set date: ", accessPeriods)
                updateLinkStatus(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå
            } catch (error) {
                console.error('Error fetching access periods:', error);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á API Response (Array) ‡πÄ‡∏õ‡πá‡∏ô Object ‡∏ï‡∏≤‡∏° key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô HTML
        function convertApiResponseToObject(data) {
            console.log("üéûÔ∏èConvert api");
            console.log(data);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ data ‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠ undefined
            if (!Array.isArray(data) || data.length === 0) {
                console.log("üí°No data to process");
                return {}; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô array ‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô object ‡∏ß‡πà‡∏≤‡∏á‡πÜ
            }

            // 1Ô∏è‚É£ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á Evaluation ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
            const allTypes = {
                "proposalEvaluation": "/show-proposal-eva-projects",
                "posterEvaluation": "/show-poster-projects",
                "defenseEvaluation": "/show-defense-eva-projects",
                "proposalGrade": "/show-proposal-grade-projects",
                "defenseGrade": "/show-defense-grade-projects"
            };

            let periodsObj = {};

            // 2Ô∏è‚É£ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (isActive = false)
            Object.keys(allTypes).forEach(type => {
                periodsObj[type] = {
                    start: null, // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô null
                    end: null,
                    isActive: false, // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                    path: allTypes[type],
                    title: type
                };
            });

            // 3Ô∏è‚É£ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
            data.forEach((period, index) => {
                console.log(`üí°Processing item at index: ${index}`);

                let evaluationTypeKey;

                // ‡πÉ‡∏ä‡πâ switch-case ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á evaluationType ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ô allTypes
                switch (period.evaluationType) {
                    case "Proposal Evaluation":
                        evaluationTypeKey = "proposalEvaluation";
                        break;
                    case "Poster Evaluation":
                        evaluationTypeKey = "posterEvaluation";
                        break;
                    case "Defense Evaluation":
                        evaluationTypeKey = "defenseEvaluation";
                        break;
                    case "Proposal Grade":
                        evaluationTypeKey = "proposalGrade";
                        break;
                    case "Defense Grade":
                        evaluationTypeKey = "defenseGrade";
                        break;
                    default:
                        console.log(`üí°No matching key for evaluation type: ${period.evaluationType}`);
                        return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö case ‡πÉ‡∏î‡πÜ ‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
                }

                console.log("üí°Evaluation type key:", evaluationTypeKey);

                if (periodsObj.hasOwnProperty(evaluationTypeKey)) {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô string ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô null
                    const startDate = Date.parse(period.startDate); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô timestamp
                    const endDate = Date.parse(period.endDate); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô timestamp

                    periodsObj[evaluationTypeKey] = {
                        start: isNaN(startDate) ? null : new Date(startDate), // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô null
                        end: isNaN(endDate) ? null : new Date(endDate), // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô null
                        isActive: true, // ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API -> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        path: allTypes[evaluationTypeKey],
                        title: period.evaluationType
                    };
                }
            });

            console.log("üéûÔ∏èFinal periodsObj: ", periodsObj); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            return periodsObj;
        }

        function updateLinkStatus() {
            const currentTime = new Date(); // Get current time
            console.log("Current Time: ", currentTime); // Debugging line
            console.log("accessPeriods: ", accessPeriods)

            // Get all links with data-period
            const links = document.querySelectorAll('a[data-period]');
            console.log("links:", links); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

            links.forEach(link => {
                const periodKey = link.getAttribute('data-period');
                const period = accessPeriods[periodKey];
                console.log("periodKey:", periodKey); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ periodKey ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                console.log("period: ", period)

                if (period) {
                    const startTime = period.start ? new Date(period.start) : null;
                    const endTime = period.end ? new Date(period.end) : null;

                    console.log(`Checking link ${periodKey}:`, currentTime, startTime, endTime); // Debugging

                    const isAccessible =
                        period.isActive &&
                        (startTime === null || currentTime >= startTime) &&
                        (endTime === null || currentTime <= endTime);

                    console.log(`Is Accessible: ${isAccessible}`);


                    if (!isAccessible) {
                        link.classList.add('disabled-link'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå
                        console.log('Disabled link added:', link);

                        link.addEventListener('click', function (e) {
                            e.preventDefault();

                            let alertMessage = "üö´ This link is not accessible right now.";

                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ startTime ‡∏´‡∏£‡∏∑‡∏≠ endTime ‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                            if (startTime && endTime) {
                                alertMessage += ` Available from ${startTime.toLocaleDateString()} to ${endTime.toLocaleDateString()}`;
                            }

                            console.warn(alertMessage); // ‡πÅ‡∏™‡∏î‡∏á warning ‡πÉ‡∏ô console
                            alert(alertMessage); // ‡πÅ‡∏™‡∏î‡∏á alert ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                        });
                    } else {
                        link.classList.remove('disabled-link');

                        // ‡∏•‡∏ö event listener ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ alert ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô accessible
                        link.replaceWith(link.cloneNode(true));
                    }
                }
            });
        }
    </script>


    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>
        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                    </path>
                </svg>
                Homepage
            </h4>
            <li><a href="/instructor/view">Dashboard</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Evaluation (40%)
            </h4>
            <li><a href="/show-proposal-eva-projects" data-period="proposalEvaluation">Proposal Evaluation</a></li>
            <li><a href="/show-poster-projects" data-period="posterEvaluation">Poster Evaluation</a></li>
            <li><a href="/show-defense-eva-projects" data-period="defenseEvaluation">Defense Evaluation</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Grades (60%)
            </h4>
            <li><a href="/show-proposal-grade-projects" data-period="proposalGrade">Senior Project 1</a></li>
            <li><a href="/show-defense-grade-projects" data-period="defenseGrade" class="active">Senior Project 2</a>
            </li>
        </ul>
    </div>

    <div class="content">

        <div class="header-section">
            <a href="/show-defense-grade-projects" class="gray-link">Defense Grade (60%)</a> > <span
                id="project-id-title"></span>
        </div>

        <div class="body-section">

            <!-- Project Details-->
            <div class="project-details">

                <h1>Project Details</h1>

                <div id="project-details">
                    <div><strong>Project ID:</strong> <span id="project-id"></span>
                        <input type="hidden" id="projectIdInput" th:value="${projectId}">
                    </div>
                    <div><strong>Project Title:</strong> <span id="project-title"></span></div>
                    <div><strong>Project Advisor:</strong> <span id="project-advisor"></span></div>
                    <div><strong>Project Description:</strong> <span id="project-description"></span></div>
                    <div><strong>Date:</strong> <span id="project-date"></span></div>
                </div>

            </div>

            <!-- Score Prop -->
            <div class="table-container">
                <div class="header-container">
                    <h1>Defense Evaluation (40%) </h1>
                    <button id="preview-button"
                            style="margin-left: auto; display: block; float: right; margin-top: 10px;">Preview
                    </button>
                </div>

                <table class="evaluation-table">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Presentation (20%)</th>
                        <th>Document (10%)</th>
                        <th>Poster (10%)</th>
                        <th>Result (40%)</th>
                    </tr>
                    </thead>
                    <tbody id="student-score">
                    <!-- Record Result -->
                    </tbody>
                </table>
            </div>

            <!-- Grading -->
            <div class="table-container">
                <h1> Grading (60%)</h1>

                <table class="evaluation-table" id="grade-evaluation-table">
                </table>

            </div>

            <!-- Extra Score -->
            <div class="table-container">
                <h1> Extra Score (10%)</h1>

                <table class="evaluation-table" id="grade-extra-score-table">
                </table>

            </div>

            <!-- Score Result -->
            <div class="table-container">
                <h1> Score Result </h1>

                <div id="card-container"></div>

                <button class="save-button"> Save</button>
            </div>

            <!-- Modal -->
            <div id="confirmationModal" class="modal">
                <div class="modal-content">
                    <span class="close-button" id="closeModal">&times;</span>
                    <h3>Are you sure you want to save the scores?</h3>
                    <div>
                        <button id="confirmSave" class="confirm-button">Yes, Save</button>
                        <button id="cancelSave" class="cancel-button">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<style>
    .zero-score-warning {
        background-color: #ffebee;
        padding: 10px 15px;
        border-radius: 4px;
        margin: 10px 0;
        border-left: 4px solid #e74c3c;
    }

    .zero-score-warning ul {
        margin: 5px 0;
        padding-left: 20px;
    }

    .zero-score-warning li {
        margin-bottom: 3px;
    }
</style>


<script>
    window.onload = function () {
        const projectId = getProjectIdFromURL();

        if (!projectId) {
            displayError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• projectId");
            return;
        }

        fetchProjectDetails(projectId)
            .then(displayProjectDetails)
            .catch(error => handleFetchError(error, '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå'));


        fetchAndDisplayInstructor(projectId)
        fetchAndDisplayScores(projectId);
        // fetchAndDisplayCardResultScores(projectId);

    };

    // Utility Functions
    function getProjectIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("projectId");
    }

    function displayError(message) {
        document.getElementById('student-score').innerHTML = message;
    }

    function handleFetchError(error, userMessage) {
        console.error("Error fetching data:", error);
        alert(userMessage);
    }

    // Fetch Functions
    async function fetchProjectDetails(projectId) {
        const url = `http://localhost:8080/instructor/getProjectDetails?projectId=${encodeURIComponent(projectId)}`;
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    }


    // Display Functions
    function displayProjectDetails(project) {
        document.getElementById('project-id').textContent = project.projectId;
        document.getElementById('project-id-title').textContent = project.projectId;
        document.getElementById('project-title').textContent = project.projectTitle;
        document.getElementById('project-description').textContent = project.projectDescription;
        document.getElementById('project-date').textContent = project.recordedOn.split("T")[0];
    }


    function displayInstructorDetails(instructor) {
        document.getElementById('project-advisor').textContent = instructor.professorName;
    }

    async function fetchAndDisplayInstructor(projectId) {
        const url = `http://localhost:8080/project/instructor?projectId=${encodeURIComponent(projectId)}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const instructorData = await response.json();

            if (Array.isArray(instructorData) && instructorData.length > 0) {
                displayInstructorDetails(instructorData[0]); // Assume only one record is needed
            } else {
                console.warn("No instructor data found for this project.");
                document.getElementById('project-advisor').textContent = "N/A";
            }
        } catch (error) {
            console.error('Error fetching instructor details:', error);
        }
    }

    async function fetchAndDisplayScores(projectId) {
        // const url1 = `http://localhost:8080/instructor/showGradeScoreDefense?projectId=${encodeURIComponent(projectId)}`;
        const url1 = `http://localhost:8080/instructor/showScoreDefense?projectId=${encodeURIComponent(projectId)}`;
        const url2 = `http://localhost:8080/instructor/showScorePoster?projectId=${encodeURIComponent(projectId)}`;
        const tableBody = document.getElementById('student-score');
        tableBody.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô

        try {
            // Fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
            const [response1, response2] = await Promise.all([fetch(url1), fetch(url2)]);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ API ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            if (!response1.ok || !response2.ok) {
                throw new Error(`HTTP error! status: ${response1.status} or ${response2.status}`);
            }

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á API
            const scoreData = await response1.json();
            const additionalData = await response2.json();

            // üîç **‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ scoreData ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏ï‡πà null**
            const hasValidScores = scoreData.some(score => score.score !== null);

            if (!scoreData || scoreData.length === 0 || !hasValidScores) {
                // üõë ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‚Üí ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                tableBody.innerHTML = "";
                await fetchStudentNamesOnly(projectId, tableBody);
            } else {
                // ‚úÖ ‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏Å‡∏ï‡∏¥
                tableBody.innerHTML = "";
                console.log("üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (scoreData):", scoreData);
                console.log("üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (additionalData):", additionalData);

                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà displayScoreData ‡∏´‡∏£‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                displayScoreData(scoreData, additionalData, tableBody);
            }
        } catch (error) {
            console.error('Error fetching or displaying score proposal:', error);
        }
    }


    // üîµ Fetch ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Backend (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
    async function fetchStudentNamesOnly(projectId, tableBody) {
        const url = `http://localhost:8080/instructor/showStudentDetails?projectId=${encodeURIComponent(projectId)}`;

        try {
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            tableBody.innerHTML = "";

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const studentList = await response.json();

            if (studentList.length === 0) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                <td colspan="4" style="text-align: center; color: red;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td>
            `;
                tableBody.appendChild(noDataRow);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                studentList.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${student.studentName}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                `;
                    tableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error('Error fetching student list:', error);
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
            const errorRow = document.createElement('tr');
            errorRow.innerHTML = `
            <td colspan="4" style="text-align: center; color: red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ</td>
        `;
            tableBody.appendChild(errorRow);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô professorId ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ criteriaId
    function getProfessorCount(scoreData) {
        const professorMap = new Map();

        scoreData.forEach(score => {
            const key = score.criteriaId;
            const professorId = score.professorId;

            if (!professorMap.has(key)) {
                professorMap.set(key, new Set());
            }

            professorMap.get(key).add(professorId);
        });

        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô professors ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ criteriaId
        const professorCount = {};
        professorMap.forEach((professorSet, criteriaId) => {
            professorCount[criteriaId] = professorSet.size;
        });

        return professorCount;
    }

    // üîµ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
    async function displayScoreData(scoreData, posterData, tableBody, projectId) {
        const studentScoresMap = {};

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° studentId
        scoreData.forEach(score => {
            const studentId = score.studentId;
            const studentName = score.studentName;

            // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô studentScoresMap ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
            if (!studentScoresMap[studentId]) {
                studentScoresMap[studentId] = {
                    studentName: studentName,
                    presentationScores: {
                        qualityOfWorkScores: [],
                        levelOfProgressScores: [],
                        presentationLanguagesScores: [],
                        questionAndAnswerScores: []
                    },
                    documentScores: {
                        completenessScores: [],
                        timelinessScores: []
                    },
                    posterScores: {
                        appearance: [],
                        contents: [],
                        verbal: []
                    },
                    totalPresentationScore: 0,
                    totalDocumentScore: 0,
                    totalPosterScore: 0,
                    resultScore: 0
                };
            }

            const scoreValue = score.score;

            // // Group and store scores for each CriteriaName under Presentation
            // if (["Quality of Work", "Level of Progress", "Presentation Language", "Question & Answer"].includes(score.criteriaName)) {
            //     studentScoresMap[studentId].presentationScores[score.criteriaName].push(scoreValue);
            // }

            if (score.criteriaName === "Quality of Work") {
                studentScoresMap[studentId].presentationScores.qualityOfWorkScores.push(scoreValue);
            } else if (score.criteriaName === "Level of Progress") {
                studentScoresMap[studentId].presentationScores.levelOfProgressScores.push(scoreValue);
            } else if (score.criteriaName === "Presentation Language") {
                studentScoresMap[studentId].presentationScores.presentationLanguagesScores.push(scoreValue);
            } else if (score.criteriaName === "Question & Answer") {
                studentScoresMap[studentId].presentationScores.questionAndAnswerScores.push(scoreValue);
            }

            // Group and store scores for Document (Completeness, Timeliness)
            if (score.criteriaName === "Completeness") {
                studentScoresMap[studentId].documentScores.completenessScores.push(scoreValue);
            } else if (score.criteriaName === "Timeliness") {
                studentScoresMap[studentId].documentScores.timelinessScores.push(scoreValue);
            }
        });

        // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°
        for (const studentId in studentScoresMap) {
            const studentData = studentScoresMap[studentId];
            const {studentName, presentationScores, documentScores} = studentData;

            // // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Presentation
            // let totalPresentationScore = 0;

            // for (const criteriaName in presentationScores) {
            //     const sumScore = presentationScores[criteriaName];
            //
            //     // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô professorId ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö criteria ‡∏ô‡∏µ‡πâ
            //     const professorIds = [...new Set(scoreData
            //         .filter(s => s.criteriaName === criteriaName && s.studentId === studentId)
            //         .map(s => s.professorId))];  // ‡πÉ‡∏ä‡πâ Set ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ professorId ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
            //
            //     const numProfessors = professorIds.length > 0 ? professorIds.length : 1;  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• professor ‡∏Å‡πá‡πÉ‡∏ä‡πâ 1 ‡πÅ‡∏ó‡∏ô
            //
            //     // ‡∏î‡∏∂‡∏á maxScore ‡πÅ‡∏•‡∏∞ weight
            //     const score = scoreData.find(s => s.studentId === studentId && s.criteriaName === criteriaName); // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ criteria
            //     const maxScore = score ? parseFloat(score.maxScore) : 10.0;  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ maxScore ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            //     const weight = score ? parseFloat(score.criteriaWeight) : 0.0;  // ‡∏Ñ‡∏π‡∏ì‡∏î‡πâ‡∏ß‡∏¢ 100 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default 100
            //
            //     // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì weightedScore ‡∏ï‡∏≤‡∏°‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
            //     const weightedScore = ((sumScore / numProfessors) / maxScore) * (weight * 100);
            //     totalPresentationScore += weightedScore;
            // }
            //
            // studentData.totalPresentationScore = totalPresentationScore;

            let rawPresentationScore = 0;

            if (presentationScores.qualityOfWorkScores.length > 0) {
                const sumQualityOfWorkScore = presentationScores.qualityOfWorkScores.reduce((sum, score) => sum + score, 0);
                const numQualityofWorkEntries= presentationScores.qualityOfWorkScores.length;
                const maxScoreQOW = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Quality of Work")?.maxScore || 10.0;
                const weightScoreQOW = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Quality of Work")?.criteriaWeight || 0.05;

                const qualityOfWorkScore =  ((sumQualityOfWorkScore / numQualityofWorkEntries) / maxScoreQOW) * (weightScoreQOW * 100);
                rawPresentationScore += qualityOfWorkScore;
            }

            if (presentationScores.levelOfProgressScores.length > 0) {
                const sumlevelProgressScore = presentationScores.levelOfProgressScores.reduce((sum, score) => sum + score, 0);
                const numlevelProgressEntries= presentationScores.levelOfProgressScores.length;
                const maxScoreLOP = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Level of Progress")?.maxScore || 10.0;
                const weightScoreLOP = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Level of Progress")?.criteriaWeight || 0.05;

                const levelOfProgressScore =  ((sumlevelProgressScore / numlevelProgressEntries) / maxScoreLOP) * (weightScoreLOP * 100);
                rawPresentationScore += levelOfProgressScore;
            }

            if (presentationScores.presentationLanguagesScores.length > 0) {
                const sumpresentLanguageScore = presentationScores.presentationLanguagesScores.reduce((sum, score) => sum + score, 0);
                const numpresentLanguageEntries= presentationScores.presentationLanguagesScores.length;
                const maxScorePL= scoreData.find(s => s.studentId === studentId && s.criteriaName === "Presentation Language")?.maxScore || 10.0;
                const weightScorePL= scoreData.find(s => s.studentId === studentId && s.criteriaName === "Presentation Language")?.criteriaWeight || 0.05;

                const presentationLanguageScore =  ((sumpresentLanguageScore / numpresentLanguageEntries) / maxScorePL) * (weightScorePL * 100);
                rawPresentationScore += presentationLanguageScore;
            }


            if (presentationScores.questionAndAnswerScores.length > 0) {
                const sumQuestionAnswerScore = presentationScores.questionAndAnswerScores.reduce((sum, score) => sum + score, 0);
                const numQuestionAnswerEntries= presentationScores.questionAndAnswerScores.length;
                const maxScoreQAW = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Question & Answer")?.maxScore || 10.0;
                const weightScoreQAW = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Question & Answer")?.criteriaWeight || 0.05;

                const questionAndAnswerScore =  ((sumQuestionAnswerScore / numQuestionAnswerEntries) / maxScoreQAW) * (weightScoreQAW * 100);
                rawPresentationScore += questionAndAnswerScore;
            }

            studentData.totalPresentationScore = rawPresentationScore;

            // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Presentation ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20%
            rawPresentationScore = Math.min(rawPresentationScore, 20.0);
            const totalPresentationScores = rawPresentationScore > 0 ? rawPresentationScore.toFixed(2) : "0";  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô "-" ‡πÄ‡∏õ‡πá‡∏ô "0"


            // **‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Document**
            let rawDocumentScore = 0;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Completeness (Document)
            if (documentScores.completenessScores.length > 0) {
                const completenessAvg = documentScores.completenessScores.reduce((sum, score) => sum + score, 0);
                const completenessEntries = documentScores.completenessScores.length;
                const completenessMaxScore = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Completeness")?.maxScore || 10.0;
                const qualityWeight = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Completeness")?.criteriaWeight || 0.07;

                const completenessScore = ((completenessAvg / completenessEntries) / completenessMaxScore) * (qualityWeight * 100);
                rawDocumentScore += completenessScore;
                console.log("CompletenessScore " + completenessScore);
            }

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Timeliness (Document)
            if (documentScores.timelinessScores.length > 0) {
                const timelinessAvg = documentScores.timelinessScores.reduce((sum, score) => sum + score, 0);
                const timelinessEntries = documentScores.timelinessScores.length;
                const timelinessMaxScore = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Timeliness")?.maxScore || 10.0;
                const timelinessWeight = scoreData.find(s => s.studentId === studentId && s.criteriaName === "Timeliness")?.criteriaWeight || 0.03;

                const timelinessScore = ((timelinessAvg / timelinessEntries) / timelinessMaxScore) * (timelinessWeight * 100);
                rawDocumentScore += timelinessScore;
                console.log("TimelinessScore " + timelinessScore);
            }

            studentData.totalDocumentScore = rawDocumentScore;

            // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Document ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10%
            rawDocumentScore = Math.min(rawDocumentScore, 10.0);
            const totalDocumentScore = rawDocumentScore > 0 ? rawDocumentScore.toFixed(2) : "0";  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô "-" ‡πÄ‡∏õ‡πá‡∏ô "0"

            // **‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Poster**
            let totalPosterScore = 0;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Poster ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ï‡πà‡∏≤‡∏á ‡πÜ
            const posterCategories = {appearance: [], contents: [], verbal: []};

            posterData.forEach(score => {
                if (score.criteriaName === "Poster is well organized, readable, easy to follow and has a logical, clear progression of ideas, methods, and") {
                    posterCategories.appearance.push(score.score);
                } else if (["English usage", "Problem statements and objectives are stated clearly", "Research methodology or development framework are stated clearly", "Level of difficulty (technical value)", "Level of progress is suitable with the timeline given"].includes(score.criteriaName)) {
                    posterCategories.contents.push(score.score);
                } else if (["Presenters speak clearly and effectively", "Presenters respond to questions effectively"].includes(score.criteriaName)) {
                    posterCategories.verbal.push(score.score);
                }
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
            const appearanceAvg = calculateCategoryAvg(posterCategories.appearance);
            const contentsAvg = calculateCategoryAvg(posterCategories.contents);
            const verbalAvg = calculateCategoryAvg(posterCategories.verbal);

            // ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
            totalPosterScore = parseFloat(appearanceAvg) + parseFloat(contentsAvg) + parseFloat(verbalAvg);

            const posterScore = totalPosterScore > 0 ? totalPosterScore.toFixed(2) : "0";  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô "-" ‡πÄ‡∏õ‡πá‡∏ô "0"


            // **‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (Total Score)**
            const PresentationNumber = parseFloat(totalPresentationScores) || 0;
            const DocumentNumber = parseFloat(totalDocumentScore) || 0;
            const PosterNumber = parseFloat(totalPosterScore) || 0;

            const rawTotalScore = PresentationNumber + DocumentNumber + PosterNumber;

            const totalScore = Math.min(rawTotalScore, 40.0).toFixed(2); // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 40%

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${studentName}</td>
            <td>${totalPresentationScores}</td>
            <td>${totalDocumentScore}</td>
            <td>${totalPosterScore.toFixed(2)}</td>
            <td>${totalScore}</td>
        `;
            tableBody.appendChild(row);

            // ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡πÉ‡∏ô console
            console.log(`Student: ${studentName}`);
            console.log(`Total Presentation Score: ${presentationScores}`);
            console.log(`Total Document Score: ${totalDocumentScore}`);
            console.log(`Total Poster Score: ${posterScore}`);
            console.log(`Total Score: ${totalScore}`);
        }
    }

    // Helper function to calculate average of a category
    function calculateCategoryAvg(scores) {
        if (scores.length === 0) return 0;
        const sum = scores.reduce((acc, score) => acc + score, 0);
        return (sum / scores.length).toFixed(2);
    }


</script>


<!--================================  Modal  ==========================================-->
<script>
    // Modal popup logic
    const modalTemplate = `
        <div id="popup-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);">
            <div style="background: white; width: 80%; margin: 5% auto; padding: 20px; position: relative;">
<!--                        <button id="close-modal" style="position: absolute; top: 10px; right: 10px;">Close</button>-->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <h1 style="margin: 0;"></h1>
                                                <div>
                                                    <button id="pre-instructor" style="margin-right: 10px;">Previous</button>
                                                    <button id="next-instructor" style="margin-right: 10px;">Next</button>
                                                    <button id="close-modal">Close</button>
                                                </div>
                        </div>
                        <div class="table-container">
                            <h1> Score Evaluation </h1>
                            <hr>
                            <div class="user-section">
                                <span class="icon">
                                    <i class="fa fa-user" style="font-size: 32px; color: #000;"></i>
                                    <div class="text-container">
                                        <div class="name">
                                                 <!--              value              -->
                                        </div>
                                        <div class="subtitle">
                                                 <!--              value              -->
                                        </div>
                                    </div>
                                </span>
                            </div>

                            <h1>Defense Presentation (20%)</h1>
                            <table class="evaluation-table" id="presentation-table">
                                    <!--              value              -->
                            </table>
                        </div>
                        <div class="table-container">
                            <h1>Document (10%)</h1>
                            <table class="evaluation-table" id="document-table">
                                    <!--              value              -->
                            </table>
                        </div>

                        <div class="table-container">
                            <div id="comment-box">
                                <h2>Comment</h2>
                                <p id="comment-text"></p>
                            </div>
                        </div>


<!--                        <div style="text-align: center; margin-top: 20px;">-->
<!--                           <button id="pre-instructor" style="margin-right: 10px;">Previous</button>-->
<!--                           <button id="next-instructor">Next</button>-->
<!--                        </div>-->
                    </div>
            </div>`;

    document.body.insertAdjacentHTML('beforeend', modalTemplate);

    document.getElementById("preview-button").addEventListener("click", function () {
        document.getElementById("popup-modal").style.display = "block";

    });

    document.getElementById("close-modal").addEventListener("click", function () {
        document.getElementById("popup-modal").style.display = "none";
    });

    // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å modal
    document.getElementById("popup-modal").addEventListener("click", function (event) {
        if (event.target === document.getElementById("popup-modal")) {
            document.getElementById("popup-modal").style.display = "none";
        }
    });

    //================================  displayDefenseCriteria + Poster (Modal)  ==========================================
    function displayPresentCriteria(data) {

        const criteria = data[2];
        const students = data[1];

        const table = document.getElementById("presentation-table");
        table.innerHTML = "";

        const thead = document.createElement("thead");
        const rowHeader = document.createElement("tr");


        rowHeader.innerHTML = `
<!--             <th></th>-->
<!--            ${students.map(student => `<th>${student.studentId} ${student.studentName}</th>`).join('')}-->

            <th></th>
        ${students.map(student => {
            const nameParts = student.studentName.split(' '); // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
            const lastNameAbbr = nameParts[1] ? nameParts[1].slice(0, 3) + '.' : ''; // ‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 3 ‡∏ï‡∏±‡∏ß + ‡∏à‡∏∏‡∏î
            return `<th>${student.studentId} ${nameParts[0]} ${lastNameAbbr}</th>`;
        }).join('')}
        `;
        thead.appendChild(rowHeader);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const presentCriteria = criteria.filter(i => i.type === "Defense Presentation");

        presentCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td style="text-align: left">
                    <strong>${criteria.criteriaName}</strong><br>
                    <span class="subtitle">${criteria.criteriaNameTH}</span>
                    <span class="max-score">Max Score ${criteria.maxScore}</span>
                </td>
                ${students.map(() => `<td></td>`).join('')}
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody)
    }

    function displayDocumentCriteria(data) {

        const criteria = data[2];
        const students = data[1];

        const table = document.getElementById("document-table");
        table.innerHTML = "";

        const thead = document.createElement("thead");
        const rowHeader = document.createElement("tr");

        rowHeader.innerHTML = `
               <th></th>
                ${students.map(student => {
            const nameParts = student.studentName.split(' '); // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
            const lastNameAbbr = nameParts[1] ? nameParts[1].slice(0, 3) + '.' : ''; // ‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 3 ‡∏ï‡∏±‡∏ß + ‡∏à‡∏∏‡∏î
            return `<th>${student.studentId} ${nameParts[0]} ${lastNameAbbr}</th>`;
        }).join('')}
        `;
        thead.appendChild(rowHeader);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const documentCriteria = criteria.filter(i => i.type === "Document");

        documentCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td style="text-align: left">
                    <strong>${criteria.criteriaName}</strong><br>
                    <span class="subtitle">${criteria.criteriaNameTH}</span>
                    <span class="max-score">Max Score ${criteria.maxScore}</span>
                </td>
                ${students.map(() => `<td></td>`).join('')}
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody);
    }

    //================================  displayModal  (Modal)  ==========================================
    function updateInstructorModal(instructors) {

        currentInstructor = 0;
        updateModalContent(currentInstructor, instructors);

        const modal = document.getElementById("popup-modal")
        displayScoreModal(modal);

        document.getElementById("pre-instructor").addEventListener("click", function () {
            if (currentInstructor > 0) {
                currentInstructor--;
                updateModalContent(currentInstructor, instructors);

                flashContent()

                displayScoreModal(modal);
            }
        });

        document.getElementById("next-instructor").addEventListener("click", function () {
            if (currentInstructor < instructors.length - 1) {
                currentInstructor++;
                updateModalContent(currentInstructor, instructors);

                flashContent()

                displayScoreModal(modal);
            }
        });

        function flashContent() {
            const modal = document.getElementById("popup-modal");
            const textElements = modal.querySelectorAll('.table-container td, .table-container strong, .table-container span, .table-container p');

            textElements.forEach(el => {
                el.classList.add('fade-text', 'active');
            });

            setTimeout(() => {
                textElements.forEach(el => {
                    el.classList.remove('active');
                });
            }, 500); // ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ fade ‡∏≠‡∏≠‡∏Å (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö CSS transition)
        }

    }


    //================================  displayInstructor  (Modal)  ==========================================
    function updateModalContent(index, instructors) {
        const instructor = instructors[index];
        document.querySelector(".user-section .name").textContent = instructor.professorName;
        document.querySelector(".user-section .subtitle").textContent = instructor.role;
    }

    //================================  displayInstructor  (Modal)  ==========================================
    async function displayScoreModal(modal) {
        try {
            const projectId = document.getElementById('projectIdInput').value;
            const instructorName = modal.querySelector(".user-section .name").textContent;
            const instructorRole = modal.querySelector(".user-section .subtitle").textContent;

            console.log('Fetch score parameter:', {
                projectId,
                instructorName,
                instructorRole
            });

            // https://www.geeksforgeeks.org/node-js-urlsearchparams-append/
            const url = new URL('http://localhost:8080/instructor/GetDefenseEvalScoreModal')
            url.searchParams.append('projectId', projectId);
            url.searchParams.append('instructorName', instructorName);
            url.searchParams.append('role', instructorRole);

            console.log('Request URL: ', url.toString());

            // fetch
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const scoreData = await response.json();

            console.log('Received score data: ', scoreData);

            clearExistingScore(modal);

            if (scoreData.length > 0) {

                const commentText = scoreData[0].comment;
                const commentBox = modal.querySelector('#comment-text');
                commentBox.textContent = commentText;
            }

            const tableList = modal.querySelectorAll('table');

            // check type of table
            tableList.forEach(table => {
                let type;

                if (table.id === 'presentation-table') {
                    type = 'Defense Presentation';
                } else if (table.id === 'document-table') {
                    type = 'Document'
                }

                console.log('Processing table type: ', type);

                // all row
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {

                    //https://stackoverflow.com/questions/9362800/how-to-select-not-first-tr-and-not-last-td
                    // criteria td
                    const criteriaName = row.querySelector('strong').textContent;
                    const cells = row.querySelectorAll('td:not(:first-child)')

                    cells.forEach((cell, index) => {
                        const studentId = table.querySelector(`thead th:nth-child(${index + 2})`).textContent.split(' ')[0];
                        const matchScore = scoreData.find(score =>
                            score.studentId === studentId &&
                            score.criteriaName === criteriaName &&
                            score.type === type);

                        if (matchScore) {
                            // toFixed x.xx
                            cell.textContent = matchScore.score.toFixed(2);
                            console.log(`Found score: ${matchScore.score.toFixed(2)}`);
                        } else {
                            console.log(`No matching score found for Student ID ${studentId}, Criteria ${criteriaName}`);
                        }
                    })
                })
            })
        } catch (error) {
            console.error('Error fetch score: ', error)
            throw error;
        }
    }

    function clearExistingScore(modal) {
        const cells = modal.querySelectorAll('table tbody td:not(:first-child)')
        cells.forEach(cell => {
            cell.textContent = '';
        })

        const commentCell = modal.querySelector('#comment-text');
        commentCell.textContent = '';
    }

</script>


<!-- ================================  Fern  ==========================================-->
<script th:inline="javascript">

    function criteriaDefense() {
        let url = `http://localhost:8080/instructor/criteriaDefenseGrade`;

        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                // console.log("JSON: " + response.json());
                return response.json();
            });
    }

    function studentProposalCriteria(projectId) {
        let url = `http://localhost:8080/instructor/studentProposalCriteria?projectId=${encodeURIComponent(projectId)}`;

        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                // console.log("JSON: " + response.json());
                return response.json();
            })
    }

    function criteriaDefenseEva() {
        let url = `http://localhost:8080/instructor/criteriaDefense`;

        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                // console.log("JSON: " + response.json());
                return response.json();
            });
    }

    function criteriaPosterEva() {
        let url = `http://localhost:8080/instructor/criteriaPoster`;

        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                // console.log("JSON: " + response.json());
                return response.json();
            });
    }

    function projectInstructor(projectId) {
        let url = `http://localhost:8080/instructor/projectDefense?projectId=${encodeURIComponent(projectId)}`;

        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                // console.log("JSON: " + response.json());
                return response.json();
            })
    }


    function fetchData(projectId) {
        Promise.all([
            criteriaDefense(),
            studentProposalCriteria(projectId),

            // modal
            criteriaDefenseEva(),
            projectInstructor(projectId),
            criteriaPosterEva()
        ])
            .then(data => {
                const criteriaProposalData = data[0];
                const studentProposalCriteriaData = data[1];

                const criteriaDefenseEva = data[2];
                const projectInstructor = data[3];
                const criteriaPosterData = data[4];

                console.log("criteriaProposalData Length: " + criteriaProposalData.length);
                console.log("Show Data criteriaProposalData: " + JSON.stringify(criteriaProposalData, null, 2));

                console.log("studentProposalCriteriaData Length: " + studentProposalCriteriaData.length);
                console.log("Show Data studentProposalCriteriaData: " + JSON.stringify(studentProposalCriteriaData, null, 2));

                console.log("criteriaDefenseEva Length: " + criteriaDefenseEva.length);
                console.log("Show Data criteriaDefenseEva: " + JSON.stringify(criteriaDefenseEva, null, 2));

                projectInstructor.sort((a, b) =>
                    a.role.localeCompare(b.role)
                );
                console.log("projectInstructor Length: " + projectInstructor.length);
                console.log("Show Data projectInstructor: " + JSON.stringify(projectInstructor, null, 2));

                console.log("criteriaPosterData Length: " + criteriaPosterData.length);
                console.log("Show Data criteriaPosterData: " + JSON.stringify(criteriaPosterData, null, 2));

                displayGradeCriteria(data)
                displayExtraScoreCriteria(data)

                displayPresentCriteria(data)
                displayDocumentCriteria(data)
                // displayPosterCriteria(data)
                updateInstructorModal(projectInstructor)
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const projectId = document.getElementById('projectIdInput').value;
        console.log("ID send to html: " + projectId);

        if (projectId && projectId.trim() !== '') {
            fetchData(projectId);
        } else {
            console.error('Project ID is not defined or is invalid.');
        }

    });

    //================================  displayGradetCriteria  ==========================================
    function displayGradeCriteria(data) {

        const criterias = data[0];
        const students = data[1];

        const table = document.getElementById("grade-evaluation-table");
        table.innerHTML = "";

        const thead = document.createElement("thead");
        const rowHeader = document.createElement("tr");

        rowHeader.innerHTML = `
        <th></th>
        ${students.map(student => {
            const nameParts = student.studentName.split(' '); // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
            const lastNameAbbr = nameParts[1] ? nameParts[1].slice(0, 3) + '.' : ''; // ‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 3 ‡∏ï‡∏±‡∏ß + ‡∏à‡∏∏‡∏î
            return `<th>${student.studentId} ${nameParts[0]} ${lastNameAbbr}</th>`;
        }).join('')}
        `;
        thead.appendChild(rowHeader);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const gradingCriteria = criterias.filter(i => i.type === "Grading")


        gradingCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td style="text-align: left;">
                        <strong>${criteria.criteriaName}</strong><br>
                        <span class="subtitle">${criteria.criteriaNameTH}</span>
                        <span class="max-score">Max Score ${criteria.maxScore}</span>
                    </td>
                    ${students.map(student => {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                return `<td><input type="number" class="present-score-input" min="0" max="${criteria.maxScore}"
                    data-student-id="${student.studentId}" data-student-name="${student.studentName}" data-criteria-id="${criteria.criteriaId}" /></td>`;
            }).join('')}
                `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody)
    }


    //================================  displayExtraCriteria  ==========================================
    function displayExtraScoreCriteria(data) {

        const criterias = data[0];
        const students = data[1];

        const table = document.getElementById("grade-extra-score-table");
        table.innerHTML = "";

        const thead = document.createElement("thead");
        const rowHeader = document.createElement("tr");

        rowHeader.innerHTML = `
        <th></th>
        ${students.map(student => {
            const nameParts = student.studentName.split(' '); // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
            const lastNameAbbr = nameParts[1] ? nameParts[1].slice(0, 3) + '.' : ''; // ‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 3 ‡∏ï‡∏±‡∏ß + ‡∏à‡∏∏‡∏î
            return `<th>${student.studentId} ${nameParts[0]} ${lastNameAbbr}</th>`;
        }).join('')}
        `;
        thead.appendChild(rowHeader);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const gradingCriteria = criterias.filter(i => i.type === "Extra Score")


        gradingCriteria.forEach(criteria => {
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td style="text-align: left;">
                        <strong>${criteria.criteriaName}</strong><br>
                        <span class="subtitle">${criteria.criteriaNameTH}</span>
                        <span class="max-score">Max Score ${criteria.maxScore}</span>
                    </td>
                    ${students.map(student => {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                return `<td><input type="number" class="present-score-input" min="0" max="${criteria.maxScore}"
                    data-student-id="${student.studentId}" data-student-name="${student.studentName}" data-criteria-id="${criteria.criteriaId}" /></td>`;
            }).join('')}
                `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody)
    }

    document.addEventListener("input", function (event) {
        if (event.target.classList.contains("present-score-input")) {
            let max = parseFloat(event.target.max);
            let value = parseFloat(event.target.value);

            if (value > max) {
                event.target.classList.add("invalid-score");
                event.target.title = `Maximum score is ${max}`;
            } else if (value < 0) {
                event.target.classList.add("invalid-score");
                event.target.title = "Score cannot be negative";
            } else {
                event.target.classList.remove("invalid-score");
                event.target.title = "";
            }
        }
    });
</script>


<!-- -------------- Insert Score to Database -------------- -->
<script>

    // Function to check for students with zero scores
    function checkForZeroScores() {
        // Get all students' IDs from input fields
        const inputs = document.querySelectorAll('.present-score-input');
        const studentMap = new Map();

        // Initialize studentMap with all studentIds and set initial total to 0
        inputs.forEach(input => {
            const studentId = input.getAttribute('data-student-id');
            if (!studentMap.has(studentId)) {
                studentMap.set(studentId, {total: 0, count: 0});
            }

            const scoreValue = parseFloat(input.value) || 0;
            const currentData = studentMap.get(studentId);
            currentData.total += scoreValue;
            currentData.count++;
            studentMap.set(studentId, currentData);
        });

        // Find students with zero total scores
        const zeroScoreStudents = [];
        for (const [studentId, data] of studentMap.entries()) {
            if (data.total === 0) {
                // Fetch student name if available
                const studentElement = document.querySelector(`.card-score-result[data-student-id="${studentId}"]`);
                let studentName = '';

                if (studentElement) {
                    const iconSpan = studentElement.querySelector('.icon');
                    if (iconSpan) {
                        studentName = iconSpan.textContent.trim();
                    }
                }

                zeroScoreStudents.push({id: studentId, name: studentName});
            }
        }

        return zeroScoreStudents;
    }


    document.querySelector('.save-button').addEventListener('click', function (event) {
        console.log("üìù Save Process Started");

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö invalid score ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        console.log("Checking for invalid scores...");
        const invalidInputs = document.querySelectorAll('.invalid-score');
        console.log("Found invalid inputs:", invalidInputs.length);

        if (invalidInputs.length > 0) {
            console.log("Invalid scores detected! Showing alert...");

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á alert ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            const alertBox = document.createElement('div');
            alertBox.className = 'score-error-alert';
            alertBox.style.position = 'fixed';
            alertBox.style.top = '20px';
            alertBox.style.left = '50%';
            alertBox.style.transform = 'translate(-50%)';
            alertBox.style.backgroundColor = '#f8d7da';
            alertBox.style.color = '#721c24';
            alertBox.style.padding = '15px 20px';
            alertBox.style.borderRadius = '5px';
            alertBox.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
            alertBox.style.zIndex = '1000';
            alertBox.style.maxWidth = '80%';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ alert
            let errorContent = '<h3 style="margin-top:0">‚ö†Ô∏è Invalid Scores Detected</h3>';
            errorContent += '<p>Cannot save evaluation. Please correct the following scores:</p><ul>';

            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            invalidInputs.forEach(input => {
                const studentId = input.getAttribute('data-student-id');
                const studentName = input.getAttribute('data-student-name');
                const maxScore = input.max;
                const currentValue = input.value;

                // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏à‡∏≤‡∏Å parent row
                const criteriaRow = input.closest('tr');
                const criteriaName = criteriaRow ? criteriaRow.querySelector('strong').textContent : 'N/A';

                // ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                let problem = "";
                if (parseFloat(currentValue) > parseFloat(maxScore)) {
                    problem = `Maximum score is (${maxScore})`;
                } else if (parseFloat(currentValue) < 0) {
                    problem = "Score cannot be negative";
                } else {
                    problem = "Invalid-score";
                }

                errorContent += `
                <li style="margin-bottom: 10px;">
                    <div><strong>${studentName}</strong> (${studentId})</div>
                    <div>Criteria: ${criteriaName}</div>
                    <div style="color: #dc3545;">Score: ${currentValue}  <strong>${problem}</strong></div>
                </li>
            `;

            });

            errorContent += `
            </ul>
            <div style="text-align: center; margin-top: 15px;">
                <button id="close-error-alert" style="padding: 8px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Close</button>
            </div>
        `;

            alertBox.innerHTML = errorContent;
            document.body.appendChild(alertBox);

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
            document.getElementById('close-error-alert').addEventListener('click', function () {
                alertBox.remove();

                // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á input ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                if (invalidInputs.length > 0) {
                    invalidInputs[0].focus();
                    invalidInputs[0].scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            });

            return false; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
        }

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö invalid scores ‡πÉ‡∏´‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        console.log("No invalid scores detected, continuing with save process...");

        event.preventDefault();

        // Check for zero scores before showing the modal
        const zeroScoreStudents = checkForZeroScores();
        const iGradeStudents = [];

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Å‡∏£‡∏î 'I'
        document.querySelectorAll('.present-score-input').forEach(input => {
            const studentId = input.getAttribute('data-student-id');
            const studentElement = document.querySelector(`.card-score-result[data-student-id="${studentId}"]`);
            const grade = studentElement ? studentElement.querySelector('.grade').textContent.trim() : '';

            if (grade === 'I') {
                iGradeStudents.push({id: studentId});
            }
        });

        // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const modal = document.getElementById('confirmationModal');
        const closeButton = document.getElementById('closeModal');
        const confirmSaveButton = document.getElementById('confirmSave');
        const cancelSaveButton = document.getElementById('cancelSave');

        // Update modal content based on zero score and I grade detection
        const modalContent = document.querySelector('.modal-content');

        // Clear previous content if any
        const oldWarning = modalContent.querySelector('.zero-score-warning');
        if (oldWarning) {
            oldWarning.remove();
        }

        const oldIGradeWarning = modalContent.querySelector('.i-grade-warning');
        if (oldIGradeWarning) {
            oldIGradeWarning.remove();
        }

        if (zeroScoreStudents.length > 0) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'zero-score-warning';
            warningDiv.style.color = '#e74c3c';
            warningDiv.style.marginBottom = '15px';
            warningDiv.style.fontWeight = 'bold';

            let warningMessage = '<p>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ 0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</p><ul>';
            zeroScoreStudents.forEach(student => {
                warningMessage += `<li>${student.name || student.id}</li>`;
            });
            warningMessage += '</ul><p>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>';
            warningDiv.innerHTML = warningMessage;
            const buttonDiv = modalContent.querySelector('div');
            modalContent.insertBefore(warningDiv, buttonDiv);
        }

        if (iGradeStudents.length > 0) {
            const iGradeWarningDiv = document.createElement('div');
            iGradeWarningDiv.className = 'i-grade-warning';
            iGradeWarningDiv.style.color = '#d88d14';
            iGradeWarningDiv.style.marginBottom = '15px';
            iGradeWarningDiv.style.fontWeight = 'bold';

            let iGradeMessage = '<p>‚ö†Ô∏è The student has an \'I\' grade because the committee has not yet given all the required scores.</p><ul>';
            // iGradeStudents.forEach(student => {
            //     iGradeMessage += `<li>${student.id}</li>`;
            // });
            // iGradeMessage += '</ul><p>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>';
            iGradeWarningDiv.innerHTML = iGradeMessage;
            const buttonDiv = modalContent.querySelector('div');
            modalContent.insertBefore(iGradeWarningDiv, buttonDiv);
        }

        modal.style.display = "block"; // ‡πÄ‡∏õ‡∏¥‡∏î Modal

        closeButton.addEventListener('click', function () {
            modal.style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô modal
        });

        function closeModal() {
            const modal = document.getElementById('confirmationModal');
            modal.style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô modal
        }

        closeButton.addEventListener('click', closeModal);
        cancelSaveButton.addEventListener('click', closeModal);


        // closeButton.addEventListener('click', closeModal, {once: true});
        // cancelSaveButton.addEventListener('click', closeModal, {once: true});

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Confirm (Save) ‡πÉ‡∏ô Modal ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        // confirmSaveButton.addEventListener('click', function () {
        //     closeModal(); // ‡∏õ‡∏¥‡∏î Modal
        confirmSaveButton.addEventListener('click', function () {
            modal.style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô modal

            // projectId
            var projectId = getProjectIdFromURL();
            console.log("projectId: " + projectId);

            // student score
            var studentScores = document.querySelectorAll('.present-score-input'); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å input ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (scores)
            var studentData = {};

            studentScores.forEach((input) => {
                let studentId = input.dataset.studentId; // ‡∏î‡∏∂‡∏á studentId
                let scoreCriteriaId = input.getAttribute('data-criteria-id'); // ‡∏î‡∏∂‡∏á criteria ID ‡∏à‡∏≤‡∏Å data-attribute
                let score = parseFloat(input.value) || 0;

                if (!studentData[studentId]) {
                    studentData[studentId] = [];
                }
                studentData[studentId].push({scoreCriteriaId, score});
            });

            console.log(studentData);

            // Fetch instructorId and then send evaluation data
            fetchInstructorId();

            function fetchInstructorId() {
                fetch(`http://localhost:8080/get-instructorId?projectId=${projectId}`)
                    .then(response => response.text())
                    .then(data => {
                        var instructorId = data;
                        console.log("Instructor Id: " + instructorId);
                        sendEvaluationData();  // Call the function to send data after instructorId is fetched
                    })
                    .catch(error => console.error('Error fetching instructorId:', error));
            }

            function sendEvaluationData() {
                const fetchPromises = [];

                // Get all studentIds from DOM
                const studentIds = new Set();
                document.querySelectorAll('.present-score-input').forEach(input => {
                    studentIds.add(input.dataset.studentId);
                });

                // Loop through valid studentIds
                studentIds.forEach(id => {
                    let scoreDTOList = studentData[id]; // ‚úÖ Use `id` instead of `studentId`

                    if (!scoreDTOList) {
                        console.error(`‚ö†Ô∏è No score data found for student ${id}`);
                        return; // Skip students with no data
                    }

                    let studentName = document.querySelector(`[data-student-id="${id}"]`)?.dataset.studentName || 'Unknown';

                    console.log("üìå Original scoreDTOList:", JSON.stringify(scoreDTOList));

                    // Use `getResultScore` to get defenseScore and posterScore from the table
                    let {defenseScore, posterScore} = getResultScore(studentName); // Get scores from getResultScore function

                    // Use `data-student-id` to get totalScore and grade for each student
                    let totalScore = parseFloat(document.querySelector(`[data-student-id="${id}"] .score`)?.textContent.split(' / ')[0] || '0');
                    let grade = document.querySelector(`[data-student-id="${id}"] .grade`)?.textContent.trim() || 'N/A';

                    // Create the data to be sent as JSON
                    let transformedData = {
                        defenseScore: defenseScore,
                        posterScore: posterScore,
                        grade: grade,
                        totalScore: totalScore,
                        scores: Array.isArray(scoreDTOList) ? scoreDTOList : [scoreDTOList] // Ensure array format
                    };

                    console.log("üöÄ Transformed Data:", JSON.stringify(transformedData));

                    // Send data to backend
                    let fetchPromise = fetch(`http://localhost:8080/saveDefenseGrade?` +
                        new URLSearchParams({
                            projectId: projectId,
                            studentId: id
                        }), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify(transformedData)
                    })
                        .then(async response => {
                            if (!response.ok) {
                                const errorMessage = await response.text();
                                console.error("‚ùå Error response from server:", errorMessage);
                                throw new Error(errorMessage);
                            }

                            const contentType = response.headers.get("content-type");
                            return contentType && contentType.includes("application/json")
                                ? response.json()
                                : response.text();
                        })
                        .then(data => console.log(`‚úÖ Evaluation saved successfully for student ${id}:`, data))
                        .catch(error => console.error(`‚ö†Ô∏è Unexpected error for student ${id}:`, error));

                    fetchPromises.push(fetchPromise);
                });

                // Wait for all fetch requests to complete
                Promise.all(fetchPromises)
                    .then(() => {
                        function showNotification(message, callback) {
                            const notification = document.createElement("div");
                            notification.textContent = message;
                            notification.style.position = "fixed";
                            notification.style.top = "20px";
                            notification.style.right = "20px";
                            notification.style.padding = "10px 20px";
                            notification.style.background = "green";
                            notification.style.color = "white";
                            notification.style.borderRadius = "5px";
                            notification.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
                            document.body.appendChild(notification);

                            // ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                            setTimeout(() => {
                                notification.remove();
                                if (callback) callback(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å callback ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
                            }, 1000);
                        }

                        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                        showNotification("Evaluation saved successfully!", function () {
                            loadEvaluationData(projectId);
                            window.location.href = "/show-defense-grade-projects";
                        });

                        // alert('‚úÖ Evaluation saved successfully!');
                        // loadEvaluationData(projectId); // Reload evaluation data after saving
                        // window.location.href = '/show-defense-grade-projects'; // Redirect to the results page
                    })
                    .catch(error => console.error('‚ö†Ô∏è Error saving evaluations:', error));
            }

            // function getResultScore(studentName) {
            //     const table = document.querySelector('#student-score');
            //     if (!table) {
            //         console.warn('‚ö†Ô∏è Table not found');
            //         return {defenseScore: 0, posterScore: 0};
            //     }
            //
            //     const rows = table.querySelectorAll('tr');
            //     console.log("üßë‚Äçüéì Checking score for: " + studentName);
            //
            //     for (const row of rows) {
            //         const nameCell = row.cells[0]; // Column for student name
            //         if (!nameCell) continue;
            //
            //         // Check if studentName matches the one in the first column
            //         if (nameCell.textContent.trim() === studentName) {
            //             const defenseScoreCell1 = row.cells[1]; // Column 2 (defenseScore - part 1)
            //             const defenseScoreCell2 = row.cells[2]; // Column 3 (defenseScore - part 2)
            //             const posterScoreCell = row.cells[3]; // Column 4 (posterScore)
            //
            //             if (defenseScoreCell1 && defenseScoreCell2 && posterScoreCell) {
            //                 // Calculate defenseScore by adding values from columns 2 and 3
            //                 const defenseScore = (parseFloat(defenseScoreCell1.textContent.trim()) || 0) +
            //                     (parseFloat(defenseScoreCell2.textContent.trim()) || 0);
            //
            //                 // Get posterScore from column 4
            //                 const posterScore = parseFloat(posterScoreCell.textContent.trim()) || 0;
            //
            //                 console.log(`‚úÖ Found scores for ${studentName}: defenseScore = ${defenseScore}, posterScore = ${posterScore}`);
            //
            //                 // Return the result
            //                 return {
            //                     defenseScore: defenseScore,
            //                     posterScore: posterScore
            //                 };
            //             }
            //         }
            //     }
            //
            //     // In case no scores are found in the table
            //     console.warn(`‚ö†Ô∏è No scores found for ${studentName}`);
            //     return {
            //         defenseScore: 0,
            //         posterScore: 0
            //     };
            // }
        });
    });
</script>


<!-- --------------- Show Evaluate Score ------------------ -->
<script>
    document.addEventListener("DOMContentLoaded", async function () {
        console.log("üöÄ DOMContentLoaded Triggered");

        const projectId = getProjectIdFromURL();
        if (!projectId) {
            console.error('‚ùå No project ID found');
            return;
        }

        console.log(`üìå Found projectId: ${projectId}`);

        // Wait for table load
        await waitForTableToLoad();

        // Load evaluation data
        await loadEvaluationData(projectId);
    });

    async function waitForTableToLoad() {
        return new Promise((resolve) => {
            const observer = new MutationObserver((mutations, obs) => {
                const scoreInputs = document.querySelectorAll('.present-score-input');
                if (scoreInputs.length > 0) {
                    console.log(`‚úÖ Table Loaded! Found ${scoreInputs.length} inputs.`);
                    obs.disconnect();
                    resolve();
                }
            });

            observer.observe(document.body, {childList: true, subtree: true});

            // Timeout after 5 seconds
            setTimeout(() => {
                console.warn("‚ö†Ô∏è Timeout waiting for table to load.");
                resolve();
            }, 5000);
        });
    }

    async function loadEvaluationData(projectId) {
        console.log("üì£ Starting loadEvaluationData");

        const scoreInputs = document.querySelectorAll('.present-score-input');
        console.log("üîç Found input fields:", scoreInputs.length);

        if (scoreInputs.length === 0) {
            console.warn("‚ö†Ô∏è No input fields found!");
            return;
        }

        // Track processed students to avoid duplicates
        const processedStudents = new Set();
        const studentResults = [];

        for (const input of scoreInputs) {
            const studentId = input.dataset.studentId;
            console.log(`üôá‚Äç‚ôÄÔ∏è Processing studentId: ${studentId}`);

            if (!studentId) {
                console.warn("‚ö†Ô∏è Input missing studentId:", input);
                continue;
            }

            // Skip if already processed this student
            if (processedStudents.has(studentId)) continue;
            processedStudents.add(studentId);

            try {
                // Fetch scores for current student
                const response = await fetch(`http://localhost:8080/getGradeDefense?projectId=${projectId}&studentId=${studentId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const text = await response.text();
                if (!text || text.trim() === '') {
                    console.warn(`üìù No data for student ${studentId}`);
                    continue;
                }

                const data = JSON.parse(text);
                console.log("üÖ∞Ô∏è Received Grade Data:", data);

                // Get scores separately
                const crit022Score = data.evaluateScore || 0;
                const crit023Score = data.extraScore || 0;
                const gradeResult = data.gradeResult || 'N/A';
                const totalScore = data.totalScore || 0;

                // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ input ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ CRIT022
                const inputFieldCRIT022 = document.querySelector(`input[data-student-id="${studentId}"][data-criteria-id="CRIT022"]`);
                if (inputFieldCRIT022) {
                    inputFieldCRIT022.value = crit022Score;
                    console.log(`‚úÖ Set score ${crit022Score} for student ${studentId} in CRIT022`);
                }

                // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ input ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ CRIT023
                const inputFieldCRIT023 = document.querySelector(`input[data-student-id="${studentId}"][data-criteria-id="CRIT023"]`);
                if (inputFieldCRIT023) {
                    inputFieldCRIT023.value = crit023Score;
                    console.log(`‚úÖ Set score ${crit023Score} for student ${studentId} in CRIT023`);
                }

                // Store student results for card display
                studentResults.push({
                    studentId,
                    studentName: data.studentId.studentName,
                    score: totalScore,
                    grade: gradeResult
                });

                // Add the student card with the correct grade from the database
                updateScoreCard(studentId, totalScore, gradeResult);

                // If the grade is 'I', we need to make sure the checkbox is checked
                if (gradeResult === 'I') {
                    setTimeout(() => {
                        const checkbox = document.querySelector(`.card-score-result[data-student-id="${studentId}"] .i-grade-checkbox`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    }, 100); // Small delay to ensure the DOM has updated
                }

            } catch (error) {
                console.error(`‚ùå Error processing student ${studentId}:`, error);

                // ‚úÖ ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ input ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ error
                const inputFieldCRIT022 = document.querySelector(`input[data-student-id="${studentId}"][data-criteria-id="CRIT022"]`);
                if (inputFieldCRIT022) {
                    inputFieldCRIT022.value = '0';
                }

                const inputFieldCRIT023 = document.querySelector(`input[data-student-id="${studentId}"][data-criteria-id="CRIT023"]`);
                if (inputFieldCRIT023) {
                    inputFieldCRIT023.value = '0';
                }
            }
        }

        // Update score result cards
        initializeScoreCalculation();
    }
</script>


<script>
    function getResultScore(studentName) {
        const table = document.querySelector('#student-score');
        if (!table) {
            console.warn('‚ö†Ô∏è Table not found');
            return {defenseScore: 0, posterScore: 0};
        }

        const rows = table.querySelectorAll('tr');
        console.log("üßë‚Äçüéì Checking score for: " + studentName);

        for (const row of rows) {
            const nameCell = row.cells[0]; // Column for student name
            if (!nameCell) continue;

            // Check if studentName matches the one in the first column
            if (nameCell.textContent.trim() === studentName) {
                const defenseScoreCell1 = row.cells[1]; // Column 2 (defenseScore - part 1)
                const defenseScoreCell2 = row.cells[2]; // Column 3 (defenseScore - part 2)
                const posterScoreCell = row.cells[3]; // Column 4 (posterScore)

                if (defenseScoreCell1 && defenseScoreCell2 && posterScoreCell) {
                    // Calculate defenseScore by adding values from columns 2 and 3
                    const defenseScore = (parseFloat(defenseScoreCell1.textContent.trim()) || 0) +
                        (parseFloat(defenseScoreCell2.textContent.trim()) || 0);

                    // Get posterScore from column 4
                    const posterScore = parseFloat(posterScoreCell.textContent.trim()) || 0;

                    console.log(`‚úÖ Found scores for ${studentName}: defenseScore = ${defenseScore}, posterScore = ${posterScore}`);

                    // Return the result
                    return {
                        defenseScore: defenseScore,
                        posterScore: posterScore
                    };
                }
            }
        }

        // In case no scores are found in the table
        console.warn(`‚ö†Ô∏è No scores found for ${studentName}`);
        return {
            defenseScore: 0,
            posterScore: 0
        };
    }

    function getResultScoreFromTable(studentName) {
        // const table = document.querySelector('#student-score');
        // if (!table) {
        //     console.warn('‚ö†Ô∏è Table not found');
        //     return 0;
        // }
        //
        // const rows = table.querySelectorAll('tr');
        // console.log("üßë‚Äçüéì Checking score for: " + studentName);
        //
        // for (const row of rows) {
        //     const nameCell = row.cells[0]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏∑‡πà‡∏≠
        //     if (!nameCell) continue;
        //
        //     const currentStudentName = nameCell.textContent.trim(); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        //
        //     // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
        //     if (currentStudentName !== studentName) continue;
        //
        //     // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1-3 (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 1-3)
        //     for (let i = 1; i <= 3; i++) {
        //         const scoreCell = row.cells[i];
        //         const score = parseFloat(scoreCell.textContent.trim());
        //
        //         if (score === 0) {
        //             console.warn(`‚ö†Ô∏è Zero score detected in column ${i} for ${studentName}`);
        //             // console.log("üòéüòéüòé result score: "+row.cells[4]);
        //             return parseFloat(row.cells[4].textContent.trim())
        //             // return 'I'; // ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏î‡πÜ ‡∏Å‡πá return 'I'
        //         }
        //     }
        //
        //     // ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ 0, ‡∏Å‡πá‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Result Column (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 4)
        //     const resultCell = row.cells[4]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Result
        //     if (resultCell) {
        //         const resultScore = parseFloat(resultCell.textContent.trim()); // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô float
        //         console.log(`‚úÖ Found score for ${studentName}: ${resultScore}`);
        //         return resultScore;
        //     }
        // }
        //
        // console.warn(`‚ö†Ô∏è No score found for student: ${studentName}`);
        // return 0;
        const table = document.querySelector('#student-score');
        if (!table) {
            console.warn('‚ö†Ô∏è Table not found');
            return 0;
        }

        const rows = table.querySelectorAll('tr');
        console.log("üßë‚Äçüéì Checking score for: " + studentName);

        for (const row of rows) {
            const nameCell = row.cells[0]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏∑‡πà‡∏≠
            if (!nameCell) continue;

            const currentStudentName = nameCell.textContent.trim(); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const resultCell = row.cells[4]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Result

            if (resultCell && currentStudentName === studentName) {
                const resultScore = parseFloat(resultCell.textContent) || 0;
                console.log(`‚úÖ Found score for ${studentName}: ${resultScore}`);
                return resultScore;
            }
        }

        console.warn(`‚ö†Ô∏è No score found for student: ${studentName}`);
        return 0;
    }

    // Function to get input score for a student
    function getEvaluationScore(studentId) {
        let totalScore = 0;
        const inputs = document.querySelectorAll(`.present-score-input[data-student-id="${studentId}"][data-criteria-id="CRIT022"]`);
        inputs.forEach(input => {
            totalScore += parseFloat(input.value) || 0;
        });
        return totalScore;
    }

    function getExtraScore(studentId) {
        let totalScore = 0;
        const inputs = document.querySelectorAll(`.present-score-input[data-student-id="${studentId}"][data-criteria-id="CRIT023"]`);
        inputs.forEach(input => {
            totalScore += parseFloat(input.value) || 0;
        });
        return totalScore;
    }

    function checkForInvalidScores(row, studentName) {
        for (let i = 1; i <= 4; i++) {
            const scoreCell = row.cells[i];
            const scoreText = scoreCell.textContent.trim();

            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô "-", 0 ‡∏´‡∏£‡∏∑‡∏≠ null
            if (scoreText === "-" || scoreText === "" || scoreText === "0" || parseFloat(scoreText) === 0) {
                console.warn(`‚ö†Ô∏è Invalid score detected in column ${i} for ${studentName}`);
                return true; // ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ true
            }
        }
        return false; // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ false
    }

    // Updated function to calculate grade with zero or null score check
    async function calculateGradeWithCheck(score, studentId) {
        console.log(`üìù Calculating grade for student: ${studentId} with total score: ${score}`);

        // Check if the checkbox is checked for manual 'I' grade
        const cardElement = document.querySelector(`.card-score-result[data-student-id="${studentId}"]`);
        const manualICheckbox = cardElement?.querySelector('.i-grade-checkbox');

        if (manualICheckbox && manualICheckbox.checked) {
            console.log(`üîç Manual 'I' grade selected for student: ${studentId}`);
            return 'I';
        }

        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô
        const instructors = await projectInstructor(getProjectIdFromURL());
        console.log('üìö Instructors:', instructors);

        // Check if any score from any instructor is 0 or null
        const hasZeroOrNullScores = await checkForZeroScoresForAllInstructors(studentId, instructors);
        // const hasZeroOrNullScores = await checkForZeroScores(studentId);
        console.log(`üîé checkForZeroScores(${studentId}) = ${hasZeroOrNullScores}`);  // ‚úÖ ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô true ‡∏´‡∏£‡∏∑‡∏≠ false

        if (hasZeroOrNullScores) {
            console.log(`‚ö†Ô∏è Setting grade to 'I' for student: ${studentId} due to zero or null score`);
            return 'I';  // Return 'I' if any score is 0 or null
        }

        // Calculate the grade based on the total score
        return calculateRegularGrade(score);

        // Otherwise, calculate the grade based on the total score
        // if (score >= 80) return 'A';
        // if (score >= 75) return 'B+';
        // if (score >= 70) return 'B';
        // if (score >= 65) return 'C+';
        // if (score >= 60) return 'C';
        // if (score >= 55) return 'D+';
        // if (score >= 50) return 'D';
        // return 'F';
    }

    async function updateStudentScore(studentId, studentName) {
        // ‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
        const table = document.querySelector('#student-score');
        if (!table) {
            console.warn('‚ö†Ô∏è Table not found');
            return;
        }

        const rows = table.querySelectorAll('tr');

        for (const row of rows) {
            const nameCell = row.cells[0]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏∑‡πà‡∏≠
            if (!nameCell) continue;

            const currentStudentName = nameCell.textContent.trim(); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á

            if (currentStudentName === studentName) {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô checkForInvalidScores ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                // if (checkForInvalidScores(row, studentName)) {
                //     console.warn(`‚ö†Ô∏è Invalid score detected for ${studentName}. Setting grade to 'I'`);
                //     updateScoreCard(studentId, totalscore, 'I'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'I'
                //     return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                // }

                // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÄ‡∏£‡∏≤‡∏Å‡πá‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                const defenseScore = getResultScoreFromTable(studentName);
                const evaluationScore = getEvaluationScore(studentId);
                const extraScore = getExtraScore(studentId);

                const totalDefenseScore = parseFloat(defenseScore) || 0;
                const totalEvaluationScore = parseFloat(evaluationScore) || 0;
                const totalExtraScore = parseFloat(extraScore) || 0;

                const rawTotalScore = totalDefenseScore + totalEvaluationScore + totalExtraScore;
                const totalScore = Math.min(rawTotalScore, 100);

                if (checkForInvalidScores(row, studentName)) {
                    console.warn(`‚ö†Ô∏è Invalid score detected for ${studentName}. Setting grade to 'I'`);
                    updateScoreCard(studentId, totalScore, 'I'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'I'
                    return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                }

                const instructors = await projectInstructor(getProjectIdFromURL());
                console.log('üìö Instructors:', instructors);

                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
                const hasZeroOrNullScores = await checkForZeroScoresForAllInstructors(studentId, instructors);
                const grade = hasZeroOrNullScores ? 'I' : await calculateGradeWithCheck(totalScore, studentId);

                console.log("ü™Ñ studentId: " + studentId);
                console.log("ü™Ñ studentName: " + studentName);
                // console.log("ü™Ñ resultScore: " + resultScore);
                // console.log("ü™Ñ inputScore: " + inputScore);
                console.log("ü™Ñ totalScore: " + totalScore);
                console.log("ü™Ñ grade: " + grade);

                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô 'I' ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (grade !== 'I') {
                    console.log("‚úÖ ‡πÄ‡∏Å‡∏£‡∏î‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà: " + grade);
                } else {
                    console.warn("‚ö†Ô∏è ‡πÄ‡∏Å‡∏£‡∏î‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô 'I'");
                }

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                updateScoreCard(studentId, totalScore, grade);
            }
        }
    }


    // Updated function to initialize score calculation
    function initializeScoreCalculation() {
        // Add event listeners to all score inputs
        document.addEventListener('input', function (event) {
            if (event.target.classList.contains('present-score-input')) {
                const studentId = event.target.dataset.studentId;
                const studentName = event.target.dataset.studentName;
                if (studentId) {
                    console.log("üî∞ Initializing score calculation for:", studentId);
                    console.log("üî∞ Initializing score calculation for:", studentName);
                    updateStudentScore(studentId, studentName);
                }
            }
        });

        // Initial calculation for all students
        const studentIds = new Set();
        document.querySelectorAll('.present-score-input').forEach(input => {
            studentIds.add(input.dataset);
        });

        studentIds.forEach(studentId => {
            console.log("Initializing score calculation for:", studentId);
            updateStudentScore(studentId.studentId, studentId.studentName);
        });
    }

    // function updateScoreCard(studentId, totalScore, grade) {
    //     const cardContainer = document.querySelector('#card-container');
    //     if (!cardContainer) return;
    //
    //     let card = cardContainer.querySelector(`[data-student-id="${studentId}"]`);
    //     if (!card) {
    //         card = document.createElement('div');
    //         card.className = 'card-score-result';
    //         card.setAttribute('data-student-id', studentId);
    //         cardContainer.appendChild(card);
    //     }
    //
    //     const studentName = getStudentName(studentId);
    //     console.log(`üéØ Updating UI: Student ${studentId} | Total Score: ${totalScore} | Grade: ${grade}`);
    //
    //     // Calculate the actual grade based on score
    //     const calculatedGrade = calculateRegularGrade(totalScore);
    //
    //     // Store original calculated grade as a data attribute
    //     card.setAttribute('data-calculated-grade', calculatedGrade);
    //     card.setAttribute('data-total-score', totalScore.toFixed(2));
    //
    //     const warningMessage = grade === 'I'
    //         ? '<div class="warning-message" style="color: #f44336; font-size: 0.8em; margin-top: 5px;">Incomplete evaluation detected</div>'
    //         : '';
    //
    //     card.innerHTML = `
    //     <span class="icon">
    //         <i class="fa fa-user"></i>
    //         ${studentName}
    //     </span>
    //     <span class="grade" ${grade === 'I' ? 'style="color: #f44336;"' : ''}>${grade}</span>
    //     <span class="score">${totalScore.toFixed(2)} / 100</span>
    //     <div class="manual-i-grade" style="margin-top: 5px;">
    //         <label style="display: flex; align-items: center; font-size: 0.9em; cursor: pointer;">
    //             <input type="checkbox" class="i-grade-checkbox" data-student-id="${studentId}" ${isChecked} style="margin-right: 5px;">
    //             Assign 'I' grade
    //         </label>
    //     </div>
    //     ${warningMessage}
    // `;
    //
    //     // Add event listener to the checkbox
    //     const checkbox = card.querySelector('.i-grade-checkbox');
    //     checkbox.addEventListener('change', function() {
    //         const newGrade = this.checked ? 'I' : card.getAttribute('data-calculated-grade');
    //         updateGradeDisplay(card, newGrade);
    //     });
    // }
    function updateScoreCard(studentId, totalScore, grade) {
        const cardContainer = document.querySelector('#card-container');
        if (!cardContainer) {
            console.error("Card container not found! Please add a div with id 'card-container' to your HTML.");
            return;
        }

        let card = cardContainer.querySelector(`[data-student-id="${studentId}"]`);
        if (!card) {
            card = document.createElement('div');
            card.className = 'card-score-result';
            card.setAttribute('data-student-id', studentId);
            cardContainer.appendChild(card);
        }

        const studentName = getStudentName(studentId);
        console.log(`üéØ Updating UI: Student ${studentId} | Total Score: ${totalScore} | Grade: ${grade}`);

        // Calculate the actual grade based on score
        const calculatedGrade = calculateRegularGrade(totalScore);

        // Store original calculated grade as a data attribute
        card.setAttribute('data-calculated-grade', calculatedGrade);
        card.setAttribute('data-total-score', totalScore.toFixed(2));

        // Check if grade should be 'I'
        const isChecked = grade === 'I' ? 'checked' : '';

        const warningMessage = grade === 'I'
            ? '<div class="warning-message" style="color: #f44336; font-size: 0.8em; margin-top: 5px;">Incomplete evaluation detected</div>'
            : '';

        card.innerHTML = `
        <span class="icon">
            <i class="fa fa-user"></i>
            ${studentName}
        </span>
        <span class="grade" ${grade === 'I' ? 'style="color: #f44336;"' : ''}>${grade}</span>
        <span class="score">${totalScore.toFixed(2)} / 100</span>
        <div class="manual-i-grade" style="margin-top: 5px;">
            <label style="display: flex; align-items: center; font-size: 0.9em; cursor: pointer;">
                <input type="checkbox" class="i-grade-checkbox" data-student-id="${studentId}" ${isChecked} style="margin-right: 5px;">
                Assign 'I' grade
            </label>
        </div>
        ${warningMessage}
    `;

        // Add event listener to the checkbox
        const checkbox = card.querySelector('.i-grade-checkbox');
        checkbox.addEventListener('change', function() {
            const newGrade = this.checked ? 'I' : card.getAttribute('data-calculated-grade');
            updateGradeDisplay(card, newGrade);
        });
    }

    // Function to update the grade display without recalculating everything
    function updateGradeDisplay(card, newGrade) {
        const gradeSpan = card.querySelector('.grade');
        const studentId = card.getAttribute('data-student-id');

        // Update the style and text of the grade display
        if (newGrade === 'I') {
            gradeSpan.style.color = '#f44336';

            // Add warning message if not already present
            if (!card.querySelector('.warning-message')) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'warning-message';
                warningDiv.style.cssText = 'color: #f44336; font-size: 0.8em; margin-top: 5px;';
                warningDiv.textContent = 'Incomplete evaluation detected';
                card.appendChild(warningDiv);
            }
        } else {
            gradeSpan.style.color = '';

            // Remove warning message if present
            const warningMessage = card.querySelector('.warning-message');
            if (warningMessage) {
                warningMessage.remove();
            }
        }

        gradeSpan.textContent = newGrade;
        console.log(`üîÑ Grade manually updated to ${newGrade} for student ${studentId}`);
    }

    // Simple function to calculate grade from score without any 'I' logic
    function calculateRegularGrade(score) {
        if (score >= 80) return 'A';
        if (score >= 75) return 'B+';
        if (score >= 70) return 'B';
        if (score >= 65) return 'C+';
        if (score >= 60) return 'C';
        if (score >= 55) return 'D+';
        if (score >= 50) return 'D';
        return 'F';
    }

    async function checkForZeroScoresForAllInstructors(studentId, instructors) {
        for (const instructor of instructors) {
            const projectId = document.getElementById('projectIdInput').value;
            const instructorName = instructor.professorName;
            const instructorRole = instructor.role;

            // Create URL with parameters for fetching scores
            const url = new URL('http://localhost:8080/instructor/GetDefenseEvalScoreModal');
            url.searchParams.append('projectId', projectId);
            url.searchParams.append('instructorName', instructorName);
            url.searchParams.append('role', instructorRole);

            console.log('Request URL: ', url.toString());

            try {
                // Fetch the score data from the API
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const scoreData = await response.json();
                console.log('Received score data: ', scoreData);

                // ‚úÖ ‡∏ñ‡πâ‡∏≤ `scoreData` ‡πÄ‡∏õ‡πá‡∏ô `[]` ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ `true`
                if (scoreData.length === 0) {
                    console.log(`‚ö†Ô∏è No scores found for Student ${studentId} from Instructor ${instructorName}`);
                    return true; // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô `I`
                }

                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                // const zeroScoreFound = scoreData.some(score => score.studentId === studentId && score.score === 0);
                //
                // if (zeroScoreFound) {
                //     console.log(`‚ö†Ô∏è Zero score found for Student ${studentId} from Instructor ${instructorName}`);
                //     return true; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 0 ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô `I`
                // }

            } catch (error) {
                console.error('Error fetching scores for instructor:', error);
            }
        }

        return false; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 0 ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å instructor ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏ö ‚Üí return false
    }

    // function getStudentName(studentId) {
    //     const evaluationInput = document.querySelector(`input[data-student-id="${studentId}"]`);
    //     return evaluationInput?.dataset?.studentName || studentId;
    // }

    function getStudentName(studentId) {
        const evaluationInput = document.querySelector(`input[data-student-id="${studentId}"]`);
        const fullName = evaluationInput?.dataset?.studentName || studentId;

        // Split the full name into first and last name
        const nameParts = fullName.split(' ');

        if (nameParts.length >= 2) {
            const firstName = nameParts[0];
            const lastName = nameParts[1];

            // Get first 3 characters of last name and add a period
            const shortenedLastName = lastName.substring(0, 3) + '.';

            return `${firstName} ${shortenedLastName}`;
        }

        // If there's no space in the name or other issues, return the original
        return fullName;
    }

</script>

</html>