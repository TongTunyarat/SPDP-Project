<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Evaluation Project</title>

    <!-- CSS -->
    <link rel="stylesheet" href="sidebar-instructor.css">
    <link rel="stylesheet" href="showproject.css">

    <!-- Library -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>
        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                <path
                        d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                </path>
            </svg> Homepage </h4>
            <li><a href="#">Dashboard</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                <g fill="#ffffff" fill-rule="nonzero">
                    <g transform="scale(5.33333,5.33333)">
                        <path
                                d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                        </path>
                    </g>
                </g>
            </svg> Evaluation (40%) </h4>
            <li><a href="/ShowProposalEvaProject.html">Proposal Evaluation</a></li>
            <li><a href="/showPosterEvaProject.html">Poster Evaluation</a></li>
            <li><a href="/showDefenseEvaProject.html">Defense Evaluation</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                <g fill="#ffffff" fill-rule="nonzero">
                    <g transform="scale(5.33333,5.33333)">
                        <path
                                d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                        </path>
                    </g>
                </g>
            </svg> Grades (60%) </h4>
            <li><a href="#">Proposal Grade</a></li>
            <li><a href="#">Defense Grade</a></li>
        </ul>
    </div>

    <div class="content">

        <div class="header-section">
            Proposal Evaluation (40%)
        </div>

        <div class="table-container">
            <h1>Projects</h1>
            <div class="filter-controls">
                <label id="program-select"><strong>Program:</strong></label>
                <select id="program-select-box" name="program">
                    <option value="all" selected>ALL</option>
                    <option value="ict">ICT</option>
                    <option value="dst">DST</option>
                </select>

                <label id="role-select"><strong>Role:</strong></label>
                <select id="role-select-box" name="role">
                    <option value="all" selected>ALL</option>
                    <option value="advisor">Advisor</option>
                    <option value="committee">Committee</option>
                </select>

                <input id="search-keyword" type="text" placeholder="Search" />

<!--                <button id="filter-btn" onclick="applyFilters()">Apply Filter</button>-->
            </div>

<!--            <div id="filter-results"></div>-->

            <table id="result-table">
                <thead>
                <tr>
                    <th>Project ID</th>
                    <th>Project Name</th>
                    <th>Role</th>
                    <th>Student ID</th>
                    <th>Student Names</th>
                    <th>Evaluation</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="filter-results">
                <!-- ผลลัพธ์จะถูกเติมที่นี่ -->
                </tbody>
            </table>

<!--            <table id="filter-results">-->
<!--                <thead>-->
<!--                <tr>-->
<!--                    <th>Project ID</th>-->
<!--                    <th>Project Name</th>-->
<!--                    <th>Role</th>-->
<!--                    <th>Student ID</th>-->
<!--                    <th>Student Names</th>-->
<!--                    <th>Evaluation</th>-->
<!--                    <th>Actions</th>-->
<!--                </tr>-->
<!--                </thead>-->
<!--                <tbody>-->
<!--                <tr>-->
<!--                    <td><span class="tag ict">ICT</span> SP2024-01</td>-->
<!--                    <td>SPDP: Senior Project Management Digital Platform</td>-->
<!--                    <td><span class="role advisor">Advisor</span></td>-->
<!--                    <td>-->
<!--                        <ul>-->
<!--                            <li>6487002</li>-->
<!--                            <li>6487023</li>-->
<!--                            <li>6487069</li>-->
<!--                        </ul>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <ul>-->
<!--                            <li>Tunyarat Nithirunpattana</li>-->
<!--                            <li>Chanyanuch Nuangjumnong</li>-->
<!--                            <li>Neadnapa Tawontaweekul</li>-->
<!--                        </ul>-->
<!--                    </td>-->
<!--                    <td class="evaluation completed"><span class="material-icons">done</span> </td>-->
<!--                    <td class="actions"><span class="material-icons">edit</span></td>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <td><span class="tag dst">DST</span> SP2024-01</td>-->
<!--                    <td>SPDP: Senior Project Management Digital Platform </td>-->
<!--                    <td><span class="role advisor">Advisor</span></td>-->
<!--                    <td>-->
<!--                        <ul>-->
<!--                            <li>6487002</li>-->
<!--                            <li>6487023</li>-->
<!--                            <li>6487069</li>-->
<!--                        </ul>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <ul>-->
<!--                            <li>Tunyarat Nithirunpattana</li>-->
<!--                            <li>Chanyanuch Nuangjumnong</li>-->
<!--                            <li>Neadnapa Tawontaweekul</li>-->
<!--                        </ul>-->
<!--                    </td>-->
<!--                    <td class="evaluation pending"><span class="material-icons">sync</span> </td>-->
<!--                    <td class="actions"><span class="material-icons">edit</span></td>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <td><span class="tag dst">DST</span> SP2024-01</td>-->
<!--                    <td>SPDP: Senior Project Management Digital Platform</td>-->
<!--                    <td><span class="role committee">Committee</span></td>-->
<!--                    <td>-->
<!--                        <ul>-->
<!--                            <li>6487002</li>-->
<!--                            <li>6487023</li>-->
<!--                            <li>6487069</li>-->
<!--                        </ul>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <ul>-->
<!--                            <li>Tunyarat Nithirunpattana</li>-->
<!--                            <li>Chanyanuch Nuangjumnong</li>-->
<!--                            <li>Neadnapa Tawontaweekul</li>-->
<!--                        </ul>-->
<!--                    </td>-->
<!--                    <td class="evaluation completed"><span class="material-icons">done</span> </td>-->
<!--                    <td class="actions"><span class="material-icons" onclick="editAction()">edit</span></td>-->
<!--                </tr>-->
<!--                </tbody>-->
<!--            </table>-->
        </div>

    </div>

</div>
</body>

</html>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        fetchData();
        // ตั้งค่า event listeners สำหรับแต่ละฟิลด์ฟิลเตอร์ เพื่อดูการเปลี่ยนแปลง
        document.getElementById('program-select-box').addEventListener('change', debounce(applyFilters, 100));
        document.getElementById('role-select-box').addEventListener('change', debounce(applyFilters, 100));
        document.getElementById('search-keyword').addEventListener('input', debounce(applyFilters, 100));
    });

    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            // เคลียร์ timeout ที่มีอยู่เดิมก่อน เพื่อหน่วงเวลาการเรียกฟังก์ชัน
            clearTimeout(timeout);

            // ตั้ง timeout ใหม่เพื่อเรียกฟังก์ชันหลังจากดีเลย์ที่กำหนด
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function fetchData() {
        // ตัวอย่าง URL ที่จะดึงข้อมูล
        let url = 'http://localhost:8080/api/filter';  // เปลี่ยน URL ตามที่ใช้

        // ทำการส่งคำขอไปยัง API หรือ Backend
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // แสดงผลข้อมูลที่ได้รับ
                displayResults(data);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('filter-results').innerHTML = "ไม่พบข้อมูล";
            });
    }

    // ฟังก์ชันสำหรับดึงข้อมูลที่กรองตามการกรอกค่าของผู้ใช้
    function applyFilters() {

        // ดึงค่าจากฟิลด์ฟิลเตอร์
        const program = document.getElementById('program-select-box').value;
        const role = document.getElementById('role-select-box').value;
        const searchKeyword = document.getElementById('search-keyword').value;

        // สร้าง URL สำหรับส่งข้อมูลไปยัง API ที่ใช้กรองข้อมูล
        let url = `http://localhost:8080/api/filter?program=${program}&role=${role}`;

        // เพิ่มคำค้นหาถ้ามีการกรอก
        if (searchKeyword) {
            url += `&searchKeyword=${searchKeyword}`;
        }

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log(data);

                // เช็คว่า data เป็น Array หรือไม่
                if (Array.isArray(data)) {
                    displayResults(data); // หากเป็น Array ให้แสดงผล
                } else if (data && data.studentName) {
                    // หากเป็น Object เดียว ให้แปลงเป็น Array ก่อนแล้วแสดงผล
                    displayResults([data]);
                } else {
                    // ถ้า data ไม่ใช่ Array หรือ Object ที่ต้องการ
                    console.error("Expected an array or object, but received:", data);
                    document.getElementById('filter-results').innerHTML = "No data found.";
                }
            })
            .catch(error => {
                console.error("Error fetching data:", error);
                document.getElementById('filter-results').innerHTML = "An error occurred while fetching data.";
            });
    }


    function displayResults(data) {
        let tableBody = document.querySelector("tbody");
        tableBody.innerHTML = "";  // เคลียร์ข้อมูลเก่า

        if (Array.isArray(data)) {
            // สร้าง object สำหรับเก็บข้อมูลที่มี projectId เดียวกัน
            let groupedData = {};

            data.forEach(item => {
                // ตรวจสอบว่ามีข้อมูลใน groupedData สำหรับ projectId นี้อยู่แล้วหรือไม่
                if (!groupedData[item.projectId]) {
                    // ถ้ายังไม่มีข้อมูลของ projectId นี้ใน groupedData ให้สร้างใหม่
                    groupedData[item.projectId] = {
                        program: item.program,
                        projectId: item.projectId,
                        projectTitle: item.projectTitle,
                        role: item.role,
                        studentIds: [],
                        studentNames: []
                    };
                }

                // ตรวจสอบว่า studentId หรือ studentName นี้มีอยู่ในกลุ่มแล้วหรือไม่
                if (!groupedData[item.projectId].studentIds.includes(item.studentId)) {
                    // ถ้าไม่มี studentId นี้ในกลุ่ม ให้เพิ่มลงไป
                    groupedData[item.projectId].studentIds.push(item.studentId);
                }
                if (!groupedData[item.projectId].studentNames.includes(item.studentName)) {
                    // ถ้าไม่มี studentName นี้ในกลุ่ม ให้เพิ่มลงไป
                    groupedData[item.projectId].studentNames.push(item.studentName);
                }
            });

            // แสดงผลข้อมูลที่จัดกลุ่มแล้ว
            for (let projectId in groupedData) {
                let item = groupedData[projectId];
                let row = document.createElement("tr");

                // ตรวจสอบว่า studentIds และ studentNames เป็นอาร์เรย์หรือไม่ ก่อนใช้งาน .map()
                const studentIdsList = Array.isArray(item.studentIds) ? item.studentIds : [item.studentIds];
                const studentNamesList = Array.isArray(item.studentNames) ? item.studentNames : [item.studentNames];

                // สร้างข้อมูลแต่ละเซลล์ในแถว
                row.innerHTML = `
                <td><span class="tag ${item.program.toLowerCase()}">${item.program}</span> ${item.projectId}</td>
                <td>${item.projectTitle}</td>
                <td><span class="role ${item.role.toLowerCase()}">${item.role}</span></td>
                <td>
                    <ul>
                        ${studentIdsList.map(id => `<li>${id}</li>`).join('')}
                    </ul>
                </td>
                <td>
                    <ul>
                        ${studentNamesList.map(name => `<li>${name}</li>`).join('')}
                    </ul>
                </td>
                <td class="evaluation completed"><span class="material-icons">done</span></td>
                <td class="actions"><span class="material-icons" @onClick="editAction">edit</span></td>
            `;

                tableBody.appendChild(row);  // เพิ่มแถวในตาราง
            }
        } else {
            console.error("Data is not an array:", data);
            document.getElementById('filter-results').innerHTML = "No valid data to display.";
        }
    }

    // Function to handle edit action (stub)
    function editAction() {
        alert('Edit action triggered');
    }
</script>