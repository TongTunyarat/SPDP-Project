<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> Dashboard </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/css/sidebar-admin.css">
  <link rel="stylesheet" href="/css/ScheduleDefenseStyle.css">

  <!-- Library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


</head>

<body>

    <!-- Slide bar-->
    <div class="sidebar">
      <h2>ICT MAHIDOL</h2>
      <ul>
        <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
          <path
                  d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
          </path>
        </svg> Homepage </h4>
        <li><a href="/admin-dashboard">Dashboard</a></li>
        <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
        <li><a href="/admin-defense-report">Defense Grade Report</a></li>
        <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
      </ul>

      <h2> Pages </h2>

      <ul>
        <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
          <g fill="#ffffff" fill-rule="nonzero">
            <g transform="scale(5.33333,5.33333)">
              <path
                      d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
              </path>
            </g>
          </g>
        </svg>Score Evaluation </h4>
        <li><a href="#">Scoring Period Settings</a></li>
      </ul>

      <ul>
        <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
          <path
                  d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
          </path>
        </svg> Manage Schedule </h4>
        <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
        <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
        <li><a href="/admin/defenseSchedule" class="active">Defense Schedule</a></li>
        <li><a href="#">Edit Defense Timing</a></li>
      </ul>

      <ul>
        <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
          <path
                  d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
          </path>
        </svg> Manage Project </h4>
        <li><a href="#">Project Overview</a></li>
        <li><a href="#">Project Details</a></li>
        <li><a href="#">Committee</a></li>
        <li><a href="#">Poster Committee</a></li>
      </ul>
    </div>


    <div class="content">
      <div class="header-section">
        <div class="title-group">
          Manage Defense Schedule
        </div>
        <button class="set-btn" id="openModal">Setting</button>
      </div>

      <!-- ===================================================================  Modal =================================================================== -->
      <div class="modal" id="settingModal">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Setting</h4>
          </div>

          <div class="modal-body">
            <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
<!--            <p>CSRF Token: <span th:text="${_csrf.token}">ไม่มีค่า</span></p>-->
            <label>Start Date:</label>
            <input type="date" class="custom-input" id="start-date"/><br>

            <label>End Date:</label>
            <input type="date" class="custom-input" id="end-date"/><br>

<!--            <label>Time Start :</label>-->
<!--            <input type="time" class="custom-input"><br>-->

<!--            <label>End Start :</label>-->
<!--            <input type="time" class="custom-input"><br>-->

<!--            <label>Room: </label>-->
<!--            <div class="dropdown">-->

<!--              <button id="selected-label" onclick="toggleDropdown()">-->
<!--                <span id="selected-text">Select Room </span>-->
<!--                <i class="fa fa-caret-down"></i>-->
<!--              </button>-->

<!--              <div class="dropdown-content upward" id="dropdown-content">-->

<!--                <div class="dropdown-header">-->
<!--                  <div id="back-button" onclick="backToFloors()">-->
<!--                    <span style="font-size: 20px">&larr;</span>-->
<!--                  </div>-->
<!--                  <h4 id="floor-title">Select Floor</h4>-->
<!--                </div>-->

<!--                <div id="search-container">-->
<!--                    <input type="text" id="search" placeholder="Search room" onkeyup="filterRooms()">-->
<!--                </div>-->

<!--                <div id="select-all-container">-->
<!--                  <label><input type="checkbox" id="select-all" onclick="selectAll()"> Select All</label><br>-->
<!--                </div>-->

<!--                  <div id="room-list"></div>-->

<!--              </div>-->
<!--            </div>-->

            <div class="modal-footer">
              <button id="saveBtn">Save</button>
              <button id="cancelBtn">Cancel</button>
            </div>
          </div>

<!--          https://codepen.io/AdamDipinto/pen/ewKxwE-->
          <div class="modal-loader-overlay" id="modalLoaderOverlay" style="display:none;">
            <div class="loader-center">
              <div class="loader">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>

        </div>
      </div>


<!--      ===================================================================  Schedule =================================================================== */-->
      <div class="schedule"></div>
      <div class="button-container">
        <button class="preview-block" onclick="openPreview()">Preview</button>
        <button class="export-block">Export</button>
      </div>
    </div>
</body>

</html>


<script>

  document.addEventListener('DOMContentLoaded', function () {
    console.log("🚀 Load Page");
  });


  // open modal
  document.getElementById("openModal").addEventListener("click", function() {
    console.log("📌 Open modal");
    document.getElementById("settingModal").style.display = "block";
  });

  // close modal
  function closeModal() {
    console.log("❌ Close Modal");
    document.getElementById("settingModal").style.display = "none";

    document.querySelectorAll("input[type='date']").forEach(input => {
      input.value = "";
      input.removeAttribute("min");
      input.removeAttribute("max");
    });

  }

  document.getElementById("cancelBtn").addEventListener("click", closeModal);


  // click out modal
  // https://stackoverflow.com/questions/45393553/window-onclick-functionevent-only-works-for-first-item
  window.onclick = function(event) {
    let modal = document.getElementById("settingModal");

    if (event.target === modal) {
      // console.log("👀 Event: " + event.target);
      // console.dir(event.target);
      // console.log("🙂 Modal: " + modal);
      // console.dir(modal);
      console.log("⛔ คลิกนอก Modal -> ปิด Modal");
      closeModal();
    }

  };

  // date (https://stackoverflow.com/questions/20491326/start-and-end-date-validation-in-html5)
  const startDate = document.querySelector("#start-date");
  const endDate = document.querySelector("#end-date");

  startDate.addEventListener('change', function () {

    if (startDate.value) {
      endDate.min = startDate.value
    }

  }, false);

  endDate.addEventListener('change', function () {

    if (endDate.value) {
      startDate.max = endDate.value
    }

  }, false);

  // https://www.w3schools.com/jsref/tryit.asp?filename=tryjsref_onblur (blur)
  endDate.addEventListener('blur', function () {

    if (endDate.value && startDate.value && endDate.value < startDate.value) {
      Swal.fire({
        icon: "error",
        title: "Sorry!",
        text: "End date cannot be earlier than the Start date.",
        draggable: true,
        confirmButtonColor: "#dc3360"
      });

      endDate.value = "";
      endDate.min = "";
    }

  });

  startDate.addEventListener('blur', function () {

    if (startDate.value && endDate.value && startDate.value > endDate.value) {
      Swal.fire({
        icon: "error",
        title: "Sorry!",
        text: "Start date cannot be more than End date",
        draggable: true,
        confirmButtonColor: "#dc3360"
      });

      startDate.value = "";
      startDate.max = "";
    }

  });


  <!-- ===================================================================  Generate =================================================================== -->

  // send value to controlller
  document.getElementById("saveBtn").addEventListener("click", function () {
    let startDateInput = document.querySelector("input[type='date']");
    let endDateInput = document.querySelectorAll("input[type='date']")[1];

    // console.log("startDateInput:", startDateInput);
    // console.log("endDateInput:", endDateInput);

    let startDate = startDateInput.value;
    let endDate = endDateInput.value;

    if (!startDate || !endDate) {
      Swal.fire({
        icon: "warning",
        title: "Oops...",
        text: "Please fill in all information.",
        draggable: true,
        confirmButtonColor: "#dc7633"
      });
      return;
    }

    //check exits
    fetch(`http://localhost:8080/admin/checkExitsDefenseSchedule`, {

      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    })
            .then(response => response.json())
            .then(data => {

              const exists = data.checkEexti;
              console.log("Schedule exists:", exists);

              if (exists) {

                Swal.fire({
                  icon: "warning",
                  title: "Existing Schedules Found",
                  text: "Projects from this program already have proposal schedules. Please delete existing schedules first.",
                  showConfirmButton: true,
                  confirmButtonColor: "#3085d6",
                  confirmButtonText: "Delete",
                  showCancelButton: true,
                  cancelButtonText: "Cancel",
                  cancelButtonColor: "#d33"
                }) .then((result) => {

                  if (result.isConfirmed) {
                    deleteAllSchedule();
                  }

                });
              } else {
                saveScheduleData();
              }
            })
            .catch(error => {
              console.error('Error:', error);
              Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "Error checking existing schedules!",
              });
            });

    function deleteAllSchedule() {

      fetch(`http://localhost:8080/admin/deleteAllExitsDefenseSchedule`, {

        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })

              .then(response => response.json())
              .then(data => {
                const statusDeleteAll = data.deleteStatus;
                console.log("Schedule success delete:", statusDeleteAll);

                if (statusDeleteAll) {
                  const schedule = document.querySelector(".schedule");
                  const table = document.querySelector("table");
                  schedule.innerHTML = "";

                  Swal.fire({
                    icon: "success",
                    title: "Delete successfully.",
                    showConfirmButton: false,
                    timer: 2000
                  });
                }
              })
              .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                  icon: "error",
                  title: "Oops...",
                  text: "Failed to delete schedules!",
                });
              });
    }

    function saveScheduleData() {
      let settingData = {
        startDate: startDate,
        endDate: endDate,
      };

      console.log("📤 settingData: ", settingData);

      document.getElementById("modalLoaderOverlay").style.display = "flex";

      fetch('http://localhost:8080/admin/bookingSaveDefense', {

        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-TOKEN': csrfToken
        },
        body: JSON.stringify(settingData)

      })
              .then(response =>
                      response.json()
              )
              .then(data => {

                console.log('🌼 Data:', data);

                if (data.status === "error") {

                  document.getElementById("modalLoaderOverlay").style.display = "none";

                  Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.message,
                    showConfirmButton: false,
                    showCancelButton: true,
                    cancelButtonText: "Cancel",
                    cancelButtonColor: "#d33"
                  });
                } else {

                  const schedule = document.querySelector(".schedule");
                  schedule.innerHTML = ""

                  const backgroundSchedule = document.createElement("div");
                  backgroundSchedule.className = "background-schedule";

                  const scheduleContainer = document.createElement("div");
                  scheduleContainer.className = "schedule-contanier";

                  const scheduleHeader = document.createElement("div");
                  scheduleHeader.className = "shedule-header";

                  const dateTitle = document.createElement("h2");
                  dateTitle.className = "date-title";
                  dateTitle.textContent = "Schedule Presentation"

                  scheduleHeader.appendChild(dateTitle);

                  backgroundSchedule.appendChild(scheduleHeader);

                  // ====================================== room =====================================

                  const scheduleTable = document.createElement("div");
                  scheduleTable.className = "schedule-table";

                  const table = document.createElement("table");
                  const thead = document.createElement("thead");
                  const rowHeader = document.createElement("tr");
                  const timeHeader = document.createElement("th");

                  timeHeader.textContent = "Date and Time";
                  timeHeader.className = "time-column";
                  rowHeader.appendChild(timeHeader);

                  const rooms = [...new Set(data.scheduledAssignments.map(proj => proj.roomNumber))];

                  rooms.sort((roomA, roomB) => {

                    const numA = roomA.replace("Room TBA ", "");
                    const numB = roomB.replace("Room TBA ", "");

                    return numA.localeCompare(numB, undefined, { numeric: true });

                  });

                  // console.log("☄️ Sorted Rooms: " + rooms);

                  rooms.forEach(room => {
                    const th = document.createElement("th");
                    th.textContent = room;
                    // console.log("room: "+room);
                    rowHeader.appendChild(th);
                  });

                  thead.appendChild(rowHeader);
                  table.appendChild(thead);

                  let tableBody = document.createElement("tbody");

                  const dateTimeSlots = {};

                  data.scheduledAssignments.forEach(project => {

                    const startTime = new Date(project.startTime);
                    const endTime = new Date(project.endTime);

                    const dateOptions = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
                    const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };

                    const dateStr = startTime.toLocaleDateString('en-US', dateOptions);
                    const timeSlot = `${startTime.toLocaleTimeString('en-US', timeOptions)} - ${endTime.toLocaleTimeString('en-US', timeOptions)}`;

                    const weekday = startTime.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();

                    const dateTimeKey = startTime.getTime(); //1970-01-01T00:00:00Z นับเป็น ms.

                    if(!dateTimeSlots[dateTimeKey]) {

                      dateTimeSlots[dateTimeKey] = {

                        displayText: `<span class="date-display">${dateStr}</span><span class="time-display">${timeSlot}</span>`,
                        projects: {},
                        dayOfWeek: weekday
                      };
                    }

                    dateTimeSlots[dateTimeKey].projects[project.roomNumber] = project;

                  });

                  const sortedDateTimes =  Object.keys(dateTimeSlots).sort((a, b) => {
                    return parseInt(a) - parseInt(b);
                  });

                  console.log("sortedDateTimes: " + JSON.stringify(sortedDateTimes, null, 2))

                  sortedDateTimes.forEach(dateTimeKey => {

                    const slotInfo = dateTimeSlots[dateTimeKey];
                    const row = document.createElement("tr");

                    const dateTimeCell = document.createElement("td");
                    dateTimeCell.className = "time-slot";

                    const dayIndicator = document.createElement("div");
                    dayIndicator.className = "day-indicator";
                    dayIndicator.classList.add(`${slotInfo.dayOfWeek}-indicator`);

                    dateTimeCell.appendChild(dayIndicator);
                    dateTimeCell.innerHTML += slotInfo.displayText;
                    row.appendChild(dateTimeCell);

                    rooms.forEach(room => {

                      const cell = document.createElement("td");
                      const project = slotInfo.projects[room];
                      console.log("project: " + project);

                      // ถ้ามี project ใน timeSlot ที่ loop
                      if (project) {

                        const instructorUsernames = project.instructorUsernames;

                        cell.innerHTML = `

                                <div class="slot-box ${project.status === "Non-Active" ? "non-active" : ''}"><br>
                                <div class="project-id">${project.projectId}</div><br>
                                <div class="instructors"></div>
                               </div>
                                `;

                        let instructorList = '';

                        if (instructorUsernames) {
                          instructorList = instructorUsernames.map(name => `${name}`).join(', ');
                        } else {
                          instructorList = 'No instructors available';
                        }

                        const instructorDiv = cell.querySelector(".instructors");
                        instructorDiv.innerHTML = instructorList;

                      }

                      row.appendChild(cell);

                    });
                    tableBody.appendChild(row);
                  });

                  table.appendChild(tableBody);
                  scheduleTable.appendChild(table);
                  backgroundSchedule.appendChild(scheduleTable);
                  schedule.appendChild(backgroundSchedule);

                  Swal.fire({
                    icon: "success",
                    title: "Data saved successfully.",
                    showConfirmButton: false,
                    timer: 2000
                  });

                  document.getElementById("settingModal").style.display = "none";

                  document.querySelectorAll("input[type='date']").forEach(input => {

                    input.value = "";
                    input.removeAttribute("min");
                    input.removeAttribute("max");

                  });
                }

              }).catch(error => {

        console.error('Error:', error);
        document.getElementById("modalLoaderOverlay").style.display = "none";
        Swal.fire({
          icon: "error",
          title: "Oops...",
          text: "Something went wrong!",
        });
      });
    }

  });

</script>