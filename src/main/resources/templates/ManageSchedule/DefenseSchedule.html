<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> Defense Schedule </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/css/sidebar-admin.css">
  <link rel="stylesheet" href="/css/ScheduleDefenseStyle.css">

  <!-- Library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


</head>

<body>

<!-- Slide bar-->
<div class="sidebar">
  <h2>ICT MAHIDOL</h2>

  <form th:action="@{/logout}" method="post" class="logout-container">
    <!--        ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cross-Site Request Forgery (CSRF)-->
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
  </form>

  <ul>
    <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
      <path
              d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
      </path>
    </svg> Homepage </h4>
    <li><a href="/admin-dashboard">Dashboard</a></li>
    <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
    <li><a href="/admin-defense-report">Defense Grade Report</a></li>
    <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
    <li><a href="/admin-timeliness-scoring">Timeliness Scoring</a></li>
  </ul>

  <h2> Pages </h2>

  <ul>
    <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
      <g fill="#ffffff" fill-rule="nonzero">
        <g transform="scale(5.33333,5.33333)">
          <path
                  d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
          </path>
        </g>
      </g>
    </svg>Score Evaluation </h4>
    <li><a href="/scoring-periods">Scoring Period Settings</a></li>
  </ul>

  <ul>
    <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
      <path
              d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
      </path>
    </svg> Manage Schedule </h4>
    <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
    <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
    <li><a href="/admin/defenseSchedule" class="active">Defense Schedule</a></li>
    <li><a href="/admin/editDefenseSchedulePage">Edit Defense Timing</a></li>
  </ul>

  <ul>
    <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
      <path
              d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
      </path>
    </svg> Manage Project </h4>
    <li><a href="/project-overview">Project Overview</a></li>
    <li><a href="/project-details">Project Details</a></li>
    <li><a href="/project-committee">Committee</a></li>
    <li><a href="/project-poster-committee">Poster Committee</a></li>
  </ul>
</div>



<div class="content">
  <div class="header-section">
    <div class="title-group">
      Manage Defense Schedule
    </div>

    <div class="semester-container">
      <select id="semester-selector" onchange="getScheduleData(); getUnScheduleData();"></select>
    </div>

    <button class="set-btn" id="openModal">Setting</button>
  </div>

  <!-- ===================================================================  Modal =================================================================== -->
  <div class="modal" id="settingModal">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Setting</h4>
      </div>

      <div class="modal-body">
        <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <!--            <p>CSRF Token: <span th:text="${_csrf.token}">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤</span></p>-->
        <!--        <label>Start Date:</label>-->
        <!--        <input type="date" class="custom-input" id="start-date"/><br>-->

        <!--        <label>End Date:</label>-->
        <!--        <input type="date" class="custom-input" id="end-date"/><br>-->


        <div class="date-selection">
          <div class="date-field">
            <label for="start-date">Start Date:</label>
            <input type="date" class="custom-input" id="start-date"/>
          </div>

          <div class="date-field">
            <label for="end-date">End Date:</label>
            <input type="date" class="custom-input" id="end-date"/>
          </div>

          <div class="date-field">
            <label for="session-duration">Session Duration (minutes):</label>
            <input type="number" class="custom-input" id="session-duration" min="1" value="75" oninput="this.value = !!this.value && Math.abs(this.value) >= 1 ? Math.abs(this.value) : null">
          </div>

        </div>

        <div id="time-slots-container" class="hidden">
          <h2>Select Time Slots</h2>
          <div id="days-container"></div>
        </div>

        <div class="modal-footer">
          <button id="saveBtn">Save</button>
          <button id="cancelBtn">Cancel</button>
        </div>
      </div>

    </div>
  </div>

  <!--          https://codepen.io/AdamDipinto/pen/ewKxwE-->
  <div class="modal-loader-overlay" id="modalLoaderOverlay" style="display:none;">
    <div class="loader-center">
      <div class="loader">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>



  <!--      ===================================================================  Schedule =================================================================== */-->
  <div class="schedule"></div>
  <div class="container"></div>

  <div class="button-container">
    <button class="preview-block" onclick="openPreview()">Preview</button>
    <script>
      //https://www.w3schools.com/jsref/met_win_open.asp
      function openPreview(){
        window.open('/admin/previewDefenseSchedulePage', '_blank');
      }
    </script>
    <button class="delete-block" onclick="deleteClickSchedule()">Delete All</button>

    <!--    <button class="export-block">Export</button>-->

    <!--    <script>-->

    <!--      document.querySelector(".export-block").addEventListener("click", function() {-->

    <!--        document.getElementById("modalLoaderOverlay").style.display = "flex";-->
    <!--        console.log("Loader should be visible now");-->

    <!--        fetch(`/admin/exportDefenseSchedule`, {-->
    <!--          method: "GET",-->
    <!--        })-->
    <!--                .then(response => {-->
    <!--                  if (!response.ok){-->
    <!--                    document.getElementById("modalLoaderOverlay").style.display = "none";-->

    <!--                    throw new Error('Network response was not ok ' + response.statusText);-->

    <!--                  }-->

    <!--                  const filename = response.headers.get('content-disposition')-->
    <!--                          .split('filename=')[1]-->
    <!--                          // ‡πÄ‡∏≠‡∏≤ " ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏ä‡∏∑‡πà‡∏≠-->
    <!--                          .replace(/"/g, '');-->

    <!--                  // blob -> Binary Large Object-->
    <!--                  return response.blob().then(blob => {-->
    <!--                    return {blob, filename};-->
    <!--                  });-->

    <!--                })-->
    <!--                .then(data => {-->

    <!--                  // https://stackoverflow.com/questions/19327749/javascript-blob-filename-without-link-->

    <!--                  // temp url-->
    <!--                  const url = window.URL.createObjectURL(data.blob);-->

    <!--                  // <a href="https://example.com">Website</a>-->
    <!--                  const a = document.createElement("a");-->

    <!--                  a.style.display = "none";-->
    <!--                  a.href = url;-->
    <!--                  a.download = data.filename;-->

    <!--                  document.body.appendChild(a);-->
    <!--                  a.click();-->

    <!--                  window.URL.revokeObjectURL(url);-->

    <!--                  document.getElementById("modalLoaderOverlay").style.display = "none";-->

    <!--                  Swal.fire({-->
    <!--                    icon: "success",-->
    <!--                    title: "Export schedule successfully.",-->
    <!--                    showConfirmButton: false,-->
    <!--                    timer: 2000-->
    <!--                  });-->
    <!--                })-->
    <!--                .catch(error => {-->
    <!--                          console.error("Error exporting schedule:", error);-->
    <!--                  document.getElementById("modalLoaderOverlay").style.display = "none";-->

    <!--                  Swal.fire({-->
    <!--                            icon: "error",-->
    <!--                            title: "Oops...",-->
    <!--                            text: "Something went wrong!",-->
    <!--                          });-->
    <!--                        }-->
    <!--                );-->
    <!--      });-->

    <!--    </script>-->


  </div>
</div>
</body>

</html>


<script>

  document.addEventListener('DOMContentLoaded', async function () {
    console.log("üöÄ Load Page");
    await getScheduleData();
    // await fetchData();
    await fetchAcademicYears();

  });


  // open modal
  document.getElementById("openModal").addEventListener("click", function() {
    console.log("üìå Open modal");
    document.getElementById("settingModal").style.display = "block";
  });

  // close modal
  function closeModal() {
    console.log("‚ùå Close Modal");
    document.getElementById("settingModal").style.display = "none";
    daysContainer.innerHTML = '';

    document.querySelectorAll("input[type='date']").forEach(input => {
      input.value = "";
      input.removeAttribute("min");
      input.removeAttribute("max");
    });

    selectedTimeSlots = {};
    timeSlotsContainer.classList.add('hidden');

  }

  document.getElementById("cancelBtn").addEventListener("click", closeModal);


  // click out modal
  // https://stackoverflow.com/questions/45393553/window-onclick-functionevent-only-works-for-first-item
  // window.onclick = function(event) {
  //   let modal = document.getElementById("settingModal");
  //
  //   if (event.target === modal) {
  //     // console.log("üëÄ Event: " + event.target);
  //     // console.dir(event.target);
  //     // console.log("üôÇ Modal: " + modal);
  //     // console.dir(modal);
  //     console.log("‚õî ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å Modal -> ‡∏õ‡∏¥‡∏î Modal");
  //     closeModal();
  //   }
  //
  // };

  // date (https://stackoverflow.com/questions/20491326/start-and-end-date-validation-in-html5)
  const startDate = document.querySelector("#start-date");
  const endDate = document.querySelector("#end-date");
  const timeSlotsContainer = document.querySelector("#time-slots-container");
  const daysContainer = document.querySelector("#days-container");

  let selectedTimeSlots = {};

  startDate.addEventListener('change', function () {

    if (startDate.value) {
      endDate.min = startDate.value
    }

    updateTimeSlots()

  }, false);

  endDate.addEventListener('change', function () {

    if (endDate.value) {
      startDate.max = endDate.value
    }

    updateTimeSlots()

  }, false);

  // https://www.w3schools.com/jsref/tryit.asp?filename=tryjsref_onblur (blur)
  endDate.addEventListener('blur', function () {

    if (endDate.value && startDate.value && endDate.value < startDate.value) {
      Swal.fire({
        icon: "error",
        title: "Sorry!",
        text: "End date cannot be earlier than the Start date.",
        draggable: true,
        confirmButtonColor: "#dc3360"
      });

      endDate.value = "";
      endDate.min = "";
    }

  });

  startDate.addEventListener('blur', function () {

    if (startDate.value && endDate.value && startDate.value > endDate.value) {
      Swal.fire({
        icon: "error",
        title: "Sorry!",
        text: "Start date cannot be more than End date",
        draggable: true,
        confirmButtonColor: "#dc3360"
      });

      startDate.value = "";
      startDate.max = "";
    }

  });



    // ü•πü•πü•πü•πü•πü•πü•π
  function updateTimeSlots() {

    selectedTimeSlots = {};

    if(startDate.value && endDate.value) {
      timeSlotsContainer.classList.remove('hidden');

      const start = new Date(startDate.value);
      const end = new Date(endDate.value);
      console.log("üç≠ start: "+start);

      daysContainer.innerHTML = '';

      let currentDate = new Date(start);
      console.log("currentDate: "+ currentDate);

      while (currentDate <= end) {
        const dayOfWeek = currentDate.getDay();

        if(dayOfWeek !== 0 && dayOfWeek !== 6) {
          // YYYY-MM-DD
          const isoDateString = currentDate.toISOString().split('T')[0];
          const dateOptions = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
          const displayDateString = currentDate.toLocaleDateString('en-US', dateOptions);

          const dayContainer = document.createElement('div');
          dayContainer.className = 'day-container';
          dayContainer.id = `day-${isoDateString}`;

          const dayHeader = document.createElement('div');
          dayHeader.className = 'day-header';
          dayHeader.textContent = `${displayDateString}`;
          dayContainer.appendChild(dayHeader);


          // div ‡πÉ‡∏´‡∏ç‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ù
          const timeSlotsDiv = document.createElement('div');
          timeSlotsDiv.className = 'time-slots';
          timeSlotsDiv.id = `slots-${isoDateString}`;
          dayContainer.appendChild(timeSlotsDiv);

          // if (!selectedTimeSlots[isoDateString]) {
          selectedTimeSlots[isoDateString] = [];
          // }

          const addButton = document.createElement('button');
          addButton.className = 'add-time-btn';
          addButton.textContent = 'Add Time Slot';

          addButton.onclick = function() {

            addEmptyTimeSlot(isoDateString);

          };

          // dayContainer.appendChild(addButton);
          //
          // daysContainer.appendChild(dayContainer);

          const headerContainer = document.createElement('div');
          headerContainer.className = 'header-container';

          const removeDayButton = document.createElement('button');
          removeDayButton.className = 'remove-day-btn';
          removeDayButton.textContent = 'Remove Day';

          removeDayButton.onclick = function() {
            removeDay(isoDateString);
          };

          headerContainer.appendChild(addButton);
          headerContainer.appendChild(removeDayButton);

          dayContainer.appendChild(headerContainer);
          daysContainer.appendChild(dayContainer);

        }

        currentDate.setDate(currentDate.getDate() + 1);
      }
    } else {

      timeSlotsContainer.classList.add('hidden');

    }
  }

  function addEmptyTimeSlot(datString) {

    const newSlot = {
      start: "",
      end: ""
    };

    selectedTimeSlots[datString].push(newSlot);
    // ‡∏≠‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const index = selectedTimeSlots[datString].length -1;
    addTimeSlotToUI(datString, newSlot.start, newSlot.end, index);

  }

  function addTimeSlotToUI(dateString, startTime, endTime, index) {

    // ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡πÄ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡∏ô‡∏∞
    const timeSlotDiv = document.createElement('div');
    timeSlotDiv.className = 'time-slot';
    timeSlotDiv.id = `slot-${dateString}-${index}`;

    const startInput = document.createElement('input');
    startInput.type = 'time';
    startInput.value = startTime;
    startInput.className = 'time-input';
    startInput.id = `start-${dateString}-${index}`;
    startInput.onchange = function () {
      selectedTimeSlots[dateString][index].start = this.value;

      updateEndTimeBasedOnDuration(dateString, index);

      const endInput = document.getElementById(`end-${dateString}-${index}`);

      if (endInput.value && this.value && endInput.value <= this.value) {
        Swal.fire({
          icon: "error",
          title: "Incorrect time",
          text: "End time must be greater than start time.",
          confirmButtonColor: "#dc3360"
        });

        endInput.value = "";
        selectedTimeSlots[dateString][index].end = "";

      }
    };

    const toSpan = document.createElement('span');
    toSpan.textContent = ' to ';
    toSpan.style.margin = '0 8px';

    const endInput = document.createElement('input');
    endInput.type = 'time';
    endInput.value = endTime;
    endInput.className = 'time-input';
    endInput.id = `end-${dateString}-${index}`;
    // closure
    endInput.onchange = function() {
      // const startInput = document.getElementById(`start-${dateString}-${index}`);

      if (startInput.value && this.value && this.value <= startInput.value) {
        Swal.fire({
          icon: "error",
          title: "Incorrect time",
          text: "End time must be greater than start time.",
          confirmButtonColor: "#dc3360"
        });
        this.value = "";

      } else {

        selectedTimeSlots[dateString][index].end = this.value;

      }
    };

    const removeButton = document.createElement('button');
    removeButton.textContent = 'X';
    removeButton.onclick = function () {
      removeTimeSlot(dateString, index);
    };

    timeSlotDiv.appendChild(startInput);
    timeSlotDiv.appendChild(toSpan);
    timeSlotDiv.appendChild(endInput);
    timeSlotDiv.appendChild(removeButton);

    const slotsContainer = document.getElementById(`slots-${dateString}`);
    slotsContainer.appendChild(timeSlotDiv);

  }

  function removeTimeSlot(dateString, index) {

    selectedTimeSlots[dateString].splice(index, 1);

    const slotElement = document.getElementById(`slot-${dateString}-${index}`);

    if(slotElement) {
      slotElement.remove();
    }

    const slotsContainer = document.getElementById(`slots-${dateString}`);
    const remainingSlots = slotsContainer.querySelectorAll('.time-slot');

    remainingSlots.forEach((slot, newIndex) =>{
      // update id ‡πÉ‡∏ô container
      slot.id = `slot-${dateString}-${newIndex}`;

      const removeBtn = slot.querySelector('button');
      const startInput = slot.querySelectorAll('input')[0];
      const endInput = slot.querySelectorAll('input')[1];

      startInput.id = `start-${dateString}-${newIndex}`;
      endInput.id = `end-${dateString}-${newIndex}`;

      removeBtn.onclick = function () {
        removeTimeSlot(dateString, newIndex);
      };

      startInput.onchange = function () {
        selectedTimeSlots[dateString][newIndex].start = this.value;
        updateEndTimeBasedOnDuration(dateString, newIndex);
      }

      endInput.onchange = function () {
        selectedTimeSlots[dateString][newIndex].end = this.value;
      };

    });

  }

  function removeDay(dateString){

    console.log("üìå Before delete day: " + Object.keys(selectedTimeSlots));

    delete selectedTimeSlots[dateString];

    console.log("‚≠êÔ∏è After delete day: " + Object.keys(selectedTimeSlots));

    const dayElement = document.getElementById(`day-${dateString}`);

    if(dayElement) {

      dayElement.remove();

    }

    const remainingDays = Object.keys(selectedTimeSlots).length;

    if(remainingDays === 0) {

      const noDateMessage = document.createElement('div');
      noDateMessage.className = 'no-date-message';
      noDateMessage.textContent = '‚ö†Ô∏è No working days selected. Please adjust your date range. ‚ö†Ô∏è';
      noDateMessage.style.display = 'flex';
      noDateMessage.style.justifyContent = 'center';
      noDateMessage.style.alignItems = 'center';
      noDateMessage.style.fontSize = '1rem';
      noDateMessage.style.marginBottom = '2rem';
      daysContainer.appendChild(noDateMessage);

    }


  }

  const durationInput = document.getElementById('session-duration');

  durationInput.addEventListener('change', function () {

    Object.keys(selectedTimeSlots).forEach(dateString => {

      selectedTimeSlots[dateString].forEach((slot, index) => {

        if(slot.start) {
          updateEndTimeBasedOnDuration(dateString, index);
        }
      });
    });
  });

  function updateEndTimeBasedOnDuration(dateString, index) {

    const startTimeInput = document.getElementById(`start-${dateString}-${index}`);
    const endTimeInput = document.getElementById(`end-${dateString}-${index}`);
    const durationInput = document.getElementById('session-duration');

    if(startTimeInput.value && durationInput.value) {

      const [startHours, startMinutes] = startTimeInput.value.split(':').map(Number);

      const startDate = new Date();
      startDate.setHours(startHours, startMinutes, 0);

      // 1 ‡∏ô‡∏≤‡∏ó‡∏µ = 60000 ms
      const endDate = new Date(startDate.getTime() + parseInt(durationInput.value) * 60000);

      // if(endDate.getDay() !== startDate.getDay() +1) {
      //
      //   const endHours = endDate.getHours().toString().padStart(2, '0');
      //   const endMinutes = endDate.getMinutes().toString().padStart(2, '0');
      //   const endTimeString = `${endHours}:${endMinutes}`;
      //
      //   endTimeInput.value = endTimeString;
      //   selectedTimeSlots[dateString][index].end = endTimeString;
      // }

      // https://www.w3schools.com/jsref/tryit.asp?filename=tryjsref_string_padding1
      const endHours = endDate.getHours().toString().padStart(2, '0');
      const endMinutes = endDate.getMinutes().toString().padStart(2, '0');
      const endTimeString = `${endHours}:${endMinutes}`;

      endTimeInput.value = endTimeString;
      selectedTimeSlots[dateString][index].end = endTimeString;

    }
  }

  <!-- ===================================================================  Generate =================================================================== -->

  function getCsrfToken() {

    let tokenInput = document.getElementById("csrfToken");

    if (tokenInput && tokenInput.value) {
      return tokenInput.value;
    }

    console.error("‚õî CSRF token not found.");
    return "dummy-token";
  }

  // send value to controlller
  document.getElementById("saveBtn").addEventListener("click", function () {
    let startDateInput = document.querySelector("input[type='date']");
    let endDateInput = document.querySelectorAll("input[type='date']")[1];

    const semesterYear = document.getElementById("semester-selector").value;

    // console.log("startDateInput:", startDateInput);
    // console.log("endDateInput:", endDateInput);

    let startDate = startDateInput.value;
    let endDate = endDateInput.value;

    if (!startDate || !endDate) {
      Swal.fire({
        icon: "warning",
        title: "Oops...",
        text: "Please fill in all information.",
        draggable: true,
        confirmButtonColor: "#dc7633"
      });
      return;
    }


    let csrfToken = getCsrfToken();
    console.log("üëÄ CSRF Token: ", csrfToken);

    if (!csrfToken || csrfToken === "dummy-token") {
      alert("CSRF Token Invalid‚ùóÔ∏è");
      return;
    }

    //check exits
    fetch(`http://localhost:8080/admin/checkExitsDefenseSchedule?semesterYear=${encodeURIComponent(semesterYear)}`, {

      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    })
            .then(response => response.json())
            .then(data => {

              const exists = data.checkEexti;
              console.log("Schedule exists:", exists);

              if (exists) {

                Swal.fire({
                  icon: "warning",
                  title: "Existing Schedules Found",
                  text: "Projects from this program already have proposal schedules. Please delete existing schedules first.",
                  showConfirmButton: true,
                  confirmButtonColor: "#3085d6",
                  confirmButtonText: "Delete",
                  showCancelButton: true,
                  cancelButtonText: "Cancel",
                  cancelButtonColor: "#d33"
                }) .then((result) => {

                  if (result.isConfirmed) {
                    deleteAllSchedule();
                  }

                });
              } else {
                checkValidData();
              }
            })
            .catch(error => {
              console.error('Error:', error);
              Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "Error checking existing schedules!",
              });
            });

    function deleteAllSchedule() {

      fetch(`http://localhost:8080/admin/deleteAllExitsDefenseSchedule?semesterYear=${encodeURIComponent(semesterYear)}`, {

        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })

              .then(response => response.json())
              .then(data => {
                const statusDeleteAll = data.deleteStatus;
                console.log("Schedule success delete:", statusDeleteAll);

                if (statusDeleteAll) {
                  const schedule = document.querySelector(".schedule");
                  const container = document.querySelector(".container");
                  const table = document.querySelector("table");
                  schedule.innerHTML = "";
                  container.innerHTML = ""

                  Swal.fire({
                    icon: "success",
                    title: "Delete successfully.",
                    showConfirmButton: false,
                    timer: 2000
                  });

                  getScheduleData()
                }
              })
              .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                  icon: "error",
                  title: "Oops...",
                  text: "Failed to delete schedules!",
                });
              });
    }

    function checkValidData() {

      const currentDates = Object.keys(selectedTimeSlots);

      if (currentDates.length === 0) {
        return Swal.fire({
          icon: "error",
          title: "No Dates Selected",
          text: "Please select a date range first.",
          confirmButtonColor: "#dc3360"
        });
      }

      for (const dateString of currentDates) {
        const slots = selectedTimeSlots[dateString];

        // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ slot ‡πÄ‡∏•‡∏¢
        if (slots.length === 0) {
          return Swal.fire({
            icon: "error",
            title: "No Time Slots",
            text: `Please add at least one time slot for ${dateString}.`,
            confirmButtonColor: "#dc3360"
          });
        }

        //  ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ slot ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
        for (const slot of slots) {
          if (!slot.start || !slot.end) {
            return Swal.fire({
              icon: "error",
              title: "Incomplete Time Slots",
              text: `Please fill in all start and end times for ${dateString}.`,
              confirmButtonColor: "#dc3360"
            });
          }
        }
      }

      saveScheduleData();
    }


    function saveScheduleData() {

      let settingData = {
        startDate: startDate,
        endDate: endDate,
        semesterYear: semesterYear,
        timeSlots: selectedTimeSlots
      };

      console.log("üì§ settingData: ", settingData);

      document.getElementById("modalLoaderOverlay").style.display = "flex";

      fetch(`http://localhost:8080/admin/bookingSaveDefense?semesterYear=${encodeURIComponent(semesterYear)}`, {

        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-TOKEN': csrfToken
        },
        body: JSON.stringify(settingData)

      })
              .then(response =>
                      response.json()
              )
              .then(data => {

                console.log('üåº Data:', data);

                if (data.status === "error") {

                  document.getElementById("modalLoaderOverlay").style.display = "none";

                  Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.message,
                    showConfirmButton: false,
                    showCancelButton: true,
                    cancelButtonText: "Cancel",
                    cancelButtonColor: "#d33"
                  });
                } else {

                  const schedule = document.querySelector(".schedule");
                  schedule.innerHTML = ""

                  const backgroundSchedule = document.createElement("div");
                  backgroundSchedule.className = "background-schedule";

                  const scheduleContainer = document.createElement("div");
                  scheduleContainer.className = "schedule-contanier";

                  const scheduleHeader = document.createElement("div");
                  scheduleHeader.className = "shedule-header";

                  const dateTitle = document.createElement("h2");
                  dateTitle.className = "date-title";
                  dateTitle.textContent = "Schedule Presentation"

                  scheduleHeader.appendChild(dateTitle);

                  backgroundSchedule.appendChild(scheduleHeader);

                  // ====================================== room =====================================

                  const scheduleTable = document.createElement("div");
                  scheduleTable.className = "schedule-table";

                  const table = document.createElement("table");
                  const thead = document.createElement("thead");
                  const rowHeader = document.createElement("tr");
                  const timeHeader = document.createElement("th");

                  timeHeader.textContent = "Date and Time";
                  timeHeader.className = "time-column";
                  rowHeader.appendChild(timeHeader);

                  const rooms = [...new Set(data.scheduledAssignments.map(proj => proj.roomNumber))];

                  rooms.sort((roomA, roomB) => {

                    const numA = roomA.replace("Room TBA ", "");
                    const numB = roomB.replace("Room TBA ", "");

                    return numA.localeCompare(numB, undefined, { numeric: true });

                  });

                  // console.log("‚òÑÔ∏è Sorted Rooms: " + rooms);

                  rooms.forEach(room => {
                    const th = document.createElement("th");
                    th.textContent = room;
                    // console.log("room: "+room);
                    rowHeader.appendChild(th);
                  });

                  thead.appendChild(rowHeader);
                  table.appendChild(thead);

                  let tableBody = document.createElement("tbody");

                  const dateTimeSlots = {};

                  data.scheduledAssignments.forEach(project => {

                    const startTime = new Date(project.startTime);
                    const endTime = new Date(project.endTime);

                    const dateOptions = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
                    const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };

                    const dateStr = startTime.toLocaleDateString('en-US', dateOptions);
                    const timeSlot = `${startTime.toLocaleTimeString('en-US', timeOptions)} - ${endTime.toLocaleTimeString('en-US', timeOptions)}`;

                    const weekday = startTime.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();

                    const dateTimeKey = startTime.getTime(); //1970-01-01T00:00:00Z ‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ms.

                    if(!dateTimeSlots[dateTimeKey]) {

                      dateTimeSlots[dateTimeKey] = {

                        displayText: `
                                  <div class="date-time-container">
                                    <span class="date-display">${dateStr}</span>
                                    <span class="time-display">${timeSlot}</span>
                                  </div>
                                `,
                        projects: {},
                        dayOfWeek: weekday
                      };
                    }

                    dateTimeSlots[dateTimeKey].projects[project.roomNumber] = project;

                  });

                  const sortedDateTimes =  Object.keys(dateTimeSlots).sort((a, b) => {
                    return parseInt(a) - parseInt(b);
                  });

                  console.log("sortedDateTimes: " + JSON.stringify(sortedDateTimes, null, 2))

                  sortedDateTimes.forEach(dateTimeKey => {

                    const slotInfo = dateTimeSlots[dateTimeKey];
                    const row = document.createElement("tr");

                    const dateTimeCell = document.createElement("td");
                    dateTimeCell.className = "time-slot";

                    const dayIndicator = document.createElement("div");
                    dayIndicator.className = "day-indicator";
                    dayIndicator.classList.add(`${slotInfo.dayOfWeek}-indicator`);

                    dateTimeCell.appendChild(dayIndicator);
                    dateTimeCell.innerHTML += slotInfo.displayText;
                    row.appendChild(dateTimeCell);

                    rooms.forEach(room => {

                      const cell = document.createElement("td");
                      const project = slotInfo.projects[room];
                      console.log("project: " + project);

                      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ project ‡πÉ‡∏ô timeSlot ‡∏ó‡∏µ‡πà loop
                      if (project) {

                        const instructorUsernames = project.instructorUsernames;

                        cell.innerHTML = `

                                <div class="slot-box ${project.status === "Edit-Active" ? "edit-active" : ''}"><br>
                                <div class="project-id">${project.projectId}</div><br>
                                <div class="instructors"></div>
                               </div>
                                `;

                        let instructorList = '';

                        if (instructorUsernames) {
                          instructorList = instructorUsernames.map(name => `${name}`).join(', ');
                        } else {
                          instructorList = 'No instructors available';
                        }

                        const instructorDiv = cell.querySelector(".instructors");
                        instructorDiv.innerHTML = instructorList;

                      }

                      row.appendChild(cell);

                    });
                    tableBody.appendChild(row);
                  });

                  table.appendChild(tableBody);
                  scheduleTable.appendChild(table);
                  backgroundSchedule.appendChild(scheduleTable);
                  schedule.appendChild(backgroundSchedule);

                  if (Array.isArray(data.unscheduledProjects) && data.unscheduledProjects.length >0) {

                    const container = document.querySelector(".container");
                    container.innerHTML = ""

                    const backgroundUnSchedule = document.createElement("div");
                    backgroundUnSchedule.className = "unscheduled-projects";

                    const headerUnSchedule = document.createElement("div");
                    headerUnSchedule.className = "header";
                    headerUnSchedule.innerHTML =  `
                           <i class="fa-solid fa-calendar-xmark"></i>
                           Unscheduled Project `;

                    backgroundUnSchedule.appendChild(headerUnSchedule);

                    const warningHeader = document.createElement("div");
                    warningHeader.className = "warning-header";
                    warningHeader.innerHTML = `
                        <i class="fa-solid fa-triangle-exclamation warning-icon"></i>
                        <div class="warning-text">The following projects could not be scheduled due to insufficient rooms or time slots.</div>
                      `;
                    backgroundUnSchedule.appendChild(warningHeader);

                    const projectsList = document.createElement("div");
                    projectsList.className = "projects-list";

                    const sortedProjects = data.unscheduledProjects.sort((a, b) => {

                      const projectIdA = a.project.projectId;
                      const projectIdB = b.project.projectId;

                      return projectIdA.localeCompare(projectIdB);

                    });


                    sortedProjects.forEach(item => {

                      const project = item.project;
                      const instructorUsernames = item.instructorUsernames;

                      const projectItem = document.createElement("div");
                      projectItem.className = "project-item";

                      const projectHeader = document.createElement("div");
                      projectHeader.className = "project-header";

                      const projectId = document.createElement("div");
                      projectId.className = "project-id-new";
                      projectId.textContent = project.projectId;

                      const tagContainer = document.createElement("div");
                      tagContainer.className = "tag-container";

                      const categoryTag = document.createElement("span");
                      categoryTag.className = "tag tag-proposal";
                      categoryTag.textContent = "Proposal";
                      tagContainer.appendChild(categoryTag);

                      const programTag = document.createElement("span");
                      programTag.className = `tag tag-${project.program.toLowerCase()}`;
                      programTag.textContent = project.program;
                      tagContainer.appendChild(programTag);

                      projectHeader.appendChild(projectId);
                      projectHeader.appendChild(tagContainer);

                      // Title
                      const projectTitle = document.createElement("div");
                      projectTitle.className = "project-title";
                      projectTitle.textContent = project.projectTitle;

                      // Instructors
                      const instructorSection = document.createElement("div");
                      instructorSection.className = "instructor-section";

                      const instructorLabel = document.createElement("div");
                      instructorLabel.className = "instructor-label";
                      instructorLabel.textContent = "Instructors:";

                      const instructorsList = document.createElement("div");
                      instructorsList.className = "instructors-list";
                      instructorUsernames.forEach(name => {

                        const instructorChip = document.createElement("div");
                        instructorChip.className = "instructor-chip";
                        instructorChip.innerHTML = `<i class="fa-solid fa-user"></i> &nbsp; ${name}`;
                        instructorsList.appendChild(instructorChip);
                      });

                      instructorSection.appendChild(instructorLabel);
                      instructorSection.appendChild(instructorsList);

                      projectItem.appendChild(projectHeader);
                      projectItem.appendChild(projectTitle);
                      projectItem.appendChild(instructorSection);

                      projectsList.appendChild(projectItem);
                    });

                    backgroundUnSchedule.appendChild(projectsList);
                    container.appendChild(backgroundUnSchedule);

                  }

                  Swal.fire({
                    icon: "success",
                    title: "Data saved successfully.",
                    showConfirmButton: false,
                    timer: 2000
                  });

                  document.getElementById("modalLoaderOverlay").style.display = "none";

                  document.getElementById("settingModal").style.display = "none";

                  document.querySelectorAll("input[type='date']").forEach(input => {

                    input.value = "";
                    input.removeAttribute("min");
                    input.removeAttribute("max");

                  });

                  selectedTimeSlots = {};
                  timeSlotsContainer.classList.add('hidden');
                }

              }).catch(error => {

        console.error('Error:', error);
        document.getElementById("modalLoaderOverlay").style.display = "none";
        Swal.fire({
          icon: "error",
          title: "Oops...",
          text: "Something went wrong!",
        });
      });
    }

  });

  <!-- ===================================================================  Get Schedule =================================================================== -->
  // change format
  function formatDate(formatDate) {

    const collectDate = [];

    formatDate.forEach(getDay => {

      const dateObj = new Date(getDay);

      //https://stackoverflow.com/questions/3552461/how-do-i-format-a-date-in-javascript/60881661
      let nameDay = dateObj.toLocaleDateString('en-us', {weekday: 'long'})
      let month = dateObj.toLocaleDateString('en-us', {month: 'long'})
      let date = dateObj.toLocaleDateString('en-us', {day: 'numeric'})
      let year = dateObj.toLocaleDateString('en-us', {year: 'numeric'})

      const FormattedDate = `${nameDay}, ${month} ${date}, ${year}`

      collectDate.push(FormattedDate);

    });

    return collectDate;
  }


  function getScheduleData() {
    document.getElementById("modalLoaderOverlay").style.display = "flex";

    const semesterYear = document.getElementById("semester-selector").value;

    fetch(`http://localhost:8080/admin/getAllDefenseSchedule?semesterYear=${encodeURIComponent(semesterYear)}`, {

      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(response => {
      // console.log(response.json());
      if (!response.ok) {
        document.getElementById("modalLoaderOverlay").style.display = "none";

        throw new Error('Network response was not ok ' + response.statusText);
        /*
                alert('Network response was not ok ' + response.statusText);
        */
      }
      return response.json();
    })
            .then(data => {
              // console.log("Show Data: " + JSON.stringify(data, null, 2));

              if (JSON.stringify(data) === "{}") {

                const schedule = document.querySelector(".schedule");
                schedule.innerHTML = "";

                const backgroundSchedule = document.createElement("div");
                backgroundSchedule.className = "background-schedule";

                const emptyScheduleImage = document.createElement("img");
                emptyScheduleImage.className = "empty-state-image";
                emptyScheduleImage.src = "/css/warning_schedule-Photoroom.png"

                backgroundSchedule.appendChild(emptyScheduleImage);

                schedule.appendChild(backgroundSchedule);
                document.getElementById("modalLoaderOverlay").style.display = "none";
              } else {

                let rooms = new Set();
                let dates = new Set();

                for(const date in data) {
                  const timeSlots =  data[date];
                  dates.add(date);

                  for(const timeSlot in timeSlots) {
                    const  project = timeSlots[timeSlot];

                    for(const i of project) {
                      rooms.add(i.roomNumber);
                    }
                  }
                }

                rooms.delete("noRoom")

                console.log("‚≠êÔ∏è Room: " + Array.from(rooms));

                let myRooms = [];

                //https://www.geeksforgeeks.org/how-to-sort-a-set-in-javascript/
                myRooms = Array.from(rooms)
                myRooms.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
                console.log("Room sort: " + myRooms);

                myDate = Array.from(dates)
                myDate.sort()
                console.log("Date sort: " + myDate);

                // ====================================== call list date =====================================

                const getDateFormat = formatDate(myDate).sort((a, b) => new Date(a) - new Date(b));
                console.log("üóìÔ∏è List of Date: " +  getDateFormat);

                const schedule = document.querySelector(".schedule");
                schedule.innerHTML = ""

                const backgroundSchedule = document.createElement("div");
                backgroundSchedule.className = "background-schedule";

                const scheduleContainer = document.createElement("div");
                scheduleContainer.className = "schedule-contanier";

                const scheduleHeader = document.createElement("div");
                scheduleHeader.className = "shedule-header";

                const dateTitle = document.createElement("h2");
                dateTitle.className = "date-title";
                dateTitle.textContent = "Schedule Presentation"

                scheduleHeader.appendChild(dateTitle);

                backgroundSchedule.appendChild(scheduleHeader);

                // ====================================== room =====================================

                const scheduleTable = document.createElement("div");
                scheduleTable.className = "schedule-table";

                const table = document.createElement("table");
                const thead = document.createElement("thead");
                const rowHeader = document.createElement("tr");
                const timeHeader = document.createElement("th");

                timeHeader.textContent = "Date and Time";
                timeHeader.className = "time-column";
                rowHeader.appendChild(timeHeader);

                myRooms.forEach(room => {
                  const th = document.createElement("th");
                  th.textContent = room;
                  console.log("-_- room: "+room);
                  rowHeader.appendChild(th);
                });

                thead.appendChild(rowHeader);
                table.appendChild(thead);

                let tableBody = document.createElement("tbody");

                const dateTimeSlots = {};

                Object.entries(data).forEach(([date, timeSlots]) => {

                  Object.entries(timeSlots).forEach(([timeSlot, projects]) => {

                    projects.forEach(project => {
                      const startTime = new Date(`${project.date}T${project.startTime}`);
                      const endTime = new Date(`${project.date}T${project.endTime}`);

                      const dateOptions = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
                      const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };

                      const dateStr = startTime.toLocaleDateString('en-US', dateOptions);
                      const timeSlot = `${startTime.toLocaleTimeString('en-US', timeOptions)} - ${endTime.toLocaleTimeString('en-US', timeOptions)}`;

                      const weekday = startTime.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();

                      const dateTimeKey = startTime.getTime(); //1970-01-01T00:00:00Z ‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ms.

                      if(!dateTimeSlots[dateTimeKey]) {

                        dateTimeSlots[dateTimeKey] = {

                          displayText: `
                                  <div class="date-time-container">
                                    <span class="date-display">${dateStr}</span>
                                    <span class="time-display">${timeSlot}</span>
                                  </div>
                                `,
                          projects: {},
                          dayOfWeek: weekday
                        };
                      }

                      dateTimeSlots[dateTimeKey].projects[project.roomNumber] = project;

                    });
                  });
                });

                const sortedDateTimes =  Object.keys(dateTimeSlots).sort((a, b) => {
                  return parseInt(a) - parseInt(b);
                });

                console.log("sortedDateTimes: " + JSON.stringify(sortedDateTimes, null, 2))

                sortedDateTimes.forEach(dateTimeKey => {

                  const slotInfo = dateTimeSlots[dateTimeKey];
                  const row = document.createElement("tr");

                  const dateTimeCell = document.createElement("td");
                  dateTimeCell.className = "time-slot";

                  const dayIndicator = document.createElement("div");
                  dayIndicator.className = "day-indicator";
                  dayIndicator.classList.add(`${slotInfo.dayOfWeek}-indicator`);

                  dateTimeCell.appendChild(dayIndicator);
                  dateTimeCell.innerHTML += slotInfo.displayText;
                  row.appendChild(dateTimeCell);

                  myRooms.forEach(room => {

                    const cell = document.createElement("td");
                    const project = slotInfo.projects[room];
                    console.log("project: " + project);

                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ project ‡πÉ‡∏ô timeSlot ‡∏ó‡∏µ‡πà loop
                    if (project) {

                      const instructorUsernames = project.instructors;

                      cell.innerHTML = `

                                <div class="slot-box ${project.status === "Edit-Active" ? "edit-active" : ''}"><br>
                                <div class="project-id">${project.projectId}</div><br>
                                <div class="instructors"></div>
                               </div>
                                `;

                      let instructorList = '';

                      if (instructorUsernames) {
                        instructorList = instructorUsernames.map(name => `${name}`).join(', ');
                      } else {
                        instructorList = 'No instructors available';
                      }

                      const instructorDiv = cell.querySelector(".instructors");
                      instructorDiv.innerHTML = instructorList;

                    }

                    row.appendChild(cell);

                  });
                  tableBody.appendChild(row);
                });


                table.appendChild(tableBody);
                scheduleTable.appendChild(table);
                backgroundSchedule.appendChild(scheduleTable);
                schedule.appendChild(backgroundSchedule);

                getUnScheduleData()
                document.getElementById("modalLoaderOverlay").style.display = "none";

              }
            })

            .catch(error => {
              console.error('Error fetching data:', error);
              document.getElementById("modalLoaderOverlay").style.display = "none";

              Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "Something went wrong!",
              });
            });
  }

  function getUnScheduleData() {

    const semesterYear = document.getElementById("semester-selector").value;

    fetch(`http://localhost:8080/admin/getAllDefenseUnSchedule?semesterYear=${encodeURIComponent(semesterYear)}`, {

      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(response => {
      // console.log(response.json());
      if (!response.ok) {

        const container = document.querySelector(".container");
        container.innerHTML = ""
        return;

        throw new Error('Network response was not ok ' + response.statusText);
        alert('Network response was not ok ' + response.statusText);
      }
      return response.json();
    })
            .then(data => {
              console.log("ü§Ø data: " + data);

              const container = document.querySelector(".container");
              container.innerHTML = ""

              if (Array.isArray(data) && data.length >0) {

                // const container = document.querySelector(".container");
                // container.innerHTML = ""

                const backgroundUnSchedule = document.createElement("div");
                backgroundUnSchedule.className = "unscheduled-projects";

                const headerUnSchedule = document.createElement("div");
                headerUnSchedule.className = "header";
                headerUnSchedule.innerHTML =  `
                           <i class="fa-solid fa-calendar-xmark"></i>
                           Unscheduled Project `;

                backgroundUnSchedule.appendChild(headerUnSchedule);

                const warningHeader = document.createElement("div");
                warningHeader.className = "warning-header";
                warningHeader.innerHTML = `
                        <i class="fa-solid fa-triangle-exclamation warning-icon"></i>
                        <div class="warning-text">The following projects could not be scheduled due to insufficient rooms or time slots.</div>
                      `;
                backgroundUnSchedule.appendChild(warningHeader);

                const projectsList = document.createElement("div");
                projectsList.className = "projects-list";

                const sortedProjects = data.sort((a, b) => {

                  const projectIdA = a.projectId;
                  const projectIdB = b.projectId;

                  return projectIdA.localeCompare(projectIdB);

                });


                sortedProjects.forEach(item => {

                  const projectItem = document.createElement("div");
                  projectItem.className = "project-item";

                  const projectHeader = document.createElement("div");
                  projectHeader.className = "project-header";

                  const projectId = document.createElement("div");
                  projectId.className = "project-id-new";
                  projectId.textContent = item.projectId;

                  const tagContainer = document.createElement("div");
                  tagContainer.className = "tag-container";

                  const categoryTag = document.createElement("span");
                  categoryTag.className = "tag tag-proposal";
                  categoryTag.textContent = "Proposal";
                  tagContainer.appendChild(categoryTag);

                  const programTag = document.createElement("span");
                  programTag.className = `tag tag-${item.program.toLowerCase()}`;
                  programTag.textContent = item.program;
                  tagContainer.appendChild(programTag);

                  projectHeader.appendChild(projectId);
                  projectHeader.appendChild(tagContainer);

                  // Title
                  const projectTitle = document.createElement("div");
                  projectTitle.className = "project-title";
                  projectTitle.textContent = item.projectTitle;

                  // Instructors
                  const instructorSection = document.createElement("div");
                  instructorSection.className = "instructor-section";

                  const instructorLabel = document.createElement("div");
                  instructorLabel.className = "instructor-label";
                  instructorLabel.textContent = "Instructors:";

                  const instructorsList = document.createElement("div");
                  instructorsList.className = "instructors-list";
                  item.instructors.forEach(name => {

                    const instructorChip = document.createElement("div");
                    instructorChip.className = "instructor-chip";
                    instructorChip.innerHTML = `<i class="fa-solid fa-user"></i> &nbsp; ${name}`;
                    instructorsList.appendChild(instructorChip);
                  });

                  instructorSection.appendChild(instructorLabel);
                  instructorSection.appendChild(instructorsList);

                  projectItem.appendChild(projectHeader);
                  projectItem.appendChild(projectTitle);
                  projectItem.appendChild(instructorSection);

                  projectsList.appendChild(projectItem);
                });

                backgroundUnSchedule.appendChild(projectsList);
                container.appendChild(backgroundUnSchedule);

              }

            })
            .catch(error => {
              console.error('Error fetching data:', error);
              document.getElementById("modalLoaderOverlay").style.display = "none";

              Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "Something went wrong generate unschedule!",
              });
            });
  }

</script>

<!-- ----------- Set Header Value -------------- -->
<script>
  // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Dropdown (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ)
  const semesterSelect = document.getElementById("semester-selector");
  semesterSelect.addEventListener("change", function () {
    console.log("Selected Semester:", semesterSelect.value);

    localStorage.setItem("selectedSemester", semesterSelect.value);
    // fetchGradeDistribution();
    // fetchEvaluationStatus();
    // fetchTeacherScoringData();

    getScheduleData();
    getUnScheduleData();
  });

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners
  document.addEventListener("DOMContentLoaded", function () {
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö semester selector
    const semesterSelect = document.getElementById("semester-selector");
    semesterSelect.addEventListener("change", function () {
      console.log("Selected Semester:", semesterSelect.value);
    });
  });
</script>

<!-- --------- Semester Change ------------- -->
<script>
  async function fetchAcademicYears() {
    try {
      const response = await fetch('/api/academic-years'); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
      const data = await response.json();

      console.log("Year: ", data);

      const semesterSelector = document.getElementById('semester-selector');
      semesterSelector.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà

      data.forEach(year => {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = "üìÜ "+year;
        // option.innerHTML = `<!--<i class='far fa-calendar'></i> ${year} <i class='fas fa-chevron-down dropdown-arrow'></i>-->`;
        semesterSelector.appendChild(option);
      });

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth() + 1; // getMonth() ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0-11 (‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° = 0, ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° = 11)

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <= 6 (‡∏°.‡∏Ñ. - ‡∏°‡∏¥.‡∏¢.) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -1, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏Å.‡∏Ñ. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const defaultYear = currentMonth <= 8 ? currentYear - 1 : currentYear;

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      // if (data.includes(defaultYear.toString())) {
      //   semesterSelector.value = defaultYear.toString();
      //   console.log("yearrrrrrrrrrrrrr : ",document.getElementById('semester-selector').value)
      // } else {
      //   semesterSelector.selectedIndex = 0; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÅ‡∏ó‡∏ô
      // }

      const savedSemester = localStorage.getItem("selectedSemester");

      if (savedSemester && data.includes(savedSemester)) {
        semesterSelector.value = savedSemester;
      } else if (data.includes(defaultYear.toString())) {
        semesterSelector.value = defaultYear.toString();
      } else {
        semesterSelector.selectedIndex = 0;
      }

      await getScheduleData();
      await getUnScheduleData();

    } catch (error) {
      console.error("Error fetching academic years:", error);
    }
  }
  fetchAcademicYears();

  function deleteClickSchedule() {
    Swal.fire({
      icon: "warning",
      title: "Do you want to delete schedule",
      showConfirmButton: true,
      confirmButtonColor: "#3085d6",
      confirmButtonText: "Delete",
      showCancelButton: true,
      cancelButtonText: "Cancel",
      cancelButtonColor: "#d33"
    }).then((result) => {

      if (result.isConfirmed) {
        const semesterYear = document.getElementById("semester-selector").value;

        fetch(`http://localhost:8080/admin/deleteAllExitsDefenseSchedule?semesterYear=${encodeURIComponent(semesterYear)}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })
                .then(response => response.json())
                .then(data => {
                  const statusDeleteAll = data.deleteStatus;
                  console.log("Schedule success delete:", statusDeleteAll);

                  if (statusDeleteAll) {
                    const schedule = document.querySelector(".schedule");
                    const container = document.querySelector(".container");
                    const table = document.querySelector("table");
                    schedule.innerHTML = "";
                    container.innerHTML = "";

                    Swal.fire({
                      icon: "success",
                      title: "Delete successfully.",
                      showConfirmButton: false,
                      timer: 2000
                    })

                    getScheduleData();
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Failed to delete schedules!",
                  });
                });
      }
    });
  }

</script>