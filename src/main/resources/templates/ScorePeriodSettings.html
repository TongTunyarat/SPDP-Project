<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Score Period Settings</title>

  <!-- CSS -->
  <link rel="stylesheet" href="/css/sidebar-admin.css">
  <link rel="stylesheet" href="/css/ScorePeriodSetting.css">

  <!-- Calendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2>ICT MAHIDOL</h2>

    <form th:action="@{/logout}" method="post" class="logout-container">
      <!--        ค่าที่ใช้สำหรับป้องกัน Cross-Site Request Forgery (CSRF)-->
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
    </form>

    <ul>
      <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
        <path
                d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
        </path>
      </svg> Homepage </h4>
      <li><a href="/admin-dashboard">Dashboard</a></li>
      <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
      <li><a href="/admin-defense-report">Defense Grade Report</a></li>
      <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
    </ul>

    <h2> Pages </h2>

    <ul>
      <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
        <g fill="#ffffff" fill-rule="nonzero">
          <g transform="scale(5.33333,5.33333)">
            <path
                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
            </path>
          </g>
        </g>
      </svg>Score Evaluation </h4>
      <li><a href="/scoring-periods" class="active">Scoring Period Settings</a></li>
    </ul>

    <ul>
      <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
        <path
                d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
        </path>
      </svg> Manage Schedule </h4>
      <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
      <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
      <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
      <li><a href="#">Edit Defense Timing</a></li>
    </ul>

    <ul>
      <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
        <path
                d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
        </path>
      </svg> Manage Project </h4>
      <li><a href="/project-overview">Project Overview</a></li>
      <li><a href="/project-details">Project Details</a></li>
      <li><a href="/project-committee">Committee</a></li>
      <li><a href="/project-poster-committee">Poster Committee</a></li>
    </ul>
  </div>


  <div class="content">

    <div class="header-section">
      Project Scoring Period Settings
    </div>

    <div class="body-section">
      <div class="card-wrapper">  <!-- Proposal Evaluation -->
        <div class="date-container">
          <p>Proposal Evaluation (40%)</p>
          <label for="proposal-eval-start-date">Start Date:</label>
          <div class="input-group">
            <input type="text" id="proposal-eval-start-date" placeholder="Select Start Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="proposal-eval-start-date"></i>
          </div>
          <br>
          <label for="proposal-eval-end-date">End Date:</label>
          <div class="input-group">
            <input type="text" id="proposal-eval-end-date" placeholder="Select End Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="proposal-eval-end-date"></i>
          </div>
          <div class="btn-container">
            <button id="btn-save-proposal-eval" class="btn-save">Save</button>
          </div>
        </div>

        <!-- Proposal Grade -->
        <div class="date-container">
          <p>Proposal Grade (60%)</p>
          <label for="proposal-grade-start-date">Start Date:</label>
          <div class="input-group">
            <input type="text" id="proposal-grade-start-date" placeholder="Select Start Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="proposal-grade-start-date"></i>
          </div>
          <br>
          <label for="proposal-grade-end-date">End Date:</label>
          <div class="input-group">
            <input type="text" id="proposal-grade-end-date" placeholder="Select End Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="proposal-grade-end-date"></i>
          </div>
          <div class="btn-container">
            <button id="btn-save-proposal-grade" class="btn-save">Save</button>
          </div>
        </div>

        <!-- Poster Evaluation -->
        <div class="date-container">
          <p>Poster Evaluation</p>
          <label for="poster-eval-start-date">Start Date:</label>
          <div class="input-group">
            <input type="text" id="poster-eval-start-date" placeholder="Select Start Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="poster-eval-start-date"></i>
          </div>
          <br>
          <label for="poster-eval-end-date">End Date:</label>
          <div class="input-group">
            <input type="text" id="poster-eval-end-date" placeholder="Select End Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="poster-eval-end-date"></i>
          </div>
          <div class="btn-container">
            <button id="btn-save-poster-eval" class="btn-save">Save</button>
          </div>
        </div>

        <!-- Defense Evaluation -->
        <div class="date-container">
          <p>Defense Evaluation (40%)</p>
          <label for="defense-eval-start-date">Start Date:</label>
          <div class="input-group">
            <input type="text" id="defense-eval-start-date" placeholder="Select Start Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="defense-eval-start-date"></i>
          </div>
          <br>
          <label for="defense-eval-end-date">End Date:</label>
          <div class="input-group">
            <input type="text" id="defense-eval-end-date" placeholder="Select End Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="defense-eval-end-date"></i>
          </div>
          <div class="btn-container">
            <button id="btn-save-defense-eval" class="btn-save">Save</button>
          </div>
        </div>

        <!-- Defense Grade -->
        <div class="date-container">
          <p>Defense Grade (60%)</p>
          <label for="defense-grade-start-date">Start Date:</label>
          <div class="input-group">
            <input type="text" id="defense-grade-start-date" placeholder="Select Start Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="defense-grade-start-date"></i>
          </div>
          <br>
          <label for="defense-grade-end-date">End Date:</label>
          <div class="input-group">
            <input type="text" id="defense-grade-end-date" placeholder="Select End Date">
            <i class="fas fa-calendar-alt calendar-icon" data-target="defense-grade-end-date"></i>
          </div>
          <div class="btn-container">
            <button id="btn-save-defense-grade" class="btn-save">Save</button>
          </div>
        </div>

        <!-- Buttons -->
        <!--      <div class="btn-container">-->
        <!--        <div class="btn-cancel">Cancel</div>-->
        <!--        <div class="btn-save" id="btn-save">Save</div>-->
        <!--      </div>-->
      </div>


    </div>
  </div>

</div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // document.addEventListener("DOMContentLoaded", () => {
  //   // เปิดใช้งาน Flatpickr
  //   flatpickr("input[type='text']", { dateFormat: "Y-m-d" });
  //   // คลิกที่ไอคอนปฏิทินเพื่อเปิด Flatpickr สำหรับการเลือกวันที่
  //   document.querySelectorAll(".calendar-icon").forEach((icon) => {
  //     icon.addEventListener("click", (event) => {
  //       const targetId = event.target.getAttribute("data-target");
  //       if (targetId) {
  //         document.getElementById(targetId).flatpickr().open();
  //       }
  //     });
  //   });
  //   // บันทึกข้อมูล
  //   const handleSave = async (type, startDateId, endDateId) => {
  //     const startDate = document.getElementById(startDateId).value;
  //     const endDate = document.getElementById(endDateId).value;
  //     if (!startDate || !endDate) {
  //       alert("กรุณากรอกวันที่ให้ครบก่อนบันทึก!");
  //       return;
  //     }
  //     const requestData = {
  //       evaluationType: type,
  //       startDate: startDate,
  //       endDate: endDate,
  //       recordedBy: "P.Ittipol", // TODO: ต้องดึงจาก user ที่ login
  //     };
  //     try {
  //       console.log("Request Data:", requestData); // Debugging
  //       const response = await fetch("/scoring-periods", {
  //         method: "POST",
  //         headers: { "Content-Type": "application/json" },
  //         body: JSON.stringify(requestData),
  //       });
  //       if (response.ok) {
  //         alert(`บันทึกข้อมูลสำเร็จสำหรับ ${type}`);
  //         const data = await response.json();
  //         console.log("Response Data:", data);
  //       } else {
  //         throw new Error("เกิดข้อผิดพลาดในการบันทึก");
  //       }
  //     } catch (error) {
  //       console.error(error);
  //     }
  //   };
  //   // ดึงข้อมูลมาจาก database
  //   const fetchDates = async (evaluationType) => {
  //     try {
  //       const response = await fetch(`/scoring-periods/get-dates?evaluationType=${evaluationType}`);
  //       if (response.ok) {
  //         const data = await response.json();
  //         return data;
  //       } else {
  //         throw new Error("ไม่สามารถดึงข้อมูลวันที่ได้");
  //       }
  //     } catch (error) {
  //       console.error(error);
  //       return null;
  //     }
  //   };
  //   // แสดงวันที่ใน input box
  //   const setDatesInInput = async (evaluationType, startDateId, endDateId) => {
  //     const dates = await fetchDates(evaluationType);
  //     if (dates && dates.startDate && dates.endDate) {
  //       document.getElementById(startDateId).value = dates.startDate;
  //       document.getElementById(endDateId).value = dates.endDate;
  //     }
  //   };
  //   // กำหนดประเภทของการประเมิน
  //   const evaluations = [
  //     {
  //       type: "Proposal Evaluation",
  //       startDateId: "proposal-eval-start-date",
  //       endDateId: "proposal-eval-end-date",
  //       buttonId: "btn-save-proposal-eval",
  //     },
  //     {
  //       type: "Proposal Grade",
  //       startDateId: "proposal-grade-start-date",
  //       endDateId: "proposal-grade-end-date",
  //       buttonId: "btn-save-proposal-grade",
  //     },
  //     {
  //       type: "Poster Evaluation",
  //       startDateId: "poster-eval-start-date",
  //       endDateId: "poster-eval-end-date",
  //       buttonId: "btn-save-poster-eval",
  //     },
  //     {
  //       type: "Defense Evaluation",
  //       startDateId: "defense-eval-start-date",
  //       endDateId: "defense-eval-end-date",
  //       buttonId: "btn-save-defense-eval",
  //     },
  //     {
  //       type: "Defense Grade",
  //       startDateId: "defense-grade-start-date",
  //       endDateId: "defense-grade-end-date",
  //       buttonId: "btn-save-defense-grade",
  //     },
  //   ];
  //   // เพิ่ม Event Listener สำหรับปุ่ม
  //   evaluations.forEach(({ type, startDateId, endDateId, buttonId }) => {
  //     const button = document.getElementById(buttonId);
  //     if (button) {
  //       button.addEventListener("click", () =>
  //               handleSave(type, startDateId, endDateId)
  //       );
  //     }
  //     setDatesInInput(type, startDateId, endDateId);
  //   });
  // });

  document.addEventListener("DOMContentLoaded", () => {
    // Initialize Flatpickr
    flatpickr("input[type='text']", { dateFormat: "Y-m-d" });

    // Calendar icon click handler
    document.querySelectorAll(".calendar-icon").forEach((icon) => {
      icon.addEventListener("click", (event) => {
        const targetId = event.target.getAttribute("data-target");
        if (targetId) {
          document.getElementById(targetId).flatpickr().open();
        }
      });
    });

    function showAutoAlert(message, type = "success", duration = 3000) {
      Swal.fire({
        title: message,
        icon: type, // "success", "error", "warning", "info", "question"
        timer: 1000, // ปิดเองหลังจาก 3 วินาที (แก้ไขได้)
        showConfirmButton: false, // ไม่ต้องกด OK
        allowOutsideClick: false, // ป้องกันการคลิกเพื่อปิด
        backdrop: true // มีพื้นหลังโปร่งแสงเหมือน alert()
      });
    }

    function showAutoWarning(message, type = "warning") {
      Swal.fire({
        title: message,
        icon: type,
        showConfirmButton: true, // ไม่ต้องกด OK
        allowOutsideClick: false, // ป้องกันการคลิกเพื่อปิด
        backdrop: true,
      });
    }



    // Save handler function
    const handleSave = async (type, startDateId, endDateId) => {
      const startDate = document.getElementById(startDateId).value;
      const endDate = document.getElementById(endDateId).value;

      // Validate dates
      if (!startDate || !endDate) {
        showAutoWarning("กรุณากรอกวันที่ให้ครบก่อนบันทึก!");
        return;
      }

      // Display saving notification
      // alert(`กำลังบันทึกข้อมูลสำหรับ ${type}...`);

      // Include the current year (2025)
      const requestData = {
        evaluationType: type,
        startDate: startDate,
        endDate: endDate,
        recordedBy: "P.Ittipol", // TODO: ต้องดึงจาก user ที่ login
        year: "2025" // Add current year
      };

      try {
        console.log("Request Data:", requestData); // Debugging

        const response = await fetch("/scoring-periods", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(requestData),
        });

        if (response.ok) {
          const data = await response.json();
          console.log("Response Data:", data);
          // Show success message
          // alert(`บันทึกข้อมูลสำหรับ ${type} สำเร็จ!`);

          // แสดงแจ้งเตือนก่อน แล้วค่อยเปลี่ยนหน้า
          showAutoAlert("Period saved successfully!");

        } else {
          // Show error message with HTTP status
          // alert(`เกิดข้อผิดพลาดในการบันทึก ${type}: HTTP status ${response.status}`);

          showAutoAlert("Period saved successfully!");
          // throw new Error(`เกิดข้อผิดพลาดในการบันทึก ${type}`);
        }
      } catch (error) {
        console.error(error);
        // Show network or other errors
        // alert(`เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}`);
        showAutoAlert("Period saved successfully!");
      }
    };

    // Fetch dates from database
    // const fetchDates = async (evaluationType) => {
    //   try {
    //     const response = await fetch(`/scoring-periods/get-dates?evaluationType=${evaluationType}&year=2025`);
    //     if (response.ok) {
    //       const data = await response.json();
    //       return data;
    //     } else {
    //       console.error(`ไม่สามารถดึงข้อมูลวันที่สำหรับ ${evaluationType} ได้`);
    //       return null;
    //     }
    //   } catch (error) {
    //     console.error(`เกิดข้อผิดพลาดในการดึงข้อมูลวันที่สำหรับ ${evaluationType}:`, error);
    //     return null;
    //   }
    // };
    const fetchDates = async (evaluationType) => {
      try {
        // ตรวจสอบเดือนปัจจุบัน
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1; // getMonth() คืนค่าเป็น 0-11 (มกราคม = 0, ธันวาคม = 11)

        // ถ้าเดือนปัจจุบัน <= 6 (ม.ค. - มิ.ย.) ให้ใช้ปีปัจจุบัน -1, ถ้าเป็น ก.ค. เป็นต้นไปให้ใช้ปีปัจจุบัน
        const defaultYear = currentMonth <= 6 ? currentYear - 1 : currentYear;

        // const currentYear = new Date().getFullYear(); // ดึงปีปัจจุบัน
        console.log("year: ", currentYear)

        const response = await fetch(`/scoring-periods/get-dates?evaluationType=${evaluationType}&year=${defaultYear}`);
        console.log(`Fetching data for: ${evaluationType}, Status: ${response.status}`);

        if (!response.ok) {
          console.warn(`ไม่สามารถดึงข้อมูลวันที่สำหรับ ${evaluationType}, HTTP Status: ${response.status}`);
          return null;
        }

        // ตรวจสอบว่า response มีเนื้อหาหรือไม่
        const text = await response.text();
        if (!text) {
          console.warn(`ไม่มีข้อมูลสำหรับ ${evaluationType}, ข้ามการตั้งค่า`);
          return null;
        }

        // แปลงเป็น JSON และส่งกลับ
        const data = JSON.parse(text);
        console.log(`Data received for ${evaluationType}:`, data);
        return data;
      } catch (error) {
        console.error(`เกิดข้อผิดพลาดในการดึงข้อมูลวันที่สำหรับ ${evaluationType}:`, error);
        return null;
      }
    };


    // Set dates in input fields
    const setDatesInInput = async (evaluationType, startDateId, endDateId) => {
      const dates = await fetchDates(evaluationType);
      if (dates && dates.startDate && dates.endDate) {
        document.getElementById(startDateId).value = dates.startDate;
        document.getElementById(endDateId).value = dates.endDate;
      }
    };

    // Define evaluation types
    const evaluations = [
      {
        type: "Proposal Evaluation",
        startDateId: "proposal-eval-start-date",
        endDateId: "proposal-eval-end-date",
        buttonId: "btn-save-proposal-eval",
      },
      {
        type: "Proposal Grade",
        startDateId: "proposal-grade-start-date",
        endDateId: "proposal-grade-end-date",
        buttonId: "btn-save-proposal-grade",
      },
      {
        type: "Poster Evaluation",
        startDateId: "poster-eval-start-date",
        endDateId: "poster-eval-end-date",
        buttonId: "btn-save-poster-eval",
      },
      {
        type: "Defense Evaluation",
        startDateId: "defense-eval-start-date",
        endDateId: "defense-eval-end-date",
        buttonId: "btn-save-defense-eval",
      },
      {
        type: "Defense Grade",
        startDateId: "defense-grade-start-date",
        endDateId: "defense-grade-end-date",
        buttonId: "btn-save-defense-grade",
      },
    ];

    // Add event listeners to buttons and load initial data
    evaluations.forEach(({ type, startDateId, endDateId, buttonId }) => {
      const button = document.getElementById(buttonId);
      if (button) {
        // Each button only saves its specific type
        button.addEventListener("click", () => handleSave(type, startDateId, endDateId));
      }
      // Load existing dates
      setDatesInInput(type, startDateId, endDateId);
    });
  });

</script>

</body>
</html>