<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Edit Project Details </title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-admin.css">
    <link rel="stylesheet" href="/css/addNewProject.css">

    <!-- Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>

<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>
        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                    </path>
                </svg>
                Homepage
            </h4>
            <li><a href="/admin-dashboard">Dashboard</a></li>
            <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
            <li><a href="/admin-timeliness-scoring">Timeliness Scoring</a></li>
        </ul>

        <h2> Pages </h2>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Score Evaluation
            </h4>
            <li><a href="/scoring-periods">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                    </path>
                </svg>
                Manage Schedule
            </h4>
            <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
            <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
            <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
            <li><a href="/admin/editDefenseSchedulePage">Edit Defense Timing</a></li>
        </ul>


        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                    </path>
                </svg>
                Manage Project
            </h4>
            <li><a href="/project-overview">Project Overview</a></li>
            <li><a href="/project-details" class="active">Project Details</a></li>
            <li><a href="/project-committee">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>

    <div class="content">

        <div class="header-section">
            Edit Project Details
        </div>

        <div class="body-section">

            <div class="modal">
                <div class="modal-content" id="modal-container">

                </div>
            </div>

            <!-- Popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö -->
            <div id="confirmDeletePopup" class="delete-popup">
                <div class="popup-content">
                    <div id="delete-confirm-msg"></div>
                    <button id="confirmDeleteBtn">Yes, Delete</button>
                    <button id="cancelDeleteBtn">Cancel</button>
                </div>
            </div>

            <!-- Popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save) -->
            <div id="confirmSavePopup" class="save-popup">
                <div class="popup-content">
                    <div id="save-confirm-msg">Are you sure you want to save the changes?</div>
                    <button id="confirmSaveBtn">Yes, Save</button>
                    <button id="cancelSaveBtn">Cancel</button>
                </div>
            </div>

        </div>
    </div>
</div>
</body>

</html>

<script>

    document.addEventListener("DOMContentLoaded", function () {
        const menuItems = document.querySelectorAll(".sidebar ul li a");

        // ‡∏î‡∏∂‡∏á URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const currentPage = window.location.pathname.split("/").pop();
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');

        menuItems.forEach(item => {
            if (item.getAttribute("href") === currentPage) {
                item.classList.add("active"); // ‡πÄ‡∏û‡∏¥‡πà‡∏° class "active" ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('#studentList tbody').addEventListener('click', e => {
                if (!e.target.classList.contains('student-delete-btn')) return;
                const btn = e.target;
                const studentId = btn.dataset.studentId;
                const studentName = btn.dataset.studentName;
                const projectId = btn.dataset.projectId;
                confirmDelete(studentId, studentName, projectId);
            });
        });

        // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ú‡∏π‡∏Å listener ‡πÅ‡∏ö‡∏ö delegation
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('#instructorList tbody')
                .addEventListener('click', e => {
                    if (e.target.classList.contains('delete-btn')) {
                        confirmDeleteInstructor(e.target.closest('tr'));
                    }
                });

        });

        // -------------------- Fetch Project -------------------- //
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
        function fetchData(projectId) {
            const url = `http://localhost:8080/admin/editDetails?projectId=${encodeURIComponent(projectId)}`;

            // ‡πÉ‡∏ä‡πâ fetch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô JSON
                })
                .then(data => {
                    return data; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }

        // ‚Äî Fetch Instructor from Back‚Äëend ‚Äî //
        let instructors = [];

        function fetchInstructors() {
            fetch('http://localhost:8080/admin/getInstructors')
                .then(r => r.json())
                .then(data => {
                    instructors = data;
                    populateInstructorDropdowns();
                })
                .catch(e => console.error("Error fetching instructors:", e));
        }

        // ‡πÄ‡∏ï‡∏¥‡∏° <option> ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å <select class="instructor-select"> ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô modal
        function populateInstructorDropdowns() {
            document.querySelectorAll('.instructor-select').forEach(select => {
                const defaultName = select.dataset.name;      // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å data-name
                select.innerHTML = `<option value="">-- Select --</option>`;
                instructors.forEach(inst => {
                    const opt = document.createElement('option');
                    opt.value = inst.professorId;
                    opt.textContent = inst.professorName;
                    if (inst.professorName === defaultName) {
                        opt.selected = true;
                    }
                    select.appendChild(opt);
                });
            });
        }


        function displayResults(data) {
            console.log(data);

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å studentList ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const students = data.studentList;
            const advisors = data.professorList.filter(professor => professor.role === "Advisor");
            const coAdvisors = data.professorList.filter(professor => professor.role === "Co-Advisor");
            const committees = data.professorList.filter(professor => professor.role === "Committee");
            const posterCommittees = data.professorList.filter(professor => professor.role === "Poster-Committee");
            const allProfessors = data.professorList;


            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö modal
            let modalHTML = `
    <h3>Project Details</h3>
    <div class="form-group">
        <label>Project ID :</label>
        <div class="input-icon">
            <input type="text" value="${data.projectId}" disabled>
        </div>
    </div>
    <div class="form-group">
        <label>Project Name :</label>
        <div class="input-icon">
            <input type="text" id="projectTitle" value="${data.projectTitle}">
        </div>
    </div>
    <div class="form-group">
        <label>Project Description :</label>
        <div class="input-icon">
            <textarea id="projectDescription">${data.projectDescription}</textarea>
        </div>
    </div>
    <div class="form-group">
        <label>Project Catrgory :</label>
        <div class="input-icon">
            <textarea id="projectCategory">${data.category}</textarea>
        </div>
    </div>

    <h3>Member Details</h3>
    <div class="form-group-row">
        <div class="form-group">
            <label>Program :</label>
            <select id="program">
                    <option value="ICT" ${data.program === 'ICT' ? 'selected' : ''}>ICT</option>
                    <option value="DST" ${data.program === 'DST' ? 'selected' : ''}>DST</option>
                </select>
        </div>

        <div class="form-group">
            <label>Semester :</label>
            <input type="text" value="${data.semester}" id="semester">
        </div>
    </div>

    <!-- ‡πÅ‡∏™‡∏î‡∏á Student from studentList -->
    <div id="studentList">
        <table>
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Student Name</th>
                    <th>Program</th>
                    <th>Section</th>
                    <th>Track</th>
                     <th>Action</th>
                </tr>
            </thead>
                <tbody>
              ${students.map(student => `
                <tr id="student-row-${student.studentId}">
                  <td>${student.studentId}</td>
                  <td>${student.studentName}</td>
                  <td>${data.program}</td>
                  <td>${student.section}</td>
                  <td>${student.track || '-'}</td>
                  <td>
                    <button
                      class="student-delete-btn"
                      data-project-id="${data.projectId}"
                      data-student-id="${student.studentId}"
                      data-student-name="${student.studentName}">
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
        </table>
    </div>

        <!-- ‡πÅ‡∏™‡∏î‡∏á Instructor -->
        <h3>Instructor Details</h3>
        <div id="instructorList">
          <table class="instructor-table">
            <thead>
              <tr><th>Role</th><th>Professor</th><th>Action</th></tr>
            </thead>
            <tbody>
              ${data.professorList.map(pr => `
                <tr data-role="${pr.role}">
                  <td>
                    <select class="role-select">
                      <option value="Advisor"        ${pr.role === 'Advisor' ? 'selected' : ''}>Advisor</option>
                      <option value="Co-Advisor"     ${pr.role === 'Co-Advisor' ? 'selected' : ''}>Co-Advisor</option>
                      <option value="Committee"      ${pr.role === 'Committee' ? 'selected' : ''}>Committee</option>
                      <option value="Poster-Committee"${pr.role === 'Poster-Committee' ? 'selected' : ''}>
                        Poster-Committee
                      </option>
                    </select>
                  </td>
                  <td>
                    <select class="instructor-select"
                            data-id="${pr.professorId}"
                            data-name="${pr.professorName}">
                      <option value="">-- Select --</option>
                      ${instructors.map(inst => `
                        <option value="${inst.professorId}"
                                ${inst.professorId === pr.professorId ? 'selected' : ''}>
                          ${inst.professorName}
                        </option>`).join('')}
                    </select>
                  </td>
                  <td><button class="delete-btn">üóëÔ∏è</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <button id="addInstructorBtn">+ Add Instructor</button>
        </div>

        <!-- Actions Button -->
        <div class="button-group">
          <button class="cancel-btn">Cancel</button>
          <button class="save-btn">Save</button>
        </div>
    `;

            document.getElementById('modal-container').innerHTML = modalHTML;

            // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° Cancel
            document.querySelector('.cancel-btn').addEventListener('click', function () {
                window.location.href = "http://localhost:8080/project-details";
            });

            // Delete student
            document.querySelectorAll('.student-delete-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const sid = e.currentTarget.dataset.studentId;
                    const sname = e.currentTarget.dataset.studentName;
                    const projId = data.projectId;
                    confirmDelete(sid, sname, projId);
                });
            });


            // Delete instructor
            document.querySelectorAll('.instructor-table .delete-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const row = e.currentTarget.closest('tr');  // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
                    confirmDeleteInstructor(row);  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å confirmDeleteInstructor ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                });
            });

            // ‡∏ú‡∏π‡∏Å listener ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏° instructor row
            document.getElementById('addInstructorBtn')
                .addEventListener('click', () => {
                    const tbody = document.querySelector('#instructorList tbody');
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                        <select class="role-select">
                            <option value="Advisor">Advisor</option>
                            <option value="Co-Advisor">Co-Advisor</option>
                            <option value="Committee">Committee</option>
                            <option value="Poster-Committee">Poster-Committee</option>
                        </select>
                        </td>
                        <td>
                        <select class="instructor-select" data-id="">
                            <!-- placeholder ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å -->
                            <option value="" disabled selected>-- Select Instructor --</option>
                            ${instructors.map(i => `
                              <option value="${i.professorId}">
                                ${i.professorName}
                              </option>
                            `).join('')}
                        </select>
                        </td>
                        <td>
                        <button class="delete-btn">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Populate & init search on new select only
                    const newSel = tr.querySelector('.instructor-select');
                    instructors.forEach(i => {
                        const opt = document.createElement('option');
                        opt.value = i.professorId;
                        opt.textContent = i.professorName;
                        newSel.appendChild(opt);
                    });
                    newSel.choicesInstance = new Choices(newSel, {
                        searchEnabled: true,
                        shouldSort: false,
                        placeholderValue: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå...',
                        classNames: {
                            containerInner: 'my-choices-inner',
                            listDropdown: 'my-choices-dropdown',
                            itemChoice: 'my-choices-item',
                            itemSelectable: 'my-choices-selectable'
                        }
                    });
                });

            document.querySelector('#instructorList tbody').addEventListener('click', e => {
                if (e.target.classList.contains('delete-btn')) {
                    // remove the entire <tr> ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏≠‡∏ö ‡πÜ ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏±‡πâ‡∏ô
                    e.target.closest('tr').remove();
                }
            });


            fetchInstructors();

            function showErrorsPopup(errors, redirectUrl = null) {
                const savePopup = document.getElementById('confirmSavePopup');
                if (savePopup) {
                    savePopup.style.display = 'none';
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Errors',
                    html: errors.map(e => `<p style="text-align:left; margin:0.25em 0;">${e}</p>`).join(''),
                    width: '600px',
                    confirmButtonText: '‡∏õ‡∏¥‡∏î',
                    timer: 1500
                }).then(() => {
                    window.location.reload();
                });
            }

            function enableInstructorSearch() {
                document.querySelectorAll('.instructor-select').forEach(el => {
                    // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏£‡∏ì‡∏µ re-init
                    if (!el.choicesInstance) {
                        el.choicesInstance = new Choices(el, {
                            searchEnabled: true,
                            shouldSort: false,
                            itemSelectText: '',
                            placeholderValue: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå...',
                            classNames: {
                                containerInner: 'my-choices-inner',
                                listDropdown: 'my-choices-dropdown',
                                itemChoice: 'my-choices-item',
                                itemSelectable: 'my-choices-selectable'
                            }
                        });
                    }
                });
            }


            // -------------------- Update Project -------------------- //
            // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° Save
            document.querySelector('.save-btn').addEventListener('click', function () {
                // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                const savePopup = document.getElementById('confirmSavePopup');
                savePopup.style.display = 'block';

                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                document.getElementById('confirmSaveBtn').addEventListener('click', async function () {

                    const instructorRows = document.querySelectorAll('#instructorList .instructor-table tbody tr');
                    for (let tr of instructorRows) {
                        const sel = tr.querySelector('select.instructor-select');
                        if (!sel.value) {
                            // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ
                            Swal.fire({
                                icon: 'warning',
                                title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß',
                                text: '‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                            });
                            return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        }
                    }

                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
                    const projectId = data.projectId;
                    const projectTitle = document.getElementById('projectTitle').value;
                    const projectDescription = document.getElementById('projectDescription').value;
                    const category           = document.getElementById('projectCategory').value.trim();

                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ program ‡∏à‡∏≤‡∏Å dropdown
                    const program = document.getElementById('program').value;

                    const semester = document.getElementById('semester').value;

                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Student
                    const studentList = Array.from(
                        document.querySelectorAll('#studentList tbody tr')
                    ).map(tr => {
                        const studentId = tr.cells[0].textContent.trim();
                        const studentName = tr.cells[1].textContent.trim();
                        const status = 'Active';
                        return {studentId, studentName, status};
                    });


                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Instructor
                    const professorList = Array.from(
                        document.querySelectorAll('#instructorList .instructor-table tbody tr')
                    ).map(tr => {
                        const roleSel = tr.querySelector('select.role-select');
                        const instSel = tr.querySelector('select.instructor-select');
                        return {
                            professorId: instSel.value,
                            professorName: instSel.selectedOptions[0].textContent,
                            role: roleSel.value
                        };
                    });

                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Controller
                    const updatedDetails = {
                        projectTitle,
                        projectDescription,
                        category,
                        program,
                        semester,
                        studentList,
                        professorList
                    };

                    console.log("Sending data to the server: ", updatedDetails);

                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà Controller ‡∏î‡πâ‡∏ß‡∏¢ fetch()
                    try {
                        const resp = await fetch(`http://localhost:8080/admin/updateProjectDetails?projectId=${encodeURIComponent(projectId)}`,
                            {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(updatedDetails)
                            }
                        );
                        if (resp.ok) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Update Project Success!',
                                timer: 1500,
                                showConfirmButton: false,
                                timerProgressBar: true       // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
                            }).then(() => window.location.href = "http://localhost:8080/project-details");
                        } else {
                            const err = await resp.json();
                            showErrorsPopup(err.errors || [err.message || 'Unknown error']);
                        }
                    } catch (e) {
                        showErrorsPopup([e.message]);
                    }
                });

                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                document.getElementById('cancelSaveBtn').addEventListener('click', function () {
                    const savePopup = document.getElementById('confirmSavePopup');
                    savePopup.style.display = 'none';  // ‡∏ã‡πà‡∏≠‡∏ô popup
                });
            });


            // -------------------- Delete Student -------------------- //
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
            function confirmDelete(studentId, studentName, projectId) {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô popup ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                const popup = document.getElementById('confirmDeletePopup');
                const deleteConfirmMsg = document.getElementById('delete-confirm-msg');
                deleteConfirmMsg.innerHTML = `Are you sure you want to remove Student : "${studentId} ${studentName}" <br> from Project ID : "${projectId}"?`;

                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const cancelBtn = document.getElementById('cancelDeleteBtn');

                // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Popup ‡πÅ‡∏™‡∏î‡∏á
                popup.style.display = 'block';

                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏ö student
                confirmBtn.onclick = function () {
                    deleteStudentFromProject(studentId, projectId);  // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏ö student ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å project
                    popup.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Popup
                };

                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                cancelBtn.onclick = function () {
                    popup.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Popup
                };
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö student ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å project
        function deleteStudentFromProject(studentId, projectId) {
            fetch(
                `/admin/deleteStudentFromProject?projectId=${encodeURIComponent(projectId)}&studentId=${encodeURIComponent(studentId)}`,
                {method: 'DELETE'}
            )
                .then(async response => {
                    const text = await response.text();
                    if (!response.ok) {
                        throw new Error(`${response.status}: ${text}`);
                    }
                    return text;
                })
                .then(msg => {
                    console.log('Success:', msg);
                    // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏î‡πâ‡∏ß‡∏¢ id ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö studentId
                    const row = document.getElementById(`student-row-${studentId}`);
                    if (row) row.remove();
                    Swal.fire({icon: 'success', title: 'Deleted', text: msg});
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({icon: 'error', title: 'Error', text: error.message});
                });
        }


        // -------------------- Delete Instructor -------------------- //

        const PROJECT_ID = urlParams.get('projectId');

        function confirmDeleteInstructor(row) {
            // ‡∏≠‡πà‡∏≤‡∏ô projectId ‡∏à‡∏≤‡∏Å URL ‡∏´‡∏£‡∏∑‡∏≠ attribute ‡∏Ç‡∏≠‡∏á element
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');
            const sel = row.querySelector('.instructor-select');
            const professorId = sel.value;   // ‡∏´‡∏£‡∏∑‡∏≠ sel.dataset.id ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
            const instructorName = sel.options[sel.selectedIndex]?.text;

            if (!projectId || !professorId) {
                return Swal.fire({icon: 'error', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡πÑ‡∏°‡πà‡∏û‡∏ö Project ID ‡∏´‡∏£‡∏∑‡∏≠ Professor ID'});
            }

            Swal.fire({
                icon: 'warning',
                title: `Are you sure you want to remove ${instructorName}?`,
                showCancelButton: true,
                confirmButtonText: 'Delete',
                cancelButtonText: 'Cancel'
            }).then(({isConfirmed}) => {
                if (isConfirmed) {
                    // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
                    row.remove();
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á param
                    deleteInstructorFromProject(projectId, professorId);
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö Instructor ‡∏à‡∏≤‡∏Å Project
        function deleteInstructorFromProject(projectId, professorId) {
            fetch(`/admin/deleteInstructorFromProject?projectId=${encodeURIComponent(projectId)}&professorId=${encodeURIComponent(professorId)}`, {
                method: 'DELETE'
            })
                .then(res => res.ok
                    ? Swal.fire({icon: 'success', title: 'Delete Success!'})
                    : res.text().then(txt => {
                        throw new Error(txt)
                    })
                )
                .catch(err => Swal.fire({icon: 'error', title: 'Error', text: err.message}));
        }


        // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        document.querySelectorAll('.instructor-table .delete-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const row = e.currentTarget.closest('tr');  // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
                confirmDeleteInstructor(row);  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
            });
        });


        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showNotification ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function showNotification(message, callback) {
            const notification = document.createElement("div");
            notification.textContent = message;
            notification.style.position = "fixed";
            notification.style.top = "20px";
            notification.style.right = "20px";
            notification.style.padding = "10px 20px";
            notification.style.background = "green";
            notification.style.color = "white";
            notification.style.borderRadius = "5px";
            notification.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
            document.body.appendChild(notification);

            // ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                notification.remove();
                if (callback) callback(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å callback ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
            }, 1000);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        function loadProjectDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');

            if (projectId) {
                fetchData(projectId)
                    .then(data => {
                        if (data) {
                            displayResults(data);  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô modal
                        }
                    })
                    .catch(error => {
                        console.error("Error in loading project details:", error);
                    });
            } else {
                console.log("No projectId found in URL");
            }
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        loadProjectDetails();
    });

</script>
