<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Project Details </title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-admin.css">
    <link rel="stylesheet" href="/css/projectDetails.css">

    <!-- Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- CSRF Token -->
    <meta name="_csrf" content="${_csrf.token}"/>
    <meta name="_csrf_header" content="${_csrf.headerName}"/>


</head>

<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>

        <form th:action="@{/logout}" method="post" class="logout-container">
            <!--        ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cross-Site Request Forgery (CSRF)-->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </form>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                    </path>
                </svg>
                Homepage
            </h4>
            <li><a href="/admin-dashboard">Dashboard</a></li>
            <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
            <li><a href="/admin-timeliness-scoring">Timeliness Scoring</a></li>
        </ul>
        <h2> Pages </h2>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Score Evaluation
            </h4>
            <li><a href="/scoring-periods">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                    </path>
                </svg>
                Manage Schedule
            </h4>
            <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
            <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
            <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
            <li><a href="/admin/editDefenseSchedulePage">Edit Defense Timing</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                    </path>
                </svg>
                Manage Project
            </h4>
            <li><a href="/project-overview">Project Overview</a></li>
            <li><a href="/project-details" class="active">Project Details</a></li>
            <li><a href="/project-committee">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>


    <div class="content">

        <div class="header-section">
            <div class="header-left">
                Project Details

                <!-- Dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å semester -->
                <div class="semester-container">
                    <select id="semester-selector" onchange="filterBySemester();">
                        <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÅ‡∏•‡∏∞ semester -->
                    </select>
                </div>
            </div>

            <div class="btn-header">
                <button class="deleteAll-btn" id="deleteAll-btn"> üóëÔ∏è Delete </button>
                <button class="export-btn" id="export-project-template">Download Project Template</button>
                <!--                <div class="dropdown-export">-->
                <!--                    <button class="dropbtn">Export Project Template</button>-->
                <!--                    <div class="dropdown-content">-->
                <!--                        <a href="#" id="export-project-template">Export Projects</a>-->
                <!--                        <a href="#" id="export-committee-template">Export Committee</a>-->
                <!--                        <a href="#" id="export-poster-committee-template">Export Poster Committee</a>-->
                <!--                    </div>-->
                <!--                </div>-->
                <!--                <div class="dropdown-export">-->
                <!--                    <button class="dropbtn">Export Project Data</button>-->
                <!--                    <div class="dropdown-content">-->
                <!--                        <a href="#" id="export-project-raw-excel">Export Raw Data</a>-->
                <!--                        <a href="#" id="export-project-merge-excel">Export Project Data</a>-->
                <!--                    </div>-->
                <!--                </div>-->
                <input type="file" id="upload-file" accept=".csv, .xlsx, .xls" style="display: none;"/>
                <button id="upload-btn">Upload Files</button>
                <button class="addProject-btn"><a href="/project-add-new-project"> + Add Projects </a></button>
            </div>

        </div>

        <div class="body-section">

            <div class="table-container">
                <div class="filter-controls">
                    <button class="filter active" onclick="filterProjects('all')">All</button>
                    <button class="filter" onclick="filterProjects('ict')">ICT</button>
                    <button class="filter" onclick="filterProjects('dst')">DST</button>
                    <input type="text" placeholder="Search" id="search-keyword"/>
                </div>
                <table>
                    <thead>
                    <tr>
                        <th>Project ID</th>
                        <th>Advisor</th>
                        <th>Co-Advisor</th>
                        <th>Project Name</th>
                        <th>Project Description</th>
                        <th>Student ID</th>
                        <th>Student Name</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="projectTable">

                    </tbody>
                </table>
            </div>
        </div>

<!--        <div class="btn-footer">-->
<!--            <button class="deleteAll-btn">Delete ALL</button>-->
<!--        </div>-->

        <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå -->
        <div id="uploadModal" class="modal-details" style="display: none;">
            <div class="modal-content">
                <span id="closeModal" class="close-btn">&times;</span>

                <h2>Upload Files</h2>
                <h6 style="color: #D32F2F; margin-top: -15px"> * You can upload only once.</h6>

                <!-- File Input -->
                <div class="upload-section">
                    <div class="file-input-container" id="drop-area">
                        <i>üìÅ</i>
                        <input type="file" id="fileInput"/>
                    </div>
                </div>

                <!-- Preview Content -->
                <div id="preview-content"></div>

                <!-- Upload Button -->
                <button type="button" id="confirm-upload-btn" style="display:none;">Upload</button>
            </div>
        </div>

        <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Delete ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Project -->
        <div id="confirmDeletePopup" style="display: none;">
            <div class="popup-overlay">
                <div class="popup-content">
                    <p id="delete-confirm-msg"></p>
                    <button id="confirmDeleteBtn">Delete</button>
                    <button id="cancelDeleteBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Project ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
        <div id="deleteAllPopup" style="display: none;">
            <div class="popup-overlay">
                <div class="popup-content">
                    <p>Type "DELETE ALL PROJECT" to confirm deletion.</p>
                    <input type="text" id="deleteAllInput" placeholder="Type DELETE ALL PROJECT"/>
                    <button id="confirmDeleteAllBtn" type="button">Delete All</button>
                    <button id="cancelDeleteAllBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Overlay / PopUp Dialog -->
        <div id="export-dialog" class="export-dialog">
            <h3>Select Columns to Export</h3>

            <!-- Column Options -->
            <div class="column-options">
                <div class="select-all-option">
                    <input type="checkbox" id="select-all">
                    <label for="select-all">Select All</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="projectId" checked>
                    <label for="projectId">Project ID</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="projectTitle" checked>
                    <label for="projectTitle">Project Title</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="projectDescription" checked>
                    <label for="projectDescription">Project Description</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="advisor" checked>
                    <label for="advisor">Advisor</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="studentId" checked>
                    <label for="studentId">Student ID</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="studentName" checked>
                    <label for="studentName">Student Name</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="program" checked>
                    <label for="program">Program</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="section" checked>
                    <label for="section">Section</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="track" checked>
                    <label for="track">Track</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="committee1" checked>
                    <label for="committee1">Committee 1</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="committee2" checked>
                    <label for="committee2">Committee 2</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="committee3" checked>
                    <label for="committee3">Committee 3</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="posterCommittee1" checked>
                    <label for="posterCommittee1">Poster Committee 1</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="posterCommittee2" checked>
                    <label for="posterCommittee2">Poster Committee 2</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="posterCommittee3" checked>
                    <label for="posterCommittee3">Poster Committee 3</label>
                </div>
            </div>

            <!-- Export Actions -->
            <div class="export-actions">
                <button class="cancel-button" id="cancel-btn">Cancel</button>
                <button class="export-button" id="confirm-btn">Export</button>
            </div>
        </div>

        <!-- Overlay -->
        <div id="export-overlay" class="export-overlay" style="display:none;"></div>


    </div>
</div>
</body>


<script>

    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.querySelector('.sidebar');

        // ‡∏û‡∏≠ scroll ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô sessionStorage
        sidebar.addEventListener('scroll', () => {
            sessionStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
        });

        // ‡∏û‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ restore ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        const saved = sessionStorage.getItem('sidebarScrollPos');
        if (saved !== null) {
            sidebar.scrollTop = parseInt(saved, 10);
        }
    });

    const semesterSelect = document.getElementById("semester-selector");
    semesterSelect.addEventListener("change", function () {
        console.log("Selected Semester:", semesterSelect.value);

        localStorage.setItem("selectedSemester", semesterSelect.value);

        fetchData();

    });

    document.addEventListener("DOMContentLoaded", function () {
        const menuItems = document.querySelectorAll(".sidebar ul li a");

        // ‡∏î‡∏∂‡∏á URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const currentPage = window.location.pathname.split("/").pop();

        menuItems.forEach(item => {
            if (item.getAttribute("href") === currentPage) {
                item.classList.add("active"); // ‡πÄ‡∏û‡∏¥‡πà‡∏° class "active" ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            }
        });
    });

    let currentCategory = 'all';

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    function filterProjects(category) {

        currentCategory = category;

        const rows = document.querySelectorAll("#projectTable tr");
        rows.forEach(row => {
            if (category === "all") {
                row.style.display = "";
            } else {
                row.style.display = row.getAttribute("data-category") === category ? "" : "none";
            }
        });

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.querySelectorAll(".filter").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`.filter[onclick="filterProjects('${category}')"]`)
            .classList.add("active");

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏∏‡πà‡∏° upload ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        checkUploadAvailability();

    }

    // -------------------- Fetch Project -------------------- //

    let projectsData = [];  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å API
    let filteredData = [];  // ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß

    function debounce(fn, ms) {
        let t;
        return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
        };
    }

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å semester ‡∏à‡∏≤‡∏Å projectsData
    function populateSemesterOptions() {
        const sel = document.getElementById('semester-selector');
        sel.innerHTML = '';  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥)

        let yearnow = String(new Date().getFullYear());
        let sems = Array.from(
            new Set([...projectsData.map(p => String(p.semester)), String(yearnow)])
        ).sort();

        sems.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = "üìÜ " + s;
            sel.appendChild(opt);
        });

        const savedSemester = localStorage.getItem("selectedSemester");

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ savedSemester ‡πÉ‡∏ô localStorage ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
        if (savedSemester && sems.includes(savedSemester)) {
            sel.value = savedSemester;
        } else {
            // ---- ‡πÄ‡∏ã‡πá‡∏ï defaultYear ----
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;   // getMonth() ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0-11 (‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° = 0, ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° = 11)

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <= 8 (‡∏°.‡∏Ñ. - ‡∏Å.‡∏Ñ.) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -1, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏Å.‡∏Ñ. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const defaultYear = (currentMonth <= 8 ? currentYear - 1 : currentYear).toString();

            if (sems.includes(defaultYear.toString())) {
                sel.value = defaultYear.toString();
            } else {

                sel.selectedIndex = 0;
            }
        }
    }

    function applyFilters() {
        const sem = document.getElementById('semester-selector').value;
        const term = document.getElementById('search-keyword').value.trim().toLowerCase();

        filteredData = projectsData.filter(p => {
            // by semester
            if (sem && String(p.semester) !== sem) return false;
            // by search: ‡πÄ‡∏ä‡πá‡∏Ñ projectId, title, description, program, advisor, co-advisor, students
            if (term) {
                const hay = [
                    p.projectId,
                    p.projectTitle,
                    p.projectDescription,
                    p.program,
                    // advisor & co-advisor
                    ...p.professorList.map(x => x.professorName),
                    // student IDs & names
                    ...p.studentList.map(s => s.studentId + ' ' + s.studentName)
                ].join(' ').toLowerCase();
                if (!hay.includes(term)) return false;
            }
            return true;
        });

        displayResults();
        checkUploadAvailability();

    }

    document.addEventListener('DOMContentLoaded', () => {
        // once only:
        document.getElementById('semester-selector')
            .addEventListener('change', applyFilters);
        document.getElementById('search-keyword')
            .addEventListener('input', debounce(applyFilters, 200));

        fetchProjects();
    });


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
    function fetchProjects() {
        fetch("/admin/projectOverview")
            .then(r => {
                if (!r.ok) throw new Error(r.statusText);
                return r.json();
            })
            .then(data => {
                projectsData = data;
                filteredData = data;

                populateSemesterOptions();
                applyFilters();
                checkUploadAvailability();
            })
            .catch(err => console.error("Error fetching projects:", err));
    }

    function checkUploadAvailability() {

        const uploadBtn = document.getElementById('upload-btn');
        const sem = document.getElementById('semester-selector').value;
        if (!sem) return;

        let url;
        if (currentCategory === 'all') {
            url = `/admin/hasAdvisor?semester=${encodeURIComponent(sem)}`;
        } else {
            url = `/admin/hasAdvisorProgram?semester=${encodeURIComponent(sem)}&program=${encodeURIComponent(currentCategory)}`;
        }

        fetch(url)
            .then(r => {
                if (!r.ok) throw new Error(r.statusText);
                return r.json();
            })
            .then(hasAdvisor => {
                if (hasAdvisor) {
                    uploadBtn.disabled = true;
                    uploadBtn.classList.add('disabled');
                    uploadBtn.textContent = 'Upload Disabled';
                } else {
                    uploadBtn.disabled = false;
                    uploadBtn.classList.remove('disabled');
                    uploadBtn.textContent = 'Upload Files';
                }
            })
            .catch(err => console.error("Error checking advisor:", err));
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô semester ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏∏‡πà‡∏°
    document.getElementById('semester-selector')
        .addEventListener('change', () => {
            applyFilters();            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            checkUploadAvailability(); // ‡∏£‡∏µ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏∏‡πà‡∏° upload
        });


    function displayResults() {
        const tbody = document.querySelector("tbody");
        tbody.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å record ‡πÉ‡∏ô filteredData
        filteredData.forEach(project => {
            const row = document.createElement('tr');
            const projectProgram = project.program ? project.program.toLowerCase() : "unknown";
            row.setAttribute("data-category", projectProgram);

            const advisor = project.professorList.find(p => p.role === "Advisor");
            const profName = advisor ? advisor.professorName : "N/A";
            const coadvisor = project.professorList.find(p => p.role === "Co-Advisor");
            const coProfName = coadvisor ? coadvisor.professorName : "";

            const parts = project.projectId.split(" ");
            const projId = parts.slice(1).join(" ");

            row.innerHTML = `
        <td><span class="tag ${projectProgram}">${project.program || "N/A"}</span> ${projId}</td>
        <td>${profName}</td>
        <td>${coProfName}</td>
        <td>${project.projectTitle || "N/A"}</td>
        <td>${project.projectDescription || "N/A"}</td>
        <td><ul>${project.studentList.map(s => `<li>${s.studentId}</li>`).join('')}</ul></td>
        <td><ul>${project.studentList.map(s => `<li>${s.studentName}</li>`).join('')}</ul></td>
        <td>
          <form action="/admin/editProjectDetails" method="get">
            <input type="hidden" name="projectId" value="${project.projectId}">
            <button type="submit" class="edit-btn"><span class="material-icons">edit</span></button>
          </form>
          <form onsubmit="return confirmDelete(event, '${project.projectId}')">
            <input type="hidden" name="projectId" value="${project.projectId}">
            <button type="submit" class="delete-btn"><span class="material-icons">delete</span></button>
          </form>
        </td>
        `;
            tbody.appendChild(row);
        });
    }

    // -------------------- Upload Files -------------------- //

    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Upload Files
    document.getElementById('upload-btn').addEventListener('click', function () {
        document.getElementById('uploadModal').style.display = 'block';
    });

    // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° close
    document.getElementById('closeModal').addEventListener('click', function () {
        document.getElementById('uploadModal').style.display = 'none';
        window.location.reload();
    });


    function csvToJson(csv) {
        // helper: ‡πÅ‡∏¢‡∏Å comma ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å quotes
        function splitCSV(line) {
            const res = [];
            let cur = "", inside = false;
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (ch === '"') {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ "" => ‡πÉ‡∏™‡πà " ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    if (inside && line[i + 1] === '"') {
                        cur += '"';
                        i++;
                    } else {
                        inside = !inside;
                    }
                } else if (ch === ',' && !inside) {
                    res.push(cur);
                    cur = "";
                } else {
                    cur += ch;
                }
            }
            res.push(cur);
            return res;
        }

        // 1) ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô "logical lines" ‡πÇ‡∏î‡∏¢ buffering ‡∏à‡∏ô quotes ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
        const rawLines = csv.split(/\r?\n/);
        const rows = [];
        let buffer = "";
        for (const line of rawLines) {
            buffer = buffer ? buffer + "\n" + line : line;
            const quoteCount = (buffer.match(/"/g) || []).length;
            // ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô quote ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà (mod 2 === 0) ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏ô‡∏∂‡πà‡∏á record
            if (quoteCount % 2 === 0) {
                rows.push(buffer);
                buffer = "";
            }
        }
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ buffer (malformed) ‡∏Å‡πá‡πÉ‡∏™‡πà‡∏•‡∏á‡πÑ‡∏õ
        if (buffer) rows.push(buffer);

        // 2) ‡∏ï‡∏£‡∏ß‡∏à header (‡∏•‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 5 ‚Üí index 4)
        const headerLine = rows[4] || "";
        const headers = splitCSV(headerLine).map(h => h.trim().replace(/^"|"$/g, ""));
        const expected = [
            "No.",
            "Project Title",
            "Project Description",
            "Project Category",
            "Student ID",
            "Student Name",
            "Program",
            "Advisor",
            "Co-Advisor" || "Co-advisor"
        ];
        const mismatch = expected.some((h, i) => headers[i] !== h);
        if (mismatch) {
            Swal.fire({
                icon: "error",
                title: "‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
                // text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ:\n" + expected.join(", ")
                text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Project"
            });
            return [];
        }

        // 3) ‡πÄ‡∏£‡∏¥‡πà‡∏° parse data ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 6 (index 5)
        const result = [];
        let currentProject = null;
        let lastNo = "";

        for (let i = 5; i < rows.length; i++) {
            const raw = rows[i].trim();
            if (!raw) continue;

            // split & trim & unquote
            let cells = splitCSV(raw).map(c => {
                let t = c.trim();
                if (t.startsWith('"') && t.endsWith('"')) {
                    t = t.slice(1, -1).replace(/""/g, '"');
                }
                return t;
            });
            // pad ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 9 columns
            while (cells.length < 9) cells.push("");

            const [
                no, projectTitle, projectDesc, projectCategory,
                studentId, studentName, program, advisor, coAdvisor
            ] = cells;

            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡∏≠ No. ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á project ‡πÉ‡∏´‡∏°‡πà
            if (no && no !== lastNo) {
                currentProject = {
                    no,
                    projectTitle,
                    projectDescription: projectDesc,
                    projectCategory,
                    program,
                    advisor,
                    coAdvisor,
                    studentList: []
                };
                result.push(currentProject);
                lastNo = no;
            } else if (!currentProject) {
                // ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ currentProject ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á
                currentProject = {
                    no,
                    projectTitle,
                    projectDescription: projectDesc,
                    projectCategory,
                    program,
                    advisor,
                    coAdvisor,
                    studentList: []
                };
                result.push(currentProject);
                lastNo = no;
            } else {
                // ‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏° property ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                if (projectTitle) currentProject.projectTitle = projectTitle;
                if (projectDesc) currentProject.projectDescription = projectDesc;
                if (projectCategory) currentProject.projectCategory = projectCategory;
                if (program) currentProject.program = program;
                if (advisor) currentProject.advisor = advisor;
                if (coAdvisor) currentProject.coAdvisor = coAdvisor;
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° student ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (studentId || studentName) {
                currentProject.studentList.push({studentId, studentName});
            }
        }

        return result;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö BOM (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
    function removeBOM(csv) {
        if (csv.charCodeAt(0) === 0xFEFF) {
            csv = csv.substring(1);
        }
        return csv;
    }


    let selectedFile = null;
    let uploadedData = null;
    let validationErrors = {};  // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏• validate ‡∏à‡∏≤‡∏Å Back‚Äëend

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå, ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON, ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å validate ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå preview
    document.getElementById('fileInput').addEventListener('change', async function (event) {
        const selectedFile = event.target.files[0];

        if (!selectedFile) return;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
        const fileType = selectedFile.type;
        const fileName = selectedFile.name;

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà CSV ‡∏´‡∏£‡∏∑‡∏≠ JSON ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if (fileType !== "text/csv" && !fileName.endsWith(".csv") && fileType !== "application/json" && !fileName.endsWith(".json")) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .csv ‡∏´‡∏£‡∏∑‡∏≠ .json ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô.");
            document.getElementById('fileInput').value = ""; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï input
            return;
        }

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô .csv ‡∏´‡∏£‡∏∑‡∏≠ .json
        const text = await selectedFile.text();
        const content = removeBOM(text);
        let data;

        // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
        if (fileType === "application/json" || fileName.endsWith(".json")) {
            try {
                data = JSON.parse(content);
            } catch (error) {
                document.getElementById('preview-content').innerHTML = "<p style='color:red;'>Error parsing JSON file.</p>";
                return;
            }
        } else if (fileType === "text/csv" || fileName.endsWith(".csv")) {
            data = csvToJson(content);
        }

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        uploadedData = data;

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å validate ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Back‚Äëend
        validationErrors = await validateWithBackend(selectedFile);

        // ‡πÅ‡∏™‡∏î‡∏á preview ‡∏û‡∏£‡πâ‡∏≠‡∏° highlight
        await displayProjectDetailsPreview(uploadedData, validationErrors);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Confirm Upload ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.getElementById('confirm-upload-btn').style.display = 'inline-block';

        // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ selectedFile
        window.selectedFile = selectedFile;  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
    });


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Validate API
    async function validateWithBackend(file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            const resp = await fetch("http://localhost:8080/admin/validateProjectFiles", {
                method: "POST",
                body: formData
            });
            const json = await resp.json();
            // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ response shape: { errors: { projectId: [msg1, msg2], ‚Ä¶ } }
            return json.errors || {};
        } catch (err) {
            console.error("Validation error:", err);
            return {};
        }
    }

    // ‡∏õ‡∏£‡∏±‡∏ö signature ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö validationErrors ‡πÄ‡∏û‡∏¥‡πà‡∏°
    async function displayProjectDetailsPreview(data, errorsMap) {
        const previewContent = document.getElementById('preview-content');
        previewContent.innerHTML = "";

        // ‡∏´‡∏≤ maxStudents ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á column dynamic
        let maxStudents = 0;
        data.forEach(p => {
            if (p.studentList && p.studentList.length > maxStudents) {
                maxStudents = p.studentList.length;
            }
        });

        const table = document.createElement('table');
        table.classList.add('preview-table');

        // ‚Äî Header ‚Äî
        const header = document.createElement('tr');
        let headerHTML = `
          <th>No.</th>
          <th>Project Title</th>
          <th>Project Description</th>
          <th>Program</th>
          <th>Advisor</th>
        `;
        for (let i = 1; i <= maxStudents; i++) {
            headerHTML += `<th>Student ${i}</th>`;
        }
        // // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà
        // headerHTML += `
        //   <th>Project ID</th>
        //   <th>Discrepancies</th>
        // `;
        header.innerHTML = headerHTML;
        table.appendChild(header);

        // ‚Äî Rows ‚Äî
        for (const project of data) {
            // ‡∏î‡∏∂‡∏á Project ID ‡∏ó‡∏µ‡πà generated (mock ‡∏´‡∏£‡∏∑‡∏≠ API)
            const generatedId = project.program
                ? await mockGenerateProjectId(project.program)
                : "N/A";

            // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ error ‡∏Ç‡∏≠‡∏á project ‡∏ô‡∏µ‡πâ
            const errs = errorsMap[generatedId] || [];
            const hasError = errs.length > 0;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß
            const row = document.createElement('tr');
            if (hasError) {
                row.style.backgroundColor = "#f8d7da";  // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô
            }

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• cell
            let rowHTML = `
              <td>${project.no || "-"}</td>
              <td>${project.projectTitle || "-"}</td>
              <td>${project.projectDescription || "-"}</td>
              <td>${project.program || "-"}</td>
              <td>${project.advisor || "-"}</td>
            `;

            for (let i = 0; i < maxStudents; i++) {
                if (project.studentList[i]) {
                    const s = project.studentList[i];
                    rowHTML += `<td>${s.studentId} (${s.studentName})</td>`;
                } else {
                    rowHTML += `<td></td>`;
                }
            }

            rowHTML += `</tr>`;

            row.innerHTML = rowHTML;
            table.appendChild(row);
        }

        previewContent.appendChild(table);
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
    document.getElementById('confirm-upload-btn').addEventListener('click', async () => {
        if (!window.selectedFile) {
            return showErrorsPopup(['‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô']);
        }

        const form = new FormData();
        form.append('file', window.selectedFile);

        try {
            const resp = await fetch('http://localhost:8080/admin/uploadProjectDBFiles', {
                method: 'POST',
                body: form
            });
            const json = await resp.json();

            if (json.message === 'File processed successfully') {
                Swal.fire({
                    icon: 'success',
                    title: 'Upload successful',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
            } else if (json.errors && json.errors.length) {
                showErrorsPopup(json.errors);
            } else if (json.warnings && json.warnings.length) {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ warnings ‡πÅ‡∏¢‡∏Å‡∏°‡∏≤‡∏≠‡∏µ‡∏Å popup
                Swal.fire({
                    icon: 'warning',
                    title: 'Warnings',
                    html: json.warnings
                        .map((w, i) => `<p style="text-align:left; margin:0.25em 0;">${i + 1}. ${w}</p>`)
                        .join(''),
                    width: '600px',
                    confirmButtonText: '‡∏õ‡∏¥‡∏î'
                });
            } else {
                showErrorsPopup([json.message || 'Unknown error']);
            }
        } catch (err) {
            showErrorsPopup(['‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ server', err.message]);
        }
    });

    async function mockGenerateProjectId(program) {
        try {
            const resp = await fetch(
                `http://localhost:8080/admin/generateNextProjectId?program=${encodeURIComponent(program)}`
            );
            if (!resp.ok) throw new Error("HTTP " + resp.status);
            const json = await resp.json();
            return json.projectId;
        } catch (err) {
            console.error("Error generating Project ID:", err);
            // ‡∏ï‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
            const year = new Date().getFullYear();
            return `${program} SP${year}-01`;
        }
    }


    function showErrorsPopup(errors) {
        Swal.fire({
            icon: 'error',
            title: 'Errors',
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô <p> ‡πÅ‡∏•‡πâ‡∏ß join ‡∏Å‡∏±‡∏ô
            html: errors.map(e => `<p style="text-align:left; margin:0.25em 0;">${e}</p>`).join(''),
            width: '600px',
            confirmButtonText: '‡∏õ‡∏¥‡∏î'
        });
    }


    // -------------------- Delete Project -------------------- //

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
    function confirmDelete(event, projectId) {
        event.preventDefault(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô popup ‡∏î‡πâ‡∏ß‡∏¢ projectId
        const popup = document.getElementById('confirmDeletePopup');
        const deleteConfirmMsg = document.getElementById('delete-confirm-msg');
        deleteConfirmMsg.innerHTML = `Do you want to delete project\n Project ID: ${projectId}?`;

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const cancelBtn = document.getElementById('cancelDeleteBtn');

        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Popup ‡πÅ‡∏™‡∏î‡∏á
        popup.style.display = 'block';

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
        confirmBtn.onclick = function () {
            deleteProject(projectId);  // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà backend
            popup.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Popup
        };

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        cancelBtn.onclick = function () {
            popup.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Popup
        };

        return false;  // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
    function deleteProject(projectId) {
        fetch(`http://localhost:8080/admin/deleteProject/${encodeURIComponent(projectId)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => {
                if (response.ok) {
                    alert('Delete Success!');  // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    location.reload();  // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå');
                }
            })
            .catch(error => {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            });
    }


    // -------------------- Delete ALL Project -------------------- //


    function getRequiredText() {
        return currentCategory === 'all'
            ? 'DELETE ALL PROJECT'
            : `DELETE ${currentCategory.toUpperCase()} PROJECT`;
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "Delete All" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î popup
    document.querySelector('.deleteAll-btn').addEventListener('click', () => {
        const popup = document.getElementById('deleteAllPopup');
        const sem   = document.getElementById('semester-selector').value;
        const txt   = getRequiredText();

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô <p>
        popup.querySelector('.popup-content p').textContent =
            `Type "${txt}" to delete ${
                currentCategory === 'all'
                    ? 'all projects'
                    : currentCategory.toUpperCase() + ' projects'
            } in semester ${sem}.`;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï placeholder ‡∏Ç‡∏≠‡∏á input
        const input = document.getElementById('deleteAllInput');
        input.value = '';
        input.setAttribute('placeholder', txt);

        popup.style.display = 'block';
    });

    // ‡∏ú‡∏π‡∏Å listener ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö getRequiredText()
    document.getElementById('confirmDeleteAllBtn').addEventListener('click', () => {
        const txt       = getRequiredText();
        const userInput = document.getElementById('deleteAllInput').value.trim();

        if (userInput !== txt) {
            return Swal.fire({
                icon: 'warning',
                title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                text: `‡∏û‡∏¥‡∏°‡∏û‡πå "${txt}" ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô`,
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            });
        }

        // ‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
        deleteAllProjects();
        document.getElementById('deleteAllPopup').style.display = 'none';
    });


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
    function deleteAllProjects() {
        const semester = document.getElementById('semester-selector').value;
        const program = currentCategory;  // 'all', 'ict', 'dst'
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');

        let url = `/admin/deleteProjectsBySemester?semester=${encodeURIComponent(semester)}`;
        if (program !== 'all') {
            url += `&program=${encodeURIComponent(program)}`;
        }

        fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': token
            }
        })
            .then(res => {
                if (!res.ok) return res.text().then(t => { throw new Error(t) });
                return res.text();
            })
            .then(msg => Swal.fire({
                icon: 'success',
                title: 'Deleted',
                text: msg,
                showConfirmButton: false,
                timer: 2000
            }).then(() => location.reload()))
            // .catch(err => Swal.fire('Error', err.message, 'error'));
    }

    // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏° confirm
    document.getElementById('confirmDeleteAllBtn').addEventListener('click', function () {
        const userInput = document.getElementById('deleteAllInput').value.trim();
        if (userInput !== 'DELETE ALL PROJECT') {
            return Swal.fire({
                icon: 'warning',
                title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                text: '‡∏û‡∏¥‡∏°‡∏û‡πå "DELETE ALL PROJECT" ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            });
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö ‡πÇ‡∏î‡∏¢‡πÄ‡∏≠‡∏≤ program ‡∏°‡∏≤‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏î‡πâ‡∏ß‡∏¢
        deleteAllProjects();
        document.getElementById('deleteAllPopup').style.display = 'none';
    });


    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Cancel
    document.getElementById('cancelDeleteAllBtn').addEventListener('click', function () {
        document.getElementById('deleteAllPopup').style.display = 'none';
    });


</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
<script>

    // -------------------- Export Template Project -------------------- //

    function exportRawData() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å fetch ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!projectsData || projectsData.length === 0) {
            alert("No project data available to export.");
            return;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö rows ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
        let dataRows = [];
        projectsData.forEach(project => {
            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÉ‡∏ô professorList
            let advisor = "";
            let coAdvisor = "";
            // let posterCommittee = "";
            if (project.professorList && Array.isArray(project.professorList)) {
                project.professorList.forEach(prof => {
                    if (prof.role === "Advisor") {
                        advisor = prof.professorName;
                    } else if (prof.role === "Co-advisor") {
                        coAdvisor = prof.professorName;
                    }
                    // } else if (prof.role === "Committee") {
                    //     committee = prof.professorName
                    // }
                });
            }

            // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
            if (project.studentList && Array.isArray(project.studentList) && project.studentList.length > 0) {
                project.studentList.forEach(student => {
                    dataRows.push([
                        project.projectId,
                        project.projectTitle,
                        project.projectDescription,
                        project.category || "",
                        student.studentId,
                        student.studentName,
                        project.program,
                        advisor,
                        coAdvisor,
                        // committee,
                        // ""
                    ]);
                });
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                dataRows.push([
                    project.projectId,
                    project.projectTitle,
                    project.projectDescription,
                    project.category || "",
                    "",
                    "",
                    project.program,
                    advisor,
                    coAdvisor,
                    // committee,
                    // ""
                ]);
            }
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook ‡πÅ‡∏•‡∏∞ Worksheet ‡∏î‡πâ‡∏ß‡∏¢ ExcelJS
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet("Project List");

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        ws.columns = [
            {width: 15},  // A - Project ID
            {width: 25},  // B - Project Title
            {width: 30},  // C - Project Description
            {width: 15},  // D - Project Category (‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡∏î‡πå project.category)
            {width: 15},  // E - Student ID
            {width: 25},  // F - Student Name
            {width: 10},  // G - Program
            {width: 20},  // H - Advisor
            {width: 20},  // I - Co-advisor
            // {width: 20},  // J - Committee
            // {width: 20},  // K - Poster-Committee
        ];

        // Merge cells ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header (‡πÅ‡∏ñ‡∏ß 1-4)
        ws.mergeCells('A1:I1');
        ws.mergeCells('A2:I2');
        ws.mergeCells('A3:I3');
        ws.mergeCells('A4:I4');

        // ‡πÅ‡∏ñ‡∏ß 1
        ws.getCell('A1').value = "Senior Project Overview";
        ws.getCell('A1').font = {bold: true, size: 14, color: {argb: 'FF000000'}};
        ws.getCell('A1').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 2
        ws.getCell('A2').value = "Exported Project Data";
        ws.getCell('A2').font = {size: 12, color: {argb: 'FF4D93D9'}};
        ws.getCell('A2').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 3
        ws.getCell('A3').value = "Link to view detailed project information";
        ws.getCell('A3').font = {bold: true, size: 12, color: {argb: 'FF000000'}};
        ws.getCell('A3').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 4
        ws.getCell('A4').value = "https://yourprojectlink.example.com";
        ws.getCell('A4').font = {size: 10, color: {argb: 'FF000000'}};
        ws.getCell('A4').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 5: Header Row ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        const headerRow = ws.getRow(5);
        headerRow.values = [
            "Project ID",
            "Project Title",
            "Project Description",
            "Project Category",
            "Student ID",
            "Student Name",
            "Program",
            "Advisor",
            "Co-Advisor",
            // "Committee",
            // "Poster-Committee"
        ];

        headerRow.font = {bold: true, size: 11, color: {argb: 'FF000000'}};
        headerRow.alignment = {vertical: 'middle', horizontal: 'center'};
        headerRow.fill = {type: 'pattern', pattern: 'solid', fgColor: {argb: 'FFB5E6A2'}};

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Border ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÉ‡∏ô header row
        headerRow.eachCell(cell => {
            cell.border = {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            };
        });

        // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô)
        const dataRowStyle = {
            fill: {fgColor: {argb: 'FFC8E6C9'}},
            border: {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            }
        };

        // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ row ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 6 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ
        dataRows.forEach(rowData => {
            let newRow = ws.addRow(rowData);
            newRow.eachCell(cell => {
                cell.alignment = {vertical: 'middle', horizontal: 'left'};
                cell.fill = dataRowStyle.fill;
                cell.border = dataRowStyle.border;
            });
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡πâ‡∏ß trigger ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        wb.xlsx.writeBuffer()
            .then(buffer => {
                const blob = new Blob([buffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Raw_Project_data.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("Error generating Excel file:", error);
            });
    }

    // // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Export
    // document.getElementById("export-project-raw-excel").addEventListener("click", exportRawData);


    function exportMergedData() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ projectsData ‡∏à‡∏≤‡∏Å fetch ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!projectsData || projectsData.length === 0) {
            alert("No project data available to export.");
            return;
        }

        const headers = [
            "Project ID",
            "Project Title",
            "Project Description",
            "Project Category",
            "Student ID",
            "Student Name",
            "Program",
            "Advisor",
            "Co-advisor"
        ];

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö rows ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
        let dataRows = [];
        // mapping ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå: key = projectId, value = { start: index, end: index }
        let projectMapping = new Map();

        projectsData.forEach(project => {
            // ------------------- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå -------------------
            let projectId = project.projectId || "";
            let projectTitle = project.projectTitle || "";
            let projectDescription = project.projectDescription || "";
            let projectCategory = project.category || "";
            let program = project.program || "";

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Advisor/Co-advisor
            let advisor = "";
            let coAdvisor = "";
            if (project.professorList && Array.isArray(project.professorList)) {
                project.professorList.forEach(prof => {
                    if (prof.role === "Advisor") {
                        advisor = prof.professorName;
                    } else if (prof.role === "Co-advisor") {
                        coAdvisor = prof.professorName;
                    }
                });
            }

            // ------------------- Student -------------------
            let studentList = [];
            if (project.studentList && Array.isArray(project.studentList) && project.studentList.length > 0) {
                studentList = project.studentList.map(student => ({
                    studentId: student.studentId || "",
                    studentName: student.studentName || ""
                }));
            }
            // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏®.‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 3 ‡πÉ‡∏´‡πâ padding ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
            const minRows = 3;
            while (studentList.length < minRows) {
                studentList.push({studentId: "", studentName: ""});
            }
            const numRows = studentList.length;

            // // ------------------- Committee -------------------
            // // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ project.committeeList
            // // ‡πÉ‡∏´‡πâ filter ‡∏°‡∏≤‡∏à‡∏≤‡∏Å professorList ‡πÅ‡∏ó‡∏ô
            // let committees = [];
            // if (project.professorList && Array.isArray(project.professorList)) {
            //     committees = project.professorList
            //         .filter(p => p.role === "Committee")
            //         .map(p => p.professorName || "");
            // }
            // // ‡πÄ‡∏ï‡∏¥‡∏°/‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö numRows
            // while (committees.length < numRows) {
            //     committees.push("");
            // }
            // if (committees.length > numRows) {
            //     committees = committees.slice(0, numRows);
            // }
            //
            // // ------------------- Poster Committee -------------------
            // let posterCommittees = [];
            // if (project.professorList && Array.isArray(project.professorList)) {
            //     posterCommittees = project.professorList
            //         .filter(p => p.role === "posterCommittee")
            //         .map(p => p.professorName || "");
            // }
            // while (posterCommittees.length < numRows) {
            //     posterCommittees.push("");
            // }
            // if (posterCommittees.length > numRows) {
            //     posterCommittees = posterCommittees.slice(0, numRows);
            // }

            // ------------------- ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á dataRows -------------------
            let startIndex = dataRows.length; // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            for (let i = 0; i < numRows; i++) {
                let row = [
                    projectId,             // index 0 => Col A
                    projectTitle,          // index 1 => Col B
                    projectDescription,    // index 2 => Col C
                    projectCategory,       // index 3 => Col D
                    studentList[i].studentId,   // index 4 => Col E
                    studentList[i].studentName, // index 5 => Col F
                    program,               // index 6 => Col G
                    advisor,               // index 7 => Col H
                    coAdvisor,             // index 8 => Col I
                ];
                dataRows.push(row);
            }
            let endIndex = dataRows.length;
            projectMapping.set(projectId, {start: startIndex, end: endIndex});
        });

        // ------------------- ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook, Worksheet ‡∏î‡πâ‡∏ß‡∏¢ ExcelJS -------------------
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet("Project Committee Overview");

        // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô 11 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (A..K)
        ws.columns = [
            {width: 15}, // A: Project ID
            {width: 25}, // B: Project Title
            {width: 30}, // C: Project Description
            {width: 15}, // D: Project Category
            {width: 15}, // E: Student ID
            {width: 25}, // F: Student Name
            {width: 10}, // G: Program
            {width: 20}, // H: Advisor
            {width: 20}, // I: Co-advisor
        ];

        // Merge cells ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header area (‡πÅ‡∏ñ‡∏ß 1-4) -> A1:K1, A2:K2, ‡∏Ø‡∏•‡∏Ø
        ws.mergeCells('A1:I1');
        ws.mergeCells('A2:I2');
        ws.mergeCells('A3:I3');
        ws.mergeCells('A4:I4');

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Header area
        ws.getCell('A1').value = "Senior Project Overview";
        ws.getCell('A1').font = {bold: true, size: 14, color: {argb: 'FF000000'}};
        ws.getCell('A1').alignment = {horizontal: 'center', vertical: 'middle'};

        ws.getCell('A2').value = "Exported Project Committee Data";
        ws.getCell('A2').font = {size: 12, color: {argb: 'FF4D93D9'}};
        ws.getCell('A2').alignment = {horizontal: 'center', vertical: 'middle'};

        ws.getCell('A3').value = "Link to view detailed project information";
        ws.getCell('A3').font = {bold: true, size: 12, color: {argb: 'FF000000'}};
        ws.getCell('A3').alignment = {horizontal: 'center', vertical: 'middle'};

        ws.getCell('A4').value = "https://yourprojectlink.example.com";
        ws.getCell('A4').font = {size: 10, color: {argb: 'FF000000'}};
        ws.getCell('A4').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 5: Header Row ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        const headerRow = ws.getRow(5);
        headerRow.values = headers;  // 11 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        headerRow.font = {bold: true, size: 11, color: {argb: 'FF000000'}};
        headerRow.alignment = {vertical: 'middle', horizontal: 'center'};
        headerRow.fill = {type: 'pattern', pattern: 'solid', fgColor: {argb: 'FFB5E6A2'}};
        headerRow.eachCell(cell => {
            cell.border = {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            };
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• rows ‡∏•‡∏á‡πÉ‡∏ô worksheet (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 6)
        dataRows.forEach(rowData => {
            ws.addRow(rowData);
        });

        // ‡πÅ‡∏õ‡∏•‡∏á projectMapping ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß
        projectMapping.forEach((range, projId) => {
            let startRow = range.start + 6; // ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°
            let endRow = range.end + 5;     // ‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (exclusive ‡∏Ç‡∏≠‡∏á endIndex ‡∏à‡∏∂‡∏á -1 +6 = +5)

            // Merge ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Project-level: A(1), B(2), C(3), D(4), G(7), H(8), I(9)
            // ‡πÑ‡∏°‡πà merge E(5), F(6) (‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤), J(10), K(11) (committee, posterCommittee)
            if (startRow < endRow) {
                [1, 2, 3, 4, 7, 8, 9].forEach(col => {
                    ws.mergeCells(startRow, col, endRow, col);
                });
            } else if (startRow === endRow) {
                // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡πÅ‡∏ñ‡∏ß => ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
                let extraRows = 3 - 1; // ‡∏°‡∏µ 1 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡πâ‡∏ß => ‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡πÅ‡∏ñ‡∏ß
                for (let i = 0; i < extraRows; i++) {
                    ws.addRow(["", "", "", "", "", "", "", "", "", "", ""]);
                    endRow++;
                }
                [1, 2, 3, 4, 7, 8, 9].forEach(col => {
                    ws.mergeCells(startRow, col, endRow, col);
                });
            }
        });

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö data rows (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô)
        const dataRowStyle = {
            fill: {fgColor: {argb: 'FFC8E6C9'}},
            border: {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            }
        };

        // Apply style ‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß 6 ‡∏•‡∏á‡πÑ‡∏õ)
        for (let i = 6; i <= ws.rowCount; i++) {
            let row = ws.getRow(i);
            row.eachCell(cell => {
                cell.alignment = {vertical: 'middle', horizontal: 'left'};
                cell.fill = dataRowStyle.fill;
                cell.border = dataRowStyle.border;
            });
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡πâ‡∏ß trigger ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        wb.xlsx.writeBuffer()
            .then(buffer => {
                const blob = new Blob([buffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Merge_Project_Data.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("Error generating Excel file:", error);
            });
    }

    // // ‡∏ú‡∏π‡∏Å event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
    // document.getElementById("export-project-merge-excel").addEventListener("click", exportMergedData);


    function exportProjectTemplate() {
        //
        // const semester = document.getElementById('semester-selector').value;
        //
        // // 1) ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ï‡∏≤‡∏° semester
        // const filteredProjects = projectsData.filter(p => String(p.semester) === semester);
        // if (filteredProjects.length === 0) {
        //     return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${semester}`, 'info');
        // }

        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet("Project List");

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        ws.columns = [
            {width: 15},  // A - No.
            {width: 25},  // B - Project Title
            {width: 30},  // C - Project Description
            {width: 15},  // D - Project Category
            {width: 15},  // E - Student ID
            {width: 25},  // F - Student Name
            {width: 10},  // G - Program
            {width: 20},  // H - Advisor
            {width: 20},  // I - Co-advisor
        ];

        // Merge cells ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header (‡πÅ‡∏ñ‡∏ß 1-4)
        ws.mergeCells('A1:I1');
        ws.mergeCells('A2:I2');
        ws.mergeCells('A3:I3');
        ws.mergeCells('A4:I4');

        // ‡πÅ‡∏ñ‡∏ß 1
        ws.getCell('A1').value = "Senior Project SignUp Template";
        ws.getCell('A1').font = {bold: true, size: 14, color: {argb: 'FF000000'}};
        ws.getCell('A1').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 2
        ws.getCell('A2').value = "Sign up template";
        ws.getCell('A2').font = {size: 12, color: {argb: 'FF4D93D9'}};
        ws.getCell('A2').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 3
        ws.getCell('A3').value = "Link to view detailed project information";
        ws.getCell('A3').font = {bold: true, size: 12, color: {argb: 'FF000000'}};
        ws.getCell('A3').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 4
        ws.getCell('A4').value = "https://yourprojectlink.example.com";
        ws.getCell('A4').font = {size: 10, color: {argb: 'FF000000'}};
        ws.getCell('A4').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 5: Header Row ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        const headerRow = ws.getRow(5);
        headerRow.values = [
            "No.",
            "Project Title",
            "Project Description",
            "Project Category",
            "Student ID",
            "Student Name",
            "Program",
            "Advisor",
            "Co-Advisor",
        ];

        headerRow.font = {bold: true, size: 11, color: {argb: 'FF000000'}};
        headerRow.alignment = {vertical: 'middle', horizontal: 'center'};
        headerRow.fill = {type: 'pattern', pattern: 'solid', fgColor: {argb: 'FFB5E6A2'}};

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Border ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÉ‡∏ô header row
        headerRow.eachCell(cell => {
            cell.border = {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            };
        });

        // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô + Border)
        const dataRowStyle = {
            fill: {fgColor: {argb: 'FFC8E6C9'}}, // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô
            border: {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            }
        };

        // -----------------------------------------------
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á" ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 6 ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 8
        // -----------------------------------------------
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á merge (A, B, C, D, G, H) ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡πÅ‡∏ñ‡∏ß 6)
        // ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô (E, F, I) ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ

        // Sample data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß 6 (‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà merge)
        const mergedData = {
            A: "X",              // No. (Merged)
            B: "XXXXX",          // Project Title (Merged)
            C: "XXXXX",          // Project Description (Merged)
            D: "XXXXX",          // Project Category (Merged)
            G: "DST or ICT",     // Program (Merged)
            H: "Aj.XXXX"         // Advisor (Merged)
        };

        // Sample data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà merge (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E, F, I)
        // ‡πÅ‡∏ñ‡∏ß 6
        const row6Extra = {
            E: "648XXXX",
            F: "XXXXXXX",
            I: "Aj.XXXX"
        };
        // ‡πÅ‡∏ñ‡∏ß 7
        const row7Extra = {
            E: "648XXXX",
            F: "XXXXXXX",
            I: "Aj.XXXX"
        };
        // ‡πÅ‡∏ñ‡∏ß 8
        const row8Extra = {
            E: "648XXXX",
            F: "XXXXXXX",
            I: "Aj.XXXX"
        };

        // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß 6-8
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà merge (A, B, C, D, G, H) ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏≤‡∏Å mergedData ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß 6
        // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß 7 ‡∏Å‡∏±‡∏ö 8 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà merge‡∏à‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å merge‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô)
        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà merge (E, F, I) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏° rowExtra ‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô

        // ‡πÅ‡∏ñ‡∏ß 6
        const row6 = ws.getRow(6);
        row6.getCell('A').value = mergedData.A;
        row6.getCell('B').value = mergedData.B;
        row6.getCell('C').value = mergedData.C;
        row6.getCell('D').value = mergedData.D;
        row6.getCell('E').value = row6Extra.E;
        row6.getCell('F').value = row6Extra.F;
        row6.getCell('G').value = mergedData.G;
        row6.getCell('H').value = mergedData.H;
        row6.getCell('I').value = row6Extra.I;
        row6.eachCell(cell => {
            cell.alignment = {vertical: 'middle', horizontal: 'left'};
            cell.fill = dataRowStyle.fill;
            cell.border = dataRowStyle.border;
        });

        // ‡πÅ‡∏ñ‡∏ß 7
        const row7 = ws.getRow(7);
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà merge ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ (‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å row6 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ merge)
        row7.getCell('E').value = row7Extra.E;
        row7.getCell('F').value = row7Extra.F;
        row7.getCell('I').value = row7Extra.I;
        row7.eachCell(cell => {
            cell.alignment = {vertical: 'middle', horizontal: 'left'};
            cell.fill = dataRowStyle.fill;
            cell.border = dataRowStyle.border;
        });

        // ‡πÅ‡∏ñ‡∏ß 8
        const row8 = ws.getRow(8);
        row8.getCell('E').value = row8Extra.E;
        row8.getCell('F').value = row8Extra.F;
        row8.getCell('I').value = row8Extra.I;
        row8.eachCell(cell => {
            cell.alignment = {vertical: 'middle', horizontal: 'left'};
            cell.fill = dataRowStyle.fill;
            cell.border = dataRowStyle.border;
        });

        // Merge cells ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á merge‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß 6 ‡∏ñ‡∏∂‡∏á 8
        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A, B, C, D, G, H
        ws.mergeCells('A6:A8');
        ws.mergeCells('B6:B8');
        ws.mergeCells('C6:C8');
        ws.mergeCells('D6:D8');
        ws.mergeCells('G6:G8');
        ws.mergeCells('H6:H8');

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡πâ‡∏ß trigger ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        wb.xlsx.writeBuffer()
            .then(buffer => {
                const blob = new Blob([buffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'ProjectTemplate_ForProjectSignUp.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("Error generating Excel file:", error);
            });
    }

    // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏° Export
    document.getElementById("export-project-template").addEventListener("click", exportProjectTemplate);


    function exportCommitteeTemplate() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ projectsData ‡∏à‡∏≤‡∏Å fetch ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!projectsData || projectsData.length === 0) {
            alert("No project data available to export.");
            return;
        }

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Header ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel
        const headers = [
            "Project ID",
            "Project Title",
            "Project Description",
            "Project Category",
            "Student ID",
            "Student Name",
            "Program",
            "Advisor",
            "Co-advisor",
            "Committee"
        ];

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö rows ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
        let dataRows = [];
        // mapping ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå: key = projectId, value = { start: index, end: index }
        let projectMapping = new Map();

        projectsData.forEach(project => {
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
            let projectId = project.projectId || "";
            let projectTitle = project.projectTitle || "";
            let projectDescription = project.projectDescription || "";
            let projectCategory = project.category || "";
            let program = project.program || "";

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Advisor/Co-advisor ‡∏à‡∏≤‡∏Å professorList
            let advisor = "";
            let coAdvisor = "";
            if (project.professorList && Array.isArray(project.professorList)) {
                project.professorList.forEach(prof => {
                    if (prof.role === "Advisor") {
                        advisor = prof.professorName;
                    } else if (prof.role === "Co-advisor") {
                        coAdvisor = prof.professorName;
                    }
                });
            }

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
            let studentList = [];
            if (project.studentList && Array.isArray(project.studentList) && project.studentList.length > 0) {
                studentList = project.studentList.map(student => {
                    return {
                        studentId: student.studentId || "",
                        studentName: student.studentName || ""
                    };
                });
            }
            // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏®.‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 3 ‡πÉ‡∏´‡πâ padding ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
            const minRows = 3;
            while (studentList.length < minRows) {
                studentList.push({studentId: "", studentName: ""});
            }
            // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á rows‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ
            const numRows = studentList.length;

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Committee:
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ committeeList ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ; ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô array ‡∏ß‡πà‡∏≤‡∏á
            let committees = [];
            if (project.committeeList && Array.isArray(project.committeeList) && project.committeeList.length > 0) {
                committees = project.committeeList.map(item => item.professorName || "");
            }
            // padding committees ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö numRows (‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡πà‡∏≤‡∏á)
            while (committees.length < numRows) {
                committees.push("");
            }
            // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà numRows ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
            if (committees.length > numRows) {
                committees = committees.slice(0, numRows);
            }

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏ô dataRows
            let startIndex = dataRows.length;
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ row (‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤)
            for (let i = 0; i < numRows; i++) {
                let row = [
                    projectId,             // Column 1: Project ID (project-level, merge)
                    projectTitle,          // Column 2: Project Title (merge)
                    projectDescription,    // Column 3: Project Description (merge)
                    projectCategory,       // Column 4: Project Category (merge)
                    studentList[i].studentId,   // Column 5: Student ID (‡πÑ‡∏°‡πà merge)
                    studentList[i].studentName, // Column 6: Student Name (‡πÑ‡∏°‡πà merge)
                    program,               // Column 7: Program (merge)
                    advisor,               // Column 8: Advisor (merge)
                    coAdvisor,             // Column 9: Co-advisor (merge)
                    committees[i]          // Column 10: Committee (‡πÑ‡∏°‡πà merge)
                ];
                dataRows.push(row);
            }
            let endIndex = dataRows.length; // dataRows index: startIndex .. endIndex-1
            projectMapping.set(projectId, {start: startIndex, end: endIndex});
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook ‡πÅ‡∏•‡∏∞ Worksheet ‡∏î‡πâ‡∏ß‡∏¢ ExcelJS
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet("Project Committee Overview");

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ï‡∏≤‡∏° headers)
        ws.columns = [
            {width: 15},  // A: Project ID
            {width: 25},  // B: Project Title
            {width: 30},  // C: Project Description
            {width: 15},  // D: Project Category
            {width: 15},  // E: Student ID
            {width: 25},  // F: Student Name
            {width: 10},  // G: Program
            {width: 20},  // H: Advisor
            {width: 20},  // I: Co-advisor
            {width: 20}   // J: Committee
        ];

        // Merge cells ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header area (‡πÅ‡∏ñ‡∏ß 1-4)
        ws.mergeCells('A1:J1');
        ws.mergeCells('A2:J2');
        ws.mergeCells('A3:J3');
        ws.mergeCells('A4:J4');

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Header area
        ws.getCell('A1').value = "Senior Project Overview";
        ws.getCell('A1').font = {bold: true, size: 14, color: {argb: 'FF000000'}};
        ws.getCell('A1').alignment = {horizontal: 'center', vertical: 'middle'};

        ws.getCell('A2').value = "Exported Project Committee Data";
        ws.getCell('A2').font = {size: 12, color: {argb: 'FF4D93D9'}};
        ws.getCell('A2').alignment = {horizontal: 'center', vertical: 'middle'};

        ws.getCell('A3').value = "Link to view detailed project information";
        ws.getCell('A3').font = {bold: true, size: 12, color: {argb: 'FF000000'}};
        ws.getCell('A3').alignment = {horizontal: 'center', vertical: 'middle'};

        ws.getCell('A4').value = "https://yourprojectlink.example.com";
        ws.getCell('A4').font = {size: 10, color: {argb: 'FF000000'}};
        ws.getCell('A4').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 5: Header Row ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        const headerRow = ws.getRow(5);
        headerRow.values = headers;
        headerRow.font = {bold: true, size: 11, color: {argb: 'FF000000'}};
        headerRow.alignment = {vertical: 'middle', horizontal: 'center'};
        headerRow.fill = {type: 'pattern', pattern: 'solid', fgColor: {argb: 'FFB5E6A2'}};
        headerRow.eachCell(cell => {
            cell.border = {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            };
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• rows ‡∏•‡∏á‡πÉ‡∏ô worksheet (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 6)
        dataRows.forEach(rowData => {
            ws.addRow(rowData);
        });

        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô worksheet
        let totalRows = ws.rowCount;
        // ‡πÅ‡∏õ‡∏•‡∏á projectMapping (‡πÄ‡∏Å‡πá‡∏ö index ‡∏Ç‡∏≠‡∏á dataRows) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô worksheet
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• rows ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 6 ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô map index + 6
        projectMapping.forEach((range, projId) => {
            let startRow = range.start + 6;
            let endRow = range.end + 5;  // merge cells from startRow to endRow (inclusive)
            // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå project-level: A (1), B (2), C (3), D (4), G (7), H (8), I (9)
            if (startRow < endRow) {
                [1, 2, 3, 4, 7, 8, 9].forEach(col => {
                    ws.mergeCells(startRow, col, endRow, col);
                });
            } else if (startRow === endRow) {
                // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á merge‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏õ‡πá‡∏ô 3 ‡πÅ‡∏ñ‡∏ß => ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á 2 ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á) ‡πÅ‡∏•‡πâ‡∏ß merge
                let extraRows = 3 - 1; // 2 extra rows
                for (let i = 0; i < extraRows; i++) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
                    ws.addRow(["", "", "", "", "", "", "", "", "", ""]);
                    endRow++; // ‡∏õ‡∏£‡∏±‡∏ö endRow ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
                }
                [1, 2, 3, 4, 7, 8, 9].forEach(col => {
                    ws.mergeCells(startRow, col, endRow, col);
                });
            }
        });

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö data rows (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô)
        const dataRowStyle = {
            fill: {fgColor: {argb: 'FFC8E6C9'}},
            border: {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            }
        };
        // Apply style for each data row cell
        for (let i = 6; i <= ws.rowCount; i++) {
            let row = ws.getRow(i);
            row.eachCell(cell => {
                cell.alignment = {vertical: 'middle', horizontal: 'left'};
                cell.fill = dataRowStyle.fill;
                cell.border = dataRowStyle.border;
            });
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡πâ‡∏ß trigger ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        wb.xlsx.writeBuffer().then(buffer => {
            const blob = new Blob([buffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'ForCommittee_SignUp.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }).catch(error => {
            console.error("Error generating Excel file:", error);
        });
    }

    // // ‡∏ú‡∏π‡∏Å event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
    // document.getElementById("export-committee-template").addEventListener("click", exportCommitteeTemplate);


    function exportPosterCommitteeTemplate() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å fetch ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!projectsData || projectsData.length === 0) {
            alert("No project data available to export.");
            return;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö rows ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
        let dataRows = [];
        projectsData.forEach(project => {
            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÉ‡∏ô professorList
            let advisor = "";
            let coAdvisor = "";
            let posterCommittee = "";
            if (project.professorList && Array.isArray(project.professorList)) {
                project.professorList.forEach(prof => {
                    if (prof.role === "Advisor") {
                        advisor = prof.professorName;
                    } else if (prof.role === "Co-advisor") {
                        coAdvisor = prof.professorName;
                    } else if (prof.role === "Committee") {
                        committee = prof.professorName
                    }
                });
            }

            // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
            if (project.studentList && Array.isArray(project.studentList) && project.studentList.length > 0) {
                project.studentList.forEach(student => {
                    dataRows.push([
                        project.projectId,
                        project.projectTitle,
                        project.projectDescription,
                        project.category || "",
                        student.studentId,
                        student.studentName,
                        project.program,
                        advisor,
                        coAdvisor,
                        committee,
                        ""
                    ]);
                });
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                dataRows.push([
                    project.projectId,
                    project.projectTitle,
                    project.projectDescription,
                    project.category || "",
                    "",
                    "",
                    project.program,
                    advisor,
                    coAdvisor,
                    committee,
                    ""
                ]);
            }
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook ‡πÅ‡∏•‡∏∞ Worksheet ‡∏î‡πâ‡∏ß‡∏¢ ExcelJS
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet("Project List");

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        ws.columns = [
            {width: 15},  // A - Project ID
            {width: 25},  // B - Project Title
            {width: 30},  // C - Project Description
            {width: 15},  // D - Project Category (‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡∏î‡πå project.category)
            {width: 15},  // E - Student ID
            {width: 25},  // F - Student Name
            {width: 10},  // G - Program
            {width: 20},  // H - Advisor
            {width: 20},  // I - Co-advisor
            {width: 20},  // J - Committee
            {width: 20},  // K - Poster-Committee
        ];

        // Merge cells ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header (‡πÅ‡∏ñ‡∏ß 1-4)
        ws.mergeCells('A1:K1');
        ws.mergeCells('A2:K2');
        ws.mergeCells('A3:K3');
        ws.mergeCells('A4:K4');

        // ‡πÅ‡∏ñ‡∏ß 1
        ws.getCell('A1').value = "Senior Project Overview";
        ws.getCell('A1').font = {bold: true, size: 14, color: {argb: 'FF000000'}};
        ws.getCell('A1').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 2
        ws.getCell('A2').value = "Exported Project Data";
        ws.getCell('A2').font = {size: 12, color: {argb: 'FF4D93D9'}};
        ws.getCell('A2').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 3
        ws.getCell('A3').value = "Link to view detailed project information";
        ws.getCell('A3').font = {bold: true, size: 12, color: {argb: 'FF000000'}};
        ws.getCell('A3').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 4
        ws.getCell('A4').value = "https://yourprojectlink.example.com";
        ws.getCell('A4').font = {size: 10, color: {argb: 'FF000000'}};
        ws.getCell('A4').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 5: Header Row ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        const headerRow = ws.getRow(5);
        headerRow.values = [
            "Project ID",
            "Project Title",
            "Project Description",
            "Project Category",
            "Student ID",
            "Student Name",
            "Program",
            "Advisor",
            "Co-advisor",
            "Committee",
            "Poster-Committee"
        ];

        headerRow.font = {bold: true, size: 11, color: {argb: 'FF000000'}};
        headerRow.alignment = {vertical: 'middle', horizontal: 'center'};
        headerRow.fill = {type: 'pattern', pattern: 'solid', fgColor: {argb: 'FFB5E6A2'}};

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Border ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÉ‡∏ô header row
        headerRow.eachCell(cell => {
            cell.border = {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            };
        });

        // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô)
        const dataRowStyle = {
            fill: {fgColor: {argb: 'FFC8E6C9'}},
            border: {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            }
        };

        // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ row ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 6 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ
        dataRows.forEach(rowData => {
            let newRow = ws.addRow(rowData);
            newRow.eachCell(cell => {
                cell.alignment = {vertical: 'middle', horizontal: 'left'};
                cell.fill = dataRowStyle.fill;
                cell.border = dataRowStyle.border;
            });
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡πâ‡∏ß trigger ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        wb.xlsx.writeBuffer()
            .then(buffer => {
                const blob = new Blob([buffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Project_Overview.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("Error generating Excel file:", error);
            });
    }

    // // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Export
    // document.getElementById("export-poster-committee-template").addEventListener("click", exportPosterCommitteeTemplate);
    //

</script>

</html>


