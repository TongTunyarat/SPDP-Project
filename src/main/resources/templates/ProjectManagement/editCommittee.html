<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Edit Committee Details </title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-admin.css">
    <link rel="stylesheet" href="/css/editCommittee.css">

    <!-- Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>
        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                </path>
            </svg> Homepage </h4>
            <li><a href="/admin-dashboard">Dashboard</a></li>
            <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
            <li><a href="/admin-timeliness-scoring">Timeliness Scoring</a></li>
        </ul>

        <h2> Pages </h2>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                <g fill="#ffffff" fill-rule="nonzero">
                    <g transform="scale(5.33333,5.33333)">
                        <path
                                d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                        </path>
                    </g>
                </g>
            </svg>Score Evaluation </h4>
            <li><a href="/scoring-periods">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                </path>
            </svg> Manage Schedule </h4>
            <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
            <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
            <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
            <li><a href="/admin/editDefenseSchedulePage">Edit Defense Timing</a></li>
        </ul>

        <ul>
            <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="fill:#FFFFFF;">
                <path
                        d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                </path>
            </svg> Manage Project </h4>
            <li><a href="/project-overview">Project Overview</a></li>
            <li><a href="/project-details">Project Details</a></li>
            <li><a href="/project-committee" class="active">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>

    <div class="content">

        <div class="header-section">
            Edit Committee
        </div>

        <div class="body-section">

            <div class="modal">
                <div class="modal-content" id="modal-container">

                </div>
            </div>

            <!-- Popup ยืนยันการลบ -->
            <div id="confirmDeletePopup" class="delete-popup">
                <div class="popup-content">
                    <div id="delete-confirm-msg"></div>
                    <button id="confirmDeleteBtn">Yes, Delete</button>
                    <button id="cancelDeleteBtn">Cancel</button>
                </div>
            </div>

            <!-- Popup ยืนยันการบันทึก (Save) -->
            <div id="confirmSavePopup" class="save-popup">
                <div class="popup-content">
                    <div id="save-confirm-msg">Are you sure you want to save the changes?</div>
                    <button id="confirmSaveBtn">Yes, Save</button>
                    <button id="cancelSaveBtn">Cancel</button>
                </div>
            </div>

        </div>
    </div>
</div>
</body>

</html>

<script>

    document.addEventListener("DOMContentLoaded", function () {
        const menuItems = document.querySelectorAll(".sidebar ul li a");

        // ดึง URL ปัจจุบัน
        const currentPage = window.location.pathname.split("/").pop();

        menuItems.forEach(item => {
            if (item.getAttribute("href") === currentPage) {
                item.classList.add("active"); // เพิ่ม class "active" ให้เมนูปัจจุบัน
            }
        });
    });

    // -------------------- Fetch Project -------------------- //
    // ฟังก์ชันสำหรับดึงข้อมูลจาก API
    function fetchData(projectId) {
        const url = `http://localhost:8080/admin/editDetails?projectId=${encodeURIComponent(projectId)}`;

        // ใช้ fetch เพื่อดึงข้อมูลจาก API
        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); // แปลงข้อมูลเป็น JSON
            })
            .then(data => {
                return data; // คืนค่าข้อมูลจาก API
            })
            .catch(error => {
                console.error("Error fetching data:", error);
            });
    }

    function displayResults(data) {
        console.log(data);

        // ดึงข้อมูลจาก studentList โดยตรง
        const students = data.studentList;
        const advisors = data.professorList.filter(professor => professor.role === "Advisor");
        const coAdvisors = data.professorList.filter(professor => professor.role === "Co-Advisor");
        const committees = data.professorList.filter(professor => professor.role === "Committee");
        const posterCommittees = data.professorList.filter(professor => professor.role === "Poster-Committee");
        const allProfessors = data.professorList;

        // สร้าง HTML สำหรับ modal
        let modalHTML = `
    <h3>Project Details</h3>
    <div class="form-group">
        <label>Project ID :</label>
        <div class="input-icon">
            <input type="text" value="${data.projectId}" disabled>
        </div>
    </div>
    <div class="form-group">
        <label>Project Name :</label>
        <div class="input-icon">
            <input type="text" id="projectTitle" value="${data.projectTitle}" disabled>
        </div>
    </div>
    <div class="form-group">
        <label>Project Description :</label>
        <div class="input-icon">
            <textarea id="projectDescription" disabled>${data.projectDescription}</textarea>
        </div>
    </div>

    <h3>Member Details</h3>
    <div class="form-group-row">
        <div class="form-group">
            <label>Program :</label>
            <input id="program" type="text" value="${data.program}" disabled>
        </div>
        <div class="form-group">
            <label>Semester :</label>
            <input type="text" value="2024" disabled>
        </div>
    </div>

    <!-- แสดงสมาชิกจาก studentList -->
    <div id="studentList">
        <table>
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Student Name</th>
                    <th>Program</th>
                    <th>Section</th>
                    <th>Track</th>
                </tr>
            </thead>
            <tbody>
                ${students.map(student => `
                    <tr>
                        <td>${student.studentId}</td>
                        <td>${student.studentName}</td>
                        <td>${data.program}</td>
                        <td>${student.section}</td>
                        <td>${student.track || '-'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    </div>

    <h3>Instructor Details</h3>

    <!-- Advisor Section -->
    <div class="form-group">
        <label>Advisor :</label>
        <div class="input-icon">
            <p>${advisors.length > 0 ? advisors[0].professorName : '-'}</p>
        </div>
    </div>

    <!-- Committee Sections (Dynamic) -->
    <div id="committees-container">
        <!-- ฟังก์ชัน JavaScript จะเพิ่ม committee dropdown ที่นี่ -->
        ${committees.map((committee, index) => `
            <div class="form-group">
                <label>Committee ${index + 1} :</label>
                <div class="input-icon">
                    <select id="committee${index + 1}">
                        <option value="">Select Committee</option>
                        ${allProfessors.map(professor => `
                            <option value="${professor.professorName}" ${professor.professorName === committee.professorName ? 'selected' : ''}>
                                ${professor.professorName}
                            </option>
                        `).join('')}
                    </select>
                </div>
            </div>
        `).join('')}
    </div>

    <!-- Button Group -->
    <div class="button-group">
        <button class="cancel-btn">Cancel</button>
        <button class="save-btn">Save</button>
    </div>
    `;

        // แสดงผล Modal ที่ div ที่ต้องการ
        document.getElementById('modal-container').innerHTML = modalHTML;

        // คลิกปุ่ม Cancel
        document.querySelector('.cancel-btn').addEventListener('click', function () {
            window.location.href = "http://localhost:8080/project-details";
        });


        // -------------------- Update Project -------------------- //
        // ดักจับการคลิกปุ่ม Save
        document.querySelector('.save-btn').addEventListener('click', function () {
            // แสดง popup ยืนยันการบันทึก
            const savePopup = document.getElementById('confirmSavePopup');
            savePopup.style.display = 'block';

            // คลิกปุ่มยืนยันการบันทึก
            document.getElementById('confirmSaveBtn').addEventListener('click', function () {
                // เก็บค่าจากฟอร์ม
                const projectId = data.projectId;
                const projectTitle = document.getElementById('projectTitle').value;
                const projectDescription = document.getElementById('projectDescription').value;

                // เก็บค่า program จาก dropdown
                const program = document.getElementById('program').value;

                // เก็บข้อมูลสมาชิก
                const students = [];
                const studentSelects = document.querySelectorAll('[id^="student-"]');
                studentSelects.forEach(select => {
                    students.push({studentId: select.id.replace('student-', ''), studentName: select.value});
                });

                // เก็บข้อมูลที่จะส่งไปยัง Controller
                const updatedDetails = {
                    projectId,
                    projectTitle,
                    projectDescription,
                    program,
                    studentList: students
                };

                console.log("Sending data to the server: ", updatedDetails);

                // ส่งข้อมูลไปที่ Controller ด้วย fetch()
                fetch(`http://localhost:8080/admin/updateProjectDetails?projectId=${encodeURIComponent(projectId)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedDetails)
                })
                    .then(response => response.ok ? response.text() : Promise.reject('Error'))
                    .then(data => {
                        console.log('Success:', data);
                        showNotification("Project updated successfully!", function () {
                            window.location.href = "http://localhost:8080/project-details"; // เปลี่ยนเส้นทางไปยังหน้าใหม่
                        });
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        showNotification('Error updating project: ' + error.message);
                    });

                // ซ่อน popup หลังการบันทึก
                savePopup.style.display = 'none';
            });

            // คลิกปุ่มยกเลิกการบันทึก
            document.getElementById('cancelSaveBtn').addEventListener('click', function () {
                const savePopup = document.getElementById('confirmSavePopup');
                savePopup.style.display = 'none';  // ซ่อน popup
            });
        });


        // ฟังก์ชันยืนยันการลบ
        function confirmDelete(studentId, studentName, projectId) {
            // แสดงข้อความใน popup ด้วยข้อมูลที่ได้รับ
            const popup = document.getElementById('confirmDeletePopup');
            const deleteConfirmMsg = document.getElementById('delete-confirm-msg');
            deleteConfirmMsg.innerHTML = `Are you sure you want to remove Student : "${studentId} ${studentName}" <br> from Project ID : "${projectId}"?`;

            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');

            // ทำให้ Popup แสดง
            popup.style.display = 'block';

            // เมื่อกดยืนยันให้ลบ student
            confirmBtn.onclick = function () {
                deleteStudentFromProject(studentId, projectId);  // ส่งคำขอลบ student ออกจาก project
                popup.style.display = 'none'; // ซ่อน Popup
            };

            // เมื่อกดยกเลิก
            cancelBtn.onclick = function () {
                popup.style.display = 'none'; // ซ่อน Popup
            };
        }
    }

    // ฟังก์ชัน showNotification สำหรับการแสดงแจ้งเตือน
    function showNotification(message, callback) {
        const notification = document.createElement("div");
        notification.textContent = message;
        notification.style.position = "fixed";
        notification.style.top = "20px";
        notification.style.right = "20px";
        notification.style.padding = "10px 20px";
        notification.style.background = "green";
        notification.style.color = "white";
        notification.style.borderRadius = "5px";
        notification.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
        document.body.appendChild(notification);

        // ให้ข้อความหายไปอัตโนมัติหลังจาก 1 วินาที
        setTimeout(() => {
            notification.remove();
            if (callback) callback(); // เรียก callback หลังจากแจ้งเตือนเสร็จ
        }, 1000);
    }

    // ฟังก์ชันหลักที่ดึงข้อมูลและแสดงผล
    function loadProjectDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');

        if (projectId) {
            fetchData(projectId)
                .then(data => {
                    if (data) {
                        displayResults(data);  // แสดงผลข้อมูลใน modal
                    }
                })
                .catch(error => {
                    console.error("Error in loading project details:", error);
                });
        } else {
            console.log("No projectId found in URL");
        }
    }

    // เรียกใช้ฟังก์ชันหลักเมื่อโหลดหน้า
    loadProjectDetails();

</script>
