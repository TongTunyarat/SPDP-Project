<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Dashboard </title>

    <!-- CSS -->
    <link rel="stylesheet" href="/CSS/sidebar-admin.css">
    <link rel="stylesheet" href="/CSS/projectCommittee.css">

    <!-- Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>

        <form th:action="@{/logout}" method="post" class="logout-container">
            <!--        ค่าที่ใช้สำหรับป้องกัน Cross-Site Request Forgery (CSRF)-->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </form>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                    </path>
                </svg>
                Homepage
            </h4>
            <li><a href="/admin-dashboard">Dashboard</a></li>
            <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
        </ul>

        <h2> Pages </h2>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Score Evaluation
            </h4>
            <li><a href="/scoring-periods">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                    </path>
                </svg>
                Manage Schedule
            </h4>
            <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
            <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
            <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
            <li><a href="#">Edit Defense Timing</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                    </path>
                </svg>
                Manage Project
            </h4>
            <li><a href="/project-overview">Project Overview</a></li>
            <li><a href="/project-details">Project Details</a></li>
            <li><a href="/project-committee" class="active">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>

    <div class="content">

        <div class="header-section">
            Committee
            <div class="btn-header">
                <button id="export-project-excel">Export Project Template</button>
                <input type="file" id="upload-file" accept=".csv, .xlsx, .xls" style="display: none;"/>
                <button id="upload-btn">Upload Files</button>
            </div>
        </div>

        <div class="body-section">

            <div class="table-container">
                <div class="filter-controls">
                    <button class="filter active" onclick="filterProjects('all')">All</button>
                    <button class="filter" onclick="filterProjects('ict')">ICT</button>
                    <button class="filter" onclick="filterProjects('dst')">DST</button>
                    <input type="text" placeholder="Search">

                </div>
                <table>
                    <thead>
                    <tr class="header-row">
                        <th>Project ID</th>
                        <th>Project Name</th>
                        <th>Student ID</th>
                        <th colspan="3">Committee</th>  <!-- ใช้ colspan รวมเป็นหัวข้อหลัก -->
                        <th class="action-header">Action</th>
                    </tr>
                    <tr class="sub-header-row">
                        <th></th>  <!-- คอลัมน์ว่างเพื่อจัดให้ตรง -->
                        <th></th>
                        <th></th>
                        <th class="advisor-header">Advisor</th>
                        <th class="committee1-header">Committee 1</th>
                        <th class="committee2-header">Committee 2</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody id="projectTable">
                    <!--          <tr data-category="ict">-->
                    <!--            <td><span class="tag ict">ICT</span> SP2024-01</td>-->
                    <!--            <td>A Noise-Resilient Model</td>-->
                    <!--            <td>6487002<br>6487023<br>6487069</td>-->
                    <!--            <td>Aj.Akara</td>-->
                    <!--            <td>Aj.Morakot</td>-->
                    <!--            <td>Aj.Pagaporn</td>-->
                    <!--            <td class="action-buttons">-->
                    <!--              <button class="icon-btn"><i class="material-icons">edit</i></button>-->
                    <!--              <button class="icon-btn"><i class="material-icons">delete</i></button>-->
                    <!--            </td>-->
                    <!--          </tr>-->
                    <!--          <tr data-category="ict">-->
                    <!--            <td><span class="tag ict">ICT</span> SP2024-01</td>-->
                    <!--            <td>A Noise-Resilient Model</td>-->
                    <!--            <td>6487002<br>6487023<br>6487069</td>-->
                    <!--            <td>Aj.Akara</td>-->
                    <!--            <td>Aj.Morakot</td>-->
                    <!--            <td>Aj.Pagaporn</td>-->
                    <!--            <td class="action-buttons">-->
                    <!--              <button class="icon-btn"><i class="material-icons">edit</i></button>-->
                    <!--              <button class="icon-btn"><i class="material-icons">delete</i></button>-->
                    <!--            </td>-->
                    <!--          </tr>-->
                    <!--          <tr data-category="ict">-->
                    <!--            <td><span class="tag ict">ICT</span> SP2024-01</td>-->
                    <!--            <td>A Noise-Resilient Model</td>-->
                    <!--            <td>6487002<br>6487023<br>6487069</td>-->
                    <!--            <td>Aj.Akara</td>-->
                    <!--            <td>Aj.Morakot</td>-->
                    <!--            <td>Aj.Pagaporn</td>-->
                    <!--            <td class="action-buttons">-->
                    <!--              <button class="icon-btn"><i class="material-icons">edit</i></button>-->
                    <!--              <button class="icon-btn"><i class="material-icons">delete</i></button>-->
                    <!--            </td>-->
                    <!--          </tr>-->
                    <!--          <tr data-category="ict">-->
                    <!--            <td><span class="tag ict">ICT</span> SP2024-01</td>-->
                    <!--            <td>A Noise-Resilient Model</td>-->
                    <!--            <td>6487002<br>6487023<br>6487069</td>-->
                    <!--            <td>Aj.Akara</td>-->
                    <!--            <td>Aj.Morakot</td>-->
                    <!--            <td>Aj.Pagaporn</td>-->
                    <!--            <td class="action-buttons">-->
                    <!--              <button class="icon-btn"><i class="material-icons">edit</i></button>-->
                    <!--              <button class="icon-btn"><i class="material-icons">delete</i></button>-->
                    <!--            </td>-->
                    <!--          </tr>-->

                    <!--          </tbody>-->
                </table>
            </div>
        </div>

        <!-- Modal สำหรับการอัปโหลดไฟล์ -->
        <div id="uploadModal" class="modal-details" style="display: none;">
            <div class="modal-content">
                <span id="closeModal" class="close-btn">&times;</span>

                <h2>Upload Files</h2>

                <!--                &lt;!&ndash; File Type Dropdown &ndash;&gt;-->
                <!--                <div class="form-group">-->
                <!--                    <label for="fileType">File Type:</label>-->
                <!--                    <span class="span-fileType"> * CSV Only * </span>-->
                <!--                    <select id="fileType" disabled>-->
                <!--                        <option value="csv">CSV</option>-->
                <!--                        &lt;!&ndash;<option value="excel">Excel</option>&ndash;&gt;-->
                <!--                    </select>-->
                <!--                </div>-->

                <!-- File Input -->
                <div class="upload-section">
                    <div class="file-input-container" id="drop-area">
                        <i>📁</i>
                        <input type="file" id="fileInput"/>
                    </div>
                </div>

                <!--                <div class="loading" id="loading">-->
                <!--                    <div class="spinner"></div>-->
                <!--                    <p>กำลังประมวลผลข้อมูล...</p>-->
                <!--                </div>-->


                <!--                &lt;!&ndash; ปุ่ม Preview และ Save &ndash;&gt;-->
                <!--                <button id="preview-btn">Preview</button>-->
                <!--                <button id="save-btn" style="display:none;">Save</button>-->

                <!-- Preview Content -->
                <div id="preview-content"></div>

                <!-- Upload Button -->
                <button type="button" id="confirm-upload-btn" style="display:none;">Upload</button>
            </div>
        </div>

        <!-- Popup สำหรับแจ้งเตือนเมื่อกด Delete ของแต่ละ Project -->
        <div id="confirmDeletePopup" style="display: none;">
            <div class="popup-overlay">
                <div class="popup-content">
                    <p id="delete-confirm-msg"></p>
                    <button id="confirmDeleteBtn">Delete</button>
                    <button id="cancelDeleteBtn">Cancel</button>
                </div>
            </div>
        </div>


        <div class="btn-footer">
            <button class="deleteAll-btn">Delete ALL</button>
        </div>

        <div class="pagination">
            <button class="page-btn" onclick="changePage('prev')">&lt;</button>
            <!-- ปุ่มหน้าอื่นๆ จะถูกเพิ่มใน JavaScript -->
            <button class="page-btn" onclick="changePage('next')">&gt;</button>
        </div>


    </div>
</div>
</body>

</html>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetchProjects();
    });

    document.addEventListener("DOMContentLoaded", function () {
        const menuItems = document.querySelectorAll(".sidebar ul li a");

        // ดึง URL ปัจจุบัน
        const currentPage = window.location.pathname.split("/").pop();

        menuItems.forEach(item => {
            if (item.getAttribute("href") === currentPage) {
                item.classList.add("active"); // เพิ่ม class "active" ให้เมนูปัจจุบัน
            }
        });
    });

    // ฟังก์ชันกรองโปรเจกต์ตามหมวดหมู่
    function filterProjects(category) {
        const rows = document.querySelectorAll("#projectTable tr");
        rows.forEach(row => {
            if (category === "all") {
                row.style.display = "";
            } else {
                row.style.display = row.getAttribute("data-category") === category ? "" : "none";
            }
        });

        // อัพเดตปุ่มที่ถูกเลือก
        document.querySelectorAll(".filter").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`.filter[onclick="filterProjects('${category}')"]`).classList.add("active");
    }

    // ฟังก์ชันค้นหาโปรเจกต์
    function searchProjects() {
        const searchValue = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll("#projectTable tr");

        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(searchValue) ? "" : "none";
        });
    }

    // -------------------- Fetch Project -------------------- //
    let currentPage = 1;  // หน้าเริ่มต้น
    const itemsPerPage = 15; // จำนวนข้อมูลที่จะแสดงในแต่ละหน้า
    let projectsData = [];  // ข้อมูลทั้งหมดที่ดึงมาจาก API

    // ฟังก์ชันดึงข้อมูลโปรเจกต์
    function fetchProjects() {
        fetch("http://localhost:8080/admin/projectOverview")
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                projectsData = data;  // เก็บข้อมูลทั้งหมด
                displayResults(currentPage);  // แสดงผลหน้าปัจจุบัน
                updatePagination();  // อัปเดตปุ่ม pagination
            })
            .catch(error => console.error("Error fetching project data:", error));
    }

    // ฟังก์ชันแสดงข้อมูลในตาราง
    function displayResults(page) {
        let tableBody = document.querySelector("tbody");
        tableBody.innerHTML = ""; // เคลียร์ข้อมูลเก่า

        // คำนวณขอบเขตข้อมูลที่จะแสดง
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = projectsData.slice(startIndex, endIndex);

        // คำนวณจำนวนคอลัมน์ Committee สูงสุดที่ต้องใช้
        const maxCommittee = Math.max(...projectsData.map(project => project.professorList.filter(p => p.role === 'Committee').length));

        pageData.forEach(project => {
            console.log(project);
            const row = document.createElement('tr');
            const projectProgram = project.program ? project.program.toLowerCase() : "unknown";
            row.setAttribute("data-category", projectProgram);

            // คัดกรอง professorList ตาม role
            const advisor = project.professorList.find(professor => professor.role === "Advisor");
            const committees = project.professorList.filter(professor => professor.role === "Committee");

            // แสดงชื่อ Advisor (ถ้าไม่มีให้เป็น "N/A")
            let advisorName = advisor ? advisor.professorName : "N/A";

            // แสดงชื่อ Committee ตามจำนวนที่มี และเติมคอลัมน์ว่างถ้ายังไม่เต็มจำนวน maxCommittee
            let committeeColumns = committees.map(professor => `<td>${professor.professorName}</td>`).join('');

            // ถ้า Committee มีไม่ถึง maxCommittee ให้เติม <td> ว่างให้ครบ
            let emptyColumns = `<td></td>`.repeat(maxCommittee - committees.length);

            row.innerHTML = `
            <td><span class="tag ${projectProgram}">${project.program || "N/A"}</span> ${project.projectId}</td>
            <td>${project.projectTitle || "N/A"}</td>
            <td>
                <ul>
                    ${project.studentList.map(student => `<li>${student.studentId}</li>`).join('')}
                </ul>
            </td>
            <td>${advisorName}</td>  <!-- แสดง Advisor -->
            ${committeeColumns}  <!-- แสดง Committee ที่มี -->
            ${emptyColumns}  <!-- เติมช่องว่างให้ครบจำนวน maxCommittee -->
           <td>
                <form action="/admin/editCommittee" method="get">
                    <input type="hidden" name="projectId" value="${project.projectId}">
                    <button type="submit" class="edit-btn"><span class="material-icons">edit</span></button>
                </form>

                <form id="deleteForm-${project.projectId}" action="" method="get" onsubmit="return confirmDelete(event, '${project.projectId}')">
                    <input type="hidden" name="projectId" value="${project.projectId}">
                    <button type="submit" class="delete-btn">
                        <span class="material-icons">delete</span>
                    </button>
                </form>
            </td>
        `;
            tableBody.appendChild(row);
        });

        // อัปเดตจำนวน <th> ของ Committee ตามจำนวนสูงสุด
        const committeeHeader = document.querySelector('.committee-header');
        let committeeHeaders = '';

        for (let i = 0; i < maxCommittee; i++) {
            committeeHeaders += `<th class="committee${i + 1}-header">Committee ${i + 1}</th>`;
        }

        committeeHeader.innerHTML = committeeHeaders;
    }

    // -------------------- Pagination -------------------- //
    // ฟังก์ชันสำหรับการเปลี่ยนหน้า
    function changePage(page) {
        if (page === 'prev' && currentPage > 1) {
            currentPage--;
        } else if (page === 'next' && currentPage < Math.ceil(projectsData.length / itemsPerPage)) {
            currentPage++;
        } else if (typeof page === 'number') {
            currentPage = page;
        }
        displayResults(currentPage);  // แสดงข้อมูลของหน้าที่เลือก
        updatePagination();  // อัปเดตปุ่ม pagination
    }

    // ฟังก์ชันอัปเดตปุ่ม pagination
    function updatePagination() {
        const totalPages = Math.ceil(projectsData.length / itemsPerPage);  // คำนวณจำนวนหน้าทั้งหมด
        const paginationContainer = document.querySelector('.pagination');
        paginationContainer.innerHTML = ''; // เคลียร์ปุ่ม pagination เก่า

        // เพิ่มปุ่ม "Previous"
        const prevButton = document.createElement('button');
        prevButton.classList.add('page-btn');
        prevButton.innerHTML = '&lt;';
        prevButton.onclick = () => changePage('prev');
        paginationContainer.appendChild(prevButton);

        // เพิ่มปุ่มหน้า
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.classList.add('page-btn');
            if (i === currentPage) {
                pageButton.classList.add('active');
            }
            pageButton.innerHTML = i;
            pageButton.onclick = () => changePage(i);
            paginationContainer.appendChild(pageButton);
        }

        // เพิ่มปุ่ม "Next"
        const nextButton = document.createElement('button');
        nextButton.classList.add('page-btn');
        nextButton.innerHTML = '&gt;';
        nextButton.onclick = () => changePage('next');
        paginationContainer.appendChild(nextButton);
    }


    // -------------------- Upload Files -------------------- //
    // เปิด Modal เมื่อกดปุ่ม Upload Files
    document.getElementById('upload-btn').addEventListener('click', function () {
        document.getElementById('uploadModal').style.display = 'block';
    });

    // ปิด Modal เมื่อกดปุ่ม close
    document.getElementById('closeModal').addEventListener('click', function () {
        document.getElementById('uploadModal').style.display = 'none';
        window.location.reload();
    });


    // Event listener เมื่อเลือกไฟล์ ✅✅
    document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                let fileContent = e.target.result;
                fileContent = removeBOM(fileContent);

                // ตรวจสอบประเภทไฟล์และแปลงเป็น JSON
                if (file.type === "application/json" || file.name.endsWith(".json")) {
                    let jsonData;
                    try {
                        jsonData = JSON.parse(fileContent);
                    } catch (error) {
                        document.getElementById('preview-content').innerHTML = "<p style='color:red;'>Error parsing JSON file.</p>";
                        return;
                    }
                    validateAndShowPreview(jsonData);
                } else if (file.type === "text/csv" || file.name.endsWith(".csv")) {
                    const jsonData = csvToJson(fileContent);
                    validateAndShowPreview(jsonData);
                } else if (file.name.endsWith(".xlsx")) {
                    // หากเป็น Excel ให้แจ้งเตือนว่าไม่รองรับในตัวอย่างนี้
                    validateAndShowPreview({error: "Unsupported file type. Please upload a CSV or JSON file."});
                } else {
                    validateAndShowPreview({error: "Unsupported file type. Please upload a CSV or JSON file."});
                }

                // แสดงปุ่ม Upload เมื่อไฟล์ถูกเลือก
                document.getElementById('confirm-upload-btn').style.display = 'inline-block';
            };
            reader.readAsText(file, "UTF-8");
        }
    });

    // ฟังก์ชันแปลง CSV เป็น JSON
    function csvToJson(csv) {
        const lines = csv.split("\n");
        const result = [];
        // กำหนด currentProject เพื่อเก็บข้อมูลโปรเจกต์ล่าสุด
        let currentProject = {
            projectId: "",
            projectTitle: "",
            projectDescription: "",
            projectCategory: "",
            program: "",
            advisor: "",
            studentList: []
        };

        // สมมติว่าข้อมูล header อยู่ที่แถว 1-8 (index 0 ถึง 7) ให้เริ่มจากแถวที่ 9 (i = 8)
        for (let i = 8; i < lines.length; i++) {
            let line = lines[i].trim();
            if (!line) continue;
            const cells = line.split(",");
            // หากข้อมูลไม่ครบตามที่ต้องการ (ต้องมีอย่างน้อย 8 ช่อง)
            if (cells.length < 8) continue;

            let projectId = cells[0].trim();
            let projectTitle = cells[1] ? cells[1].trim() : "";
            let projectDescription = cells[2] ? cells[2].trim() : "";
            let projectCategory = cells[3] ? cells[3].trim() : "";
            let studentId = cells[4] ? cells[4].trim() : "";
            let studentName = cells[5] ? cells[5].trim() : "";
            let program = cells[6] ? cells[6].trim() : "";
            let advisor = cells[7] ? cells[7].trim() : "";
            let committee = cells[8] ? cells[8].trim() : "";

            // หากมีข้อมูลโปรเจกต์ในแถวนี้ (เช็คจากหลายช่อง)
            if (projectTitle !== "" || projectDescription !== "" || projectCategory !== "" || program !== "" || advisor !== "" || projectId !== "") {
                currentProject = {
                    projectId: projectId,
                    projectTitle: projectTitle,
                    projectDescription: projectDescription,
                    projectCategory: projectCategory,
                    program: program,
                    advisor: advisor,
                    committee: committee,
                    studentList: []
                };
                result.push(currentProject);
            }
            // ถ้ามีข้อมูลนักศึกษา ให้นำเข้า studentList ของ currentProject
            if (studentId || studentName) {
                currentProject.studentList.push({
                    studentId: studentId,
                    studentName: studentName
                });
            }
        }
        return result;
    }


    function validateAndShowPreview(data) {
        if (data.error) {
            document.getElementById('preview-content').innerHTML = `<p style="color:red;">${data.error}</p>`;
            return;
        }
        uploadedData = data;
        console.log("Converted JSON Data:\n", JSON.stringify(uploadedData, null, 2));
        displayProjectDetailsPreview(uploadedData);
    }


    // ตัวแปรเก็บข้อมูลที่ได้จากไฟล์
    let uploadedData = null;


    // ฟังก์ชันสำหรับแสดงพรีวิวของ Project Details
    async function displayProjectDetailsPreview(data) {
        const previewContent = document.getElementById('preview-content');
        previewContent.innerHTML = "";

        // สร้าง table สำหรับแสดง preview
        const table = document.createElement('table');
        table.classList.add('preview-table');

        // สร้าง header row สำหรับ 5 คอลัมน์
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `
        <th>Project ID</th>
        <th>Project Title</th>
        <th>Student IDs</th>
        <th>Advisor</th>
        <th>Committee</th>
    `;
        table.appendChild(headerRow);

        // สำหรับแต่ละโปรเจกต์ใน data ให้สร้าง row ที่มีข้อมูลตามหัวข้อ
        data.forEach(project => {
            const row = document.createElement('tr');
            // รวม studentId จาก studentList (ถ้ามี) ด้วย comma
            let studentIDs = "N/A";
            if (project.studentList && project.studentList.length > 0) {
                studentIDs = project.studentList.map(stu => stu.studentId).join(", ");
            }

            row.innerHTML = `
            <td>${project.projectId || "N/A"}</td>
            <td>${project.projectTitle || "N/A"}</td>
            <td>${studentIDs}</td>
            <td>${project.advisor || "N/A"}</td>
            <td>${project.committee || "N/A"}</td>
        `;
            table.appendChild(row);
        });

        previewContent.appendChild(table);

        // แสดง JSON ที่ได้ (ใน element <pre id="jsonOutput">) หากมี
        const jsonOutput = document.getElementById('jsonOutput');
        if (jsonOutput) {
            jsonOutput.textContent = JSON.stringify(data, null, 2);
        }
    }



    // Event Listener เมื่อเลือกไฟล์
    document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                let fileContent = e.target.result;
                fileContent = removeBOM(fileContent);

                if (file.type === "text/csv" || file.name.endsWith(".csv")) {
                    const jsonData = csvToJson(fileContent);
                    validateAndShowPreview(jsonData);
                } else if (file.type === "application/json" || file.name.endsWith(".json")) {
                    let jsonData;
                    try {
                        jsonData = JSON.parse(fileContent);
                    } catch (err) {
                        document.getElementById('preview-content').innerHTML = "<p style='color:red;'>Error parsing JSON file.</p>";
                        return;
                    }
                    validateAndShowPreview(jsonData);
                } else if (file.name.endsWith(".xlsx")) {
                    // สำหรับไฟล์ Excel แจ้งเตือนว่าไม่รองรับในตัวอย่างนี้
                    validateAndShowPreview({error: "Unsupported file type. Please upload a CSV or JSON file."});
                } else {
                    validateAndShowPreview({error: "Unsupported file type. Please upload a CSV or JSON file."});
                }

                // แสดงปุ่ม Upload เมื่อเลือกไฟล์แล้ว
                document.getElementById('confirm-upload-btn').style.display = 'inline-block';
            };
            reader.readAsText(file, "UTF-8");
        }
    });


    // ฟังก์ชัน Upload ข้อมูลไปยังเซิร์ฟเวอร์ (เรียก API Service)
    document.getElementById('confirm-upload-btn').addEventListener('click', function () {
        const file = document.getElementById('fileInput').files[0];

        if (!file) {
            alert("Please select a file first!");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        console.log("📌 Sending file to server:", file.name);

        fetch("http://localhost:8080/admin/uploadCommitteeFiles", {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                // ตรวจสอบ data.message ก่อน
                if (data.message === "File processed successfully") {
                    // กรณีอัปโหลดสำเร็จสมบูรณ์
                    alert(data.message);
                    location.reload();

                } else if (data.message === "File processed with warnings") {
                    // ถ้ามี warnings ให้ลองใช้ shortMessage ถ้ามี
                    if (data.shortMessage) {
                        alert(data.shortMessage);
                    } else if (data.warnings && data.warnings.length > 0) {
                        let warnMsg = data.message + "\n\nWarnings:\n" + data.warnings.join("\n");
                        alert(warnMsg);
                    } else {
                        alert(data.message);
                    }
                    // ถ้าต้องการ reload หน้า ให้ยกเลิก comment บรรทัดต่อไปนี้
                    // location.reload();

                } else if (data.message === "File processing failed") {
                    // กรณีไฟล์มีปัญหาร้ายแรง
                    if (data.errors && data.errors.length > 0) {
                        alert("Upload failed: " + data.errors.join(", "));
                    } else {
                        alert("Upload failed: " + data.message);
                    }
                } else {
                    // กรณีอื่น ๆ ที่ไม่อยู่ในเงื่อนไขข้างต้น
                    if (data.errors && data.errors.length > 0) {
                        alert("Upload failed: " + data.errors.join(", "));
                    } else if (data.message) {
                        alert("Upload failed: " + data.message);
                    } else {
                        alert("Upload failed: Unknown error");
                    }
                }
            })
            .catch(error => console.error("Error uploading file:", error));
    });


    // ฟังก์ชันสำหรับลบ BOM (รองรับภาษาไทย)
    function removeBOM(csv) {
        if (csv.charCodeAt(0) === 0xFEFF) {
            csv = csv.substring(1);
        }
        return csv;
    }


    function exportTemplate() {
        // ตรวจสอบว่ามีข้อมูลจาก fetch หรือไม่
        if (!projectsData || projectsData.length === 0) {
            alert("No project data available to export.");
            return;
        }

        // สร้าง array สำหรับเก็บ rows ของข้อมูล Excel
        let dataRows = [];
        projectsData.forEach(project => {
            // ประมวลผลรายชื่ออาจารย์ใน professorList
            let advisor = "";
            let coAdvisor = "";
            let posterCommittee = "";
            if (project.professorList && Array.isArray(project.professorList)) {
                project.professorList.forEach(prof => {
                    if (prof.role === "Advisor") {
                        advisor = prof.professorName;
                    } else if (prof.role === "Co-advisor") {
                        coAdvisor = prof.professorName;
                    } else if (prof.role === "Poster-Committee") {
                        posterCommittee = prof.professorName
                    }
                });
            }

            // ใส่ข้อมูลนักศึกษา หากมี
            if (project.studentList && Array.isArray(project.studentList) && project.studentList.length > 0) {
                project.studentList.forEach(student => {
                    dataRows.push([
                        project.projectId,
                        project.projectTitle,
                        project.projectDescription,
                        // เปลี่ยนจาก project.projectCategory เป็น project.category
                        project.category || "",
                        student.studentId,
                        student.studentName,
                        project.program,
                        advisor,
                        coAdvisor,
                        posterCommittee,
                        ""
                    ]);
                });
            } else {
                // ถ้าไม่มีข้อมูลนักศึกษา
                dataRows.push([
                    project.projectId,
                    project.projectTitle,
                    project.projectDescription,
                    project.category || "",
                    "",
                    "",
                    project.program,
                    advisor,
                    coAdvisor,
                    posterCommittee,
                    ""
                ]);
            }
        });

        // สร้าง Workbook และ Worksheet ด้วย ExcelJS
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet("Project List");

        // กำหนดความกว้างของคอลัมน์
        ws.columns = [
            { width: 15 },  // A - Project ID
            { width: 25 },  // B - Project Title
            { width: 30 },  // C - Project Description
            { width: 15 },  // D - Project Category (ใช้ฟิลด์ project.category)
            { width: 15 },  // E - Student ID
            { width: 25 },  // F - Student Name
            { width: 10 },  // G - Program
            { width: 20 },  // H - Advisor
            { width: 20 },  // I - Co-advisor
            { width: 20 },  // J - Committee
            { width: 20 },  // K - Poster-Committee
        ];

        // Merge cells สำหรับ Header (แถว 1-4)
        ws.mergeCells('A1:K1');
        ws.mergeCells('A2:K2');
        ws.mergeCells('A3:K3');
        ws.mergeCells('A4:K4');

        // แถว 1
        ws.getCell('A1').value = "Senior Project Overview";
        ws.getCell('A1').font = { bold: true, size: 14, color: { argb: 'FF000000' } };
        ws.getCell('A1').alignment = { horizontal: 'center', vertical: 'middle' };

        // แถว 2
        ws.getCell('A2').value = "Exported Project Data";
        ws.getCell('A2').font = { size: 12, color: { argb: 'FF4D93D9' } };
        ws.getCell('A2').alignment = { horizontal: 'center', vertical: 'middle' };

        // แถว 3
        ws.getCell('A3').value = "Link to view detailed project information";
        ws.getCell('A3').font = { bold: true, size: 12, color: { argb: 'FF000000' } };
        ws.getCell('A3').alignment = { horizontal: 'center', vertical: 'middle' };

        // แถว 4
        ws.getCell('A4').value = "https://yourprojectlink.example.com";
        ws.getCell('A4').font = { size: 10, color: { argb: 'FF000000' } };
        ws.getCell('A4').alignment = { horizontal: 'center', vertical: 'middle' };

        // แถว 5: Header Row ของคอลัมน์
        const headerRow = ws.getRow(5);
        headerRow.values = [
            "Project ID",
            "Project Title",
            "Project Description",
            "Project Category",
            "Student ID",
            "Student Name",
            "Program",
            "Advisor",
            "Co-advisor",
            "Committee",
            "Poster-Committee"
        ];

        headerRow.font = { bold: true, size: 11, color: { argb: 'FF000000' } };
        headerRow.alignment = { vertical: 'middle', horizontal: 'center' };
        headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFB5E6A2' } };

        // เพิ่ม Border ให้กับแต่ละเซลล์ใน header row
        headerRow.eachCell(cell => {
            cell.border = {
                top: { style: 'thin', color: { argb: 'FF000000' } },
                left: { style: 'thin', color: { argb: 'FF000000' } },
                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                right: { style: 'thin', color: { argb: 'FF000000' } }
            };
        });

        // สไตล์สำหรับข้อมูลแถว (พื้นหลังสีเขียวอ่อน)
        const dataRowStyle = {
            fill: { fgColor: { argb: 'FFC8E6C9' } },
            border: {
                top: { style: 'thin', color: { argb: 'FF000000' } },
                left: { style: 'thin', color: { argb: 'FF000000' } },
                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                right: { style: 'thin', color: { argb: 'FF000000' } }
            }
        };

        // ใส่ข้อมูลในแต่ละ row ตั้งแต่แถวที่ 6 เป็นต้นไป
        dataRows.forEach(rowData => {
            let newRow = ws.addRow(rowData);
            newRow.eachCell(cell => {
                cell.alignment = { vertical: 'middle', horizontal: 'left' };
                cell.fill = dataRowStyle.fill;
                cell.border = dataRowStyle.border;
            });
        });

        // สร้างไฟล์ Excel แล้ว trigger ดาวน์โหลด
        wb.xlsx.writeBuffer()
            .then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Project_Overview.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("Error generating Excel file:", error);
            });
    }

    // เพิ่ม event listener ให้ปุ่ม Export
    document.getElementById("export-project-excel").addEventListener("click", exportTemplate);



</script>