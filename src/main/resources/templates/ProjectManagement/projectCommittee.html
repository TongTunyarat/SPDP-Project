<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Dashboard </title>

    <!-- CSS -->
    <link rel="stylesheet" href="/CSS/sidebar-admin.css">
    <link rel="stylesheet" href="/CSS/projectCommittee.css">

    <!-- Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

</head>

<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>

        <form th:action="@{/logout}" method="post" class="logout-container">
            <!--        ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cross-Site Request Forgery (CSRF)-->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </form>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                    </path>
                </svg>
                Homepage
            </h4>
            <li><a href="/admin-dashboard">Dashboard</a></li>
            <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
        </ul>

        <h2> Pages </h2>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Score Evaluation
            </h4>
            <li><a href="/scoring-periods">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                    </path>
                </svg>
                Manage Schedule
            </h4>
            <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
            <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
            <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
            <li><a href="#">Edit Defense Timing</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                    </path>
                </svg>
                Manage Project
            </h4>
            <li><a href="/project-overview">Project Overview</a></li>
            <li><a href="/project-details">Project Details</a></li>
            <li><a href="/project-committee" class="active">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>

    <div class="content">

        <div class="header-section">
            <div class="header-left">
                Committee
                <!-- Dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å semester -->
                <div class="semester-container">
                    <select id="semester-selector" onchange="filterBySemester();">
                        <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÅ‡∏•‡∏∞ semester -->
                    </select>
                </div>
            </div>

            <div class="btn-header">

                <div class="dropdown-export">
                    <button class="dropbtn">Export</button>
                    <div class="dropdown-content">
                        <a href="#" id="export-project-raw-excel">Export Raw Project Data</a>
                        <a href="#" id="export-project-excel-new">Export Project Template</a>
                    </div>
                </div>
                <input type="file" id="upload-file" accept=".csv, .xlsx, .xls" style="display: none;"/>
                <button id="upload-btn">Upload Files</button>
            </div>
        </div>

        <div class="body-section">

            <div class="table-container">
                <div class="filter-controls">
                    <button class="filter active" onclick="filterProjects('all')">All</button>
                    <button class="filter" onclick="filterProjects('ict')">ICT</button>
                    <button class="filter" onclick="filterProjects('dst')">DST</button>
                    <input type="text" placeholder="Search" id="search-keyword" />

                </div>
                <table id="projectsTable">
                    <thead>
                    <!--                    <tr class="header-row">-->
                    <!--                        <th>Project ID</th>-->
                    <!--                        <th>Project Name</th>-->
                    <!--                        <th>Student ID</th>-->
                    <!--                        <th colspan="5">Committee</th>  &lt;!&ndash; ‡πÉ‡∏ä‡πâ colspan ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å &ndash;&gt;-->
                    <!--&lt;!&ndash;                        <th class="action-header">Action</th>&ndash;&gt;-->
                    <!--                    </tr>-->
                    <!--                    <tr class="sub-header-row">-->
                    <!--                        <th></th>  &lt;!&ndash; ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á &ndash;&gt;-->
                    <!--                        <th></th>-->
                    <!--                        <th></th>-->
                    <!--                        <th class="advisor-header">Advisor</th>-->
                    <!--                        <th class="committee1-header">Committee 1</th>-->
                    <!--                        <th class="committee2-header">Committee 2</th>-->
                    <!--                        <th></th>-->
                    <!--                        <th></th>-->
                    <!--                    </tr>-->
                    </thead>
                    <tbody id="projectTable">
                    <!--          <tr data-category="ict">-->
                    <!--            <td><span class="tag ict">ICT</span> SP2024-01</td>-->
                    <!--            <td>A Noise-Resilient Model</td>-->
                    <!--            <td>6487002<br>6487023<br>6487069</td>-->
                    <!--            <td>Aj.Akara</td>-->
                    <!--            <td>Aj.Morakot</td>-->
                    <!--            <td>Aj.Pagaporn</td>-->
                    <!--            <td class="action-buttons">-->
                    <!--              <button class="icon-btn"><i class="material-icons">edit</i></button>-->
                    <!--              <button class="icon-btn"><i class="material-icons">delete</i></button>-->
                    <!--            </td>-->
                    <!--          </tr>-->
                    <!--          <tr data-category="ict">-->
                    <!--            <td><span class="tag ict">ICT</span> SP2024-01</td>-->
                    <!--            <td>A Noise-Resilient Model</td>-->
                    <!--            <td>6487002<br>6487023<br>6487069</td>-->
                    <!--            <td>Aj.Akara</td>-->
                    <!--            <td>Aj.Morakot</td>-->
                    <!--            <td>Aj.Pagaporn</td>-->
                    <!--            <td class="action-buttons">-->
                    <!--              <button class="icon-btn"><i class="material-icons">edit</i></button>-->
                    <!--              <button class="icon-btn"><i class="material-icons">delete</i></button>-->
                    <!--            </td>-->
                    <!--          </tr>-->
                    <!--          <tr data-category="ict">-->
                    <!--            <td><span class="tag ict">ICT</span> SP2024-01</td>-->
                    <!--            <td>A Noise-Resilient Model</td>-->
                    <!--            <td>6487002<br>6487023<br>6487069</td>-->
                    <!--            <td>Aj.Akara</td>-->
                    <!--            <td>Aj.Morakot</td>-->
                    <!--            <td>Aj.Pagaporn</td>-->
                    <!--            <td class="action-buttons">-->
                    <!--              <button class="icon-btn"><i class="material-icons">edit</i></button>-->
                    <!--              <button class="icon-btn"><i class="material-icons">delete</i></button>-->
                    <!--            </td>-->
                    <!--          </tr>-->
                    <!--          <tr data-category="ict">-->
                    <!--            <td><span class="tag ict">ICT</span> SP2024-01</td>-->
                    <!--            <td>A Noise-Resilient Model</td>-->
                    <!--            <td>6487002<br>6487023<br>6487069</td>-->
                    <!--            <td>Aj.Akara</td>-->
                    <!--            <td>Aj.Morakot</td>-->
                    <!--            <td>Aj.Pagaporn</td>-->
                    <!--            <td class="action-buttons">-->
                    <!--              <button class="icon-btn"><i class="material-icons">edit</i></button>-->
                    <!--              <button class="icon-btn"><i class="material-icons">delete</i></button>-->
                    <!--            </td>-->
                    <!--          </tr>-->

                    <!--          </tbody>-->
                </table>
            </div>
        </div>

        <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå -->
        <div id="uploadModal" class="modal-details" style="display: none;">
            <div class="modal-content">
                <span id="closeModal" class="close-btn">&times;</span>

                <h2>Upload Files</h2>
                <h6 style="color: #D32F2F; margin-top: -15px"> * You can upload only once.</h6>

                <!--                &lt;!&ndash; File Type Dropdown &ndash;&gt;-->
                <!--                <div class="form-group">-->
                <!--                    <label for="fileType">File Type:</label>-->
                <!--                    <span class="span-fileType"> * CSV Only * </span>-->
                <!--                    <select id="fileType" disabled>-->
                <!--                        <option value="csv">CSV</option>-->
                <!--                        &lt;!&ndash;<option value="excel">Excel</option>&ndash;&gt;-->
                <!--                    </select>-->
                <!--                </div>-->

                <!-- File Input -->
                <div class="upload-section">
                    <div class="file-input-container" id="drop-area">
                        <i>üìÅ</i>
                        <input type="file" id="fileInput"/>
                    </div>
                </div>

                <!--                <div class="loading" id="loading">-->
                <!--                    <div class="spinner"></div>-->
                <!--                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>-->
                <!--                </div>-->


                <!--                &lt;!&ndash; ‡∏õ‡∏∏‡πà‡∏° Preview ‡πÅ‡∏•‡∏∞ Save &ndash;&gt;-->
                <!--                <button id="preview-btn">Preview</button>-->
                <!--                <button id="save-btn" style="display:none;">Save</button>-->

                <!-- Preview Content -->
                <div id="preview-content"></div>

                <!-- Upload Button -->
                <button type="button" id="confirm-upload-btn" style="display:none;">Upload</button>
            </div>
        </div>

        <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Delete ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Project -->
        <div id="confirmDeletePopup" style="display: none;">
            <div class="popup-overlay">
                <div class="popup-content">
                    <p id="delete-confirm-msg"></p>
                    <button id="confirmDeleteBtn">Delete</button>
                    <button id="cancelDeleteBtn">Cancel</button>
                </div>
            </div>
        </div>


        <div class="btn-footer">
            <button class="deleteAll-btn">Delete ALL</button>
        </div>

        <div class="pagination">
            <button class="page-btn" onclick="changePage('prev')">&lt;</button>
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô JavaScript -->
            <button class="page-btn" onclick="changePage('next')">&gt;</button>
        </div>


    </div>
</div>
</div>
</body>
</html>
<script>

    // document.addEventListener("DOMContentLoaded", function () {
    //     fetchProjects();
    // });

    document.addEventListener("DOMContentLoaded", function () {
        const menuItems = document.querySelectorAll(".sidebar ul li a");

        // ‡∏î‡∏∂‡∏á URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const currentPage = window.location.pathname.split("/").pop();

        menuItems.forEach(item => {
            if (item.getAttribute("href") === currentPage) {
                item.classList.add("active"); // ‡πÄ‡∏û‡∏¥‡πà‡∏° class "active" ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            }
        });
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    function filterProjects(category) {
        const rows = document.querySelectorAll("#projectTable tr");
        rows.forEach(row => {
            if (category === "all") {
                row.style.display = "";
            } else {
                row.style.display = row.getAttribute("data-category") === category ? "" : "none";
            }
        });

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.querySelectorAll(".filter").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`.filter[onclick="filterProjects('${category}')"]`).classList.add("active");
    }

    // -------------------- Fetch Project -------------------- //
    let currentPage = 1;  // ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    const itemsPerPage = 15; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤
    let projectsData = [];  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å API

    function debounce(fn, ms) {
        let t;
        return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
        };
    }

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å semester ‡∏à‡∏≤‡∏Å projectsData
    function populateSemesterOptions() {
        const sel = document.getElementById('semester-selector');
        sel.innerHTML = '';  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥)
        // ‡πÄ‡∏Å‡πá‡∏ö unique semesters
        const sems = Array.from(new Set(projectsData.map(p => String(p.semester))))
            .sort();

        sems.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = s;
            sel.appendChild(opt);
        });

        // ---- ‡πÄ‡∏ã‡πá‡∏ï defaultYear ----
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;  // 1-12
        const defaultYear = (currentMonth <= 8 ? currentYear - 1 : currentYear).toString();

        if (sems.includes(defaultYear)) {
            sel.value = defaultYear;
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
            sel.selectedIndex = 0;
        }
    }

    function applyFilters() {
        const sem = document.getElementById('semester-selector').value;
        const term = document.getElementById('search-keyword').value.trim().toLowerCase();

        filteredData = projectsData.filter(p => {
            // by semester
            if (sem && String(p.semester) !== sem) return false;
            // by search: ‡πÄ‡∏ä‡πá‡∏Ñ projectId, title, description, program, advisor, co-advisor, students
            if (term) {
                const hay = [
                    p.projectId,
                    p.projectTitle,
                    p.projectDescription,
                    p.program,
                    // advisor & co-advisor
                    ...p.professorList.map(x => x.professorName),
                    // student IDs & names
                    ...p.studentList.map(s => s.studentId + ' ' + s.studentName)
                ].join(' ').toLowerCase();
                if (!hay.includes(term)) return false;
            }
            return true;
        });

        // reset page ‡πÅ‡∏•‡∏∞ re-render
        currentPage = 1;
        updatePagination();
        displayResults(currentPage);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // once only:
        document.getElementById('semester-selector')
            .addEventListener('change', applyFilters);
        document.getElementById('search-keyword')
            .addEventListener('input', debounce(applyFilters, 200));

        fetchProjects();
    });


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
    function fetchProjects() {
        fetch("/admin/projectOverview")
            .then(r => {
                if (!r.ok) throw new Error(r.statusText);
                return r.json();
            })
            .then(data => {
                projectsData = data;
                filteredData = data;

                populateSemesterOptions();

                applyFilters();

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ß‡πà‡∏≤‡∏°‡∏µ Advisor ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                return Promise.all(
                    projectsData.map(proj =>
                        fetch(`/admin/hasCommittee?projectId=${encodeURIComponent(proj.projectId)}`)
                            .then(r => r.ok ? r.json() : false)
                    )
                );
            })
            .then(advisorFlags => {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ true ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡πà‡∏≤ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ Advisor
                if (advisorFlags.some(flag => flag)) {
                    const uploadBtn = document.getElementById('upload-btn');
                    uploadBtn.disabled = true;
                    uploadBtn.classList.add('disabled');
                    uploadBtn.textContent = 'Upload Disabled';
                }
            })
            .catch(err => console.error("Error fetching projects or advisors:", err));
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á <thead> ‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Committee)
    function renderCommitteeHeader(maxCommittee) {
        const thead = document.querySelector("#projectsTable thead");
        thead.innerHTML = "";

        const colors = [
            "#FCB6B7", "#F9FFA1", "#B0E4FF", "#B4D2FF",
            "#CCF4DD", "#FCB6CE", "#A8E6CF", "#DCE775",
        ];

        // ‚Äî Header ‡∏´‡∏•‡∏±‡∏Å ‚Äî
        const headerRow = document.createElement("tr");
        headerRow.classList.add("header-row");
        headerRow.innerHTML = `
            <th>Project ID</th>
            <th>Project Name</th>
            <th>Student ID</th>
            <th colspan="${1 + maxCommittee}">Committee</th>
          `;
        thead.appendChild(headerRow);

        // ‚Äî Sub‚Äëheader (Advisor + Committee 1..n) ‚Äî
        const subRow = document.createElement("tr");
        subRow.classList.add("sub-header-row");
        subRow.innerHTML = `<th></th><th></th><th></th>`;

        // Advisor
        subRow.innerHTML += `
            <th style="
              background-color: ${colors[0]};
              color: black;
              font-weight: bold;
            ">
              Advisor
            </th>`;

        // Committee 1..maxCommittee
        for (let i = 1; i <= maxCommittee; i++) {
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡πÇ‡∏î‡∏¢‡∏ß‡∏ô‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå (i modulo length)
            const bg = colors[i % colors.length];
            subRow.innerHTML += `
          <th style="
            background-color: ${bg};
            color: black;
          ">
            Committee ${i}
          </th>`;
        }

        thead.appendChild(subRow);
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderCommitteeHeader ‡∏Å‡πà‡∏≠‡∏ô)
    function displayResults(page) {
        const tableBody = document.querySelector("#projectsTable tbody");
        tableBody.innerHTML = "";

        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData   = filteredData.slice(startIndex, endIndex);

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì maxCommittee ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≥ 1 (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        const maxCommittee = Math.max(
            1, ...filteredData.map(p => p.professorList.filter(x=>x.role==="Committee").length)
        );

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á header ‡πÉ‡∏´‡∏°‡πà ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏µ
        renderCommitteeHeader(maxCommittee);

        pageData.forEach(project => {
            const row = document.createElement("tr");
            const programClass = (project.program || "").toLowerCase();
            row.setAttribute("data-category", programClass);

            const advisor = project.professorList.find(p => p.role === "Advisor");
            const committees = project.professorList.filter(p => p.role === "Committee");
            const advisorName = advisor ? advisor.professorName : "N/A";

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á <td> Committee
            let committeeCols = committees
                .map(p => `<td>${p.professorName}</td>`)
                .join("");
            committeeCols += "<td></td>".repeat(maxCommittee - committees.length);

            // ‡πÅ‡∏¢‡∏Å projectId ‡∏Å‡∏±‡∏ö prefix
            const [prefix, ...rest] = project.projectId.split(" ");
            const idWithoutPrefix = rest.join(" ");

            row.innerHTML = `
              <td>
                <span class="tag ${programClass}">
                  ${project.program || "N/A"}
                </span>
                ${idWithoutPrefix}
              </td>
              <td>${project.projectTitle || "N/A"}</td>
              <td>
                <ul>
                  ${project.studentList.map(s => `<li>${s.studentId}</li>`).join("")}
                </ul>
              </td>
              <td>${advisorName}</td>
              ${committeeCols}
            `;
            tableBody.appendChild(row);
        });
    }


    // -------------------- Pagination -------------------- //
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (page === 'prev' && currentPage > 1) {
            currentPage--;
        } else if (page === 'next' && currentPage < totalPages) {
            currentPage++;
        } else if (typeof page === 'number') {
            currentPage = page;
        }
        displayResults(currentPage);
        updatePagination();
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const container = document.querySelector('.pagination');
        container.innerHTML = '';

        // Prev
        const prev = document.createElement('button');
        prev.classList.add('page-btn');
        prev.textContent = '<';
        prev.onclick = () => changePage('prev');
        container.appendChild(prev);

        // Pages
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.classList.add('page-btn');
            btn.textContent = i;
            if (i === currentPage) btn.classList.add('active');
            btn.onclick = () => changePage(i);
            container.appendChild(btn);
        }

        // Next
        const next = document.createElement('button');
        next.classList.add('page-btn');
        next.textContent = '>';
        next.onclick = () => changePage('next');
        container.appendChild(next);
    }


    // -------------------- Upload Files -------------------- //
    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Upload Files
    document.getElementById('upload-btn').addEventListener('click', function () {
        document.getElementById('uploadModal').style.display = 'block';
    });

    // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° close
    document.getElementById('closeModal').addEventListener('click', function () {
        document.getElementById('uploadModal').style.display = 'none';
        window.location.reload();
    });


    // Event listener ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‚úÖ‚úÖ
    document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                let fileContent = e.target.result;
                fileContent = removeBOM(fileContent);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON
                if (file.type === "application/json" || file.name.endsWith(".json")) {
                    let jsonData;
                    try {
                        jsonData = JSON.parse(fileContent);
                    } catch (error) {
                        document.getElementById('preview-content').innerHTML = "<p style='color:red;'>Error parsing JSON file.</p>";
                        return;
                    }
                    validateAndShowPreview(jsonData);
                } else if (file.type === "text/csv" || file.name.endsWith(".csv")) {
                    const jsonData = csvToJson(fileContent);
                    validateAndShowPreview(jsonData);
                } else if (file.name.endsWith(".xlsx")) {
                    // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
                    validateAndShowPreview({error: "Unsupported file type. Please upload a CSV or JSON file."});
                } else {
                    validateAndShowPreview({error: "Unsupported file type. Please upload a CSV or JSON file."});
                }

                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Upload ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                document.getElementById('confirm-upload-btn').style.display = 'inline-block';
            };
            reader.readAsText(file, "UTF-8");
        }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á CSV ‡πÄ‡∏õ‡πá‡∏ô JSON
    function csvToJson(csv) {
        const EXPECTED_COLS = 10; // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 10 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà index 0 ‡∏ñ‡∏∂‡∏á 9
        const result = [];

        Papa.parse(csv, {
            skipEmptyLines: true,
            header: false,
            complete: function ({data}) {
                // 1) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡πà‡∏≠‡∏ô (‡∏Ç‡πâ‡∏≤‡∏° 8 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å)
                for (let i = 8; i < data.length; i++) {
                    if (data[i].length !== EXPECTED_COLS) {
                        Swal.fire({
                            icon: 'error',
                            title: '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                            // text: `‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà ${i + 1} ‡∏û‡∏ö ${data[i].length} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô ${EXPECTED_COLS} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå`
                            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Ç‡∏≠‡∏á Committee '
                        });
                        return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
                    }
                }

                // 2) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ú‡πà‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                let currentProject = null;
                for (let i = 8; i < data.length; i++) {
                    // trim ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ slice ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 10 ‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å
                    const row = data[i].map(cell => cell.trim()).slice(0, EXPECTED_COLS);
                    const [
                        projectId,
                        projectTitle,
                        projectDescription,
                        projectCategory,
                        studentId,
                        studentName,
                        program,
                        advisor,
                        coAdvisor,
                        committee
                    ] = row;

                    // ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á Project ‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠ projectId (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á) ‚Äî
                    if (projectId) {
                        currentProject = {
                            projectId,
                            projectTitle,
                            projectDescription,
                            projectCategory,
                            program,
                            advisor,
                            coAdvisor,
                            committee,
                            studentList: []
                        };
                        result.push(currentProject);
                    }

                    // ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏° student ‡∏•‡∏á‡πÉ‡∏ô currentProject ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî
                    if (currentProject && (studentId || studentName)) {
                        currentProject.studentList.push({
                            studentId,
                            studentName
                        });
                    }
                }
            }
        });

        return result;
    }


    function shortenString(str, maxLen) {
        if (!str) return "";
        if (str.length <= maxLen) return str;
        return str.substring(0, maxLen) + "...";
    }


    function validateAndShowPreview(data) {
        if (data.error) {
            document.getElementById('preview-content').innerHTML = `<p style="color:red;">${data.error}</p>`;
            return;
        }
        uploadedData = data;
        console.log("Converted JSON Data:\n", JSON.stringify(uploadedData, null, 2));
        displayProjectDetailsPreview(uploadedData);
    }


    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
    let uploadedData = null;


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á Project Details
    function displayProjectDetailsPreview(data) {
        const previewContent = document.getElementById('preview-content');
        previewContent.innerHTML = "";

        const table = document.createElement('table');
        table.classList.add('preview-table');

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á header row
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `
        <th>Project ID</th>
        <th>Project Title</th>
        <th>Student IDs</th>
        <th>Advisor</th>
        <th>Committee</th>
    `;
        table.appendChild(headerRow);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
        data.forEach(project => {
            const row = document.createElement('tr');

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á string ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö student IDs ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô
            let studentIDs = "N/A";
            if (project.studentList && project.studentList.length > 0) {
                studentIDs = project.studentList.map(stu => stu.studentId).join(", ");
            }

            // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏ï‡∏±‡∏î projectTitle ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 50 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
            const shortenedTitle = shortenString(project.projectTitle, 50);

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
            row.innerHTML = `
            <td>${project.projectId || "N/A"}</td>
            <td title="${project.projectTitle}">${shortenedTitle}</td>
            <td>${studentIDs}</td>
            <td>${project.advisor || "N/A"}</td>
            <td>${project.committee || "N/A"}</td>
        `;
            table.appendChild(row);
        });

        previewContent.appendChild(table);

        // ‡πÅ‡∏™‡∏î‡∏á JSON (optional)
        const jsonOutput = document.getElementById('jsonOutput');
        if (jsonOutput) {
            jsonOutput.textContent = JSON.stringify(data, null, 2);
        }
    }


    // Event Listener ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
    document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                let fileContent = e.target.result;
                fileContent = removeBOM(fileContent);

                if (file.type === "text/csv" || file.name.endsWith(".csv")) {
                    const jsonData = csvToJson(fileContent);
                    validateAndShowPreview(jsonData);
                } else if (file.type === "application/json" || file.name.endsWith(".json")) {
                    let jsonData;
                    try {
                        jsonData = JSON.parse(fileContent);
                    } catch (err) {
                        document.getElementById('preview-content').innerHTML = "<p style='color:red;'>Error parsing JSON file.</p>";
                        return;
                    }
                    validateAndShowPreview(jsonData);
                } else if (file.name.endsWith(".xlsx")) {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
                    validateAndShowPreview({error: "Unsupported file type. Please upload a CSV or JSON file."});
                } else {
                    validateAndShowPreview({error: "Unsupported file type. Please upload a CSV or JSON file."});
                }

                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Upload ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß
                document.getElementById('confirm-upload-btn').style.display = 'inline-block';
            };
            reader.readAsText(file, "UTF-8");
        }
    });


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Upload ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API Service)
    document.getElementById('confirm-upload-btn').addEventListener('click', function () {
        const file = document.getElementById('fileInput').files[0];

        if (!file) {
            alert("Please select a file first!");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        console.log("üìå Sending file to server:", file.name);

        fetch("http://localhost:8080/admin/uploadCommitteeFiles", {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö data.message ‡∏Å‡πà‡∏≠‡∏ô
                if (data.message === "File processed successfully") {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                    Swal.fire({
                        icon: "success",
                        title: "Data Upload successfully.",
                        showConfirmButton: true,
                        timer: 2000
                    }).then(() => {
                        // Reload ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠ swal ‡∏õ‡∏¥‡∏î‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß
                        location.reload();
                    });
                } else if (data.message === "File processed with warnings") {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ warnings ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ shortMessage ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                    if (data.shortMessage) {
                        alert(data.shortMessage);
                    } else if (data.warnings && data.warnings.length > 0) {
                        let warnMsg = data.message + "\n\nWarnings:\n" + data.warnings.join("\n");
                        alert(warnMsg);
                    } else {
                        alert(data.message);
                    }
                    // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ reload ‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å comment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ
                    // location.reload();

                } else if (data.message === "File processing failed") {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á
                    if (data.errors && data.errors.length > 0) {
                        alert("Upload failed: " + data.errors.join(", "));
                    } else {
                        alert("Upload failed: " + data.message);
                    }
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô
                    if (data.errors && data.errors.length > 0) {
                        alert("Upload failed: " + data.errors.join(", "));
                    } else if (data.message) {
                        alert("Upload failed: " + data.message);
                    } else {
                        alert("Upload failed: Unknown error");
                    }
                }
            })
            .catch(error => console.error("Error uploading file:", error));
    });


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö BOM (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
    function removeBOM(csv) {
        if (csv.charCodeAt(0) === 0xFEFF) {
            csv = csv.substring(1);
        }
        return csv;
    }


</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
<script>
    function exportTemplate() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å fetch ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!projectsData || projectsData.length === 0) {
            alert("No project data available to export.");
            return;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö rows ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
        let dataRows = [];
        projectsData.forEach(project => {
            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÉ‡∏ô professorList
            let advisor = "";
            let coAdvisor = "";
            let posterCommittee = "";
            if (project.professorList && Array.isArray(project.professorList)) {
                project.professorList.forEach(prof => {
                    if (prof.role === "Advisor") {
                        advisor = prof.professorName;
                    } else if (prof.role === "Co-advisor") {
                        coAdvisor = prof.professorName;
                    } else if (prof.role === "Committee") {
                        committee = prof.professorName
                    }
                });
            }

            // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
            if (project.studentList && Array.isArray(project.studentList) && project.studentList.length > 0) {
                project.studentList.forEach(student => {
                    dataRows.push([
                        project.projectId,
                        project.projectTitle,
                        project.projectDescription,
                        project.category || "",
                        student.studentId,
                        student.studentName,
                        project.program,
                        advisor,
                        coAdvisor,
                        committee,
                        ""
                    ]);
                });
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                dataRows.push([
                    project.projectId,
                    project.projectTitle,
                    project.projectDescription,
                    project.category || "",
                    "",
                    "",
                    project.program,
                    advisor,
                    coAdvisor,
                    committee,
                    ""
                ]);
            }
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook ‡πÅ‡∏•‡∏∞ Worksheet ‡∏î‡πâ‡∏ß‡∏¢ ExcelJS
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet("Project List");

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        ws.columns = [
            {width: 15},  // A - Project ID
            {width: 25},  // B - Project Title
            {width: 30},  // C - Project Description
            {width: 15},  // D - Project Category (‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡∏î‡πå project.category)
            {width: 15},  // E - Student ID
            {width: 25},  // F - Student Name
            {width: 10},  // G - Program
            {width: 20},  // H - Advisor
            {width: 20},  // I - Co-advisor
            {width: 20},  // J - Committee
            {width: 20},  // K - Poster-Committee
        ];

        // Merge cells ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header (‡πÅ‡∏ñ‡∏ß 1-4)
        ws.mergeCells('A1:K1');
        ws.mergeCells('A2:K2');
        ws.mergeCells('A3:K3');
        ws.mergeCells('A4:K4');

        // ‡πÅ‡∏ñ‡∏ß 1
        ws.getCell('A1').value = "Senior Project Overview";
        ws.getCell('A1').font = {bold: true, size: 14, color: {argb: 'FF000000'}};
        ws.getCell('A1').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 2
        ws.getCell('A2').value = "Exported Project Data";
        ws.getCell('A2').font = {size: 12, color: {argb: 'FF4D93D9'}};
        ws.getCell('A2').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 3
        ws.getCell('A3').value = "Link to view detailed project information";
        ws.getCell('A3').font = {bold: true, size: 12, color: {argb: 'FF000000'}};
        ws.getCell('A3').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 4
        ws.getCell('A4').value = "https://yourprojectlink.example.com";
        ws.getCell('A4').font = {size: 10, color: {argb: 'FF000000'}};
        ws.getCell('A4').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 5: Header Row ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        const headerRow = ws.getRow(5);
        headerRow.values = [
            "Project ID",
            "Project Title",
            "Project Description",
            "Project Category",
            "Student ID",
            "Student Name",
            "Program",
            "Advisor",
            "Co-advisor",
            "Committee",
            "Poster-Committee"
        ];

        headerRow.font = {bold: true, size: 11, color: {argb: 'FF000000'}};
        headerRow.alignment = {vertical: 'middle', horizontal: 'center'};
        headerRow.fill = {type: 'pattern', pattern: 'solid', fgColor: {argb: 'FFB5E6A2'}};

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Border ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÉ‡∏ô header row
        headerRow.eachCell(cell => {
            cell.border = {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            };
        });

        // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô)
        const dataRowStyle = {
            fill: {fgColor: {argb: 'FFC8E6C9'}},
            border: {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            }
        };

        // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ row ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 6 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ
        dataRows.forEach(rowData => {
            let newRow = ws.addRow(rowData);
            newRow.eachCell(cell => {
                cell.alignment = {vertical: 'middle', horizontal: 'left'};
                cell.fill = dataRowStyle.fill;
                cell.border = dataRowStyle.border;
            });
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡πâ‡∏ß trigger ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        wb.xlsx.writeBuffer()
            .then(buffer => {
                const blob = new Blob([buffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Raw_Committee_data.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("Error generating Excel file:", error);
            });
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Export
    document.getElementById("export-project-raw-excel").addEventListener("click", exportTemplate);


    function exportTemplateNew() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ projectsData ‡∏à‡∏≤‡∏Å fetch ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!projectsData || projectsData.length === 0) {
            alert("No project data available to export.");
            return;
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Poster Committee ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô headers
        const headers = [
            "Project ID",
            "Project Title",
            "Project Description",
            "Project Category",
            "Student ID",
            "Student Name",
            "Program",
            "Advisor",
            "Co-advisor",
            "Committee"
        ];

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö rows ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
        let dataRows = [];
        // mapping ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå: key = projectId, value = { start: index, end: index }
        let projectMapping = new Map();

        projectsData.forEach(project => {
            // ------------------- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå -------------------
            let projectId = project.projectId || "";
            let projectTitle = project.projectTitle || "";
            let projectDescription = project.projectDescription || "";
            let projectCategory = project.category || "";
            let program = project.program || "";

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Advisor/Co-advisor
            let advisor = "";
            let coAdvisor = "";
            if (project.professorList && Array.isArray(project.professorList)) {
                project.professorList.forEach(prof => {
                    if (prof.role === "Advisor") {
                        advisor = prof.professorName;
                    } else if (prof.role === "Co-advisor") {
                        coAdvisor = prof.professorName;
                    }
                });
            }

            // ------------------- ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå -------------------
            let studentList = [];
            if (project.studentList && Array.isArray(project.studentList) && project.studentList.length > 0) {
                studentList = project.studentList.map(student => ({
                    studentId: student.studentId || "",
                    studentName: student.studentName || ""
                }));
            }
            // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏®.‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 3 ‡πÉ‡∏´‡πâ padding ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
            const minRows = 3;
            while (studentList.length < minRows) {
                studentList.push({studentId: "", studentName: ""});
            }
            const numRows = studentList.length;

            // ------------------- Committee -------------------
            // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ project.committeeList
            // ‡πÉ‡∏´‡πâ filter ‡∏°‡∏≤‡∏à‡∏≤‡∏Å professorList ‡πÅ‡∏ó‡∏ô
            let committees = [];
            if (project.professorList && Array.isArray(project.professorList)) {
                committees = project.professorList
                    .filter(p => p.role === "Committee")
                    .map(p => p.professorName || "");
            }
            // ‡πÄ‡∏ï‡∏¥‡∏°/‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö numRows
            while (committees.length < numRows) {
                committees.push("");
            }
            if (committees.length > numRows) {
                committees = committees.slice(0, numRows);
            }

            // // ------------------- Poster Committee -------------------
            // let posterCommittees = [];
            // if (project.professorList && Array.isArray(project.professorList)) {
            //     posterCommittees = project.professorList
            //         .filter(p => p.role === "posterCommittee")
            //         .map(p => p.professorName || "");
            // }
            // while (posterCommittees.length < numRows) {
            //     posterCommittees.push("");
            // }
            // if (posterCommittees.length > numRows) {
            //     posterCommittees = posterCommittees.slice(0, numRows);
            // }

            // ------------------- ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á dataRows -------------------
            let startIndex = dataRows.length; // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            for (let i = 0; i < numRows; i++) {
                let row = [
                    projectId,             // index 0 => Col A
                    projectTitle,          // index 1 => Col B
                    projectDescription,    // index 2 => Col C
                    projectCategory,       // index 3 => Col D
                    studentList[i].studentId,   // index 4 => Col E
                    studentList[i].studentName, // index 5 => Col F
                    program,               // index 6 => Col G
                    advisor,               // index 7 => Col H
                    coAdvisor,             // index 8 => Col I
                    "",         // index 9 => Col J
                ];
                dataRows.push(row);
            }
            let endIndex = dataRows.length;
            projectMapping.set(projectId, {start: startIndex, end: endIndex});
        });

        // ------------------- ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook, Worksheet ‡∏î‡πâ‡∏ß‡∏¢ ExcelJS -------------------
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet("Project Committee Overview");

        // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô 11 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (A..K)
        ws.columns = [
            {width: 15}, // A: Project ID
            {width: 25}, // B: Project Title
            {width: 30}, // C: Project Description
            {width: 15}, // D: Project Category
            {width: 15}, // E: Student ID
            {width: 25}, // F: Student Name
            {width: 10}, // G: Program
            {width: 20}, // H: Advisor
            {width: 20}, // I: Co-advisor
            {width: 20}, // J: Committee
        ];

        // Merge cells ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header area (‡πÅ‡∏ñ‡∏ß 1-4) -> A1:K1, A2:K2, ‡∏Ø‡∏•‡∏Ø
        ws.mergeCells('A1:J1');
        ws.mergeCells('A2:J2');
        ws.mergeCells('A3:J3');
        ws.mergeCells('A4:J4');

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Header area
        ws.getCell('A1').value = "Senior Project Overview";
        ws.getCell('A1').font = {bold: true, size: 14, color: {argb: 'FF000000'}};
        ws.getCell('A1').alignment = {horizontal: 'center', vertical: 'middle'};

        ws.getCell('A2').value = "Exported Project Committee Data";
        ws.getCell('A2').font = {size: 12, color: {argb: 'FF4D93D9'}};
        ws.getCell('A2').alignment = {horizontal: 'center', vertical: 'middle'};

        ws.getCell('A3').value = "Link to view detailed project information";
        ws.getCell('A3').font = {bold: true, size: 12, color: {argb: 'FF000000'}};
        ws.getCell('A3').alignment = {horizontal: 'center', vertical: 'middle'};

        ws.getCell('A4').value = "https://yourprojectlink.example.com";
        ws.getCell('A4').font = {size: 10, color: {argb: 'FF000000'}};
        ws.getCell('A4').alignment = {horizontal: 'center', vertical: 'middle'};

        // ‡πÅ‡∏ñ‡∏ß 5: Header Row ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        const headerRow = ws.getRow(5);
        headerRow.values = headers;  // 11 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        headerRow.font = {bold: true, size: 11, color: {argb: 'FF000000'}};
        headerRow.alignment = {vertical: 'middle', horizontal: 'center'};
        headerRow.fill = {type: 'pattern', pattern: 'solid', fgColor: {argb: 'FFB5E6A2'}};
        headerRow.eachCell(cell => {
            cell.border = {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            };
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• rows ‡∏•‡∏á‡πÉ‡∏ô worksheet (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 6)
        dataRows.forEach(rowData => {
            ws.addRow(rowData);
        });

        // ‡πÅ‡∏õ‡∏•‡∏á projectMapping ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß
        projectMapping.forEach((range, projId) => {
            let startRow = range.start + 6; // ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°
            let endRow = range.end + 5;     // ‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (exclusive ‡∏Ç‡∏≠‡∏á endIndex ‡∏à‡∏∂‡∏á -1 +6 = +5)

            // Merge ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Project-level: A(1), B(2), C(3), D(4), G(7), H(8), I(9)
            // ‡πÑ‡∏°‡πà merge E(5), F(6) (‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤), J(10), K(11) (committee, posterCommittee)
            if (startRow < endRow) {
                [1, 2, 3, 4, 7, 8, 9].forEach(col => {
                    ws.mergeCells(startRow, col, endRow, col);
                });
            } else if (startRow === endRow) {
                // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡πÅ‡∏ñ‡∏ß => ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
                let extraRows = 3 - 1; // ‡∏°‡∏µ 1 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡πâ‡∏ß => ‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡πÅ‡∏ñ‡∏ß
                for (let i = 0; i < extraRows; i++) {
                    ws.addRow(["", "", "", "", "", "", "", "", "", "", ""]);
                    endRow++;
                }
                [1, 2, 3, 4, 7, 8, 9].forEach(col => {
                    ws.mergeCells(startRow, col, endRow, col);
                });
            }
        });

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö data rows (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô)
        const dataRowStyle = {
            fill: {fgColor: {argb: 'FFC8E6C9'}},
            border: {
                top: {style: 'thin', color: {argb: 'FF000000'}},
                left: {style: 'thin', color: {argb: 'FF000000'}},
                bottom: {style: 'thin', color: {argb: 'FF000000'}},
                right: {style: 'thin', color: {argb: 'FF000000'}}
            }
        };

        // Apply style ‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß 6 ‡∏•‡∏á‡πÑ‡∏õ)
        for (let i = 6; i <= ws.rowCount; i++) {
            let row = ws.getRow(i);
            row.eachCell(cell => {
                cell.alignment = {vertical: 'middle', horizontal: 'left'};
                cell.fill = dataRowStyle.fill;
                cell.border = dataRowStyle.border;
            });
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡πâ‡∏ß trigger ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        wb.xlsx.writeBuffer()
            .then(buffer => {
                const blob = new Blob([buffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'ForCommittee_SignUp.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("Error generating Excel file:", error);
            });
    }

    // ‡∏ú‡∏π‡∏Å event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
    document.getElementById("export-project-excel-new").addEventListener("click", exportTemplateNew);


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
    function confirmDelete(studentId, studentName, projectId) {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô popup ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
        const popup = document.getElementById('confirmDeletePopup');
        const deleteConfirmMsg = document.getElementById('delete-confirm-msg');
        deleteConfirmMsg.innerHTML = `Are you sure you want to remove Student : "${studentId} ${studentName}" <br> from Project ID : "${projectId}"?`;

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const cancelBtn = document.getElementById('cancelDeleteBtn');

        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Popup ‡πÅ‡∏™‡∏î‡∏á
        popup.style.display = 'block';

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏ö student
        confirmBtn.onclick = function () {
            deleteStudentFromProject(studentId, projectId);  // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏ö student ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å project
            popup.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Popup
        };

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        cancelBtn.onclick = function () {
            popup.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Popup
        };
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö student ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å project
    function deleteStudentFromProject(studentId, projectId) {
        // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
        fetch(`http://localhost:8080/admin/deleteStudentFromProject?projectId=${encodeURIComponent(projectId)}&studentId=${encodeURIComponent(studentId)}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(errorText => {
                        throw new Error(`HTTP error! status: ${response.status}, Message: ${errorText}`);
                    });
                }
                // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                return response.text();
            })
            .then(data => {
                console.log('Success:', data);
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                document.getElementById(`student-${studentId}`).closest('.form-group').remove();
                showNotification('Student removed from project successfully!');
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error deleting student: ' + error.message);
            });
    }


</script>
