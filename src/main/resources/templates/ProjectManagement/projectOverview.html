<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Project Overview </title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-admin.css">
    <link rel="stylesheet" href="/css/projectOverview.css">

    <!-- Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>

<body>
<div class="container">
    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>

        <form th:action="@{/logout}" method="post" class="logout-container">
            <!--        ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cross-Site Request Forgery (CSRF)-->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </form>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                    </path>
                </svg>
                Homepage
            </h4>
            <li><a href="/admin-dashboard">Dashboard</a></li>
            <li><a href="/admin-proposal-report">Proposal Grade Report</a></li>
            <li><a href="/admin-defense-report">Defense Grade Report</a></li>
            <li><a href="/admin-eva-traking">Evaluation Tracking</a></li>
            <li><a href="/admin-timeliness-scoring">Timeliness Scoring</a></li>
        </ul>
        <h2> Pages </h2>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Score Evaluation
            </h4>
            <li><a href="/scoring-periods">Scoring Period Settings</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M42 15v-2.5C42 8.916 39.084 6 35.5 6h-23C8.916 6 6 8.916 6 12.5V15H42zM25.5 27H32V33H25.5zM35 27H42V33H35zM6 27H13V33H6zM16 27H22.5V33H16zM35 18H42V24H35zM25.5 18H32V24H25.5zM25.5 36H32V42H25.5zM16 36H22.5V42H16zM35 36v6h.5c3.415 0 6.218-2.649 6.475-6H35zM6.025 36c.257 3.351 3.059 6 6.475 6H13v-6H6.025zM16 18H22.5V24H16zM6 18H13V24H6z">
                    </path>
                </svg>
                Manage Schedule
            </h4>
            <li><a href="/admin/proposalSchedule">Proposal Schedule</a></li>
            <li><a href="/admin/editProposalSchedulePage">Edit Proposal Timing</a></li>
            <li><a href="/admin/defenseSchedule">Defense Schedule</a></li>
            <li><a href="/admin/editDefenseSchedulePage">Edit Defense Timing</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M35.5,8h-3.551C31.697,5.756,29.81,4,27.5,4h-7c-2.31,0-4.197,1.756-4.449,4H12.5C10.019,8,8,10.019,8,12.5v27	c0,2.481,2.019,4.5,4.5,4.5h23c2.481,0,4.5-2.019,4.5-4.5v-27C40,10.019,37.981,8,35.5,8z M20.5,7h7C28.327,7,29,7.673,29,8.5	S28.327,10,27.5,10h-7C19.673,10,19,9.327,19,8.5S19.673,7,20.5,7z M22.5,34h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,34,22.5,34z M22.5,24h-8c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h8	c0.828,0,1.5,0.671,1.5,1.5S23.328,24,22.5,24z M34.561,34.439c0.586,0.585,0.586,1.536,0,2.121C34.268,36.854,33.884,37,33.5,37	s-0.768-0.146-1.061-0.439L31,35.121l-1.439,1.439C29.268,36.854,28.884,37,28.5,37s-0.768-0.146-1.061-0.439	c-0.586-0.585-0.586-1.536,0-2.121L28.879,33l-1.439-1.439c-0.586-0.585-0.586-1.536,0-2.121c0.586-0.586,1.535-0.586,2.121,0	L31,30.879l1.439-1.439c0.586-0.586,1.535-0.586,2.121,0c0.586,0.585,0.586,1.536,0,2.121L33.121,33L34.561,34.439z M34.561,21.561	l-4,4C30.268,25.854,29.884,26,29.5,26s-0.768-0.146-1.061-0.439l-2-2c-0.586-0.585-0.586-1.536,0-2.121	c0.586-0.586,1.535-0.586,2.121,0l0.939,0.939l2.939-2.939c0.586-0.586,1.535-0.586,2.121,0	C35.146,20.025,35.146,20.975,34.561,21.561z">
                    </path>
                </svg>
                Manage Project
            </h4>
            <li><a href="/project-overview" class="active">Project Overview</a></li>
            <li><a href="/project-details">Project Details</a></li>
            <li><a href="/project-committee">Committee</a></li>
            <li><a href="/project-poster-committee">Poster Committee</a></li>
        </ul>
    </div>


    <div class="content">

        <div class="header-section">
            <div class="header-left">
                Project Overview

                <!-- Dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å semester -->
                <div class="semester-container">
                    <select id="semester-selector" onchange="filterBySemester();">
                        <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÅ‡∏•‡∏∞ semester -->
                    </select>
                </div>
            </div>

            <div class="btn-header">
                <!-- ‡∏õ‡∏∏‡πà‡∏° Export -->
                <!--                <button id="export-project-excel">Export Project Template</button>-->
                <button class="export-btn" id="open-export-dialog">Export Data</button>
            </div>
        </div>


        <div class="body-section">

            <div class="table-container">
                <div class="filter-controls">
                    <button class="filter active" onclick="filterProjects('all')">All</button>
                    <button class="filter" onclick="filterProjects('ict')">ICT</button>
                    <button class="filter" onclick="filterProjects('dst')">DST</button>
                    <input type="text" placeholder="Search" id="search-keyword"/>

                </div>
                <table>
                    <thead>
                    <tr>
                        <th>Project ID</th>
                        <th>Advisor</th>
                        <th>Project Name</th>
                        <th>Project Description</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="projectTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!--        <div class="pagination">-->
        <!--            <button class="page-btn" onclick="changePage('prev')">&lt;</button>-->
        <!--            &lt;!&ndash; ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô JavaScript &ndash;&gt;-->
        <!--            <button class="page-btn" onclick="changePage('next')">&gt;</button>-->
        <!--        </div>-->


        <!-- Modal Structure -->
        <div id="card-popup" class="card-popup"
             style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);">
            <div style="background: white; width: 80%; margin: 5% auto; padding: 20px; position: relative;">
                <div class="card-header">
                    <h1 class="card-title" id="popup-project-title"></h1>
                    <div id="popup-project-tag"></div>
                </div>

                <div class="card-description" id="popup-project-description"></div>

                <div class="project-info">
                    <p><strong>Project ID :</strong> <span id="popup-project-id">SP2024-04</span></p>
                    <p><strong>Advisor :</strong> <span id="popup-professor-name">Aj.Jidapa</span></p>
                </div>

                <div class="students-section">
                    <h2 class="section-title">Student</h2>
                    <div id="student-cards-container"></div>
                </div>

                <div class="committee-section">
                    <h2 class="section-title">Committee</h2>
                    <div id="committee-grid-container"></div>
                </div>

                <button class="close-btn" id="close-modal" onclick="closePopup()">Close</button>
            </div>
        </div>

        <!-- Overlay / PopUp Dialog -->
        <div id="export-dialog" class="export-dialog">
            <h3>Select Columns to Export</h3>

            <!-- Program Filter -->
            <label>Export Program:</label>
            <div class="program-options">
                <div class="select-item selected" data-value="ALL">All</div>
                <div class="select-item" data-value="ICT">ICT</div>
                <div class="select-item" data-value="DST">DST</div>
            </div>

            <!-- Column Options -->
            <div class="column-options">
                <div class="select-all-option">
                    <input type="checkbox" id="select-all">
                    <label for="select-all">Select All</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="projectId" checked>
                    <label for="projectId">Project ID</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="projectTitle" checked>
                    <label for="projectTitle">Project Title</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="projectDescription" checked>
                    <label for="projectDescription">Project Description</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="projectCategory" checked>
                    <label for="projectCategory"> Category</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="advisor" checked>
                    <label for="advisor">Advisor</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="coAdvisor" checked>
                    <label for="advisor">Co-Advisor</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="studentId" checked>
                    <label for="studentId">Student ID</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="studentName" checked>
                    <label for="studentName">Student Name</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="program" checked>
                    <label for="program">Program</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="section" checked>
                    <label for="section">Section</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="track" checked>
                    <label for="track">Track</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="committee" checked>
                    <label for="committee">Committee</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="posterCommittee" checked>
                    <label for="posterCommittee">Poster Committee</label>
                </div>
            </div>

            <!-- Export Actions -->
            <div class="export-actions">
                <button class="cancel-button" id="cancel-btn">Cancel</button>
                <button class="export-button" id="confirm-btn">Export Raw Data</button>
                <button class="export-button" id="export-project-excel-new">Export Project</button>
            </div>
        </div>

        <!-- Overlay -->
        <div id="export-overlay" class="export-overlay" style="display:none;"></div>

    </div>
</div>
</body>

<script>

    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.querySelector('.sidebar');

        // ‡∏û‡∏≠ scroll ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô sessionStorage
        sidebar.addEventListener('scroll', () => {
            sessionStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
        });

        // ‡∏û‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ restore ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        const saved = sessionStorage.getItem('sidebarScrollPos');
        if (saved !== null) {
            sidebar.scrollTop = parseInt(saved, 10);
        }
    });

    const semesterSelect = document.getElementById("semester-selector");
    semesterSelect.addEventListener("change", function () {
        console.log("Selected Semester:", semesterSelect.value);

        localStorage.setItem("selectedSemester", semesterSelect.value);

        fetchData();

    });

    document.addEventListener("DOMContentLoaded", function () {
        const menuItems = document.querySelectorAll(".sidebar ul li a");

        // ‡∏î‡∏∂‡∏á URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const currentPage = window.location.pathname.split("/").pop();

        menuItems.forEach(item => {
            if (item.getAttribute("href") === currentPage) {
                item.classList.add("active"); // ‡πÄ‡∏û‡∏¥‡πà‡∏° class "active" ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            }
        });
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    function filterProjects(category) {
        const rows = document.querySelectorAll("#projectTable tr");
        rows.forEach(row => {
            if (category === "all") {
                row.style.display = "";
            } else {
                row.style.display = row.getAttribute("data-category") === category ? "" : "none";
            }
        });

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.querySelectorAll(".filter").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`.filter[onclick="filterProjects('${category}')"]`).classList.add("active");
    }

    // -------------------- Fetch Project -------------------- //

    let projectsData = [];  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å API
    let filteredData = [];  // ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß

    function debounce(fn, ms) {
        let t;
        return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
        };
    }

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å semester ‡∏à‡∏≤‡∏Å projectsData
    function populateSemesterOptions() {
        const sel = document.getElementById('semester-selector');
        sel.innerHTML = '';  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥)

        // ‡πÄ‡∏Å‡πá‡∏ö unique semesters
        const sems = Array.from(new Set(projectsData.map(p => String(p.semester))))
            .sort();

        sems.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = "üìÜ " + s;
            sel.appendChild(opt);
        });

        const savedSemester = localStorage.getItem("selectedSemester");

        if (savedSemester && sems.includes(savedSemester)) {
            sel.value = savedSemester;
        } else {
            // ---- ‡πÄ‡∏ã‡πá‡∏ï defaultYear ----
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;   // getMonth() ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0-11 (‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° = 0, ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° = 11)

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <= 6 (‡∏°.‡∏Ñ. - ‡∏°‡∏¥.‡∏¢.) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -1, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏Å.‡∏Ñ. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const defaultYear = (currentMonth <= 8 ? currentYear - 1 : currentYear).toString();

            if (sems.includes(defaultYear.toString())) {
                sel.value = defaultYear.toString();
            } else {

                sel.selectedIndex = 0;
            }
        }
    }

    function applyFilters() {
        const sem = document.getElementById('semester-selector').value;
        const term = document.getElementById('search-keyword').value.trim().toLowerCase();

        filteredData = projectsData.filter(p => {
            // by semester
            if (sem && String(p.semester) !== sem) return false;
            // by search: ‡πÄ‡∏ä‡πá‡∏Ñ projectId, title, description, program, advisor, co-advisor, students
            if (term) {
                const hay = [
                    p.projectId,
                    p.projectTitle,
                    p.projectDescription,
                    p.program,
                    // advisor & co-advisor
                    ...p.professorList.map(x => x.professorName),
                    // student IDs & names
                    ...p.studentList.map(s => s.studentId + ' ' + s.studentName)
                ].join(' ').toLowerCase();
                if (!hay.includes(term)) return false;
            }
            return true;
        });

        displayResults();
        checkUploadAvailability();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // once only:
        document.getElementById('semester-selector')
            .addEventListener('change', applyFilters);
        document.getElementById('search-keyword')
            .addEventListener('input', debounce(applyFilters, 200));

        fetchProjects();
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
    function fetchProjects() {
        fetch("/admin/projectOverview")
            .then(r => {
                if (!r.ok) throw new Error(r.statusText);
                return r.json();
            })
            .then(data => {
                projectsData = data;
                filteredData = data;

                populateSemesterOptions();

                applyFilters();

            })

            .catch(err => console.error("Error fetching projects or advisors:", err));
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function displayResults(page) {
        let tableBody = document.querySelector("tbody");
        tableBody.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

        filteredData.forEach(project => {
            console.log(project);
            const row = document.createElement('tr');
            const projectProgram = project.program ? project.program.toLowerCase() : "unknown";
            row.setAttribute("data-category", projectProgram);

            // ‡∏Å‡∏£‡∏≠‡∏á professorList ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "Advisor"
            const advisor = project.professorList.find(professor => professor.role === "Advisor");
            const professorName = advisor ? advisor.professorName : "N/A"; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ "Advisor" ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á "N/A"

            // ‡πÉ‡∏ä‡πâ split ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏Ñ‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°
            const programParts = project.projectId.split(" ");
            const programPrefix = programParts[0]; // ‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (DST, ICT, etc.)
            const projectId = programParts.slice(1).join(" ");

            console.log(professorName); // ‡πÅ‡∏™‡∏î‡∏á professorName ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß

            row.innerHTML = `
            <td><span class="tag ${projectProgram}">${project.program || "N/A"}</span> ${projectId}</td>
            <td>${professorName}</td>
            <td>${project.projectTitle || "N/A"}</td>
            <td>${project.projectDescription || "N/A"}</td>
            <td>
            <button id="preview-button" class="view-btn" onclick="openPopup('${project.projectId}')">View</button>
            </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // -------------------- Pagination -------------------- //
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (page === 'prev' && currentPage > 1) {
            currentPage--;
        } else if (page === 'next' && currentPage < totalPages) {
            currentPage++;
        } else if (typeof page === 'number') {
            currentPage = page;
        }
        displayResults(currentPage);
        updatePagination();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° pagination
    function updatePagination() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const container = document.querySelector('.pagination');
        container.innerHTML = '';

        // Prev
        const prev = document.createElement('button');
        prev.classList.add('page-btn');
        prev.textContent = '<';
        prev.onclick = () => changePage('prev');
        container.appendChild(prev);

        // Pages
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.classList.add('page-btn');
            btn.textContent = i;
            if (i === currentPage) btn.classList.add('active');
            btn.onclick = () => changePage(i);
            container.appendChild(btn);
        }

        // Next
        const next = document.createElement('button');
        next.classList.add('page-btn');
        next.textContent = '>';
        next.onclick = () => changePage('next');
        container.appendChild(next);
    }

    // -------------------- Pop Up -------------------- //
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
    function openPopup(projectId) {
        console.log(`Opening modal for project ID: ${projectId}`);

        // Show the modal
        const modal = document.getElementById("card-popup");
        modal.style.display = "block";
        console.log(modal.style.display); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ display

        fetch(`http://localhost:8080/admin/projectOverview?projectId=${projectId}`)
            .then(response => response.json())
            .then(data => {
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ projectId ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ
                const project = data.find(project => project.projectId === projectId);

                if (project) {
                    document.getElementById("popup-project-title").textContent = project.projectTitle || "N/A";
                    document.getElementById("popup-project-id").textContent = project.projectId || "N/A";
                    document.getElementById("popup-project-description").textContent = project.projectDescription || "N/A";

                    // ‡∏Å‡∏£‡∏≠‡∏á professorName ‡∏ó‡∏µ‡πà‡∏°‡∏µ Role ‡πÄ‡∏õ‡πá‡∏ô "Advisor"
                    const advisor = project.professorList.find(professor => professor.role === "Advisor");
                    document.getElementById("popup-professor-name").textContent = advisor ? advisor.professorName : "N/A";

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° class "tag" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ program (‡πÉ‡∏ô lowercase)
                    const programTag = document.getElementById("popup-project-tag");
                    programTag.classList.add("tag", project.program.toLowerCase());
                    programTag.textContent = project.program || "N/A";

                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                    const studentCardsContainer = document.getElementById("student-cards-container");
                    studentCardsContainer.innerHTML = ''; // Clear any existing data
                    project.studentList.forEach(student => {
                        const studentCard = document.createElement("div");
                        studentCard.classList.add("student-card");
                        studentCard.innerHTML = `
                    <p><strong>${student.studentName}</strong></p>
                    <p>Student ID: ${student.studentId}  &nbsp;&nbsp;&nbsp;&nbsp; ${project.program || "N/A"} | Section: ${student.section || "N/A"} | Track: ${student.track || "-"}</p>
                `
                        studentCardsContainer.appendChild(studentCard);
                    });

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Committee ‡πÅ‡∏•‡∏∞ Poster Committee
                    const committeeGridContainer = document.getElementById("committee-grid-container");

                    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                    committeeGridContainer.innerHTML = '';

                    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Committee ‡πÅ‡∏•‡∏∞ Poster-Committee
                    project.professorList.forEach(professor => {
                        const committeeItem = document.createElement("div");
                        committeeItem.classList.add("committee-item");

                        if (professor.role === "Committee") {
                            committeeItem.innerHTML = `<strong>Committee :</strong> ${professor.professorName}`;
                            committeeGridContainer.appendChild(committeeItem);
                        }

                        if (professor.role === "Poster-Committee") {
                            const posterCommitteeItem = document.createElement("div");
                            posterCommitteeItem.classList.add("committee-item");
                            posterCommitteeItem.innerHTML = `<strong>Poster Committee :</strong> ${professor.professorName}`;
                            committeeGridContainer.appendChild(posterCommitteeItem);
                        }
                    });
                } else {
                    console.log("Project not found!");
                }
            })
            .catch(error => {
                console.error("Error fetching project details:", error);
            });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î Modal
    function closePopup() {
        const modal = document.getElementById("card-popup");
        modal.style.display = "none";
        console.log("Modal closed"); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î modal
    }

    // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "Close"
    document.getElementById("close-modal").addEventListener("click", function () {
        document.getElementById("card-popup").style.display = "none";
    });

    // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å modal
    document.getElementById("card-popup").addEventListener("click", function (event) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ click event ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á modal ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (event.target === document.getElementById("card-popup")) {
            document.getElementById("card-popup").style.display = "none";
        }
    });


    // -------------------- Export to CSV -------------------- //
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV
    // function exportToCSV() {
    //     console.log("Export button clicked");
    //     fetch("http://localhost:8080/admin/projectOverview")
    //         .then(response => response.json())
    //         .then(data => {
    //             if (!data || data.length === 0) {
    //                 console.warn("No data available to export.");
    //                 return;
    //             }
    //
    //             // ‡πÄ‡∏û‡∏¥‡πà‡∏° BOM (Byte Order Mark) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    //             let csvContent = "\uFEFF";
    //
    //             // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Committee ‡πÅ‡∏•‡∏∞ PosterCommittee
    //             let maxCommittees = 0;
    //             let maxPosterCommittees = 0;
    //
    //             data.forEach(project => {
    //                 const committeeCount = project.professorList.filter(p => p.role === "Committee").length;
    //                 const posterCommitteeCount = project.professorList.filter(p => p.role === "Poster-Committee").length;
    //                 maxCommittees = Math.max(maxCommittees, committeeCount);
    //                 maxPosterCommittees = Math.max(maxPosterCommittees, posterCommitteeCount);
    //             });
    //
    //             // ‡∏™‡∏£‡πâ‡∏≤‡∏á Header
    //             csvContent += "Project ID,Project Title,Project Description,Advisor,";
    //             for (let i = 1; i <= maxCommittees; i++) csvContent += `Committee ${i},`;
    //             for (let i = 1; i <= maxPosterCommittees; i++) csvContent += `Poster Committee ${i},`;
    //             csvContent += "Student ID,Student Name,Program,Section,Track\r\n";
    //
    //             // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV
    //             data.forEach(project => {
    //                 const projectId = `"${project.projectId || "N/A"}"`;
    //                 const projectTitle = `"${project.projectTitle || "N/A"}"`;
    //                 const projectDescription = `"${project.projectDescription || "N/A"}"`;
    //                 const advisor = `"${project.professorList.find(p => p.role === "Advisor")?.professorName || "N/A"}"`;
    //
    //                 // Committee & Poster Committee
    //                 const committeeList = project.professorList.filter(p => p.role === "Committee").map(p => `"${p.professorName}"`);
    //                 while (committeeList.length < maxCommittees) committeeList.push('""'); // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
    //                 const posterCommitteeList = project.professorList.filter(p => p.role === "Poster-Committee").map(p => `"${p.professorName}"`);
    //                 while (posterCommitteeList.length < maxPosterCommittees) posterCommitteeList.push('""'); // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
    //
    //                 // ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏ö
    //                 let firstRow = true;
    //
    //                 project.studentList.forEach(student => {
    //                     const studentId = `"${student.studentId || "N/A"}"`;
    //                     const studentName = `"${student.studentName || "N/A"}"`;
    //                     const program = `"${project.program || "N/A"}"`;
    //                     const section = `"${student.section || "N/A"}"`;
    //                     const track = `"${student.track || "-"}"`;
    //
    //                     if (firstRow) {
    //                         csvContent += `${projectId},${projectTitle},${projectDescription},${advisor},${committeeList.join(",")},${posterCommitteeList.join(",")},${studentId},${studentName},${program},${section},${track}\r\n`;
    //                         firstRow = false; // ‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ã‡πâ‡∏≥
    //                     } else {
    //                         csvContent += `,,,,${committeeList.join(",")},${posterCommitteeList.join(",")},${studentId},${studentName},${program},${section},${track}\r\n`;
    //                     }
    //                 });
    //
    //                 // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    //                 if (project.studentList.length === 0) {
    //                     csvContent += `${projectId},${projectTitle},${projectDescription},${advisor},${committeeList.join(",")},${posterCommitteeList.join(",")},,,,,\r\n`;
    //                 }
    //             });
    //
    //             // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    //             const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    //             const link = document.createElement("a");
    //             link.href = URL.createObjectURL(blob);
    //             link.setAttribute("download", "project_data.csv");
    //             document.body.appendChild(link);
    //             link.click();
    //             document.body.removeChild(link);
    //         })
    //         .catch(error => console.error("Error exporting CSV:", error));
    // }

    // ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Export ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô exportToCSV
    // document.getElementById("export-btn").addEventListener("click", exportToCSV);

    // function exportToCSV() {
    //     console.log("Export button clicked");
    //
    //     fetch("http://localhost:8080/admin/projectOverview")
    //         .then(response => response.json())
    //         .then(data => {
    //             if (!data || data.length === 0) {
    //                 console.warn("No data available to export.");
    //                 return;
    //             }
    //
    //             // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Committee ‡πÅ‡∏•‡∏∞ PosterCommittee
    //             let maxCommittees = 0;
    //             let maxPosterCommittees = 0;
    //
    //             data.forEach(project => {
    //                 const committeeCount = project.professorList.filter(p => p.role === "Committee").length;
    //                 const posterCommitteeCount = project.professorList.filter(p => p.role === "Poster-Committee").length;
    //                 maxCommittees = Math.max(maxCommittees, committeeCount);
    //                 maxPosterCommittees = Math.max(maxPosterCommittees, posterCommitteeCount);
    //             });
    //
    //             // ‡∏™‡∏£‡πâ‡∏≤‡∏á Header
    //             const headers = ["Project ID", "Project Title", "Project Description", "Advisor"];
    //             for (let i = 1; i <= maxCommittees; i++) headers.push(`Committee ${i}`);
    //             for (let i = 1; i <= maxPosterCommittees; i++) headers.push(`Poster Committee ${i}`);
    //             headers.push("Student ID", "Student Name", "Program", "Section", "Track");
    //
    //             const rows = [];
    //
    //             // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    //             data.forEach(project => {
    //                 const projectId = project.projectId || "N/A";
    //                 const projectTitle = project.projectTitle || "N/A";
    //                 const projectDescription = project.projectDescription || "N/A";
    //                 const advisor = project.professorList.find(p => p.role === "Advisor")?.professorName || "N/A";
    //
    //                 // Committee & Poster Committee
    //                 const committeeList = project.professorList.filter(p => p.role === "Committee").map(p => p.professorName);
    //                 while (committeeList.length < maxCommittees) committeeList.push('');
    //                 const posterCommitteeList = project.professorList.filter(p => p.role === "Poster-Committee").map(p => p.professorName);
    //                 while (posterCommitteeList.length < maxPosterCommittees) posterCommitteeList.push('');
    //
    //                 // ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏ö
    //                 project.studentList.forEach(student => {
    //                     const studentId = student.studentId || "N/A";
    //                     const studentName = student.studentName || "N/A";
    //                     const program = project.program || "N/A";
    //                     const section = student.section || "N/A";
    //                     const track = student.track || "-";
    //
    //                     const row = [projectId, projectTitle, projectDescription, advisor, ...committeeList, ...posterCommitteeList, studentId, studentName, program, section, track];
    //                     rows.push(row);
    //                 });
    //
    //                 // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    //                 if (project.studentList.length === 0) {
    //                     const row = [projectId, projectTitle, projectDescription, advisor, ...committeeList, ...posterCommitteeList, '', '', '', '', ''];
    //                     rows.push(row);
    //                 }
    //             });
    //
    //             // ‡πÉ‡∏ä‡πâ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ xlsx ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel
    //             const wb = XLSX.utils.book_new();
    //             const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
    //
    //             // ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏µ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Header
    //             const headerRange = {s: {r: 0, c: 0}, e: {r: 0, c: headers.length - 1}};
    //             ws['!cols'] = headers.map(() => ({wch: 20})); // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    //             ws['!rows'] = rows.length;
    //
    //             // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Header
    //             for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
    //                 const address = XLSX.utils.encode_cell({r: 0, c: C});
    //                 if (!ws[address]) continue;
    //                 ws[address].s = {
    //                     fill: {
    //                         fgColor: {rgb: "FFFF00"} // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
    //                     },
    //                     font: {
    //                         bold: true
    //                     }
    //                 };
    //             }
    //
    //             // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    //             XLSX.writeFile(wb, "project_data.xlsx");
    //         })
    //         .catch(error => console.error("Error exporting Excel:", error));
    // }

    // ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Export ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô exportToExcel
    // document.getElementById("export-btn").addEventListener("click", exportToExcel);

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
<script>
    // ‡πÄ‡∏õ‡∏¥‡∏î Dialog ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Export
    document.getElementById('open-export-dialog').addEventListener('click', () => {
        // ‡πÅ‡∏™‡∏î‡∏á Dialog ‡πÅ‡∏•‡∏∞ Overlay
        document.getElementById('export-dialog').style.display = 'block';
        document.getElementById('export-overlay').style.display = 'block';
    });

    // ‡∏õ‡∏¥‡∏î Dialog ‡πÅ‡∏•‡∏∞ Overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Cancel
    document.getElementById('cancel-btn').addEventListener('click', () => {
        // ‡∏ã‡πà‡∏≠‡∏ô Dialog ‡πÅ‡∏•‡∏∞ Overlay
        document.getElementById('export-dialog').style.display = 'none';
        document.getElementById('export-overlay').style.display = 'none';
    });


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏î Export
    document.getElementById('confirm-btn').addEventListener('click', () => {
        const selectedColumns = [];

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏´‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏á
        const columns = [
            'projectId', 'projectTitle', 'projectDescription', 'advisor', 'coAdvisor',
            'studentId', 'studentName', 'program', 'section', 'track',
            'committee', 'posterCommittee'
        ];

        columns.forEach(col => {
            const checkbox = document.getElementById(col);
            if (checkbox.checked) {
                selectedColumns.push(col);
            }
        });

        // ‡∏ã‡πà‡∏≠‡∏ô Dialog ‡πÅ‡∏•‡∏∞ Overlay ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î Export
        document.getElementById('export-dialog').style.display = 'none';
        document.getElementById('export-overlay').style.display = 'none';

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô exportToExcel ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö selectedColumns
        exportToExcel(selectedColumns);
    });


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å checkbox
    function getSelectedColumns() {
        const cols = [];
        if (document.getElementById("projectId").checked) cols.push("Project ID");
        if (document.getElementById("projectTitle").checked) cols.push("Project Title");
        if (document.getElementById("projectDescription").checked) cols.push("Project Description");
        if (document.getElementById("advisor").checked) cols.push("Advisor");
        if (document.getElementById("coAdvisor").checked) cols.push("Co-Advisor");
        if (document.getElementById("studentId").checked) cols.push("Student ID");
        if (document.getElementById("studentName").checked) cols.push("Student Name");
        if (document.getElementById("program").checked) cols.push("Program");
        if (document.getElementById("section").checked) cols.push("Section");
        if (document.getElementById("track").checked) cols.push("Track");
        if (document.getElementById("committee").checked) cols.push("Committee");
        if (document.getElementById("posterCommittee").checked) cols.push("Poster-Committee");
        return cols;
    }

    // 1) setup click handlers to toggle selection
    document.querySelectorAll('.program-options .select-item')
        .forEach(item => {
            item.addEventListener('click', () => {
                // unselect all, then select this one
                document
                    .querySelectorAll('.program-options .select-item')
                    .forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
            });
        });

    function exportToExcel() {
        console.log("Export button clicked");

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
        fetch("http://localhost:8080/admin/projectOverview")
            .then(resp => resp.json())
            .then(data => {
                    if (!data || data.length === 0) {
                        console.warn("No data available to export.");
                        return;
                    }

                    // ‡∏≠‡πà‡∏≤‡∏ô semester ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å dropdown
                    const sem = document.getElementById('semester-selector').value;

                    const programFilter = document.querySelector('.program-options .select-item.selected').dataset.value;

                    const filtered = data.filter(p =>
                        String(p.semester) === sem &&
                        (programFilter === 'ALL' || p.program === programFilter)
                    );
                    if (!filtered.length) {
                        return Swal.fire(
                            'Warning',
                            `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Semester ${sem} / Program ${programFilter}`,
                            'warning'
                        );
                    }

                    // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    const selectedColumns = getSelectedColumns();

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á header ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    const headers = [];
                    if (selectedColumns.includes("Project ID")) headers.push("Project ID");
                    if (selectedColumns.includes("Project Title")) headers.push("Project Title");
                    if (selectedColumns.includes("Project Description")) headers.push("Project Description");
                    if (selectedColumns.includes("Advisor")) headers.push("Advisor");
                    if (selectedColumns.includes("Co-Advisor")) headers.push("Co-Advisor");
                    if (selectedColumns.includes("Student ID")) headers.push("Student ID");
                    if (selectedColumns.includes("Student Name")) headers.push("Student Name");
                    if (selectedColumns.includes("Program")) headers.push("Program");
                    if (selectedColumns.includes("Section")) headers.push("Section");
                    if (selectedColumns.includes("Track")) headers.push("Track");
                    if (selectedColumns.includes("Committee")) headers.push("Committee");
                    if (selectedColumns.includes("Poster-Committee")) headers.push("Poster-Committee");

                    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß
                    const rows = [];
                    filtered.forEach(project => {
                        // ‡∏´‡∏≤ Advisor
                        const advisorName = project.professorList.find(p => p.role === "Advisor")?.professorName || "";

                        // ‡∏´‡∏≤ Co-Advisor
                        const coAdvisorName = project.professorList.find(p => p.role === "Co-Advisor")?.professorName || "";

                        // ‡∏´‡∏≤ Committee ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        const committeeList = project.professorList
                            .filter(p => p.role === "Committee")
                            .map(p => p.professorName);

                        // ‡∏´‡∏≤ Poster Committee
                        const posterList = project.professorList
                            .filter(p => p.role === "Poster-Committee")
                            .map(p => p.professorName);

                        project.studentList.forEach(student => {
                            // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ committee ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô
                            const committeeName = committeeList.length > 0 ? committeeList.shift() : "";
                            const posterCommitteeName = posterList.length > 0 ? posterList.shift() : "";

                            const row = [];
                            if (selectedColumns.includes("Project ID")) row.push(project.projectId);
                            if (selectedColumns.includes("Project Title")) row.push(project.projectTitle);
                            if (selectedColumns.includes("Project Description")) row.push(project.projectDescription);
                            if (selectedColumns.includes("Advisor")) row.push(advisorName);
                            if (selectedColumns.includes("Co-Advisor")) row.push(coAdvisorName);
                            if (selectedColumns.includes("Student ID")) row.push(student.studentId);
                            if (selectedColumns.includes("Student Name")) row.push(student.studentName);
                            if (selectedColumns.includes("Program")) row.push(project.program);
                            if (selectedColumns.includes("Section")) row.push(student.section);
                            if (selectedColumns.includes("Track")) row.push(student.track);
                            if (selectedColumns.includes("Committee")) row.push(committeeName);
                            if (selectedColumns.includes("Poster-Committee")) row.push(posterCommitteeName);

                            rows.push(row);
                        });
                    });

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel Workbook + Worksheet
                    const wb = new ExcelJS.Workbook();
                    const ws = wb.addWorksheet('Project Overview');

                    // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Header Row (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1)
                    const headerRow = ws.getRow(1);
                    headerRow.values = headers;
                    headerRow.font = {bold: true, color: {argb: 'FFFFFFFF'}};
                    headerRow.alignment = {horizontal: 'center', vertical: 'middle'};
                    headers.forEach((_, i) => {
                        const cell = headerRow.getCell(i + 1);
                        cell.fill = {type: 'pattern', pattern: 'solid', fgColor: {argb: '4472C4'}};
                        cell.border = {
                            top: {style: 'thin'}, left: {style: 'thin'},
                            bottom: {style: 'thin'}, right: {style: 'thin'}
                        };
                    });

                    // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Data Rows
                    rows.forEach((dataRow, idx) => {
                        const row = ws.addRow(dataRow);
                        row.alignment = {vertical: 'middle'};
                        row.eachCell(cell => {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: {argb: idx % 2 === 0 ? 'FFE9EFF7' : 'FFFFFFFF'}
                            };
                            cell.border = {
                                top: {style: 'thin'}, left: {style: 'thin'},
                                bottom: {style: 'thin'}, right: {style: 'thin'}
                            };
                        });
                    });

                    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                    ws.columns = headers.map(() => ({width: 20}));

                    // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel
                    wb.xlsx.writeBuffer().then(buffer => {
                        const blob = new Blob([buffer], {
                            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'Project_Overview_Raw.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    });
                }
            )
            .catch(err => console.error("Error exporting Excel:", err));
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å Select All ‡πÉ‡∏´‡πâ toggle ‡∏ó‡∏∏‡∏Å checkbox ‡πÉ‡∏ô .column-option
    document.getElementById("select-all")
        .addEventListener("change", function (e) {
            const on = e.target.checked;
            document.querySelectorAll(".column-option input[type=checkbox]")
                .forEach(chk => chk.checked = on);
        });

    //  ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏±‡∏ô ‡πÉ‡∏´‡πâ auto-uncheck Select All ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    document.querySelectorAll(".column-option input[type=checkbox]").forEach(chk => {
        chk.addEventListener("change", () => {
            const all = Array.from(
                document.querySelectorAll(".column-option input[type=checkbox]")
            ).every(c => c.checked);
            document.getElementById("select-all").checked = all;
        });
    });

    function getSelectedColumnsPC() {
        const map = [
            {id: "projectId", name: "Project ID"},
            {id: "projectTitle", name: "Project Title"},
            {id: "projectDescription", name: "Project Description"},
            {id: "projectCategory", name: "Project Category"},
            {id: "studentId", name: "Student ID"},
            {id: "studentName", name: "Student Name"},
            {id: "section", name: "Section"},
            {id: "track", name: "Track"},
            {id: "program", name: "Program"},
            {id: "advisor", name: "Advisor"},
            {id: "coAdvisor", name: "Co-Advisor"},
            {id: "committee", name: "Committee"},
            {id: "posterCommittee", name: "Poster-Committee"}
        ];
        return map
            .filter(col => {
                const chk = document.getElementById(col.id);
                return chk && chk.checked;
            })
            .map(col => col.name);
    }


    // 2) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô export ‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°
    async function exportMergeExcel() {

        if (!projectsData || projectsData.length === 0) {
            return Swal.fire('Warning', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'warning');
        }

        const sem = document.getElementById('semester-selector').value;
        const programFilter = document.querySelector('.program-options .select-item.selected').dataset.value;

        const exportData = projectsData.filter(p =>
            String(p.semester) === sem &&
            (programFilter === 'ALL' || p.program === programFilter)
        );
        if (exportData.length === 0) {
            return Swal.fire(
                'Warning',
                `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Semester ${sem} / Program ${programFilter}`,
                'warning'
            );
        }

        let headers = getSelectedColumnsPC();
        if (headers.length === 0) {
            return Swal.fire('Warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå', 'warning');
        }


        // 4) ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° row objects
        const rowObjs = [];
        const projectMap = new Map();
        let globalRow = 6; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 6

        exportData.forEach(proj => {
            // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ï‡∏≤‡∏° role
            const advs = proj.professorList.filter(p => p.role === "Advisor").map(p => p.professorName);
            const coAd = proj.professorList.filter(p => p.role === "Co-Advisor").map(p => p.professorName);
            const coms = proj.professorList.filter(p => p.role === "Committee").map(p => p.professorName);
            const pos = proj.professorList.filter(p => p.role === "Poster-Committee").map(p => p.professorName);

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° studentList
            const studs = Array.isArray(proj.studentList)
                ? proj.studentList.map(s => ({
                    "Student ID": s.studentId || "",
                    "Student Name": s.studentName || "",
                    "Section": s.section || "",
                    "Track": s.track || ""
                }))
                : [];

            // ‡∏´‡∏≤ numRows ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß pad ‡πÅ‡∏ï‡πà‡∏•‡∏∞ array
            const numRows = Math.max(studs.length, advs.length, coAd.length, coms.length, pos.length);
            while (advs.length < numRows) advs.push("");
            while (coAd.length < numRows) coAd.push("");
            while (coms.length < numRows) coms.push("");
            while (pos.length < numRows) pos.push("");
            while (studs.length < numRows) studs.push({});

            const startRow = globalRow;
            for (let i = 0; i < numRows; i++, globalRow++) {
                const obj = {};
                headers.forEach(h => {
                    switch (h) {
                        case "Project ID":
                            obj[h] = proj.projectId;
                            break;
                        case "Project Title":
                            obj[h] = proj.projectTitle;
                            break;
                        case "Project Description":
                            obj[h] = proj.projectDescription;
                            break;
                        case "Project Category":
                            obj[h] = proj.category;
                            break;
                        case "Program":
                            obj[h] = proj.program;
                            break;
                        case "Student ID":
                        case "Student Name":
                        case "Section":
                        case "Track":
                            obj[h] = studs[i][h] || "";
                            break;
                        case "Advisor":
                            obj[h] = advs[i];
                            break;
                        case "Co-Advisor":
                            obj[h] = coAd[i];
                            break;
                        case "Committee":
                            obj[h] = coms[i];
                            break;
                        case "Poster-Committee":
                            obj[h] = pos[i];
                            break;
                        default:
                            obj[h] = "";
                            break;
                    }
                });
                rowObjs.push(obj);
            }
            projectMap.set(proj.projectId, {startRow, endRow: globalRow - 1});
        });

        // 5) ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook & Worksheet
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet("Project Overview");
        ws.columns = headers.map(() => ({width: 20}));

        // 6) Merge title rows A1..A4
        const lastCol = String.fromCharCode(64 + headers.length);
        ["1", "2", "3", "4"].forEach(r => {
            ws.mergeCells(`A${r}:${lastCol}${r}`);
            ws.getCell(`A${r}`).alignment = {horizontal: "center", vertical: "middle"};
        });
        ws.getCell("A1").value = "Senior Project Overview";
        ws.getCell("A2").value = "Exported Project Committee Data";
        ws.getCell("A3").value = `Program: ${programFilter}`;
        ws.getCell("A4").value = new Date().toLocaleString();

        // 7) ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô header row ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß 5
        const hr = ws.getRow(5);
        hr.values = headers;
        hr.font = {bold: true};
        hr.alignment = {horizontal: "center", vertical: "middle"};
        hr.eachCell(c => {
            c.fill = {type: "pattern", pattern: "solid", fgColor: {argb: "FFB5E6A2"}};
            c.border = {top: {style: "thin"}, left: {style: "thin"}, bottom: {style: "thin"}, right: {style: "thin"}};
        });

        // 8) ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô dataRows
        rowObjs.forEach((obj, idx) => {
            const row = ws.getRow(6 + idx);
            row.values = headers.map(h => obj[h]);
            row.alignment = {vertical: "middle", horizontal: "left"};
            row.eachCell(c => {
                c.border = {
                    top: {style: "thin"},
                    left: {style: "thin"},
                    bottom: {style: "thin"},
                    right: {style: "thin"}
                };
            });
        });

        // 8) Merge ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å per projectMap
        ["Project ID", "Project Title", "Project Description", "Project Category", "Program", "Advisor", "Co-Advisor"]
            .forEach(colName => {
                const colIdx = headers.indexOf(colName) + 1;
                if (colIdx < 1) return;
                projectMap.forEach(({startRow, endRow}) => {
                    if (endRow > startRow) ws.mergeCells(startRow, colIdx, endRow, colIdx);
                });
            });

        // 9) ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
        const buf = await wb.xlsx.writeBuffer();
        const blob = new Blob([buf], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Project_Overview.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

    // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏° Export
    document.getElementById("export-project-excel-new").addEventListener("click", exportMergeExcel);


</script>

</html>