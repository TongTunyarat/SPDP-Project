<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Grade Evaluation Project</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/sidebar-instructor.css">
    <link rel="stylesheet" href="/css/ShowProject.css">

    <!-- Library -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


</head>

<body>
<div class="container">
    <!-- script ในการเปิดปิด period -->
    <script>
        let accessPeriods = {};

        console.log('Calling updateLinkStatus function');
        window.onload = fetchAccessPeriods;
        setInterval(updateLinkStatus, 60000);

        async function fetchAccessPeriods() {
            try {
                const response = await fetch('http://localhost:8080/api/period'); // เปลี่ยน URL ตาม backend ของคุณ
                if (!response.ok) {
                    throw new Error('Failed to fetch access periods');
                }

                const data = await response.json(); // แปลง response เป็น JSON
                console.log(data);

                accessPeriods = convertApiResponseToObject(data); // แปลง array จาก API เป็น object ที่ใช้งานง่าย
                console.log("before set date: ", accessPeriods)
                updateLinkStatus(); // อัปเดตสถานะของลิงก์
            } catch (error) {
                console.error('Error fetching access periods:', error);
            }
        }

        // ฟังก์ชันแปลง API Response (Array) เป็น Object ตาม key ที่ใช้ใน HTML
        function convertApiResponseToObject(data) {
            console.log("🎞️Convert api");
            console.log(data);

            // ตรวจสอบว่า data เป็น array และไม่เป็น null หรือ undefined
            if (!Array.isArray(data) || data.length === 0) {
                console.log("💡No data to process");
                return {}; // ถ้าไม่มีข้อมูล หรือไม่เป็น array จะคืนค่าเป็น object ว่างๆ
            }

            // 1️⃣ กำหนดประเภทของ Evaluation ที่รองรับ
            const allTypes = {
                "proposalEvaluation": "/show-proposal-eva-projects",
                "posterEvaluation": "/show-poster-projects",
                "defenseEvaluation": "/show-defense-eva-projects",
                "proposalGrade": "/show-proposal-grade-projects",
                "defenseGrade": "/show-defense-grade-projects"
            };

            let periodsObj = {};

            // 2️⃣ สร้างค่าเริ่มต้นให้ทุกประเภท (isActive = false)
            Object.keys(allTypes).forEach(type => {
                periodsObj[type] = {
                    start: null, // ไม่มีข้อมูลให้เป็น null
                    end: null,
                    isActive: false, // ปิดการใช้งาน
                    path: allTypes[type],
                    title: type
                };
            });

            // 3️⃣ อัปเดตค่าถ้ามีข้อมูลจาก API
            data.forEach((period, index) => {
                console.log(`💡Processing item at index: ${index}`);

                let evaluationTypeKey;

                // ใช้ switch-case เพื่อแปลง evaluationType ให้ตรงกับคีย์ใน allTypes
                switch (period.evaluationType) {
                    case "Proposal Evaluation":
                        evaluationTypeKey = "proposalEvaluation";
                        break;
                    case "Poster Evaluation":
                        evaluationTypeKey = "posterEvaluation";
                        break;
                    case "Defense Evaluation":
                        evaluationTypeKey = "defenseEvaluation";
                        break;
                    case "Proposal Grade":
                        evaluationTypeKey = "proposalGrade";
                        break;
                    case "Defense Grade":
                        evaluationTypeKey = "defenseGrade";
                        break;
                    default:
                        console.log(`💡No matching key for evaluation type: ${period.evaluationType}`);
                        return; // ถ้าไม่ตรงกับ case ใดๆ ก็ให้ข้ามไป
                }

                console.log("💡Evaluation type key:", evaluationTypeKey);

                if (periodsObj.hasOwnProperty(evaluationTypeKey)) {
                    // ตรวจสอบและแปลงวันที่ ถ้าวันที่เป็น string ที่ไม่สามารถแปลงได้เป็นวันที่ จะตั้งค่าเป็น null
                    const startDate = Date.parse(period.startDate); // แปลงเป็น timestamp
                    const endDate = Date.parse(period.endDate); // แปลงเป็น timestamp

                    periodsObj[evaluationTypeKey] = {
                        start: isNaN(startDate) ? null : new Date(startDate), // ถ้าแปลงไม่สำเร็จให้เป็น null
                        end: isNaN(endDate) ? null : new Date(endDate), // ถ้าแปลงไม่สำเร็จให้เป็น null
                        isActive: true, // มีข้อมูล API -> เปิดใช้งาน
                        path: allTypes[evaluationTypeKey],
                        title: period.evaluationType
                    };
                }
            });

            console.log("🎞️Final periodsObj: ", periodsObj); // ตรวจสอบผลลัพธ์
            return periodsObj;
        }

        function updateLinkStatus() {
            const currentTime = new Date(); // Get current time
            console.log("Current Time: ", currentTime); // Debugging line
            console.log("accessPeriods: ", accessPeriods)

            // Get all links with data-period
            const links = document.querySelectorAll('a[data-period]');
            console.log("links:", links); // ตรวจสอบว่าได้ลิงก์ทั้งหมดหรือไม่

            links.forEach(link => {
                const periodKey = link.getAttribute('data-period');
                const period = accessPeriods[periodKey];
                console.log("periodKey:", periodKey); // ตรวจสอบว่า periodKey ถูกต้อง
                console.log("period: ", period)

                if (period) {
                    const startTime = period.start ? new Date(period.start) : null;
                    const endTime = period.end ? new Date(period.end) : null;

                    console.log(`Checking link ${periodKey}:`, currentTime, startTime, endTime); // Debugging

                    const isAccessible =
                        period.isActive &&
                        (startTime === null || currentTime >= startTime) &&
                        (endTime === null || currentTime <= endTime);

                    console.log(`Is Accessible: ${isAccessible}`);


                    if (!isAccessible) {
                        link.classList.add('disabled-link'); // เพิ่มสไตล์
                        console.log('Disabled link added:', link);

                        link.addEventListener('click', function (e) {
                            e.preventDefault();

                            let alertMessage = "🚫 This link is not accessible right now.";

                            // ตรวจสอบว่า startTime หรือ endTime เป็น null หรือไม่
                            if (startTime && endTime) {
                                alertMessage += ` Available from ${startTime.toLocaleDateString()} to ${endTime.toLocaleDateString()}`;
                            }

                            console.warn(alertMessage); // แสดง warning ใน console
                            alert(alertMessage); // แสดง alert ตามข้อความที่กำหนด
                        });
                    } else {
                        link.classList.remove('disabled-link');

                        // ลบ event listener ที่เคยเพิ่มไว้ เพื่อไม่ให้ alert ทำงานถ้าเปลี่ยนสถานะเป็น accessible
                        link.replaceWith(link.cloneNode(true));
                    }
                }
            });
        }

    </script>


    <div class="sidebar">
        <h2>ICT MAHIDOL</h2>
        <form th:action="@{/logout}" method="post" class="logout-container">
            <!--        ค่าที่ใช้สำหรับป้องกัน Cross-Site Request Forgery (CSRF)-->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </form>
        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"
                     style="fill:#FFFFFF;">
                    <path
                            d="M39.5,43h-9c-1.381,0-2.5-1.119-2.5-2.5v-9c0-1.105-0.895-2-2-2h-4c-1.105,0-2,0.895-2,2v9c0,1.381-1.119,2.5-2.5,2.5h-9	C7.119,43,6,41.881,6,40.5V21.413c0-2.299,1.054-4.471,2.859-5.893L23.071,4.321c0.545-0.428,1.313-0.428,1.857,0L39.142,15.52	C40.947,16.942,42,19.113,42,21.411V40.5C42,41.881,40.881,43,39.5,43z">
                    </path>
                </svg>
                Homepage
            </h4>
            <li><a href="/instructor/view">Dashboard</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Evaluation (40%)
            </h4>
            <li><a href="/show-proposal-eva-projects" data-period="proposalEvaluation">Proposal Evaluation</a></li>
            <li><a href="/show-poster-projects" data-period="posterEvaluation">Poster Evaluation</a></li>
            <li><a href="/show-defense-eva-projects" data-period="defenseEvaluation">Defense Evaluation</a></li>
        </ul>

        <ul>
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero">
                        <g transform="scale(5.33333,5.33333)">
                            <path
                                    d="M12.5,4c-2.481,0 -4.5,2.019 -4.5,4.5v31c0,2.481 2.019,4.5 4.5,4.5h23c2.481,0 4.5,-2.019 4.5,-4.5v-19.5h-11.5c-2.481,0 -4.5,-2.019 -4.5,-4.5v-11.5zM27,4.87891v10.62109c0,0.827 0.673,1.5 1.5,1.5h10.62109zM17.5,25h13c0.828,0 1.5,0.672 1.5,1.5c0,0.828 -0.672,1.5 -1.5,1.5h-13c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.828 0.672,-1.5 1.5,-1.5zM17.49023,32h8.99609c0.828,0 1.5,0.671 1.5,1.5c0.001,0.759 -0.56292,1.38733 -1.29492,1.48633l-0.20312,0.01367h-8.99609c-0.828,0 -1.5,-0.672 -1.5,-1.5c0,-0.759 0.56292,-1.38733 1.29492,-1.48633z">
                            </path>
                        </g>
                    </g>
                </svg>
                Grades (60%)
            </h4>
            <li><a href="/show-proposal-grade-projects" data-period="proposalGrade" class="active">Proposal Grade</a>
            </li>
            <li><a href="/show-defense-grade-projects" data-period="defenseGrade">Defense Grade</a></li>
        </ul>
    </div>

    <div class="content">

        <div class="header-section">
            Proposal Grade (60%)

            <!-- Dropdown สำหรับเลือก semester -->
            <div class="semester-container">
                <select id="semester-selector" onchange="filterBySemester();">
                    <!-- ตัวเลือกสำหรับปีและ semester -->
                </select>
            </div>

        </div>

        <div class="table-container">
            <h1>Projects</h1>
            <div class="filter-controls">
                <label id="program-select"><strong>Program:</strong>
                    <select id="program-select-box" name="program">
                        <option value="all" selected>ALL</option>
                        <option value="ict">ICT</option>
                        <option value="dst">DST</option>
                    </select>
                </label>
                <label id="role-select"><strong>Role:</strong>
                    <select id="role-select-box" name="role">
                        <option value="all" selected>ALL</option>
                        <option value="advisor">Advisor</option>
                        <option value="committee">Committee</option>
                    </select>
                </label>
                <input id="search-keyword" type="text" placeholder="Search"/>
            </div>

            <table id="result-table">
                <thead>
                <tr>
                    <th>Project ID</th>
                    <th>Project Name</th>
                    <th>Role</th>
                    <th>Student ID</th>
                    <th>Student Names</th>
                    <th>Evaluation</th>
                    <th>Grade Evaluation</th>
                    <th>Grade</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="filter-results">
                <!-- Record Result -->

                </tbody>
            </table>
        </div>

    </div>

</div>
</body>

</html>

<script>

    // ------ Script for search function ------- //
    document.getElementById('search-keyword').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();

        // ดึงทุกแถวในตารางมา
        const rows = document.querySelectorAll("#filter-results tr");
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');

            // ตัวแปรที่ใช้ check ว่า row นี้มีข้อมูลที่ตรงกับคำค้นหามั้ย
            let rowMatches = false;

            // วนลูปผ่านทุกคอลัมน์ในแถว
            cells.forEach(cell => {
                // ถ้า cell มี ul หรือ li ให้ค้นหาข้อมูลจาก li แทน
                if (cell.querySelector('ul')) {
                    const liText = Array.from(cell.querySelectorAll('li')).map(li => li.textContent.toLowerCase()).join(' ');
                    if (liText.includes(searchTerm)) {
                        rowMatches = true;
                    }
                } else {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        rowMatches = true;
                    }
                }
            });

            // ถ้าแถวนี้มีข้อมูลที่ตรงกับคำค้นหาก็จะแสดงแถวนั้น
            if (rowMatches) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        fetchProjectData();
        // ตั้งค่า event listeners สำหรับแต่ละฟิลด์ฟิลเตอร์ เพื่อดูการเปลี่ยนแปลง
        document.getElementById('program-select-box').addEventListener('change', debounce(applyFilters, 100));
        document.getElementById('role-select-box').addEventListener('change', debounce(applyFilters, 100));
        // document.getElementById('search-keyword').addEventListener('input', debounce(applyFilters, 100)); // เพิ่มการค้นหาคำ
    });

    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            // เคลียร์ timeout ที่มีอยู่เดิมก่อน เพื่อหน่วงเวลาการเรียกฟังก์ชัน
            clearTimeout(timeout);

            // ตั้ง timeout ใหม่เพื่อเรียกฟังก์ชันหลังจากดีเลย์ที่กำหนด
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // ------ Script for filter function ------- //
    function applyFilters() {
        const programFilter = document.getElementById('program-select-box')?.value;
        const roleFilter = document.getElementById('role-select-box')?.value;

        // กรองข้อมูลที่ต้องการ
        const filteredData = projectData.filter(project => {
            let matches = true;

            // กรองโปรแกรม
            if (programFilter !== 'all' && project.projectProgram.toLowerCase() !== programFilter.toLowerCase()) {
                matches = false;
            }

            // กรองบทบาท
            if (roleFilter !== 'all' && project.role.toLowerCase() !== roleFilter.toLowerCase()) {
                matches = false;
            }

            // ฟังก์ชันค้นหาคำ
            if (searchTerm && !project.projectId.toLowerCase().includes(searchTerm) && !project.projectTitle.toLowerCase().includes(searchTerm)) {
                matches = false;
            }

            return matches;
        });

        // แสดงผลข้อมูลที่กรองแล้ว
        displayResults(filteredData);
    }

    // ตัวแปรที่ใช้เก็บข้อมูลที่ได้รับจาก API
    let projectData = [];

    // ฟังก์ชันดึงข้อมูลจาก API
    async function fetchProjectData() {
        try {
            const response = await fetch('http://localhost:8080/instructor/projectPropGradeList');
            const data = await response.json();
            projectData = data;  // เก็บข้อมูลโปรเจกต์

            // เรียกใช้ฟังก์ชันเพื่ออัปเดต dropdown และแสดงข้อมูลที่กรอง
            updateSemesterDropdown();
            filterBySemester();  // กรองข้อมูลและแสดงผลตาม semester ที่เลือก
        } catch (error) {
            console.error("Error fetching project data:", error);
        }
    }

    // ฟังก์ชันอัปเดต dropdown สำหรับเลือกปี
    function updateSemesterDropdown() {
        const semesterSelector = document.getElementById('semester-selector');
        semesterSelector.innerHTML = ""; // เคลียร์ค่าก่อนเติมใหม่

        // เติมตัวเลือก semester จากข้อมูล API
        const semesters = [...new Set(projectData.map(project => project.semester))]; // ดึงค่า semester ที่ไม่ซ้ำจากข้อมูล
        semesters.forEach(semester => {
            const option = document.createElement("option");
            option.value = semester;
            option.textContent = `🗓︎ ${semester}`;
            semesterSelector.appendChild(option);
        });

        // ตั้งค่า default เป็น semester ที่พบในข้อมูล
        const defaultSemester = semesters.length > 0 ? semesters[0] : "1";  // หากมีค่า semester ให้เลือกตัวแรก
        semesterSelector.value = defaultSemester;
    }

    // ฟังก์ชันกรองข้อมูลตาม semester ที่เลือก
    function filterBySemester() {
        const semesterSelector = document.getElementById('semester-selector');
        const selectedSemester = semesterSelector.value;

        // กรองข้อมูลตาม semester ที่เลือก
        const filteredData = projectData.filter(project => project.semester.toString() === selectedSemester);

        // แสดงข้อมูลที่กรองแล้ว
        displayResults(filteredData);
    }


    function displayResults(data) {
        let tableBody = document.querySelector("tbody");
        tableBody.innerHTML = "";  // เคลียร์ข้อมูลเก่า

        try {
            data.forEach(project => {
                console.log("Process project: " + project);

                const row = document.createElement('tr');

                // ใช้ split เพื่อแยกค่าออกจากโปรแกรม
                const programParts = project.projectId.split(" ");
                const programPrefix = programParts[0]; // ค่าก่อนหน้า (DST, ICT, etc.)
                const projectId = programParts.slice(1).join(" ");

                // status
                const evaluationStatus = project.allEvaluationsComplete
                    ? `<td>
                        <div class="status-icon completed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                             <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                             <polyline points="22 4 12 14.01 9 11.01"></polyline>
                           </svg>
                        </div>
                         </td>`

                    : `<td>
                        <div class="status-icon pending">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                             <circle cx="12" cy="12" r="10"></circle>
                             <polyline points="12 6 12 12 16 14"></polyline>
                           </svg>
                           </div>
                         </td>`;

                let maxInstructor = project.students[0].instructorEvaluation.totalInstructors;
                let completeEva = Math.min(...project.students.map(student => student.instructorEvaluation.completedInstructors));
                let waitEva = maxInstructor - completeEva;

                let completeEvaIcons = "";
                for (let i = 0; i < completeEva; i++) {
                    completeEvaIcons += '<i class=\'fas fa-user-alt\' style=\'font-size:1.7rem;color:#78adc5\'></i>'
                }

                let waitEvaIcons = "";
                for (let i = 0; i < waitEva; i++) {
                    waitEvaIcons += '<i class=\'fas fa-user-alt\' style=\'font-size:1.7rem;color:#dbdbdb\'></i>'
                }

                row.innerHTML = `
                 <td><span class="tag ${project.projectProgram.toLowerCase()}">${programPrefix}</span> ${projectId}</td>
                <td>${project.projectTitle}</td>
                <td><span class="role ${project.role.toLowerCase()}">${project.role}</span></td>
                <td>
                    <ul>
                        ${project.students.map(student => `<li>${student.studentId}</li>`).join('')}
                    </ul>
                </td>
                <td>
                    <ul>
                        ${project.students.map(student => `<li>${student.studentName}</li>`).join('')}
                    </ul>
                </td>
                <td>
                 ${completeEvaIcons}${waitEvaIcons}
                </td>
                ${evaluationStatus}
                <td>
                    <ul>
                        ${project.students.map(student => `<li>${student.gradeResult}</li>`).join('')}
                    </ul>
                </td>
                <td>
                    <form action="/instructor/editProposalGrade" method="get">
                        <input type="hidden" name="projectId" value="${project.projectId}">
                        <button type="submit"><span class="material-icons">edit</span></button>
                    </form>
                </td>
                `;
                tableBody.appendChild(row);
            })
        } catch (error) {
            console.error("Error display data in html: " + error);
            document.getElementById('filter-results').innerHTML = "No valid data to display.";
        }
    }

</script>


